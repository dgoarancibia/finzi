<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Verificar Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            font-size: 16px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button.danger {
            background: #f44336;
        }
    </style>
</head>
<body>
    <h1>üîç Verificador de Firebase</h1>
    <button onclick="verificar()">Verificar Estado Firebase</button>
    <button class="danger" onclick="borrarTodo()">üóëÔ∏è Borrar Todo de Firebase</button>

    <pre id="output">Esperando...</pre>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBFzZleam4NK9XqQQ8rYS4Sb8Nhxa9xhFo",
            authDomain: "finzi-bbdbc.firebaseapp.com",
            projectId: "finzi-bbdbc",
            storageBucket: "finzi-bbdbc.firebasestorage.app",
            messagingSenderId: "1068955823447",
            appId: "1:1068955823447:web:16968a73375fbf027fa212"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        async function verificar() {
            const output = document.getElementById('output');
            output.textContent = 'üîÑ Verificando...\n\n';

            try {
                const user = auth.currentUser;
                if (!user) {
                    output.textContent += '‚ùå No autenticado. Autentic√°ndote...\n';
                    await auth.signInAnonymously();
                    output.textContent += '‚úÖ Autenticado an√≥nimamente\n';
                }

                const userId = auth.currentUser.email || 'anonymous';
                output.textContent += `üë§ Usuario: ${userId}\n\n`;

                // Verificar meses
                const mesesSnapshot = await db.collection(`users/${userId}/mesesCarga`).get();
                output.textContent += `üìÖ MESES EN FIREBASE: ${mesesSnapshot.size}\n`;
                mesesSnapshot.docs.forEach((doc, i) => {
                    const data = doc.data();
                    output.textContent += `  ${i+1}. ID: ${doc.id} | mesAnio: ${data.mesAnio} | perfilId: ${data.perfilId}\n`;
                });

                // Verificar transacciones
                const transSnapshot = await db.collection(`users/${userId}/transacciones`).get();
                output.textContent += `\nüí∞ TRANSACCIONES EN FIREBASE: ${transSnapshot.size}\n`;

                // Contar por mes
                const porMes = {};
                transSnapshot.docs.forEach(doc => {
                    const mesAnioId = doc.data().mesAnioId;
                    porMes[mesAnioId] = (porMes[mesAnioId] || 0) + 1;
                });

                Object.entries(porMes).forEach(([mesId, count]) => {
                    output.textContent += `  Mes ${mesId}: ${count} transacciones\n`;
                });

                // Verificar presupuestos
                const presSnapshot = await db.collection(`users/${userId}/presupuestos`).get();
                output.textContent += `\nüíµ PRESUPUESTOS EN FIREBASE: ${presSnapshot.size}\n`;

                output.textContent += '\n‚úÖ Verificaci√≥n completa';

            } catch (error) {
                output.textContent += `\n‚ùå Error: ${error.message}`;
                console.error(error);
            }
        }

        async function borrarTodo() {
            if (!confirm('¬øSEGURO que quieres BORRAR TODO de Firebase?\n\nEsto eliminar√°:\n- Todos los meses\n- Todas las transacciones\n- Todos los presupuestos\n\n¬°NO SE PUEDE DESHACER!')) {
                return;
            }

            const output = document.getElementById('output');
            output.textContent = 'üóëÔ∏è Borrando TODO de Firebase...\n\n';

            try {
                const user = auth.currentUser;
                if (!user) {
                    output.textContent += '‚ùå No autenticado\n';
                    return;
                }

                const userId = user.email;
                output.textContent += `üë§ Usuario: ${userId}\n\n`;

                // Borrar meses
                output.textContent += 'üîÑ Borrando meses...\n';
                const mesesSnapshot = await db.collection(`users/${userId}/mesesCarga`).get();
                const batch1 = db.batch();
                mesesSnapshot.docs.forEach(doc => batch1.delete(doc.ref));
                await batch1.commit();
                output.textContent += `‚úÖ ${mesesSnapshot.size} meses eliminados\n`;

                // Borrar transacciones (en lotes de 500)
                output.textContent += 'üîÑ Borrando transacciones...\n';
                let totalTrans = 0;
                let transSnapshot = await db.collection(`users/${userId}/transacciones`).limit(500).get();
                while (!transSnapshot.empty) {
                    const batch = db.batch();
                    transSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    totalTrans += transSnapshot.size;
                    output.textContent += `  ‚úì ${transSnapshot.size} transacciones eliminadas\n`;
                    transSnapshot = await db.collection(`users/${userId}/transacciones`).limit(500).get();
                }
                output.textContent += `‚úÖ Total: ${totalTrans} transacciones eliminadas\n`;

                // Borrar presupuestos
                output.textContent += 'üîÑ Borrando presupuestos...\n';
                const presSnapshot = await db.collection(`users/${userId}/presupuestos`).get();
                if (!presSnapshot.empty) {
                    const batch3 = db.batch();
                    presSnapshot.docs.forEach(doc => batch3.delete(doc.ref));
                    await batch3.commit();
                    output.textContent += `‚úÖ ${presSnapshot.size} presupuestos eliminados\n`;
                }

                output.textContent += '\n‚úÖ TODO ELIMINADO DE FIREBASE\n';
                output.textContent += '\nüëâ Ahora recarga la app (Cmd + Shift + R)';

            } catch (error) {
                output.textContent += `\n‚ùå Error: ${error.message}`;
                console.error(error);
            }
        }

        // Auto-verificar al cargar
        auth.onAuthStateChanged(user => {
            if (user) {
                verificar();
            }
        });
    </script>
</body>
</html>
