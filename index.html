<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Gastos TC v3.2</title>

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>

    <!-- React 18 CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel Standalone para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- PapaParse para CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Dexie.js para IndexedDB -->
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>

    <!-- PDF.js para lectura de PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configurar worker de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Firebase SDK v9 (Compat para compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* Animaciones suaves minimalistas */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-soft {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-pulse-soft {
            animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        /* Fondo minimalista limpio */
        body {
            background: #f8f9fa;
            min-height: 100vh;
        }

        body.dark {
            background: #0f172a;
        }

        /* Patr√≥n sutil de fondo */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        body.dark::before {
            background-image:
                radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.08) 0%, transparent 50%);
        }

        /* Scrollbar minimalista */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 10px;
        }

        body.dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #6366f1;
            border-radius: 10px;
            border: 2px solid #f1f3f5;
        }

        body.dark ::-webkit-scrollbar-thumb {
            border-color: #1e293b;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f46e5;
        }

        /* Transiciones suaves */
        * {
            transition: all 0.3s ease;
        }

        /* Fix para charts responsivos */
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Sombras minimalistas */
        .shadow-minimal {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        .shadow-minimal-md {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .shadow-minimal-lg {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        /* Hover effects minimalistas */
        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.12), 0 6px 8px rgba(0, 0, 0, 0.08);
        }

        /* Responsive Tables - Mobile Optimization */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 0.75rem;
        }

        .table-responsive table {
            min-width: 100%;
        }

        @media (max-width: 768px) {
            .table-responsive table {
                font-size: 0.875rem;
            }

            .table-responsive th,
            .table-responsive td {
                padding: 0.75rem 0.5rem;
                white-space: nowrap;
            }
        }

        /* Touch Targets - Minimum 44x44px para m√≥viles */
        @media (max-width: 768px) {
            button,
            a,
            input[type="button"],
            input[type="submit"] {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* Grid Responsive - Auto ajuste en m√≥viles */
        @media (max-width: 640px) {
            .grid-responsive {
                grid-template-columns: 1fr !important;
            }
        }

        /* Prevent horizontal overflow */
        * {
            max-width: 100%;
        }

        /* Ensure containers don't overflow */
        @media (max-width: 1024px) {
            .container, .max-w-7xl, .max-w-6xl, .max-w-5xl, .max-w-4xl {
                max-width: 100% !important;
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            /* Grid responsivo por defecto */
            [class*="grid-cols-"] {
                grid-template-columns: 1fr !important;
            }

            /* Flex wrap en mobile */
            .flex {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- INICIALIZACI√ìN GLOBAL DE REACT HELPERS -->
    <script>
        // Definir memo globalmente para todos los componentes
        window.memo = React.memo;
    </script>

    <!-- CONSTANTS -->
    <script>
        // Categor√≠as predefinidas del sistema
window.DEFAULT_CATEGORIES = [
    { id: 'alimentacion', nombre: 'Alimentaci√≥n', icono: 'üçî', color: '#10b981' },
    { id: 'transporte', nombre: 'Transporte', icono: 'üöó', color: '#3b82f6' },
    { id: 'servicios', nombre: 'Servicios', icono: 'üí°', color: '#f59e0b' },
    { id: 'salud', nombre: 'Salud', icono: '‚öïÔ∏è', color: '#ef4444' },
    { id: 'entretenimiento', nombre: 'Entretenimiento', icono: 'üé¨', color: '#8b5cf6' },
    { id: 'educacion', nombre: 'Educaci√≥n', icono: 'üìö', color: '#6366f1' },
    { id: 'hogar', nombre: 'Hogar', icono: 'üè†', color: '#ec4899' },
    { id: 'tecnologia', nombre: 'Tecnolog√≠a', icono: 'üíª', color: '#06b6d4' },
    { id: 'ropa', nombre: 'Ropa', icono: 'üëï', color: '#a855f7' },
    { id: 'belleza', nombre: 'Belleza', icono: 'üíÖ', color: '#f97316' },
    { id: 'mascotas', nombre: 'Mascotas', icono: 'üêæ', color: '#84cc16' },
    { id: 'viajes', nombre: 'Viajes', icono: '‚úàÔ∏è', color: '#0ea5e9' },
    { id: 'seguros', nombre: 'Seguros', icono: 'üõ°Ô∏è', color: '#64748b' },
    { id: 'prestamos', nombre: 'Pr√©stamos', icono: 'üí∞', color: '#dc2626' },
    { id: 'ahorro', nombre: 'Ahorro/Inversi√≥n', icono: 'üìà', color: '#059669' },
    { id: 'donaciones', nombre: 'Donaciones', icono: '‚ù§Ô∏è', color: '#be123c' },
    { id: 'otros', nombre: 'Otros', icono: 'üì¶', color: '#6b7280' }
];

// Perfiles por defecto
window.getDefaultPerfiles = function() {
    return [
        { id: 1, nombre: 'Diego', color: '#6366f1', activo: true },
        { id: 2, nombre: 'Marcela', color: '#ec4899', activo: true }
    ];
}

    </script>

    <script>
        // Patrones predefinidos para categorizaci√≥n autom√°tica
// Palabras clave que identifican comercios chilenos comunes
window.CATEGORY_PATTERNS = {
    alimentacion: [
        'lider', 'jumbo', 'unimarc', 'santa isabel', 'tottus', 'ekono',
        'mercado', 'supermercado', 'almacen', 'verduleria', 'panaderia',
        'restaurant', 'resto', 'cafe', 'coffee', 'starbucks', 'juan valdez',
        'mcdonalds', 'burger king', 'kfc', 'subway', 'dominos', 'pizza',
        'sushi', 'comida', 'delivery', 'rappi', 'uber eats', 'pedidos ya',
        'copec', 'shell', 'esso', 'petrobras', 'enex', // Bencineras con tiendas
        'ok market', 'pronto', 'big john', 'spacio1'
    ],
    transporte: [
        'uber', 'cabify', 'didi', 'beat', 'taxi', 'transvip',
        'bip', 'metro', 'transantiago', 'red bus',
        'copec', 'shell', 'esso', 'petrobras', 'enex', 'bencinera',
        'combustible', 'peaje', 'autopista', 'tag', 'estacionamiento',
        'parking', 'tren', 'efe', 'turbus', 'pullman', 'buses'
    ],
    servicios: [
        'enel', 'cge', 'chilquinta', 'saesa', 'frontel', // Electricidad
        'esval', 'aguas andinas', 'nuevo sur', 'smapa', // Agua
        'metrogas', 'gasco', 'lipigas', 'abastible', // Gas
        'movistar', 'entel', 'claro', 'wom', 'vtr', 'mundo', 'virgin', // Telefon√≠a
        'netflix', 'spotify', 'amazon prime', 'disney', 'hbo', 'apple',
        'youtube', 'google', 'microsoft', 'adobe', 'dropbox', 'icloud'
    ],
    salud: [
        'farmacia', 'cruz verde', 'salcobrand', 'ahumada',
        'clinica', 'hospital', 'consulta', 'medico', 'doctor',
        'dental', 'dentista', 'odontologo', 'laboratorio',
        'isapre', 'fonasa', 'consalud', 'banmedica', 'cruz blanca',
        'optica', 'gimnasio', 'gym', 'smartfit', 'sportlife'
    ],
    entretenimiento: [
        'cine', 'cinemark', 'hoyts', 'cineplanet', 'cinepolis',
        'teatro', 'concierto', 'ticketmaster', 'puntoticket',
        'bar', 'pub', 'disco', 'club', 'bowling',
        'steam', 'playstation', 'xbox', 'nintendo', 'epic games',
        'casino', 'enjoy', 'dreams'
    ],
    educacion: [
        'universidad', 'instituto', 'colegio', 'escuela',
        'libreria', 'antartica', 'feria del libro',
        'curso', 'capacitacion', 'udemy', 'coursera', 'platzi',
        'duolingo', 'babbel'
    ],
    hogar: [
        'sodimac', 'easy', 'homecenter', 'construmart',
        'paris', 'falabella', 'ripley', 'lapolar', 'hites',
        'muebles', 'muebleria', 'deco', 'decoracion',
        'ferreteria', 'pintura', 'construc'
    ],
    tecnologia: [
        'pc factory', 'sp digital', 'abcdin', 'pc express',
        'apple', 'mac', 'iphone', 'samsung', 'xiaomi',
        'mercadolibre', 'aliexpress', 'amazon', 'ebay',
        'store', 'tech', 'digital', 'computacion', 'celular'
    ],
    ropa: [
        'zara', 'h&m', 'gap', 'forever 21', 'c&a', 'basement',
        'adidas', 'nike', 'puma', 'reebok', 'new balance',
        'falabella', 'ripley', 'paris', // Tambi√©n venden ropa
        'ropa', 'zapateria', 'zapatos', 'boutique'
    ],
    belleza: [
        'peluqueria', 'salon', 'spa', 'estetica',
        'perfumeria', 'sephora', 'mac', 'loreal',
        'barberia', 'barber', 'manicure', 'pedicure'
    ],
    mascotas: [
        'veterinaria', 'pet', 'mascota', 'perro', 'gato',
        'puppis', 'super zoo', 'pet food', 'alimento'
    ],
    viajes: [
        'hotel', 'hostal', 'apart', 'airbnb', 'booking',
        'latam', 'jetsmart', 'sky', 'aerol', 'vuelo',
        'turismo', 'tour', 'viaje', 'agencia'
    ],
    seguros: [
        'seguro', 'insurance', 'bci seguros', 'liberty',
        'chilena consolidada', 'hdi', 'sura', 'mapfre'
    ],
    prestamos: [
        'prestamo', 'credito', 'cuota', 'dividendo',
        'banco', 'santander', 'chile', 'bci', 'estado',
        'scotiabank', 'itau', 'security', 'falabella', 'ripley'
    ],
    ahorro: [
        'afp', 'capital', 'cuprum', 'habitat', 'modelo', 'planvital', 'provida',
        'inversion', 'fondo', 'mutuo', 'apv', 'ahorro'
    ]
};

// Normalizaci√≥n de nombres de comercios
// Mapeo de variaciones comunes a nombres est√°ndar
window.COMMERCE_NORMALIZATIONS = {
    'lider express': 'Lider',
    'lider hiper': 'Lider',
    'jumbo mas': 'Jumbo',
    'unimarc express': 'Unimarc',
    'mc donalds': 'McDonalds',
    'mcdonald': 'McDonalds',
    'burger king': 'Burger King',
    'cruz verde': 'Cruz Verde',
    'farmacias cruz verde': 'Cruz Verde',
    'salcobrand': 'Salcobrand',
    'farmacias salcobrand': 'Salcobrand',
    'farmacia ahumada': 'Ahumada',
    'cinemark': 'Cinemark',
    'cine hoyts': 'Hoyts',
    'spotify premium': 'Spotify',
    'netflix': 'Netflix',
    'uber trip': 'Uber',
    'uber eats': 'Uber Eats',
    'rappi': 'Rappi',
    'pedidosya': 'PedidosYa',
    'pedidos ya': 'PedidosYa'
};

    </script>

    <!-- UTILS -->
    <script>
        // Configuraci√≥n de IndexedDB con Dexie.js
window.db = new Dexie('GastosTCDatabase');

// Definir el esquema de la base de datos
db.version(11).stores({
    // Meses cargados: registra cada mes con transacciones
    mesesCarga: '++id, mesAnio, fechaCarga',

    // Transacciones: todas las compras del CSV
    // Campos adicionales: esCompartido, porcentajePerfil, perfilCompartidoId
    // Campos de reembolso: esReembolsable, reembolsoId
    // Campos v3.4 (Entrada R√°pida): origen ('manual'|'csv'), estado ('provisional'|'confirmado'), textoOriginal, transaccionRelacionadaId
    transacciones: '++id, mesAnioId, perfilId, fecha, categoria, comercio, esCompartido, esReembolsable, reembolsoId, origen, estado',

    // Presupuestos: l√≠mites por categor√≠a por mes
    // esPlantilla: true para la plantilla base, false para meses espec√≠ficos
    presupuestos: '++id, mesAnioId, categoria, monto, esPlantilla',

    // Recurrentes: transacciones recurrentes con frecuencias variables
    // frecuencia: 'mensual', 'bimestral', 'trimestral', 'semestral', 'anual', 'personalizado'
    // fechaProximoPago: pr√≥xima fecha de cobro (YYYY-MM-DD)
    // monto: monto del pago (no mensual estimado, sino el monto real del pago)
    recurrentes: '++id, nombre, categoria, perfilId, monto, frecuencia, fechaProximoPago, activa',

    // Historial de recurrentes: registro de montos reales por mes
    historialRecurrentes: '++id, recurrenteId, mesAnio, monto, fecha',

    // Compras planeadas: para proyecci√≥n futura
    comprasPlaneadas: '++id, nombre, monto, cuotas, categoria, perfilId, fechaCreacion',

    // Liquidaciones: registro de pagos entre perfiles para saldar cuentas
    liquidaciones: '++id, mesAnioId, mesAnio, deudorId, acreedorId, monto, fecha, gastosIncluidos',

    // Ingresos: registro de ingresos mensuales por perfil
    ingresos: '++id, mesAnio, perfilId, monto, descripcion, fecha, esRecurrente',

    // Reembolsos: seguimiento de gastos a reembolsar
    // estado: 'pendiente', 'solicitado', 'pagado'
    // tipoCompra: 'spot' o 'cuotas'
    // Si es cuotas: transaccionOrigenId apunta a la primera cuota, cuotasTotal indica el total
    reembolsos: '++id, transaccionOrigenId, nombreDeudor, estado, tipoCompra, cuotasTotal, fechaCreacion, fechaSolicitud, fechaPago'
}).upgrade(tx => {
    // Migraci√≥n de versi√≥n 9 a 10: actualizar recurrentes con nuevos campos
    return tx.table('recurrentes').toCollection().modify(recurrente => {
        // Si no tiene frecuencia, asignar 'mensual' por defecto
        if (!recurrente.frecuencia) {
            recurrente.frecuencia = 'mensual';
        }
        // Si no tiene fechaProximoPago, calcular del primer d√≠a del pr√≥ximo mes
        if (!recurrente.fechaProximoPago) {
            const hoy = new Date();
            const proximoMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 1);
            recurrente.fechaProximoPago = proximoMes.toISOString().split('T')[0];
        }
        // Migrar montoEstimado a monto si existe
        if (recurrente.montoEstimado !== undefined && !recurrente.monto) {
            recurrente.monto = recurrente.montoEstimado;
        }
    });
});

// Migraci√≥n de versi√≥n 10 a 11: agregar campos de entrada r√°pida
db.version(11).upgrade(tx => {
    return tx.table('transacciones').toCollection().modify(transaccion => {
        // Transacciones existentes del CSV se marcan como confirmadas
        if (!transaccion.origen) {
            transaccion.origen = 'csv';
        }
        if (!transaccion.estado) {
            transaccion.estado = 'confirmado';
        }
        if (!transaccion.textoOriginal) {
            transaccion.textoOriginal = null;
        }
        if (!transaccion.transaccionRelacionadaId) {
            transaccion.transaccionRelacionadaId = null;
        }
    });
});

// Funciones auxiliares para trabajar con la DB

/**
 * Obtiene o crea un mes de carga
 * @param {string} mesAnio - Formato "YYYY-MM"
 * @returns {Promise<number>} ID del mes
 */
window.getOrCreateMesAnio = async function(mesAnio) {
    const mesExistente = await db.mesesCarga
        .where('mesAnio')
        .equals(mesAnio)
        .first();

    if (mesExistente) {
        return mesExistente.id;
    }

    const id = await db.mesesCarga.add({
        mesAnio: mesAnio,
        fechaCarga: new Date().toISOString()
    });

    return id;
}

/**
 * Obtiene todas las transacciones de un mes espec√≠fico
 * @param {number} mesAnioId - ID del mes
 * @returns {Promise<Array>} Array de transacciones
 */
window.getTransaccionesByMes = async function(mesAnioId) {
    console.log(`üîç getTransaccionesByMes llamado con mesAnioId:`, mesAnioId);

    // WORKAROUND: El √≠ndice de Dexie est√° roto en DBs antiguas
    // Usar .filter() manual en lugar de .where().equals()
    const todas = await db.transacciones.toArray();
    const result = todas.filter(t => t.mesAnioId === mesAnioId);

    console.log(`üîç Total en DB: ${todas.length}, Filtradas: ${result.length}`);

    return result;
}

/**
 * Obtiene transacciones filtradas
 * @param {number} mesAnioId - ID del mes
 * @param {Object} filtros - { perfilId, categoria, tipo }
 * @returns {Promise<Array>} Array de transacciones filtradas
 */
window.getTransaccionesFiltradas = async function(mesAnioId, filtros = {}) {
    // WORKAROUND: Usar .filter() manual en lugar de √≠ndice
    const todas = await db.transacciones.toArray();
    const transacciones = todas.filter(t => t.mesAnioId === mesAnioId);

    // Aplicar filtros en memoria
    return transacciones.filter(t => {
        if (filtros.perfilId && t.perfilId !== filtros.perfilId) return false;
        if (filtros.categoria && t.categoria !== filtros.categoria) return false;
        if (filtros.tipo) {
            // Spot: sin cuotas O pago del mes 1/1
            if (filtros.tipo === 'spot' && t.cuotaActual && !(t.cuotaActual === 1 && t.cuotasTotal === 1)) return false;
            // Cuotas del mes: primera cuota de compra en cuotas (1/2, 1/3, etc.)
            if (filtros.tipo === 'cuotasMes' && (!t.cuotaActual || t.cuotaActual !== 1 || t.cuotasTotal === 1)) return false;
            // Cuotas anteriores: cuotas 2/12, 3/12, etc.
            if (filtros.tipo === 'cuotasAnteriores' && (!t.cuotaActual || t.cuotaActual === 1)) return false;
        }
        return true;
    });
}

/**
 * Agrega m√∫ltiples transacciones
 * @param {Array} transacciones - Array de transacciones
 * @returns {Promise<void>}
 */
window.addTransacciones = async function(transacciones) {
    return await db.transacciones.bulkAdd(transacciones);
}

/**
 * Actualiza una transacci√≥n existente
 * @param {number} id - ID de la transacci√≥n
 * @param {Object} cambios - Campos a actualizar
 * @returns {Promise<number>}
 */
window.updateTransaccion = async function(id, cambios) {
    return await db.transacciones.update(id, cambios);
}

/**
 * Elimina una transacci√≥n
 * @param {number} id - ID de la transacci√≥n
 * @returns {Promise<void>}
 */
window.deleteTransaccion = async function(id) {
    return await db.transacciones.delete(id);
}

/**
 * Obtiene presupuestos de un mes (o plantilla)
 * @param {number|null} mesAnioId - ID del mes, o null para plantilla
 * @returns {Promise<Array>} Array de presupuestos
 */
window.getPresupuestos = async function(mesAnioId = null) {
    if (mesAnioId === null) {
        // Obtener plantilla base
        return await db.presupuestos
            .where('esPlantilla')
            .equals(1)
            .toArray();
    }

    // Buscar presupuestos espec√≠ficos del mes
    const presupuestosMes = await db.presupuestos
        .where('mesAnioId')
        .equals(mesAnioId)
        .toArray();

    // Si no hay presupuestos para el mes, usar plantilla
    if (presupuestosMes.length === 0) {
        return await db.presupuestos
            .where('esPlantilla')
            .equals(1)
            .toArray();
    }

    return presupuestosMes;
}

/**
 * Guarda o actualiza presupuestos
 * @param {Array} presupuestos - Array de presupuestos
 * @param {number|null} mesAnioId - ID del mes, o null para plantilla
 * @returns {Promise<void>}
 */
window.savePresupuestos = async function(presupuestos, mesAnioId = null) {
    const esPlantilla = mesAnioId === null ? 1 : 0;

    // Eliminar presupuestos anteriores
    if (mesAnioId === null) {
        await db.presupuestos.where('esPlantilla').equals(1).delete();
    } else {
        await db.presupuestos.where('mesAnioId').equals(mesAnioId).delete();
    }

    // Agregar nuevos presupuestos
    const items = presupuestos.map(p => ({
        mesAnioId: mesAnioId,
        categoria: p.categoria,
        monto: p.monto,
        esPlantilla: esPlantilla
    }));

    await db.presupuestos.bulkAdd(items);
}

/**
 * Elimina todas las transacciones de un mes
 * @param {number} mesAnioId - ID del mes
 * @returns {Promise<void>}
 */
window.deleteAllTransaccionesByMes = async function(mesAnioId) {
    await db.transacciones.where('mesAnioId').equals(mesAnioId).delete();
}

/**
 * Elimina un mes completo y todas sus transacciones
 * @param {number} mesAnioId - ID del mes
 * @returns {Promise<void>}
 */
window.deleteMesCompleto = async function(mesAnioId) {
    await deleteAllTransaccionesByMes(mesAnioId);
    await db.mesesCarga.delete(mesAnioId);
}

/**
 * Obtiene recurrentes activas
 * @returns {Promise<Array>} Array de recurrentes
 */
window.getRecurrentesActivas = async function() {
    return await db.recurrentes
        .where('activa')
        .equals(1)
        .toArray();
}

/**
 * Obtiene historial de una recurrente
 * @param {number} recurrenteId - ID de la recurrente
 * @param {number} meses - Cantidad de meses hacia atr√°s
 * @returns {Promise<Array>} Array de historial
 */
window.getHistorialRecurrente = async function(recurrenteId, meses = 6) {
    return await db.historialRecurrentes
        .where('recurrenteId')
        .equals(recurrenteId)
        .reverse()
        .limit(meses)
        .toArray();
}

/**
 * Registra un pago de recurrente
 * @param {number} recurrenteId - ID de la recurrente
 * @param {string} mesAnio - Formato "YYYY-MM"
 * @param {number} monto - Monto pagado
 * @returns {Promise<number>} ID del registro
 */
window.registrarPagoRecurrente = async function(recurrenteId, mesAnio, monto) {
    return await db.historialRecurrentes.add({
        recurrenteId,
        mesAnio,
        monto,
        fecha: new Date().toISOString()
    });
}

/**
 * Obtiene compras planeadas
 * @returns {Promise<Array>} Array de compras planeadas
 */
window.getComprasPlaneadas = async function() {
    return await db.comprasPlaneadas.toArray();
}

/**
 * Agrega una compra planeada
 * @param {Object} compra - Datos de la compra
 * @returns {Promise<number>} ID de la compra
 */
window.addCompraPlaneada = async function(compra) {
    return await db.comprasPlaneadas.add({
        ...compra,
        fechaCreacion: new Date().toISOString()
    });
}

/**
 * Elimina una compra planeada
 * @param {number} id - ID de la compra
 * @returns {Promise<void>}
 */
window.deleteCompraPlaneada = async function(id) {
    return await db.comprasPlaneadas.delete(id);
}

// ============================================
// FUNCIONES PARA LIQUIDACIONES
// ============================================

/**
 * Agrega una nueva liquidaci√≥n
 * @param {Object} liquidacion - Datos de la liquidaci√≥n
 * @returns {Promise<number>} ID de la liquidaci√≥n creada
 */
window.addLiquidacion = async function(liquidacion) {
    return await db.liquidaciones.add(liquidacion);
}

/**
 * Obtiene las liquidaciones de un mes espec√≠fico
 * @param {number} mesAnioId - ID del mes
 * @returns {Promise<Array>} Array de liquidaciones
 */
window.getLiquidaciones = async function(mesAnioId) {
    return await db.liquidaciones
        .where('mesAnioId')
        .equals(mesAnioId)
        .reverse()
        .sortBy('fecha');
}

/**
 * Obtiene todas las liquidaciones
 * @returns {Promise<Array>} Array de todas las liquidaciones
 */
window.getAllLiquidaciones = async function() {
    return await db.liquidaciones.reverse().sortBy('fecha');
}

/**
 * Elimina una liquidaci√≥n
 * @param {number} id - ID de la liquidaci√≥n
 * @returns {Promise<void>}
 */
window.deleteLiquidacion = async function(id) {
    return await db.liquidaciones.delete(id);
}

// ============================================
// FUNCIONES PARA INGRESOS
// ============================================

/**
 * Obtiene los ingresos de un mes espec√≠fico
 * @param {string} mesAnio - Formato "YYYY-MM"
 * @returns {Promise<Array>} Array de ingresos
 */
window.getIngresos = async function(mesAnio) {
    return await db.ingresos
        .where('mesAnio')
        .equals(mesAnio)
        .toArray();
}

/**
 * Agrega un nuevo ingreso
 * @param {Object} ingreso - Datos del ingreso
 * @returns {Promise<number>} ID del ingreso creado
 */
window.addIngreso = async function(ingreso) {
    return await db.ingresos.add({
        ...ingreso,
        fecha: ingreso.fecha || new Date().toISOString()
    });
}

/**
 * Actualiza un ingreso existente
 * @param {number} id - ID del ingreso
 * @param {Object} cambios - Campos a actualizar
 * @returns {Promise<number>}
 */
window.updateIngreso = async function(id, cambios) {
    return await db.ingresos.update(id, cambios);
}

/**
 * Elimina un ingreso
 * @param {number} id - ID del ingreso
 * @returns {Promise<void>}
 */
window.deleteIngreso = async function(id) {
    return await db.ingresos.delete(id);
}

/**
 * Obtiene el total de ingresos de un mes por perfil
 * @param {string} mesAnio - Formato "YYYY-MM"
 * @param {number} perfilId - ID del perfil (opcional)
 * @returns {Promise<number>} Total de ingresos
 */
window.getTotalIngresosMes = async function(mesAnio, perfilId = null) {
    let query = db.ingresos.where('mesAnio').equals(mesAnio);
    const ingresos = await query.toArray();

    return ingresos
        .filter(i => !perfilId || i.perfilId === perfilId)
        .reduce((sum, i) => sum + i.monto, 0);
}

// ============================================
// FUNCIONES PARA REEMBOLSOS
// ============================================

/**
 * Crea un nuevo reembolso
 * @param {Object} reembolso - Datos del reembolso
 * @returns {Promise<number>} ID del reembolso creado
 */
window.addReembolso = async function(reembolso) {
    const id = await db.reembolsos.add({
        ...reembolso,
        fechaCreacion: new Date().toISOString()
    });

    // Marcar la transacci√≥n origen como reembolsable
    await db.transacciones.update(reembolso.transaccionOrigenId, {
        esReembolsable: true,
        reembolsoId: id
    });

    return id;
}

/**
 * Obtiene todos los reembolsos
 * @param {string} estado - Filtrar por estado ('pendiente', 'solicitado', 'pagado', o null para todos)
 * @returns {Promise<Array>} Array de reembolsos
 */
window.getReembolsos = async function(estado = null) {
    if (estado) {
        return await db.reembolsos
            .where('estado')
            .equals(estado)
            .reverse()
            .sortBy('fechaCreacion');
    }
    return await db.reembolsos.reverse().sortBy('fechaCreacion');
}

/**
 * Obtiene un reembolso por ID
 * @param {number} id - ID del reembolso
 * @returns {Promise<Object>} Reembolso
 */
window.getReembolsoById = async function(id) {
    return await db.reembolsos.get(id);
}

/**
 * Actualiza el estado de un reembolso
 * @param {number} id - ID del reembolso
 * @param {string} nuevoEstado - Nuevo estado ('pendiente', 'solicitado', 'pagado')
 * @returns {Promise<number>}
 */
window.updateEstadoReembolso = async function(id, nuevoEstado) {
    const cambios = { estado: nuevoEstado };

    if (nuevoEstado === 'solicitado') {
        cambios.fechaSolicitud = new Date().toISOString();
    } else if (nuevoEstado === 'pagado') {
        cambios.fechaPago = new Date().toISOString();
    }

    return await db.reembolsos.update(id, cambios);
}

/**
 * Elimina un reembolso
 * @param {number} id - ID del reembolso
 * @returns {Promise<void>}
 */
window.deleteReembolso = async function(id) {
    const reembolso = await db.reembolsos.get(id);
    if (reembolso) {
        // Desmarcar la transacci√≥n origen
        await db.transacciones.update(reembolso.transaccionOrigenId, {
            esReembolsable: false,
            reembolsoId: null
        });
    }
    return await db.reembolsos.delete(id);
}

/**
 * Obtiene reembolsos con informaci√≥n de transacciones asociadas
 * @param {string} estado - Filtrar por estado (opcional)
 * @returns {Promise<Array>} Array de reembolsos con datos de transacciones
 */
window.getReembolsosConTransacciones = async function(estado = null) {
    const reembolsos = await getReembolsos(estado);
    const result = [];

    for (const reembolso of reembolsos) {
        const transaccion = await db.transacciones.get(reembolso.transaccionOrigenId);
        result.push({
            ...reembolso,
            transaccion
        });
    }

    return result;
}

    </script>

    <script>
        // Utilidades para formateo de n√∫meros y fechas

/**
 * Formatea un n√∫mero a formato chileno con punto como separador de miles
 * @param {number} valor - N√∫mero a formatear
 * @param {boolean} incluirSigno - Si incluir el signo $ (default: true)
 * @returns {string} N√∫mero formateado
 */
window.formatearMonto = function(valor, incluirSigno = true) {
    if (valor === null || valor === undefined || isNaN(valor)) {
        return incluirSigno ? '$0' : '0';
    }

    const numero = Math.round(valor);
    const formateado = numero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    return incluirSigno ? `${formateado}` : formateado;
}

/**
 * Convierte un string con formato chileno a n√∫mero
 * @param {string} montoStr - String con formato "$123.456" o "123.456"
 * @returns {number} N√∫mero parseado
 */
window.parsearMonto = function(montoStr) {
    if (typeof montoStr === 'number') return montoStr;
    if (!montoStr) return 0;

    // Remover $ y espacios
    let str = montoStr.toString().replace(/\$/g, '').trim();

    // Remover puntos (separadores de miles)
    str = str.replace(/\./g, '');

    // Reemplazar coma por punto (si hay decimales)
    str = str.replace(/,/g, '.');

    return parseFloat(str) || 0;
}

/**
 * Formatea una fecha a formato legible en espa√±ol
 * @param {string|Date} fecha - Fecha a formatear
 * @param {string} formato - "corto", "largo", "mes" (default: "corto")
 * @returns {string} Fecha formateada
 */
window.formatearFecha = function(fecha, formato = 'corto') {
    if (!fecha) return '';

    const date = typeof fecha === 'string' ? new Date(fecha) : fecha;

    const opciones = {
        corto: { day: '2-digit', month: '2-digit', year: 'numeric' },
        largo: { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' },
        mes: { year: 'numeric', month: 'long' }
    };

    return date.toLocaleDateString('es-CL', opciones[formato] || opciones.corto);
}

/**
 * Convierte fecha string a formato YYYY-MM-DD
 * @param {string} fechaStr - Fecha en formato DD/MM/YYYY, DD-MM-YYYY, etc.
 * @returns {string} Fecha en formato YYYY-MM-DD
 */
window.normalizarFecha = function(fechaStr) {
    if (!fechaStr) return null;

    // Si ya est√° en formato ISO, retornar
    if (/^\d{4}-\d{2}-\d{2}/.test(fechaStr)) {
        return fechaStr.split('T')[0];
    }

    // Intentar parsear formatos comunes
    let match;

    // DD/MM/YYYY o DD-MM-YYYY (a√±o con 4 d√≠gitos)
    match = fechaStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
    if (match) {
        const [, dia, mes, anio] = match;
        return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    }

    // DD/MM/YY o DD-MM-YY (a√±o con 2 d√≠gitos)
    match = fechaStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})$/);
    if (match) {
        const [, dia, mes, anioCorto] = match;
        // Convertir a√±o de 2 d√≠gitos a 4 d√≠gitos
        // Si es <= 50, asumimos 20XX, si es > 50, asumimos 19XX
        const anio = parseInt(anioCorto) <= 50 ? `20${anioCorto}` : `19${anioCorto}`;
        return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    }

    // YYYY/MM/DD o YYYY-MM-DD
    match = fechaStr.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
    if (match) {
        const [, anio, mes, dia] = match;
        return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    }

    // Si no se puede parsear, intentar con Date
    try {
        const date = new Date(fechaStr);
        if (!isNaN(date.getTime())) {
            return date.toISOString().split('T')[0];
        }
    } catch (e) {
        console.error('Error al parsear fecha:', fechaStr);
    }

    return null;
}

/**
 * Obtiene el formato YYYY-MM de una fecha
 * @param {string|Date} fecha - Fecha
 * @returns {string} Formato YYYY-MM
 */
window.getMesAnio = function(fecha) {
    const date = typeof fecha === 'string' ? new Date(fecha) : fecha;
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    return `${year}-${month}`;
}

/**
 * Obtiene el nombre del mes en espa√±ol
 * @param {string} mesAnio - Formato YYYY-MM
 * @returns {string} Nombre del mes y a√±o
 */
window.getNombreMes = function(mesAnio) {
    if (!mesAnio) return '';

    const [year, month] = mesAnio.split('-');
    const date = new Date(year, parseInt(month) - 1, 1);

    return date.toLocaleDateString('es-CL', { year: 'numeric', month: 'long' });
}

/**
 * Calcula el porcentaje de uso de presupuesto
 * @param {number} gastado - Monto gastado
 * @param {number} presupuesto - Presupuesto total
 * @returns {number} Porcentaje (0-100)
 */
window.calcularPorcentaje = function(gastado, presupuesto) {
    if (!presupuesto || presupuesto === 0) return 0;
    return Math.min(Math.round((gastado / presupuesto) * 100), 100);
}

/**
 * Obtiene el color del sem√°foro seg√∫n porcentaje
 * @param {number} porcentaje - Porcentaje de uso
 * @returns {Object} { color, bgColor, textColor }
 */
window.getColorSemaforo = function(porcentaje) {
    if (porcentaje < 70) {
        return {
            color: '#10b981',
            bgColor: 'bg-green-100',
            textColor: 'text-green-700',
            borderColor: 'border-green-300'
        };
    } else if (porcentaje < 90) {
        return {
            color: '#f59e0b',
            bgColor: 'bg-yellow-100',
            textColor: 'text-yellow-700',
            borderColor: 'border-yellow-300'
        };
    } else {
        return {
            color: '#ef4444',
            bgColor: 'bg-red-100',
            textColor: 'text-red-700',
            borderColor: 'border-red-300'
        };
    }
}

/**
 * Genera un array de meses hacia atr√°s
 * @param {number} cantidad - Cantidad de meses
 * @param {string} desde - Mes inicial en formato YYYY-MM (default: mes actual)
 * @returns {Array} Array de strings YYYY-MM
 */
window.generarMesesAtras = function(cantidad, desde = null) {
    const meses = [];
    const fechaInicio = desde ? new Date(desde + '-01') : new Date();

    for (let i = 0; i < cantidad; i++) {
        const fecha = new Date(fechaInicio);
        fecha.setMonth(fecha.getMonth() - i);
        meses.push(getMesAnio(fecha));
    }

    return meses;
}

/**
 * Genera un array de meses hacia adelante
 * @param {number} cantidad - Cantidad de meses
 * @param {string} desde - Mes inicial en formato YYYY-MM (default: mes actual)
 * @returns {Array} Array de strings YYYY-MM
 */
window.generarMesesAdelante = function(cantidad, desde = null) {
    const meses = [];
    const fechaInicio = desde ? new Date(desde + '-01') : new Date();

    for (let i = 0; i < cantidad; i++) {
        const fecha = new Date(fechaInicio);
        fecha.setMonth(fecha.getMonth() + i);
        meses.push(getMesAnio(fecha));
    }

    return meses;
}

/**
 * Trunca un texto a una longitud m√°xima
 * @param {string} texto - Texto a truncar
 * @param {number} maxLength - Longitud m√°xima
 * @returns {string} Texto truncado con "..."
 */
window.truncarTexto = function(texto, maxLength = 30) {
    if (!texto) return '';
    if (texto.length <= maxLength) return texto;
    return texto.substring(0, maxLength - 3) + '...';
}

    </script>

    <script>
        // Parser de archivos CSV con PapaParse

/**
 * Parsea un archivo CSV y retorna las transacciones
 * @param {File} file - Archivo CSV
 * @returns {Promise<Array>} Array de transacciones parseadas
 */
window.parsearCSV = async function(file) {
    return new Promise((resolve, reject) => {
        Papa.parse(file, {
            delimiter: ';',
            header: true,
            skipEmptyLines: true,
            transformHeader: (header) => {
                // Normalizar nombres de columnas
                const normalizado = header.trim().toLowerCase();
                const mapeo = {
                    'fecha': 'fecha',
                    'date': 'fecha',
                    'descripcion': 'descripcion',
                    'descripci√≥n': 'descripcion',
                    'description': 'descripcion',
                    'comercio': 'descripcion',
                    'monto': 'monto',
                    'amount': 'monto',
                    'valor': 'monto',
                    'cuotas': 'cuotas',
                    'cuota': 'cuotas',
                    'installments': 'cuotas'
                };
                return mapeo[normalizado] || normalizado;
            },
            complete: (results) => {
                try {
                    const transacciones = procesarResultadosCSV(results.data);
                    resolve(transacciones);
                } catch (error) {
                    reject(error);
                }
            },
            error: (error) => {
                reject(error);
            }
        });
    });
}

/**
 * Procesa los resultados del parser CSV
 * @param {Array} data - Datos parseados por PapaParse
 * @returns {Array} Array de transacciones normalizadas
 */
window.procesarResultadosCSV = function(data) {
    const transacciones = [];
    let filasDescartadas = 0;
    let totalMontosOriginales = 0;

    console.log(`üìä Procesando ${data.length} filas del CSV...`);

    for (const row of data) {
        // Validar que tenga los campos m√≠nimos
        if (!row.fecha || !row.descripcion || !row.monto) {
            console.warn('Fila inv√°lida (campos faltantes):', row);
            filasDescartadas++;
            continue;
        }

        // Normalizar fecha
        const fechaNormalizada = normalizarFecha(row.fecha);
        if (!fechaNormalizada) {
            console.warn('Fecha inv√°lida:', row.fecha, row);
            filasDescartadas++;
            continue;
        }

        // Parsear monto
        const monto = parsearMonto(row.monto);
        totalMontosOriginales += Math.abs(monto);

        if (monto === 0 || isNaN(monto)) {
            console.warn('Monto inv√°lido:', row.monto, '-> parseado como:', monto);
            filasDescartadas++;
            continue;
        }

        // Detectar informaci√≥n de cuotas
        const infoCuotas = detectarCuotas(row.descripcion, row.cuotas);

        // Si infoCuotas es null, significa que es una cuota 0/X y debe excluirse
        if (infoCuotas === null) {
            console.log('‚ö†Ô∏è  Transacci√≥n excluida (cuota 0/X):', row.descripcion);
            filasDescartadas++;
            continue;
        }

        // Normalizar nombre del comercio
        const comercioNormalizado = normalizarComercio(row.descripcion);

        // Aplicar descripci√≥n aprendida si es una compra con cuotas
        let descripcionFinal = row.descripcion.trim();
        if (infoCuotas.cuotasTotal && infoCuotas.cuotasTotal > 1) {
            const claveCompra = `${comercioNormalizado}_${infoCuotas.cuotasTotal}cuotas`.toLowerCase();
            const descripcionesAprendidas = obtenerDescripcionesAprendidas();
            if (descripcionesAprendidas[claveCompra]) {
                descripcionFinal = descripcionesAprendidas[claveCompra];
                console.log(`üéØ Aplicando descripci√≥n aprendida: "${claveCompra}" ‚Üí "${descripcionFinal}"`);
            }
        }

        // Crear transacci√≥n
        const transaccion = {
            fecha: fechaNormalizada,
            descripcion: descripcionFinal,
            comercio: comercioNormalizado,
            monto: monto,
            ...infoCuotas
        };

        transacciones.push(transaccion);
    }

    // Mostrar resumen de procesamiento
    const totalProcesado = transacciones.reduce((sum, t) => sum + Math.abs(t.monto), 0);
    console.log(`‚úÖ Procesamiento completado:`);
    console.log(`   - Total filas le√≠das: ${data.length}`);
    console.log(`   - Transacciones v√°lidas: ${transacciones.length}`);
    console.log(`   - Filas descartadas: ${filasDescartadas}`);
    console.log(`   - Total montos originales: ${totalMontosOriginales.toLocaleString('es-CL')}`);
    console.log(`   - Total transacciones procesadas: ${Math.round(totalProcesado).toLocaleString('es-CL')}`);

    return transacciones;
}

/**
 * Detecta informaci√≥n de cuotas en la descripci√≥n o campo cuotas
 * Formatos soportados: "1/12", "2 de 6", "Cuota 3/10", etc.
 * IMPORTANTE: Si detecta "0/X", retorna null para indicar que debe excluirse
 * @param {string} descripcion - Descripci√≥n de la transacci√≥n
 * @param {string} campoCuotas - Campo cuotas del CSV (opcional)
 * @returns {Object|null} { cuotaActual, cuotasTotal, esCuotaMes } o null si es cuota 0
 */
window.detectarCuotas = function(descripcion, campoCuotas = '') {
    const texto = `${descripcion} ${campoCuotas}`.toLowerCase();

    // Patrones para detectar cuotas
    const patrones = [
        /(\d+)\s*\/\s*(\d+)/,           // 1/12
        /(\d+)\s+de\s+(\d+)/,            // 1 de 12
        /cuota\s+(\d+)\s*\/\s*(\d+)/,   // Cuota 1/12
        /cuota\s+(\d+)\s+de\s+(\d+)/,   // Cuota 1 de 12
        /cta\s+(\d+)\s*\/\s*(\d+)/,     // Cta 1/12
        /(\d+)-(\d+)/                    // 1-12
    ];

    for (const patron of patrones) {
        const match = texto.match(patron);
        if (match) {
            const cuotaActual = parseInt(match[1]);
            const cuotasTotal = parseInt(match[2]);

            // Si la cuota actual es 0, retornar null para excluir esta transacci√≥n
            if (cuotaActual === 0) {
                return null;
            }

            // Validar que sean n√∫meros razonables
            if (cuotaActual > 0 && cuotasTotal > 0 && cuotaActual <= cuotasTotal && cuotasTotal <= 60) {
                return {
                    cuotaActual,
                    cuotasTotal,
                    esCuotaMes: cuotaActual === 1
                };
            }
        }
    }

    // No se detectaron cuotas - es una compra spot
    return {
        cuotaActual: null,
        cuotasTotal: null,
        esCuotaMes: false
    };
}

/**
 * Normaliza el nombre del comercio usando patrones conocidos
 * @param {string} descripcion - Descripci√≥n original
 * @returns {string} Nombre normalizado del comercio
 */
window.normalizarComercio = function(descripcion) {
    if (!descripcion) return 'Sin descripci√≥n';

    const descripcionOriginal = descripcion.trim();
    let comercio = descripcionOriginal;

    // PRIMERO: Buscar en comercios aprendidos usando descripci√≥n ORIGINAL (antes de limpiar)
    const comerciosAprendidos = obtenerComerciosAprendidos();

    // Probar con la descripci√≥n original en min√∫sculas
    const descripcionOriginalLower = descripcionOriginal.toLowerCase();
    if (comerciosAprendidos[descripcionOriginalLower]) {
        console.log(`üéØ Aplicando comercio aprendido: "${descripcionOriginal}" ‚Üí "${comerciosAprendidos[descripcionOriginalLower]}"`);
        return comerciosAprendidos[descripcionOriginalLower];
    }

    // Remover informaci√≥n de cuotas del nombre
    comercio = comercio.replace(/\s*\d+\s*\/\s*\d+\s*$/i, '');
    comercio = comercio.replace(/\s*\d+\s+de\s+\d+\s*$/i, '');
    comercio = comercio.replace(/\s*cuota\s+\d+.*$/i, '');

    // Convertir a min√∫sculas para comparaci√≥n
    const comercioLower = comercio.toLowerCase();

    // Tambi√©n probar con la descripci√≥n limpia (sin cuotas)
    if (comerciosAprendidos[comercioLower]) {
        console.log(`üéØ Aplicando comercio aprendido (limpio): "${comercio}" ‚Üí "${comerciosAprendidos[comercioLower]}"`);
        return comerciosAprendidos[comercioLower];
    }

    // Buscar en normalizaciones conocidas
    for (const [patron, nombreEstandar] of Object.entries(COMMERCE_NORMALIZATIONS)) {
        if (comercioLower.includes(patron.toLowerCase())) {
            return nombreEstandar;
        }
    }

    // Capitalizar primera letra de cada palabra
    return comercio
        .split(' ')
        .map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1).toLowerCase())
        .join(' ');
}

/**
 * Obtiene el diccionario de comercios aprendidos desde localStorage
 * @returns {Object} Diccionario { comercioOriginal: comercioNormalizado }
 */
window.obtenerComerciosAprendidos = function() {
    const stored = localStorage.getItem('comerciosAprendidos');
    return stored ? JSON.parse(stored) : {};
}

/**
 * Guarda un comercio aprendido
 * @param {string} comercioOriginal - Nombre original del comercio (descripci√≥n del CSV)
 * @param {string} comercioNormalizado - Nombre normalizado/editado
 */
window.guardarComercioAprendido = function(comercioOriginal, comercioNormalizado) {
    const comercios = obtenerComerciosAprendidos();
    const clave = comercioOriginal.toLowerCase().trim();
    comercios[clave] = comercioNormalizado;
    localStorage.setItem('comerciosAprendidos', JSON.stringify(comercios));
    console.log(`üíæ Comercio guardado para aprendizaje: "${clave}" ‚Üí "${comercioNormalizado}"`);
}

/**
 * Guarda una descripci√≥n aprendida para cuotas
 * @param {string} claveCompra - Clave √∫nica de la compra (comercio + total cuotas)
 * @param {string} descripcionPersonalizada - Descripci√≥n personalizada
 */
window.guardarDescripcionAprendida = function(claveCompra, descripcionPersonalizada) {
    const descripciones = obtenerDescripcionesAprendidas();
    const clave = claveCompra.toLowerCase().trim();
    descripciones[clave] = descripcionPersonalizada;
    localStorage.setItem('descripcionesAprendidas', JSON.stringify(descripciones));
    console.log(`üíæ Descripci√≥n guardada para aprendizaje: "${clave}" ‚Üí "${descripcionPersonalizada}"`);
}

/**
 * Obtiene el diccionario de descripciones aprendidas desde localStorage
 * @returns {Object} Diccionario { claveCompra: descripcionPersonalizada }
 */
window.obtenerDescripcionesAprendidas = function() {
    const stored = localStorage.getItem('descripcionesAprendidas');
    return stored ? JSON.parse(stored) : {};
}

/**
 * Valida el formato del CSV antes de procesar
 * @param {File} file - Archivo CSV
 * @returns {Promise<Object>} { valido, error, preview }
 */
window.validarCSV = async function(file) {
    return new Promise((resolve) => {
        Papa.parse(file, {
            delimiter: ';',
            header: true,
            preview: 5, // Solo las primeras 5 filas
            skipEmptyLines: true,
            complete: (results) => {
                const headers = results.meta.fields || [];
                const data = results.data;

                // Verificar que tenga headers
                if (headers.length === 0) {
                    resolve({
                        valido: false,
                        error: 'El archivo no tiene encabezados v√°lidos',
                        preview: null
                    });
                    return;
                }

                // Verificar que tenga al menos 3 columnas (fecha, descripci√≥n, monto)
                if (headers.length < 3) {
                    resolve({
                        valido: false,
                        error: 'El archivo debe tener al menos 3 columnas: Fecha, Descripci√≥n y Monto',
                        preview: null
                    });
                    return;
                }

                // Verificar que tenga datos
                if (data.length === 0) {
                    resolve({
                        valido: false,
                        error: 'El archivo no contiene datos',
                        preview: null
                    });
                    return;
                }

                resolve({
                    valido: true,
                    error: null,
                    preview: data
                });
            },
            error: (error) => {
                resolve({
                    valido: false,
                    error: `Error al leer el archivo: ${error.message}`,
                    preview: null
                });
            }
        });
    });
}

    </script>

    <script>
        // Sistema de categorizaci√≥n inteligente con aprendizaje

/**
 * Categoriza autom√°ticamente una transacci√≥n
 * @param {string} descripcion - Descripci√≥n de la transacci√≥n
 * @param {string} comercio - Nombre normalizado del comercio
 * @returns {string} ID de la categor√≠a sugerida
 */
window.categorizarTransaccion = function(descripcion, comercio) {
    const texto = `${descripcion} ${comercio}`.toLowerCase();

    // 1. Buscar en categorizaciones aprendidas (match exacto por nombre)
    const categoriasAprendidas = obtenerCategoriasAprendidas();

    if (categoriasAprendidas[comercio]) {
        return categoriasAprendidas[comercio];
    }

    // 2. Buscar en patrones predefinidos
    for (const [categoria, patrones] of Object.entries(CATEGORY_PATTERNS)) {
        for (const patron of patrones) {
            if (texto.includes(patron.toLowerCase())) {
                return categoria;
            }
        }
    }

    // 3. Si no se encuentra, retornar "otros"
    return 'otros';
}

/**
 * Categoriza m√∫ltiples transacciones de forma batch
 * @param {Array} transacciones - Array de transacciones sin categor√≠a
 * @returns {Array} Array de transacciones con categor√≠a asignada
 */
window.categorizarLote = function(transacciones) {
    return transacciones.map(t => ({
        ...t,
        categoria: categorizarTransaccion(t.descripcion, t.comercio)
    }));
}

/**
 * Registra una correcci√≥n manual de categor√≠a para aprendizaje
 * @param {string} comercio - Nombre exacto del comercio (sin normalizaci√≥n)
 * @param {string} categoriaId - ID de la categor√≠a correcta
 */
window.aprenderCategorizacion = function(comercio, categoriaId) {
    const categorias = obtenerCategoriasAprendidas();
    categorias[comercio] = categoriaId; // Guardar con nombre exacto
    localStorage.setItem('categoriasAprendidas', JSON.stringify(categorias));
    console.log(`‚úÖ Aprendido: "${comercio}" ‚Üí ${categoriaId}`);
}

/**
 * Obtiene el diccionario de categor√≠as aprendidas
 * @returns {Object} Diccionario { comercio: categoriaId }
 */
window.obtenerCategoriasAprendidas = function() {
    const stored = localStorage.getItem('categoriasAprendidas');
    return stored ? JSON.parse(stored) : {};
}

/**
 * Limpia el cach√© de categor√≠as aprendidas
 */
window.limpiarCategoriasAprendidas = function() {
    localStorage.removeItem('categoriasAprendidas');
}

/**
 * Obtiene estad√≠sticas de categorizaci√≥n
 * @returns {Object} { totalAprendidas, categoriasMasAprendidas }
 */
window.obtenerEstadisticasCategorizacion = function() {
    const categorias = obtenerCategoriasAprendidas();
    const conteo = {};

    for (const categoriaId of Object.values(categorias)) {
        conteo[categoriaId] = (conteo[categoriaId] || 0) + 1;
    }

    const categoriasMasAprendidas = Object.entries(conteo)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([id, cantidad]) => ({ id, cantidad }));

    return {
        totalAprendidas: Object.keys(categorias).length,
        categoriasMasAprendidas
    };
}

/**
 * Sugerir categor√≠a basada en coincidencias parciales
 * @param {string} texto - Texto a buscar
 * @param {number} limite - Cantidad m√°xima de sugerencias
 * @returns {Array} Array de { categoria, confianza }
 */
window.sugerirCategorias = function(texto, limite = 3) {
    const textoLower = texto.toLowerCase();
    const sugerencias = [];

    // Buscar en patrones predefinidos
    for (const [categoria, patrones] of Object.entries(CATEGORY_PATTERNS)) {
        let coincidencias = 0;

        for (const patron of patrones) {
            if (textoLower.includes(patron.toLowerCase())) {
                coincidencias++;
            }
        }

        if (coincidencias > 0) {
            const confianza = Math.min((coincidencias / patrones.length) * 100, 100);
            sugerencias.push({ categoria, confianza });
        }
    }

    // Ordenar por confianza y retornar top N
    return sugerencias
        .sort((a, b) => b.confianza - a.confianza)
        .slice(0, limite);
}

/**
 * Exportar categor√≠as aprendidas como JSON
 * @returns {string} JSON string de las categor√≠as
 */
window.exportarCategoriasAprendidas = function() {
    const categorias = obtenerCategoriasAprendidas();
    return JSON.stringify(categorias, null, 2);
}

/**
 * Importar categor√≠as aprendidas desde JSON
 * @param {string} jsonString - JSON string con categor√≠as
 * @returns {boolean} True si se import√≥ exitosamente
 */
window.importarCategoriasAprendidas = function(jsonString) {
    try {
        const categorias = JSON.parse(jsonString);
        localStorage.setItem('categoriasAprendidas', JSON.stringify(categorias));
        return true;
    } catch (error) {
        console.error('Error al importar categor√≠as:', error);
        return false;
    }
}

    </script>

    <script>
        // Calculadora de presupuestos y an√°lisis de gastos

/**
 * Calcula el gasto por categor√≠a para un conjunto de transacciones
 * @param {Array} transacciones - Array de transacciones
 * @returns {Object} Diccionario { categoriaId: montoTotal }
 */
window.calcularGastosPorCategoria = function(transacciones) {
    const gastos = {};

    for (const t of transacciones) {
        const categoria = t.categoria || 'otros';
        gastos[categoria] = (gastos[categoria] || 0) + t.monto;
    }

    return gastos;
}

/**
 * Calcula el estado del presupuesto por categor√≠a
 * @param {Array} transacciones - Array de transacciones del mes
 * @param {Array} presupuestos - Array de presupuestos { categoria, monto }
 * @returns {Array} Array de { categoria, gastado, presupuesto, porcentaje, estado }
 */
window.calcularEstadoPresupuestos = function(transacciones, presupuestos) {
    const gastosPorCategoria = calcularGastosPorCategoria(transacciones);
    const estados = [];

    for (const presupuesto of presupuestos) {
        const gastado = gastosPorCategoria[presupuesto.categoria] || 0;
        const porcentaje = calcularPorcentaje(gastado, presupuesto.monto);
        const estado = getEstadoPresupuesto(porcentaje);

        estados.push({
            categoria: presupuesto.categoria,
            gastado,
            presupuesto: presupuesto.monto,
            disponible: presupuesto.monto - gastado,
            porcentaje,
            estado
        });
    }

    return estados;
}

/**
 * Determina el estado de un presupuesto seg√∫n el porcentaje
 * @param {number} porcentaje - Porcentaje de uso
 * @returns {string} "ok", "alerta", "critico"
 */
window.getEstadoPresupuesto = function(porcentaje) {
    if (porcentaje < 70) return 'ok';
    if (porcentaje < 90) return 'alerta';
    return 'critico';
}

/**
 * Obtiene las categor√≠as en riesgo (>70% del presupuesto)
 * @param {Array} estadosPresupuestos - Array de estados de presupuestos
 * @returns {Array} Array de categor√≠as en riesgo
 */
window.getCategoriasEnRiesgo = function(estadosPresupuestos) {
    return estadosPresupuestos
        .filter(e => e.estado === 'alerta' || e.estado === 'critico')
        .sort((a, b) => b.porcentaje - a.porcentaje);
}

/**
 * Calcula la salud financiera general del mes
 * @param {Array} estadosPresupuestos - Array de estados de presupuestos
 * @returns {Object} { puntuacion, nivel, mensaje }
 */
window.calcularSaludFinanciera = function(estadosPresupuestos) {
    if (estadosPresupuestos.length === 0) {
        return {
            puntuacion: 100,
            nivel: 'excelente',
            mensaje: 'No hay datos suficientes para evaluar'
        };
    }

    // Calcular puntuaci√≥n basada en estados
    let puntos = 0;
    let total = estadosPresupuestos.length;

    for (const estado of estadosPresupuestos) {
        if (estado.estado === 'ok') puntos += 100;
        else if (estado.estado === 'alerta') puntos += 50;
        else puntos += 0; // cr√≠tico
    }

    const puntuacion = Math.round(puntos / total);

    // Determinar nivel
    let nivel, mensaje;
    if (puntuacion >= 80) {
        nivel = 'excelente';
        mensaje = '¬°Excelente control de gastos!';
    } else if (puntuacion >= 60) {
        nivel = 'bueno';
        mensaje = 'Buen manejo, pero hay margen de mejora';
    } else if (puntuacion >= 40) {
        nivel = 'regular';
        mensaje = 'Atenci√≥n: varias categor√≠as cerca del l√≠mite';
    } else {
        nivel = 'critico';
        mensaje = '¬°Alerta! M√∫ltiples presupuestos superados';
    }

    return { puntuacion, nivel, mensaje };
}

/**
 * Calcula el desglose de gastos: spot, cuotas mes, cuotas anteriores
 * @param {Array} transacciones - Array de transacciones
 * @returns {Object} { spot, cuotasMes, cuotasAnteriores, total }
 *
 * Definici√≥n de gastos spot:
 * - Sin cuotas (cuotaActual = null)
 * - O pago del mes 1/1 (cuotaActual = 1 y cuotasTotal = 1)
 */
window.calcularDesglose = function(transacciones) {
    let spot = 0;
    let cuotasMes = 0;
    let cuotasAnteriores = 0;

    for (const t of transacciones) {
        if (!t.cuotaActual || (t.cuotaActual === 1 && t.cuotasTotal === 1)) {
            // Compra spot: sin cuotas O pago del mes (1/1)
            spot += t.monto;
        } else if (t.cuotaActual === 1) {
            // Primera cuota de una compra en cuotas (1/2, 1/3, etc.)
            cuotasMes += t.monto;
        } else {
            // Cuota de compra anterior (2/12, 3/12, etc.)
            cuotasAnteriores += t.monto;
        }
    }

    return {
        spot,
        cuotasMes,
        cuotasAnteriores,
        total: spot + cuotasMes + cuotasAnteriores
    };
}

/**
 * Obtiene el top N de gastos
 * @param {Array} transacciones - Array de transacciones
 * @param {number} limite - Cantidad m√°xima de resultados
 * @returns {Array} Array de transacciones ordenadas por monto
 */
window.getTopGastos = function(transacciones, limite = 5) {
    return [...transacciones]
        .sort((a, b) => b.monto - a.monto)
        .slice(0, limite);
}

/**
 * Calcula estad√≠sticas del mes
 * @param {Array} transacciones - Array de transacciones
 * @returns {Object} Estad√≠sticas variadas
 */
window.calcularEstadisticasMes = function(transacciones) {
    if (transacciones.length === 0) {
        return {
            total: 0,
            promedio: 0,
            mediana: 0,
            minimo: 0,
            maximo: 0,
            cantidadTransacciones: 0
        };
    }

    const montos = transacciones.map(t => t.monto).sort((a, b) => a - b);
    const total = montos.reduce((sum, m) => sum + m, 0);

    return {
        total,
        promedio: total / montos.length,
        mediana: montos[Math.floor(montos.length / 2)],
        minimo: montos[0],
        maximo: montos[montos.length - 1],
        cantidadTransacciones: transacciones.length
    };
}

/**
 * Compara el mes actual con el promedio de meses anteriores
 * @param {number} totalMesActual - Total del mes actual
 * @param {Array} totalesMesesAnteriores - Array de totales de meses anteriores
 * @returns {Object} { promedioAnterior, diferencia, porcentajeDiferencia, mejor }
 */
window.compararConPromedio = function(totalMesActual, totalesMesesAnteriores) {
    if (totalesMesesAnteriores.length === 0) {
        return {
            promedioAnterior: 0,
            diferencia: 0,
            porcentajeDiferencia: 0,
            mejor: false
        };
    }

    const promedioAnterior = totalesMesesAnteriores.reduce((sum, t) => sum + t, 0) / totalesMesesAnteriores.length;
    const diferencia = totalMesActual - promedioAnterior;
    const porcentajeDiferencia = promedioAnterior > 0
        ? Math.round((diferencia / promedioAnterior) * 100)
        : 0;

    return {
        promedioAnterior,
        diferencia,
        porcentajeDiferencia,
        mejor: diferencia < 0 // Gastar menos es mejor
    };
}

/**
 * Calcula gastos por perfil
 * @param {Array} transacciones - Array de transacciones
 * @returns {Object} Diccionario { perfilId: monto }
 */
window.calcularGastosPorPerfil = function(transacciones) {
    const gastos = {};

    for (const t of transacciones) {
        const perfilId = t.perfilId || 1;
        gastos[perfilId] = (gastos[perfilId] || 0) + t.monto;
    }

    return gastos;
}

/**
 * Calcula gastos por d√≠a del mes
 * @param {Array} transacciones - Array de transacciones
 * @returns {Object} Diccionario { dia: monto }
 */
window.calcularGastosPorDia = function(transacciones) {
    const gastos = {};

    for (const t of transacciones) {
        const dia = new Date(t.fecha).getDate();
        gastos[dia] = (gastos[dia] || 0) + t.monto;
    }

    return gastos;
}

/**
 * Detecta patrones de gasto (d√≠as de m√°s consumo, comercios frecuentes, etc.)
 * @param {Array} transacciones - Array de transacciones
 * @returns {Object} Patrones detectados
 */
window.detectarPatrones = function(transacciones) {
    // Comercios m√°s frecuentes
    const comerciosFrecuencia = {};
    for (const t of transacciones) {
        comerciosFrecuencia[t.comercio] = (comerciosFrecuencia[t.comercio] || 0) + 1;
    }
    const topComerciosFrecuentes = Object.entries(comerciosFrecuencia)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([comercio, cantidad]) => ({ comercio, cantidad }));

    // D√≠a de la semana con m√°s gastos
    const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
    const gastosPorDiaSemana = {};
    for (const t of transacciones) {
        const diaSemana = new Date(t.fecha).getDay();
        gastosPorDiaSemana[diasSemana[diaSemana]] = (gastosPorDiaSemana[diasSemana[diaSemana]] || 0) + t.monto;
    }
    const diaMasGasto = Object.entries(gastosPorDiaSemana)
        .sort((a, b) => b[1] - a[1])[0];

    return {
        topComerciosFrecuentes,
        diaMasGasto: diaMasGasto ? { dia: diaMasGasto[0], monto: diaMasGasto[1] } : null
    };
}

/**
 * Calcula el disponible para gastar considerando presupuesto, gastos y cuotas futuras
 * @param {Array} transacciones - Array de transacciones del mes
 * @param {Array} presupuestos - Array de presupuestos
 * @param {Array} cuotasActivas - Array de cuotas activas que seguir√°n pag√°ndose
 * @returns {Object} { disponibleTotal, disponiblePorCategoria, presupuestoTotal, gastadoTotal, cuotasProyectadas }
 */
window.calcularDisponible = function(transacciones, presupuestos, cuotasActivas = []) {
    // Calcular presupuesto total
    const presupuestoTotal = presupuestos.reduce((sum, p) => sum + p.monto, 0);

    // Calcular gastado total
    const gastadoTotal = transacciones.reduce((sum, t) => sum + t.monto, 0);

    // Calcular cuotas proyectadas (cuotas activas que seguir√°n pag√°ndose este mes)
    // Solo contamos las cuotas que a√∫n no han sido pagadas
    const cuotasProyectadas = cuotasActivas.reduce((sum, c) => {
        // Solo contar si hay cuotas restantes
        return sum + (c.cuotasRestantes > 0 ? c.montoCuota : 0);
    }, 0);

    // Calcular disponible total
    const disponibleTotal = presupuestoTotal - gastadoTotal - cuotasProyectadas;

    // Calcular disponible por categor√≠a
    const gastosPorCategoria = calcularGastosPorCategoria(transacciones);
    const cuotasPorCategoria = {};

    // Agrupar cuotas por categor√≠a
    for (const cuota of cuotasActivas) {
        if (cuota.cuotasRestantes > 0) {
            const categoria = cuota.categoria || 'otros';
            cuotasPorCategoria[categoria] = (cuotasPorCategoria[categoria] || 0) + cuota.montoCuota;
        }
    }

    const disponiblePorCategoria = [];

    for (const presupuesto of presupuestos) {
        const gastado = gastosPorCategoria[presupuesto.categoria] || 0;
        const cuotasProyectadasCat = cuotasPorCategoria[presupuesto.categoria] || 0;
        const disponible = presupuesto.monto - gastado - cuotasProyectadasCat;

        disponiblePorCategoria.push({
            categoria: presupuesto.categoria,
            presupuesto: presupuesto.monto,
            gastado,
            cuotasProyectadas: cuotasProyectadasCat,
            disponible,
            porcentajeUsado: calcularPorcentaje(gastado + cuotasProyectadasCat, presupuesto.monto)
        });
    }

    return {
        disponibleTotal,
        presupuestoTotal,
        gastadoTotal,
        cuotasProyectadas,
        disponiblePorCategoria: disponiblePorCategoria.sort((a, b) => b.disponible - a.disponible)
    };
}

/**
 * Calcula el balance de gastos compartidos entre dos perfiles
 * @param {Array} transacciones - Array de transacciones
 * @param {number} perfilId1 - ID del primer perfil
 * @param {number} perfilId2 - ID del segundo perfil (opcional, si null usa el primero encontrado)
 * @returns {Object} Balance compartido con totales y saldo neto
 */
window.calcularBalanceCompartido = function(transacciones, perfilId1, perfilId2 = null) {
    // Filtrar solo transacciones compartidas
    const compartidas = transacciones.filter(t => t.esCompartido);

    if (compartidas.length === 0) {
        return {
            transaccionesCompartidas: [],
            totalPerfil1: 0,
            totalPerfil2: 0,
            saldoNeto: 0,
            quienDebe: null,
            quienRecibe: null,
            cantidadTransacciones: 0
        };
    }

    let totalPerfil1 = 0;
    let totalPerfil2 = 0;
    const transaccionesCompartidas = [];

    for (const t of compartidas) {
        // Calcular cu√°nto corresponde a cada perfil
        const porcentaje1 = t.porcentajePerfil || 50;
        const porcentaje2 = 100 - porcentaje1;
        
        const montoPerfil1 = (t.monto * porcentaje1) / 100;
        const montoPerfil2 = (t.monto * porcentaje2) / 100;

        // Si la transacci√≥n fue pagada por perfil1
        if (t.perfilId === perfilId1) {
            totalPerfil1 += t.monto; // Pag√≥ todo
        } 
        // Si la transacci√≥n fue pagada por perfil2
        else if (perfilId2 && t.perfilId === perfilId2) {
            totalPerfil2 += t.monto; // Pag√≥ todo
        }
        // Si es compartida con otro perfil espec√≠fico
        else if (t.perfilCompartidoId) {
            if (t.perfilCompartidoId === perfilId1) {
                totalPerfil2 += t.monto;
            } else if (perfilId2 && t.perfilCompartidoId === perfilId2) {
                totalPerfil1 += t.monto;
            }
        }

        transaccionesCompartidas.push({
            ...t,
            montoPerfil1,
            montoPerfil2,
            porcentaje1,
            porcentaje2
        });
    }

    // Calcular lo que cada uno debe pagar seg√∫n porcentajes
    const debiaPagarPerfil1 = transaccionesCompartidas.reduce((sum, t) => sum + t.montoPerfil1, 0);
    const debiaPagarPerfil2 = transaccionesCompartidas.reduce((sum, t) => sum + t.montoPerfil2, 0);

    // Calcular saldo neto
    const saldoNeto = Math.abs(totalPerfil1 - debiaPagarPerfil1 - (totalPerfil2 - debiaPagarPerfil2));
    
    // Determinar qui√©n debe a qui√©n
    let quienDebe = null;
    let quienRecibe = null;
    
    if ((totalPerfil1 - debiaPagarPerfil1) > (totalPerfil2 - debiaPagarPerfil2)) {
        // Perfil 1 pag√≥ m√°s de lo que deb√≠a
        quienRecibe = perfilId1;
        quienDebe = perfilId2;
    } else if ((totalPerfil1 - debiaPagarPerfil1) < (totalPerfil2 - debiaPagarPerfil2)) {
        // Perfil 2 pag√≥ m√°s de lo que deb√≠a
        quienRecibe = perfilId2;
        quienDebe = perfilId1;
    }

    return {
        transaccionesCompartidas,
        totalPagadoPerfil1: totalPerfil1,
        totalPagadoPerfil2: totalPerfil2,
        debiaPagarPerfil1,
        debiaPagarPerfil2,
        saldoNeto: Math.round(saldoNeto),
        quienDebe,
        quienRecibe,
        cantidadTransacciones: compartidas.length
    };
}

    </script>

    <script>
        // Proyecciones de cuotas futuras y simulaci√≥n de compras

/**
 * Calcula las cuotas activas que seguir√°n pag√°ndose en el futuro
 * @param {Array} transacciones - Todas las transacciones hist√≥ricas
 * @param {string} mesActual - Mes actual en formato YYYY-MM
 * @returns {Array} Array de cuotas activas con proyecci√≥n
 */
window.calcularCuotasActivas = function(transacciones, mesActual) {
    const cuotasActivas = [];

    // Filtrar transacciones con cuotas
    const transaccionesConCuotas = transacciones.filter(t =>
        t.cuotaActual && t.cuotasTotal && t.cuotaActual <= t.cuotasTotal
    );

    // Agrupar por comercio + descripci√≥n + monto (para identificar la misma compra)
    const comprasAgrupadas = {};

    for (const t of transaccionesConCuotas) {
        const key = `${t.comercio}-${t.monto}-${t.cuotasTotal}`;

        if (!comprasAgrupadas[key]) {
            comprasAgrupadas[key] = {
                comercio: t.comercio,
                descripcion: t.descripcion,
                montoCuota: t.monto,
                montoTotal: t.monto * t.cuotasTotal,
                cuotaActual: t.cuotaActual,
                cuotasTotal: t.cuotasTotal,
                cuotasRestantes: t.cuotasTotal - t.cuotaActual,
                fechaPrimeraCuota: t.fecha,
                categoria: t.categoria,
                perfilId: t.perfilId
            };
        } else {
            // Si encontramos otra cuota de la misma compra, actualizar info
            if (t.cuotaActual > comprasAgrupadas[key].cuotaActual) {
                comprasAgrupadas[key].cuotaActual = t.cuotaActual;
                comprasAgrupadas[key].cuotasRestantes = t.cuotasTotal - t.cuotaActual;
            }
        }
    }

    // Convertir a array y filtrar las que a√∫n tienen cuotas pendientes
    for (const compra of Object.values(comprasAgrupadas)) {
        if (compra.cuotasRestantes > 0) {
            cuotasActivas.push(compra);
        }
    }

    return cuotasActivas.sort((a, b) => b.montoCuota - a.montoCuota);
}

/**
 * Proyecta los gastos de los pr√≥ximos N meses
 * @param {Array} cuotasActivas - Array de cuotas activas
 * @param {Array} recurrentes - Array de transacciones recurrentes
 * @param {Array} comprasPlaneadas - Array de compras planeadas
 * @param {string} mesInicio - Mes de inicio en formato YYYY-MM
 * @param {number} meses - Cantidad de meses a proyectar
 * @returns {Array} Array de proyecciones por mes
 */
async function proyectarGastosFuturos(cuotasActivas, recurrentes, comprasPlaneadas, mesInicio, meses = 12) {
    const proyecciones = [];
    const mesesArray = generarMesesAdelante(meses, mesInicio);

    for (let i = 0; i < meses; i++) {
        const mes = mesesArray[i];
        let totalCuotas = 0;
        let totalRecurrentes = 0;
        let totalComprasPlaneadas = 0;

        // Calcular cuotas activas para este mes
        for (const cuota of cuotasActivas) {
            if (i < cuota.cuotasRestantes) {
                totalCuotas += cuota.montoCuota;
            }
        }

        // Calcular recurrentes
        for (const rec of recurrentes) {
            if (rec.activa) {
                // Usar el monto estimado o el promedio del historial
                const historial = await getHistorialRecurrente(rec.id, 6);
                const monto = historial.length > 0
                    ? historial.reduce((sum, h) => sum + h.monto, 0) / historial.length
                    : rec.montoEstimado;

                totalRecurrentes += monto;
            }
        }

        // Calcular compras planeadas (solo para meses donde apliquen)
        for (const compra of comprasPlaneadas) {
            if (i === 0) {
                // En el primer mes, agregar todas las cuotas planeadas
                totalComprasPlaneadas += compra.monto / compra.cuotas;
            } else if (i < compra.cuotas) {
                totalComprasPlaneadas += compra.monto / compra.cuotas;
            }
        }

        proyecciones.push({
            mes,
            mesNombre: getNombreMes(mes),
            cuotas: totalCuotas,
            recurrentes: totalRecurrentes,
            comprasPlaneadas: totalComprasPlaneadas,
            total: totalCuotas + totalRecurrentes + totalComprasPlaneadas
        });
    }

    return proyecciones;
}

/**
 * Simula el impacto de una nueva compra en cuotas
 * @param {number} montoTotal - Monto total de la compra
 * @param {number} cuotas - Cantidad de cuotas
 * @param {Array} proyeccionActual - Proyecci√≥n sin la nueva compra
 * @param {number} presupuestoMensual - Presupuesto mensual promedio
 * @returns {Object} An√°lisis de la simulaci√≥n
 */
window.simularNuevaCompra = function(montoTotal, cuotas, proyeccionActual, presupuestoMensual) {
    const montoCuota = montoTotal / cuotas;

    // Crear nueva proyecci√≥n con la compra
    const proyeccionConCompra = proyeccionActual.map((mes, i) => {
        if (i < cuotas) {
            return {
                ...mes,
                total: mes.total + montoCuota,
                nuevaCompra: montoCuota
            };
        }
        return {
            ...mes,
            nuevaCompra: 0
        };
    });

    // An√°lisis de impacto
    const mesesExcedidos = proyeccionConCompra.filter(m => m.total > presupuestoMensual).length;
    const excedenteMayor = Math.max(...proyeccionConCompra.map(m =>
        m.total > presupuestoMensual ? m.total - presupuestoMensual : 0
    ));

    // Recomendaci√≥n
    let recomendacion, nivelRiesgo;

    if (mesesExcedidos === 0) {
        recomendacion = 'Compra viable. No supera el presupuesto mensual.';
        nivelRiesgo = 'bajo';
    } else if (mesesExcedidos <= cuotas / 3) {
        recomendacion = 'Compra riesgosa. Algunos meses superar√°n el presupuesto.';
        nivelRiesgo = 'medio';
    } else {
        recomendacion = 'Compra no recomendada. Supera el presupuesto en la mayor√≠a de meses.';
        nivelRiesgo = 'alto';
    }

    return {
        proyeccionConCompra,
        montoCuota,
        mesesExcedidos,
        excedenteMayor,
        recomendacion,
        nivelRiesgo
    };
}

/**
 * Calcula el impacto de recurrentes pendientes
 * @param {Array} recurrentes - Array de recurrentes activas
 * @param {string} mesActual - Mes actual en formato YYYY-MM
 * @returns {Array} Array de recurrentes pendientes de pago
 */
async function calcularRecurrentesPendientes(recurrentes, mesActual) {
    const pendientes = [];

    for (const rec of recurrentes) {
        if (!rec.activa) continue;

        // Verificar si ya se pag√≥ este mes
        const historial = await db.historialRecurrentes
            .where('recurrenteId')
            .equals(rec.id)
            .toArray();

        const yaRegistrado = historial.some(h => h.mesAnio === mesActual);

        if (!yaRegistrado) {
            pendientes.push({
                ...rec,
                montoEstimado: rec.montoEstimado
            });
        }
    }

    return pendientes;
}

/**
 * Calcula tendencia hist√≥rica de gastos
 * @param {Array} mesesCargados - Array de meses con datos
 * @param {number} cantidadMeses - Cantidad de meses a analizar
 * @returns {Promise<Array>} Array de { mes, total, spot, cuotas, recurrentes }
 */
async function calcularTendenciaHistorica(mesesCargados, cantidadMeses = 6) {
    const tendencia = [];

    // Ordenar meses de m√°s reciente a m√°s antiguo
    const mesesOrdenados = [...mesesCargados]
        .sort((a, b) => b.mesAnio.localeCompare(a.mesAnio))
        .slice(0, cantidadMeses);

    for (const mes of mesesOrdenados) {
        const transacciones = await getTransaccionesByMes(mes.id);
        const desglose = calcularDesglose(transacciones);

        // Calcular recurrentes registradas para ese mes
        const historialRec = await db.historialRecurrentes
            .where('mesAnio')
            .equals(mes.mesAnio)
            .toArray();

        const totalRecurrentes = historialRec.reduce((sum, h) => sum + h.monto, 0);

        tendencia.push({
            mes: mes.mesAnio,
            mesNombre: getNombreMes(mes.mesAnio),
            total: desglose.total,
            spot: desglose.spot,
            cuotas: desglose.cuotasMes + desglose.cuotasAnteriores,
            recurrentes: totalRecurrentes
        });
    }

    // Invertir para mostrar de m√°s antiguo a m√°s reciente
    return tendencia.reverse();
}

/**
 * Predice gastos del pr√≥ximo mes bas√°ndose en historial
 * @param {Array} tendenciaHistorica - Array de tendencia hist√≥rica
 * @returns {Object} { prediccion, confianza, rango }
 */
window.predecirGastoProximoMes = function(tendenciaHistorica) {
    if (tendenciaHistorica.length === 0) {
        return {
            prediccion: 0,
            confianza: 0,
            rango: { min: 0, max: 0 }
        };
    }

    // Calcular promedio simple
    const totales = tendenciaHistorica.map(t => t.total);
    const promedio = totales.reduce((sum, t) => sum + t, 0) / totales.length;

    // Calcular desviaci√≥n est√°ndar
    const varianza = totales.reduce((sum, t) => sum + Math.pow(t - promedio, 2), 0) / totales.length;
    const desviacion = Math.sqrt(varianza);

    // Confianza: mayor con m√°s datos y menor desviaci√≥n
    const confianza = Math.min(
        (tendenciaHistorica.length / 6) * 100 * (1 - Math.min(desviacion / promedio, 1)),
        100
    );

    return {
        prediccion: Math.round(promedio),
        confianza: Math.round(confianza),
        rango: {
            min: Math.round(promedio - desviacion),
            max: Math.round(promedio + desviacion)
        }
    };
}

/**
 * Calcula el "costo de oportunidad" de una compra en cuotas vs ahorro
 * @param {number} montoTotal - Monto total de la compra
 * @param {number} cuotas - Cantidad de cuotas
 * @param {number} tasaInteres - Tasa de inter√©s anual del cr√©dito (%)
 * @param {number} tasaAhorro - Tasa de inter√©s anual de ahorro (%)
 * @returns {Object} An√°lisis del costo de oportunidad
 */
window.calcularCostoOportunidad = function(montoTotal, cuotas, tasaInteres = 0, tasaAhorro = 5) {
    const tasaMensualCredito = tasaInteres / 12 / 100;
    const tasaMensualAhorro = tasaAhorro / 12 / 100;

    // Calcular cuota con inter√©s (si aplica)
    let montoCuota;
    let totalPagado;

    if (tasaInteres > 0) {
        // F√≥rmula de cuota con inter√©s
        montoCuota = montoTotal * (tasaMensualCredito * Math.pow(1 + tasaMensualCredito, cuotas)) /
            (Math.pow(1 + tasaMensualCredito, cuotas) - 1);
        totalPagado = montoCuota * cuotas;
    } else {
        // Sin inter√©s
        montoCuota = montoTotal / cuotas;
        totalPagado = montoTotal;
    }

    // Calcular valor futuro si se ahorrara el dinero
    let valorFuturoAhorro = 0;
    for (let i = 0; i < cuotas; i++) {
        valorFuturoAhorro += montoCuota * Math.pow(1 + tasaMensualAhorro, cuotas - i);
    }

    const costoOportunidad = valorFuturoAhorro - totalPagado;

    return {
        montoCuota: Math.round(montoCuota),
        totalPagado: Math.round(totalPagado),
        interesesPagados: Math.round(totalPagado - montoTotal),
        valorFuturoAhorro: Math.round(valorFuturoAhorro),
        costoOportunidad: Math.round(costoOportunidad)
    };
}

    </script>

    <script>
        // Sistema de Reconciliaci√≥n Inteligente - Finzi v3.4
// Empareja transacciones manuales (provisionales) con transacciones del CSV

/**
 * Calcula la distancia de Levenshtein entre dos strings
 * Mide cu√°ntos cambios (inserci√≥n, eliminaci√≥n, sustituci√≥n) se necesitan
 * @param {string} a - Primer string
 * @param {string} b - Segundo string
 * @returns {number} - Distancia de Levenshtein
 */
function levenshteinDistance(a, b) {
    const matrix = [];

    // Normalizar strings: min√∫sculas y sin espacios extras
    const strA = a.toLowerCase().trim();
    const strB = b.toLowerCase().trim();

    // Inicializar primera columna
    for (let i = 0; i <= strB.length; i++) {
        matrix[i] = [i];
    }

    // Inicializar primera fila
    for (let j = 0; j <= strA.length; j++) {
        matrix[0][j] = j;
    }

    // Llenar la matriz
    for (let i = 1; i <= strB.length; i++) {
        for (let j = 1; j <= strA.length; j++) {
            if (strB.charAt(i - 1) === strA.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1, // sustituci√≥n
                    matrix[i][j - 1] + 1,     // inserci√≥n
                    matrix[i - 1][j] + 1      // eliminaci√≥n
                );
            }
        }
    }

    return matrix[strB.length][strA.length];
}

/**
 * Calcula la similitud entre dos strings (0-1)
 * @param {string} a - Primer string
 * @param {string} b - Segundo string
 * @returns {number} - Similitud de 0 a 1 (1 = id√©ntico)
 */
function similaridadStrings(a, b) {
    if (!a || !b) return 0;

    const distance = levenshteinDistance(a, b);
    const maxLength = Math.max(a.length, b.length);

    if (maxLength === 0) return 1;

    return 1 - (distance / maxLength);
}

/**
 * Normaliza un nombre de comercio para comparaci√≥n
 * Elimina sufijos comunes, normaliza espacios, etc.
 * @param {string} comercio - Nombre del comercio
 * @returns {string} - Comercio normalizado
 */
function normalizarComercio(comercio) {
    if (!comercio) return '';

    let normalizado = comercio.toLowerCase().trim();

    // Eliminar sufijos comunes de bancos
    const sufijos = [
        ' s.a.', ' sa', ' ltda', ' spa', ' chile',
        ' inc', ' corp', ' corporation', ' company',
        ' co.', ' co', ' store', ' tienda'
    ];

    for (const sufijo of sufijos) {
        if (normalizado.endsWith(sufijo)) {
            normalizado = normalizado.slice(0, -sufijo.length).trim();
        }
    }

    // Eliminar caracteres especiales excepto espacios
    normalizado = normalizado.replace(/[^a-z0-9\s]/g, '');

    // Normalizar espacios m√∫ltiples
    normalizado = normalizado.replace(/\s+/g, ' ');

    return normalizado;
}

/**
 * Calcula la diferencia de d√≠as entre dos fechas
 * @param {string} fecha1 - Fecha en formato YYYY-MM-DD
 * @param {string} fecha2 - Fecha en formato YYYY-MM-DD
 * @returns {number} - D√≠as de diferencia (absoluto)
 */
function diferenciaDias(fecha1, fecha2) {
    const d1 = new Date(fecha1);
    const d2 = new Date(fecha2);
    const diff = Math.abs(d1 - d2);
    return Math.floor(diff / (1000 * 60 * 60 * 24));
}

/**
 * Calcula un score de matching entre dos transacciones
 * @param {Object} manual - Transacci√≥n manual (provisional)
 * @param {Object} csv - Transacci√≥n del CSV
 * @returns {Object} - { score: number, detalles: object }
 */
window.calcularScoreMatching = function(manual, csv) {
    const detalles = {
        comercio: 0,
        monto: 0,
        fecha: 0
    };

    // 1. Similitud de COMERCIO (70% del peso)
    const comercioManualNorm = normalizarComercio(manual.comercio);
    const comercioCsvNorm = normalizarComercio(csv.comercio);
    const similitudComercio = similaridadStrings(comercioManualNorm, comercioCsvNorm);
    detalles.comercio = Math.round(similitudComercio * 70);

    // 2. Similitud de MONTO (25% del peso)
    // Consideramos match si la diferencia es menor al 5%
    const montoManual = manual.monto;
    const montoCsv = csv.monto;
    const diferenciaMonto = Math.abs(montoManual - montoCsv);
    const porcentajeDiferencia = (diferenciaMonto / montoManual) * 100;

    if (porcentajeDiferencia === 0) {
        detalles.monto = 25; // Monto exacto
    } else if (porcentajeDiferencia <= 5) {
        detalles.monto = 20; // Diferencia menor al 5%
    } else if (porcentajeDiferencia <= 10) {
        detalles.monto = 10; // Diferencia menor al 10%
    } else {
        detalles.monto = 0; // Diferencia mayor al 10%
    }

    // 3. Similitud de FECHA (5% del peso)
    // Ventana de ¬±5 d√≠as
    const diasDiferencia = diferenciaDias(manual.fecha, csv.fecha);

    if (diasDiferencia === 0) {
        detalles.fecha = 5; // Misma fecha
    } else if (diasDiferencia <= 2) {
        detalles.fecha = 4; // ¬±2 d√≠as
    } else if (diasDiferencia <= 5) {
        detalles.fecha = 2; // ¬±5 d√≠as
    } else {
        detalles.fecha = 0; // M√°s de 5 d√≠as
    }

    // Score total
    const scoreTotal = detalles.comercio + detalles.monto + detalles.fecha;

    return {
        score: scoreTotal,
        detalles: detalles,
        similitudComercio: similitudComercio
    };
};

/**
 * Encuentra matches entre transacciones manuales y del CSV
 * @param {Array} manuales - Transacciones manuales (provisionales)
 * @param {Array} csvs - Transacciones del CSV reci√©n cargado
 * @returns {Object} - { autoMatches, suggestedMatches, noMatches }
 */
window.encontrarMatches = function(manuales, csvs) {
    const autoMatches = []; // Score >= 85
    const suggestedMatches = []; // 70 <= Score < 85
    const noMatches = []; // Score < 70

    // Crear copia de arrays para ir eliminando matches
    const manualesRestantes = [...manuales];
    const csvsRestantes = [...csvs];

    // Para cada transacci√≥n manual, buscar el mejor match en CSV
    for (const manual of manualesRestantes) {
        let mejorMatch = null;
        let mejorScore = 0;
        let mejorIndice = -1;

        for (let i = 0; i < csvsRestantes.length; i++) {
            const csv = csvsRestantes[i];
            const resultado = window.calcularScoreMatching(manual, csv);

            if (resultado.score > mejorScore) {
                mejorScore = resultado.score;
                mejorMatch = csv;
                mejorIndice = i;
            }
        }

        // Clasificar seg√∫n score
        if (mejorScore >= 85) {
            autoMatches.push({
                manual: manual,
                csv: mejorMatch,
                score: mejorScore
            });
            // Eliminar del pool de CSV para evitar matches duplicados
            csvsRestantes.splice(mejorIndice, 1);
        } else if (mejorScore >= 70) {
            suggestedMatches.push({
                manual: manual,
                csv: mejorMatch,
                score: mejorScore
            });
            // No eliminar a√∫n, puede haber otro mejor match
        } else {
            noMatches.push({
                manual: manual,
                score: mejorScore
            });
        }
    }

    return {
        autoMatches: autoMatches,
        suggestedMatches: suggestedMatches,
        noMatches: noMatches,
        csvsSinMatch: csvsRestantes
    };
};

/**
 * Fusiona una transacci√≥n manual con una del CSV
 * La transacci√≥n del CSV es la "fuente de verdad", pero se preservan metadatos del manual
 * @param {Object} manual - Transacci√≥n manual
 * @param {Object} csv - Transacci√≥n del CSV
 * @returns {Object} - Transacci√≥n fusionada
 */
window.fusionarTransacciones = async function(manual, csv) {
    // La transacci√≥n del CSV es la fuente de verdad para datos b√°sicos
    const fusionada = {
        ...csv,
        estado: 'confirmado',
        origen: 'csv',

        // Preservar metadatos del manual si existen
        textoOriginal: manual.textoOriginal || null,
        transaccionRelacionadaId: manual.id, // Referencia al manual original

        // Si el manual ten√≠a categorizaci√≥n manual diferente, preservarla
        categoriaManual: manual.categoria !== csv.categoria ? manual.categoria : null
    };

    // Actualizar la transacci√≥n del CSV con los datos fusionados
    await db.transacciones.update(csv.id, fusionada);

    // Eliminar la transacci√≥n manual (ya qued√≥ fusionada)
    await db.transacciones.delete(manual.id);

    return fusionada;
};

/**
 * Marca una transacci√≥n manual como "sin emparejar" (ej: pago en efectivo)
 * @param {Object} manual - Transacci√≥n manual
 * @param {string} motivo - Motivo por el cual no se empareja
 */
window.marcarSinEmparejar = async function(manual, motivo = 'No facturado') {
    await db.transacciones.update(manual.id, {
        estado: 'confirmado', // Ya no es provisional
        origen: 'manual',
        descripcion: manual.descripcion ? `${manual.descripcion} (${motivo})` : motivo
    });
};

/**
 * Ejecuta la reconciliaci√≥n autom√°tica completa
 * @param {string} mesAnio - Mes en formato YYYY-MM
 * @returns {Object} - Resultado de la reconciliaci√≥n
 */
window.ejecutarReconciliacion = async function(mesAnio) {
    // 1. Obtener transacciones manuales provisionales de este mes
    const todasManuales = await db.transacciones
        .where('origen')
        .equals('manual')
        .and(t => t.estado === 'provisional')
        .toArray();

    // Filtrar por mes
    const manuales = todasManuales.filter(t => {
        const fechaMes = t.fecha.substring(0, 7); // YYYY-MM
        return fechaMes === mesAnio;
    });

    // 2. Obtener transacciones del CSV reci√©n cargado
    const mesAnioObj = await db.mesesCarga.where('mesAnio').equals(mesAnio).first();
    if (!mesAnioObj) {
        return { error: 'Mes no encontrado' };
    }

    // WORKAROUND: Usar .filter() manual en lugar de √≠ndice
    const todas = await db.transacciones.toArray();
    const csvs = todas.filter(t => t.mesAnioId === mesAnioObj.id && t.origen === 'csv');

    // 3. Encontrar matches
    const resultado = window.encontrarMatches(manuales, csvs);

    return {
        ...resultado,
        totalManuales: manuales.length,
        totalCsvs: csvs.length
    };
};

    </script>

    <script>
        // Parser de PDF para Estados de Cuenta - Finzi v3.5
// Extrae texto de PDFs y parsea transacciones por banco

/**
 * Extrae todo el texto de un archivo PDF
 * @param {File} file - Archivo PDF
 * @returns {Promise<string>} - Texto completo del PDF
 */
window.extractTextFromPDF = async function(file) {
    try {
        // Convertir archivo a ArrayBuffer
        const arrayBuffer = await file.arrayBuffer();

        // Cargar el PDF con PDF.js
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        let fullText = '';

        // Iterar por todas las p√°ginas
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const textContent = await page.getTextContent();

            // Extraer texto de cada item
            const pageText = textContent.items
                .map(item => item.str)
                .join(' ');

            fullText += pageText + '\n';
        }

        return fullText;
    } catch (error) {
        console.error('Error al extraer texto del PDF:', error);
        throw new Error('No se pudo leer el PDF. Aseg√∫rate de que sea un PDF v√°lido con texto seleccionable.');
    }
};

/**
 * Detecta autom√°ticamente el banco basado en el contenido del PDF
 * @param {string} texto - Texto completo del PDF
 * @returns {string|null} - ID del banco detectado o null
 */
window.detectarBanco = function(texto) {
    const textoLower = texto.toLowerCase();

    // Patrones de detecci√≥n por banco
    const patrones = {
        'santander': ['banco santander', 'santander chile', 'www.santander.cl'],
        'bci': ['banco bci', 'bci.cl', 'banco de cr√©dito'],
        'chile': ['banco de chile', 'bancochile.cl', 'banco chile', 'edwards', 'banco edwards'],
        'estado': ['bancoestado', 'banco estado', 'estado.cl'],
        'scotiabank': ['scotiabank', 'scotia', 'scotiabank.cl'],
        'itau': ['ita√∫', 'itau', 'banco ita√∫'],
        'security': ['banco security', 'security.cl'],
        'falabella': ['banco falabella', 'cmr falabella', 'falabella.com'],
        'ripley': ['banco ripley', 'tarjeta ripley', 'ripley.cl']
    };

    for (const [banco, keywords] of Object.entries(patrones)) {
        for (const keyword of keywords) {
            if (textoLower.includes(keyword)) {
                return banco;
            }
        }
    }

    return null;
};

/**
 * Normaliza un monto de texto a n√∫mero
 * Maneja formatos: $1.234.567, 1234567, $1,234,567
 * @param {string} montoStr - Monto como string
 * @returns {number} - Monto como n√∫mero
 */
function normalizarMonto(montoStr) {
    if (!montoStr) return 0;

    // Eliminar s√≠mbolos de moneda y espacios
    let cleaned = montoStr.replace(/[$\s]/g, '');

    // Detectar si usa punto o coma como separador decimal
    // En Chile normalmente es: 1.234.567 (punto para miles)
    // Eliminar puntos de miles
    cleaned = cleaned.replace(/\./g, '');

    // Si tiene coma, es el decimal (reemplazar por punto)
    cleaned = cleaned.replace(/,/g, '.');

    const numero = parseFloat(cleaned);
    return isNaN(numero) ? 0 : Math.abs(numero);
}

/**
 * Normaliza una fecha de texto a formato YYYY-MM-DD
 * Maneja formatos: DD/MM/YYYY, DD-MM-YYYY, DD.MM.YYYY
 * @param {string} fechaStr - Fecha como string
 * @param {number} anio - A√±o por defecto si no viene en la fecha
 * @returns {string} - Fecha en formato YYYY-MM-DD
 */
function normalizarFecha(fechaStr, anio = new Date().getFullYear()) {
    if (!fechaStr) return new Date().toISOString().split('T')[0];

    // Patrones de fecha: DD/MM/YYYY, DD-MM-YYYY, DD.MM.YYYY, DD/MM
    const patterns = [
        /(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/,  // DD/MM/YYYY
        /(\d{1,2})[\/\-\.](\d{1,2})$/                 // DD/MM
    ];

    for (const pattern of patterns) {
        const match = fechaStr.match(pattern);
        if (match) {
            const dia = match[1].padStart(2, '0');
            const mes = match[2].padStart(2, '0');
            const year = match[3] || anio;
            return `${year}-${mes}-${dia}`;
        }
    }

    return new Date().toISOString().split('T')[0];
}

// =============================================================================
// PARSERS ESPEC√çFICOS POR BANCO
// =============================================================================

/**
 * Parser gen√©rico - intenta detectar patrones comunes
 * Formato esperado: FECHA DESCRIPCION MONTO
 */
window.parsearBancoGenerico = function(texto, mesAnio) {
    const transacciones = [];

    // Separar por l√≠neas
    const lineas = texto.split('\n');

    // Patr√≥n gen√©rico: buscar l√≠neas con fecha y monto
    // Ejemplo: "05/11/2024 MERCADONA CHILE $45.000"
    const patron = /(\d{1,2}[\/\-\.]\d{1,2}(?:[\/\-\.]\d{4})?)\s+(.+?)\s+([\$\d\.,]+)/g;

    for (const linea of lineas) {
        const matches = [...linea.matchAll(patron)];

        for (const match of matches) {
            const fecha = normalizarFecha(match[1], parseInt(mesAnio.split('-')[0]));
            const descripcion = match[2].trim();
            const monto = normalizarMonto(match[3]);

            if (monto > 0 && descripcion.length > 2) {
                transacciones.push({
                    fecha: fecha,
                    descripcion: descripcion,
                    comercio: descripcion.substring(0, 50), // Tomar primeros 50 chars como comercio
                    monto: monto
                });
            }
        }
    }

    return transacciones;
};

/**
 * Parser para Banco Santander
 * Personaliza seg√∫n el formato espec√≠fico del PDF de Santander
 */
window.parsearBancoSantander = function(texto, mesAnio) {
    console.log('Usando parser de Santander');
    // Por ahora usa el gen√©rico, se personalizar√° cuando tengamos un ejemplo real
    return window.parsearBancoGenerico(texto, mesAnio);
};

/**
 * Parser para Banco BCI
 * Formato tabular: LUGAR FECHA CODIGO DESCRIPCION LUGAR $ MONTO $ MONTO CUOTA $ MONTO
 * Ejemplo: SANTIAGO 17/09/25 2209 14634522 PAYU *UBER EATS SANTIAGO $33.944 $33.944 01/01 $33.944
 */
window.parsearBancoBCI = function(texto, mesAnio) {
    console.log('Usando parser espec√≠fico de BCI');
    const transacciones = [];
    const lineas = texto.split('\n');

    // Patr√≥n para BCI: fecha DD/MM/YY, dos c√≥digos, descripci√≥n completa hasta el primer $
    // Ejemplo: SANTIAGO 17/09/25 2209 14634522 PAYU *UBER EATS SANTIAGO $33.944 $33.944 01/01 $33.944
    const patron = /(\d{2}\/\d{2}\/\d{2,4})\s+\d+\s+\d+\s+(.+?)\s+\$\s*([\d\.]+)/gi;

    for (const linea of lineas) {
        // Saltar l√≠neas de encabezado, totales y secciones especiales
        const lineaLower = linea.toLowerCase();
        if (lineaLower.includes('fecha') ||
            lineaLower.includes('total ') ||
            lineaLower.includes('subtotal') ||
            lineaLower.includes('saldo ') ||
            lineaLower.includes('cupo ') ||
            lineaLower.includes('per√≠odo') ||
            lineaLower.includes('monto facturado') ||
            lineaLower.includes('monto cancelado') ||
            lineaLower.includes('tasa int')) {
            continue;
        }

        const matches = [...linea.matchAll(patron)];

        for (const match of matches) {
            let fechaStr = match[1];
            let descripcion = match[2].trim();
            const monto = normalizarMonto(match[3]);

            // Convertir fecha DD/MM/YY a DD/MM/YYYY
            if (fechaStr.length === 8) { // DD/MM/YY
                const partes = fechaStr.split('/');
                const anio = parseInt(partes[2]);
                const anioCompleto = anio >= 0 && anio <= 50 ? 2000 + anio : 1900 + anio;
                fechaStr = `${partes[0]}/${partes[1]}/${anioCompleto}`;
            }

            const fecha = normalizarFecha(fechaStr, parseInt(mesAnio.split('-')[0]));

            // Limpiar descripci√≥n: puede tener ubicaci√≥n al final
            descripcion = descripcion.replace(/\s+(SANTIAGO|LAS CONDES|LA SERENA|PROVIDENCIA|CHILE|VITACURA|LA REINA)$/i, '');

            // Filtrar transacciones que no son gastos (solo montos positivos)
            if (monto > 0 && descripcion.length > 3 && !descripcion.match(/^[\d\s]+$/)) {
                transacciones.push({
                    fecha: fecha,
                    descripcion: descripcion,
                    comercio: descripcion.substring(0, 50),
                    monto: monto
                });
            }
        }
    }

    console.log(`Parser BCI encontr√≥ ${transacciones.length} transacciones`);

    // Si no encontr√≥ nada con el patr√≥n espec√≠fico, usar gen√©rico como fallback
    if (transacciones.length === 0) {
        console.log('Parser espec√≠fico de BCI no encontr√≥ transacciones, usando gen√©rico');
        return window.parsearBancoGenerico(texto, mesAnio);
    }

    return transacciones;
};

/**
 * Parser para Banco de Chile / Edwards
 * Formato tabular: LUGAR FECHA CODIGO DESCRIPCION LUGAR $ MONTO $ MONTO CUOTA $ MONTO
 * Ejemplo: SANTIAGO 20/08/25 210834426118 PAYU *UBER TRIP SANTIAGO $ 7.102 $ 7.102 01/01 $ 7.102
 */
window.parsearBancoChile = function(texto, mesAnio) {
    console.log('Usando parser espec√≠fico de Banco de Chile/Edwards');
    const transacciones = [];
    const lineas = texto.split('\n');

    // Patr√≥n para Edwards: fecha DD/MM/YY, c√≥digo, descripci√≥n completa hasta el primer $
    // Ejemplo: SANTIAGO 20/08/25 210834426118 PAYU *UBER TRIP SANTIAGO $ 7.102 $ 7.102 01/01 $ 7.102
    const patron = /(\d{2}\/\d{2}\/\d{2,4})\s+\d+\s+(.+?)\s+\$\s*([\-\d\.]+)/gi;

    for (const linea of lineas) {
        // Saltar l√≠neas de encabezado, totales y secciones especiales
        const lineaLower = linea.toLowerCase();
        if (lineaLower.includes('fecha') ||
            lineaLower.includes('total ') ||
            lineaLower.includes('subtotal') ||
            lineaLower.includes('saldo ') ||
            lineaLower.includes('cupo ') ||
            lineaLower.includes('per√≠odo') ||
            lineaLower.includes('monto facturado') ||
            lineaLower.includes('impuesto') ||
            lineaLower.includes('comision') ||
            lineaLower.includes('intereses') ||
            lineaLower.includes('traspaso deuda') ||
            lineaLower.includes('tasa int')) {
            continue;
        }

        const matches = [...linea.matchAll(patron)];

        for (const match of matches) {
            let fechaStr = match[1];
            let descripcion = match[2].trim();
            const monto = normalizarMonto(match[3]);

            // Convertir fecha DD/MM/YY a DD/MM/YYYY
            if (fechaStr.length === 8) { // DD/MM/YY
                const partes = fechaStr.split('/');
                const anio = parseInt(partes[2]);
                const anioCompleto = anio >= 0 && anio <= 50 ? 2000 + anio : 1900 + anio;
                fechaStr = `${partes[0]}/${partes[1]}/${anioCompleto}`;
            }

            const fecha = normalizarFecha(fechaStr, parseInt(mesAnio.split('-')[0]));

            // Limpiar descripci√≥n: puede tener ubicaci√≥n al final (SANTIAGO, LAS CONDES, etc)
            // Remover palabras de ubicaci√≥n comunes al final
            descripcion = descripcion.replace(/\s+(SANTIAGO|LAS CONDES|PROVIDENCIA|CHILE|VITACURA|LA REINA)$/i, '');

            // Filtrar transacciones que no son gastos (solo queremos montos positivos)
            // y que tengan una descripci√≥n v√°lida
            if (monto > 0 && descripcion.length > 3 && !descripcion.match(/^[\d\s]+$/)) {
                transacciones.push({
                    fecha: fecha,
                    descripcion: descripcion,
                    comercio: descripcion.substring(0, 50),
                    monto: monto
                });
            }
        }
    }

    console.log(`Parser Edwards encontr√≥ ${transacciones.length} transacciones`);

    // Si no encontr√≥ nada con el patr√≥n espec√≠fico, usar gen√©rico como fallback
    if (transacciones.length === 0) {
        console.log('Parser espec√≠fico de Banco Chile/Edwards no encontr√≥ transacciones, usando gen√©rico');
        return window.parsearBancoGenerico(texto, mesAnio);
    }

    return transacciones;
};

/**
 * Parser para Banco Estado
 * Personaliza seg√∫n el formato espec√≠fico del PDF de Banco Estado
 */
window.parsearBancoEstado = function(texto, mesAnio) {
    console.log('Usando parser de Banco Estado');
    return window.parsearBancoGenerico(texto, mesAnio);
};

/**
 * Parser para Scotiabank
 */
window.parsearBancoScotiabank = function(texto, mesAnio) {
    console.log('Usando parser de Scotiabank');
    return window.parsearBancoGenerico(texto, mesAnio);
};

/**
 * Parser para Banco Falabella (CMR)
 */
window.parsearBancoFalabella = function(texto, mesAnio) {
    console.log('Usando parser de Falabella');
    return window.parsearBancoGenerico(texto, mesAnio);
};

/**
 * Parser para Banco Ripley
 */
window.parsearBancoRipley = function(texto, mesAnio) {
    console.log('Usando parser de Ripley');
    return window.parsearBancoGenerico(texto, mesAnio);
};

/**
 * Funci√≥n principal para parsear PDF seg√∫n el banco
 * @param {File} file - Archivo PDF
 * @param {string} bancoId - ID del banco (o null para auto-detectar)
 * @param {string} mesAnio - Mes en formato YYYY-MM
 * @returns {Promise<Object>} - { transacciones, bancoDetectado }
 */
window.parsearPDF = async function(file, bancoId, mesAnio) {
    try {
        // 1. Extraer texto del PDF
        const texto = await window.extractTextFromPDF(file);

        if (!texto || texto.trim().length < 100) {
            throw new Error('El PDF parece estar vac√≠o o no tiene texto extra√≠ble. Intenta con un PDF diferente o usa el CSV.');
        }

        // 2. Detectar banco si no se especific√≥
        const bancoDetectado = bancoId || window.detectarBanco(texto);

        if (!bancoDetectado) {
            console.warn('No se pudo detectar el banco autom√°ticamente, usando parser gen√©rico');
        }

        // 3. Seleccionar parser seg√∫n el banco
        const parsers = {
            'santander': window.parsearBancoSantander,
            'bci': window.parsearBancoBCI,
            'chile': window.parsearBancoChile,
            'estado': window.parsearBancoEstado,
            'scotiabank': window.parsearBancoScotiabank,
            'falabella': window.parsearBancoFalabella,
            'ripley': window.parsearBancoRipley
        };

        const parser = parsers[bancoDetectado] || window.parsearBancoGenerico;

        // 4. Parsear transacciones
        const transacciones = parser(texto, mesAnio);

        if (transacciones.length === 0) {
            throw new Error('No se encontraron transacciones en el PDF. Verifica que el formato sea correcto o usa el CSV.');
        }

        return {
            transacciones: transacciones,
            bancoDetectado: bancoDetectado,
            totalTransacciones: transacciones.length
        };

    } catch (error) {
        console.error('Error al parsear PDF:', error);
        throw error;
    }
};

/**
 * Validar que un archivo sea un PDF v√°lido
 * @param {File} file - Archivo a validar
 * @returns {Promise<Object>} - { valido: boolean, error: string }
 */
window.validarPDF = async function(file) {
    if (!file) {
        return { valido: false, error: 'No se seleccion√≥ ning√∫n archivo' };
    }

    if (file.type !== 'application/pdf') {
        return { valido: false, error: 'El archivo debe ser un PDF' };
    }

    if (file.size > 10 * 1024 * 1024) { // 10 MB
        return { valido: false, error: 'El archivo es demasiado grande (m√°ximo 10 MB)' };
    }

    try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        if (pdf.numPages === 0) {
            return { valido: false, error: 'El PDF no tiene p√°ginas' };
        }

        return { valido: true };
    } catch (error) {
        return { valido: false, error: 'El archivo PDF est√° corrupto o no es v√°lido' };
    }
};

    </script>

    <!-- FIREBASE (v3.3) -->
    <script>
        /**
 * Configuraci√≥n de Firebase para Finzi v3.3
 *
 * INSTRUCCIONES:
 * 1. Ve a Firebase Console: https://console.firebase.google.com/
 * 2. Selecciona tu proyecto
 * 3. Ve a Configuraci√≥n del proyecto (√≠cono engranaje)
 * 4. Scroll down hasta "Tus apps" ‚Üí selecciona la app web
 * 5. Copia el objeto firebaseConfig
 * 6. Reemplaza los valores abajo con los tuyos
 */

// ‚ö†Ô∏è CONFIGURACI√ìN REAL - Tus credenciales de Firebase
window.FIREBASE_CONFIG = {
    apiKey: "AIzaSyBFzZleam4NK9XqQQ8rYS4Sb8Nhxa9xhFo",
    authDomain: "finzi-bbdbc.firebaseapp.com",
    projectId: "finzi-bbdbc",
    storageBucket: "finzi-bbdbc.firebasestorage.app",
    messagingSenderId: "1068955823447",
    appId: "1:1068955823447:web:16968a73375fbf027fa212"
};

// ‚ö†Ô∏è USUARIOS AUTORIZADOS - Agrega los emails que pueden acceder
window.AUTHORIZED_EMAILS = [
    "diegoarancibiamaturana@gmail.com",        // ‚Üê CAMBIAR por tu email
    "marcelaayestas@gmail.com"     // ‚Üê CAMBIAR por email de tu esposa
];

// Flag para habilitar/deshabilitar Firebase
// true = usar Firebase (sincronizaci√≥n en la nube)
// false = usar IndexedDB local (como antes)
window.USE_FIREBASE = true;

/**
 * Configuraci√≥n de Firestore
 */
window.FIRESTORE_SETTINGS = {
    // Habilitar persistencia offline
    enablePersistence: true,

    // Sincronizaci√≥n en tiempo real
    realtime: true,

    // Logs de debug (solo desarrollo)
    debug: false
};

    </script>

    <script>
        /**
 * Inicializaci√≥n y utilidades de Firebase
 * Finzi v3.3
 */

// Variables globales de Firebase
window.firebaseApp = null;
window.firebaseAuth = null;
window.firestore = null;
window.currentUser = null;

/**
 * Inicializar Firebase
 */
window.initializeFirebase = async function() {
    try {
        console.log('üî• Inicializando Firebase...');

        // Verificar que Firebase est√© cargado
        if (typeof firebase === 'undefined') {
            throw new Error('Firebase SDK no cargado');
        }

        // Verificar configuraci√≥n
        if (!window.FIREBASE_CONFIG || !window.FIREBASE_CONFIG.apiKey) {
            throw new Error('Configuraci√≥n de Firebase no encontrada. Edita src/utils/firebase-config.js');
        }

        // Inicializar App
        window.firebaseApp = firebase.initializeApp(window.FIREBASE_CONFIG);
        console.log('‚úÖ Firebase App inicializada');

        // Inicializar Auth con persistencia LOCAL (m√°s compatible con m√≥viles)
        window.firebaseAuth = firebase.auth();

        // Configurar persistencia LOCAL para compatibilidad m√≥vil
        try {
            await window.firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
            console.log('‚úÖ Firebase Auth inicializada con persistencia LOCAL');
        } catch (err) {
            console.warn('‚ö†Ô∏è No se pudo configurar persistencia, usando por defecto:', err);
        }

        // Inicializar Firestore
        window.firestore = firebase.firestore();

        // Habilitar persistencia offline
        if (window.FIRESTORE_SETTINGS.enablePersistence) {
            try {
                await window.firestore.enablePersistence({
                    synchronizeTabs: true
                });
                console.log('‚úÖ Persistencia offline habilitada');
            } catch (err) {
                if (err.code === 'failed-precondition') {
                    console.warn('‚ö†Ô∏è Persistencia: m√∫ltiples pesta√±as abiertas');
                } else if (err.code === 'unimplemented') {
                    console.warn('‚ö†Ô∏è Persistencia no soportada en este navegador');
                } else {
                    console.warn('‚ö†Ô∏è Error en persistencia:', err);
                }
            }
        }

        console.log('‚úÖ Firestore inicializada');

        // Observer de autenticaci√≥n
        window.firebaseAuth.onAuthStateChanged((user) => {
            window.currentUser = user;

            if (user) {
                console.log('üë§ Usuario autenticado:', user.email);

                // Verificar si est√° autorizado
                if (!window.isAuthorizedUser(user.email)) {
                    console.error('‚ùå Usuario no autorizado:', user.email);
                    window.firebaseAuth.signOut();
                    alert('Tu cuenta no est√° autorizada para usar esta aplicaci√≥n.');
                    return;
                }

                // Disparar evento personalizado
                console.log('üîî Disparando evento firebaseUserChanged (autenticado)');
                window.dispatchEvent(new CustomEvent('firebaseUserChanged', {
                    detail: { user, isAuthenticated: true }
                }));
            } else {
                console.log('üë§ Usuario no autenticado');
                window.dispatchEvent(new CustomEvent('firebaseUserChanged', {
                    detail: { user: null, isAuthenticated: false }
                }));
            }
        });

        return true;
    } catch (error) {
        console.error('‚ùå Error al inicializar Firebase:', error);
        throw error;
    }
};

/**
 * Verificar si un email est√° autorizado
 */
window.isAuthorizedUser = function(email) {
    if (!email) return false;
    return window.AUTHORIZED_EMAILS.includes(email.toLowerCase());
};

/**
 * Login con Google
 */
window.loginWithGoogle = async function() {
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        const result = await window.firebaseAuth.signInWithPopup(provider);
        const user = result.user;

        console.log('‚úÖ Login exitoso:', user.email);

        // Verificar autorizaci√≥n
        if (!window.isAuthorizedUser(user.email)) {
            await window.firebaseAuth.signOut();
            throw new Error('Usuario no autorizado');
        }

        return user;
    } catch (error) {
        console.error('‚ùå Error en login:', error);

        if (error.code === 'auth/popup-closed-by-user') {
            throw new Error('Login cancelado');
        } else if (error.code === 'auth/popup-blocked') {
            throw new Error('Popup bloqueado. Habilita popups para este sitio.');
        } else {
            throw error;
        }
    }
};

/**
 * Logout
 */
window.logoutFirebase = async function() {
    try {
        await window.firebaseAuth.signOut();
        console.log('‚úÖ Logout exitoso');
        window.currentUser = null;
    } catch (error) {
        console.error('‚ùå Error en logout:', error);
        throw error;
    }
};

/**
 * Obtener usuario actual
 */
window.getCurrentUser = function() {
    return window.currentUser;
};

/**
 * Verificar si est√° autenticado
 */
window.isAuthenticated = function() {
    return window.currentUser !== null;
};

/**
 * Esperar a que el usuario est√© autenticado
 */
window.waitForAuth = function() {
    return new Promise((resolve) => {
        if (window.currentUser) {
            resolve(window.currentUser);
        } else {
            const unsubscribe = window.firebaseAuth.onAuthStateChanged((user) => {
                unsubscribe();
                resolve(user);
            });
        }
    });
};

/**
 * Helper: obtener referencia a colecci√≥n de usuario
 */
window.getUserCollection = function(collectionName) {
    if (!window.currentUser) {
        throw new Error('Usuario no autenticado');
    }

    // Estructura: gastos/{userId}/{collectionName}
    return window.firestore
        .collection('gastos')
        .doc(window.currentUser.uid)
        .collection(collectionName);
};

/**
 * Helper: obtener documento de usuario
 */
window.getUserDoc = function() {
    if (!window.currentUser) {
        throw new Error('Usuario no autenticado');
    }

    return window.firestore
        .collection('users')
        .doc(window.currentUser.uid);
};

console.log('‚úÖ firebase.js cargado');

    </script>

    <script>
        /**
 * Capa de Abstracci√≥n de Datos - Finzi v3.3
 *
 * Permite usar IndexedDB (local) o Firebase (nube) de forma transparente
 * Cambiando window.USE_FIREBASE puedes alternar entre ambos
 */

/**
 * TRANSACCIONES
 */

// Agregar transacci√≥n
window.addTransaccion = async function(transaccion) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await addTransaccionFirebase(transaccion);
    } else {
        return await addTransaccionIndexedDB(transaccion);
    }
};

async function addTransaccionIndexedDB(transaccion) {
    return await db.transacciones.add(transaccion);
}

async function addTransaccionFirebase(transaccion) {
    const col = window.getUserCollection('transacciones');
    const docRef = await col.add({
        ...transaccion,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return docRef.id;
}

// Obtener transacciones por mes
window.getTransaccionesByMes = async function(mesAnioId) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await getTransaccionesByMesFirebase(mesAnioId);
    } else {
        return await getTransaccionesByMesIndexedDB(mesAnioId);
    }
};

async function getTransaccionesByMesIndexedDB(mesAnioId) {
    // WORKAROUND: Usar .filter() manual en lugar de √≠ndice
    const todas = await db.transacciones.toArray();
    return todas.filter(t => t.mesAnioId === mesAnioId);
}

async function getTransaccionesByMesFirebase(mesAnioId) {
    const col = window.getUserCollection('transacciones');
    const snapshot = await col
        .where('mesAnioId', '==', mesAnioId)
        .get();

    return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }));
}

// Actualizar transacci√≥n
window.updateTransaccion = async function(id, cambios) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await updateTransaccionFirebase(id, cambios);
    } else {
        return await updateTransaccionIndexedDB(id, cambios);
    }
};

async function updateTransaccionIndexedDB(id, cambios) {
    return await db.transacciones.update(id, cambios);
}

async function updateTransaccionFirebase(id, cambios) {
    const col = window.getUserCollection('transacciones');
    await col.doc(id).update({
        ...cambios,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return 1; // N√∫mero de registros actualizados
}

// Eliminar transacci√≥n
window.deleteTransaccion = async function(id) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await deleteTransaccionFirebase(id);
    } else {
        return await deleteTransaccionIndexedDB(id);
    }
};

async function deleteTransaccionIndexedDB(id) {
    return await db.transacciones.delete(id);
}

async function deleteTransaccionFirebase(id) {
    const col = window.getUserCollection('transacciones');
    await col.doc(id).delete();
}

/**
 * MESES CARGA
 */

// Agregar mes
window.addMesCarga = async function(mes) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await addMesCargaFirebase(mes);
    } else {
        return await addMesCargaIndexedDB(mes);
    }
};

async function addMesCargaIndexedDB(mes) {
    return await db.mesesCarga.add(mes);
}

async function addMesCargaFirebase(mes) {
    const col = window.getUserCollection('mesesCarga');
    const docRef = await col.add({
        ...mes,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return docRef.id;
}

// Obtener todos los meses
window.getMesesCarga = async function() {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await getMesesCargaFirebase();
    } else {
        return await getMesesCargaIndexedDB();
    }
};

async function getMesesCargaIndexedDB() {
    return await db.mesesCarga.toArray();
}

async function getMesesCargaFirebase() {
    const col = window.getUserCollection('mesesCarga');
    const snapshot = await col
        .orderBy('fechaCarga', 'desc')
        .get();

    return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }));
}

// Eliminar mes
window.deleteMesCarga = async function(id) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await deleteMesCargaFirebase(id);
    } else {
        return await deleteMesCargaIndexedDB(id);
    }
};

async function deleteMesCargaIndexedDB(id) {
    // WORKAROUND: Usar .filter() manual para encontrar y eliminar
    const transacciones = await db.transacciones.toArray();
    const idsTransacciones = transacciones.filter(t => t.mesAnioId === id).map(t => t.id);
    await db.transacciones.bulkDelete(idsTransacciones);

    const presupuestos = await db.presupuestos.toArray();
    const idsPresupuestos = presupuestos.filter(p => p.mesAnioId === id).map(p => p.id);
    await db.presupuestos.bulkDelete(idsPresupuestos);

    // Eliminar el mes
    return await db.mesesCarga.delete(id);
}

async function deleteMesCargaFirebase(id) {
    // Firebase: eliminar transacciones asociadas
    const transCol = window.getUserCollection('transacciones');
    const transSnapshot = await transCol.where('mesAnioId', '==', id).get();

    const batch = window.firestore.batch();
    transSnapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
    });

    // Eliminar presupuestos asociados
    const presupCol = window.getUserCollection('presupuestos');
    const presupSnapshot = await presupCol.where('mesAnioId', '==', id).get();
    presupSnapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
    });

    // Eliminar el mes
    const mesDoc = window.getUserCollection('mesesCarga').doc(id);
    batch.delete(mesDoc);

    await batch.commit();
}

/**
 * PRESUPUESTOS
 */

// Agregar presupuesto
window.addPresupuesto = async function(presupuesto) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await addPresupuestoFirebase(presupuesto);
    } else {
        return await addPresupuestoIndexedDB(presupuesto);
    }
};

async function addPresupuestoIndexedDB(presupuesto) {
    return await db.presupuestos.add(presupuesto);
}

async function addPresupuestoFirebase(presupuesto) {
    const col = window.getUserCollection('presupuestos');
    const docRef = await col.add({
        ...presupuesto,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return docRef.id;
}

// Obtener presupuestos de un mes
window.getPresupuestosByMes = async function(mesAnioId) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await getPresupuestosByMesFirebase(mesAnioId);
    } else {
        return await getPresupuestosByMesIndexedDB(mesAnioId);
    }
};

async function getPresupuestosByMesIndexedDB(mesAnioId) {
    // WORKAROUND: Usar .filter() manual en lugar de √≠ndice
    const todos = await db.presupuestos.toArray();
    return todos.filter(p => p.mesAnioId === mesAnioId);
}

async function getPresupuestosByMesFirebase(mesAnioId) {
    const col = window.getUserCollection('presupuestos');
    const snapshot = await col
        .where('mesAnioId', '==', mesAnioId)
        .get();

    return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }));
}

// Obtener plantillas de presupuesto
window.getPresupuestosPlantilla = async function() {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await getPresupuestosPlantillaFirebase();
    } else {
        return await getPresupuestosPlantillaIndexedDB();
    }
};

async function getPresupuestosPlantillaIndexedDB() {
    return await db.presupuestos
        .where('esPlantilla')
        .equals(true)
        .toArray();
}

async function getPresupuestosPlantillaFirebase() {
    const col = window.getUserCollection('presupuestos');
    const snapshot = await col
        .where('esPlantilla', '==', true)
        .get();

    return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }));
}

// Actualizar presupuesto
window.updatePresupuesto = async function(id, cambios) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await updatePresupuestoFirebase(id, cambios);
    } else {
        return await updatePresupuestoIndexedDB(id, cambios);
    }
};

async function updatePresupuestoIndexedDB(id, cambios) {
    return await db.presupuestos.update(id, cambios);
}

async function updatePresupuestoFirebase(id, cambios) {
    const col = window.getUserCollection('presupuestos');
    await col.doc(id).update({
        ...cambios,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return 1;
}

// Eliminar presupuesto
window.deletePresupuesto = async function(id) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await deletePresupuestoFirebase(id);
    } else {
        return await deletePresupuestoIndexedDB(id);
    }
};

async function deletePresupuestoIndexedDB(id) {
    return await db.presupuestos.delete(id);
}

async function deletePresupuestoFirebase(id) {
    const col = window.getUserCollection('presupuestos');
    await col.doc(id).delete();
}

/**
 * INGRESOS
 */

// Agregar ingreso
window.addIngreso = async function(ingreso) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await addIngresoFirebase(ingreso);
    } else {
        return await addIngresoIndexedDB(ingreso);
    }
};

async function addIngresoIndexedDB(ingreso) {
    return await db.ingresos.add(ingreso);
}

async function addIngresoFirebase(ingreso) {
    const col = window.getUserCollection('ingresos');
    const docRef = await col.add({
        ...ingreso,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return docRef.id;
}

// Obtener ingresos de un mes
window.getIngresosByMes = async function(mesAnio) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await getIngresosByMesFirebase(mesAnio);
    } else {
        return await getIngresosByMesIndexedDB(mesAnio);
    }
};

async function getIngresosByMesIndexedDB(mesAnio) {
    return await db.ingresos
        .where('mesAnio')
        .equals(mesAnio)
        .toArray();
}

async function getIngresosByMesFirebase(mesAnio) {
    const col = window.getUserCollection('ingresos');
    const snapshot = await col
        .where('mesAnio', '==', mesAnio)
        .get();

    return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }));
}

// Eliminar ingreso
window.deleteIngreso = async function(id) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await deleteIngresoFirebase(id);
    } else {
        return await deleteIngresoIndexedDB(id);
    }
};

async function deleteIngresoIndexedDB(id) {
    return await db.ingresos.delete(id);
}

async function deleteIngresoFirebase(id) {
    const col = window.getUserCollection('ingresos');
    await col.doc(id).delete();
}

/**
 * REEMBOLSOS
 */

// Agregar reembolso
window.addReembolso = async function(reembolso) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await addReembolsoFirebase(reembolso);
    } else {
        return await addReembolsoIndexedDB(reembolso);
    }
};

async function addReembolsoIndexedDB(reembolso) {
    const id = await db.reembolsos.add({
        ...reembolso,
        fechaCreacion: new Date().toISOString()
    });

    await db.transacciones.update(reembolso.transaccionOrigenId, {
        esReembolsable: true,
        reembolsoId: id
    });

    return id;
}

async function addReembolsoFirebase(reembolso) {
    const col = window.getUserCollection('reembolsos');
    const docRef = await col.add({
        ...reembolso,
        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Actualizar transacci√≥n
    const transCol = window.getUserCollection('transacciones');
    await transCol.doc(reembolso.transaccionOrigenId).update({
        esReembolsable: true,
        reembolsoId: docRef.id
    });

    return docRef.id;
}

// Obtener todos los reembolsos
window.getReembolsos = async function() {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await getReembolsosFirebase();
    } else {
        return await getReembolsosIndexedDB();
    }
};

async function getReembolsosIndexedDB() {
    return await db.reembolsos.toArray();
}

async function getReembolsosFirebase() {
    const col = window.getUserCollection('reembolsos');
    const snapshot = await col
        .orderBy('fechaCreacion', 'desc')
        .get();

    return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }));
}

// Actualizar estado de reembolso
window.updateReembolso = async function(id, cambios) {
    if (window.USE_FIREBASE && window.isAuthenticated()) {
        return await updateReembolsoFirebase(id, cambios);
    } else {
        return await updateReembolsoIndexedDB(id, cambios);
    }
};

async function updateReembolsoIndexedDB(id, cambios) {
    return await db.reembolsos.update(id, cambios);
}

async function updateReembolsoFirebase(id, cambios) {
    const col = window.getUserCollection('reembolsos');
    await col.doc(id).update({
        ...cambios,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return 1;
}

console.log('‚úÖ dataLayer.js cargado');

    </script>

    <!-- SHARED COMPONENTS -->
    <script type="text/babel">
        // Componente Modal reutilizable - Dise√±o Minimalista

const Modal = memo(({ isOpen, onClose, title, children, size = 'md', showCloseButton = true }) => {
    useEffect(() => {
        // Manejar tecla ESC para cerrar
        const handleEsc = (e) => {
            if (e.key === 'Escape' && isOpen) {
                onClose();
            }
        };

        if (isOpen) {
            document.addEventListener('keydown', handleEsc);
            // Prevenir scroll del body
            document.body.style.overflow = 'hidden';
        }

        return () => {
            document.removeEventListener('keydown', handleEsc);
            document.body.style.overflow = 'unset';
        };
    }, [isOpen, onClose]);

    if (!isOpen) return null;

    const sizeClasses = {
        sm: 'max-w-[95vw] sm:max-w-md',
        md: 'max-w-[95vw] sm:max-w-2xl',
        lg: 'max-w-[95vw] sm:max-w-4xl',
        xl: 'max-w-[95vw] sm:max-w-6xl',
        full: 'max-w-full mx-2 sm:mx-4'
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-1 sm:p-4 animate-slideIn bg-black bg-opacity-50 dark:bg-opacity-70">
            <div
                className={`bg-white dark:bg-slate-800 rounded-lg sm:rounded-2xl ${sizeClasses[size]} w-full max-h-[98vh] sm:max-h-[90vh] overflow-hidden flex flex-col border border-gray-200 dark:border-slate-700 shadow-minimal-lg`}
                onClick={(e) => e.stopPropagation()}
            >
                {/* Header minimalista - responsive */}
                <div className="flex items-center justify-between p-3 sm:p-6 border-b border-gray-200 dark:border-slate-700 flex-shrink-0">
                    <h2 className="text-base sm:text-2xl font-bold text-gray-900 dark:text-white truncate pr-2">
                        {title}
                    </h2>
                    {showCloseButton && (
                        <button
                            onClick={onClose}
                            className="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors p-1.5 sm:p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg flex-shrink-0"
                            aria-label="Cerrar modal"
                        >
                            <svg className="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    )}
                </div>

                {/* Content - responsive padding */}
                <div className="flex-1 overflow-y-auto p-3 sm:p-6">
                    {children}
                </div>
            </div>
        </div>
    );
});

    </script>

    <script type="text/babel">
        // Componente Card reutilizable - Dise√±o Minimalista

const Card = memo(({ title, subtitle, icon, children, className = '', actions = null, variant = 'default' }) => {
    const variantClasses = {
        default: 'bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700',
        primary: 'bg-white dark:bg-slate-800 border border-indigo-200 dark:border-indigo-900',
        success: 'bg-white dark:bg-slate-800 border border-green-200 dark:border-green-900',
        warning: 'bg-white dark:bg-slate-800 border border-yellow-200 dark:border-yellow-900',
        danger: 'bg-white dark:bg-slate-800 border border-red-200 dark:border-red-900'
    };

    return (
        <div className={`rounded-xl shadow-minimal-md ${variantClasses[variant]} ${className} animate-slideIn hover-lift transition-all duration-300`}>
            {(title || subtitle || icon || actions) && (
                <div className="p-4 sm:p-6 border-b border-gray-100 dark:border-slate-700">
                    <div className="flex items-center justify-between flex-wrap gap-3">
                        <div className="flex items-center space-x-2 sm:space-x-3 flex-1 min-w-0">
                            {icon && (
                                <div className="text-2xl sm:text-3xl flex-shrink-0">
                                    {icon}
                                </div>
                            )}
                            <div className="min-w-0">
                                {title && (
                                    <h3 className="text-lg sm:text-xl font-bold text-gray-900 dark:text-white truncate">
                                        {title}
                                    </h3>
                                )}
                                {subtitle && (
                                    <p className="text-xs sm:text-sm text-gray-600 dark:text-gray-300 mt-1">
                                        {subtitle}
                                    </p>
                                )}
                            </div>
                        </div>
                        {actions && (
                            <div className="flex items-center space-x-2 flex-shrink-0">
                                {actions}
                            </div>
                        )}
                    </div>
                </div>
            )}

            <div className="p-4 sm:p-6">
                {children}
            </div>
        </div>
    );
});

// Componente CardStat para estad√≠sticas num√©ricas - Dise√±o Minimalista
const CardStat = memo(({ label, value, icon, color = 'indigo', trend = null, subtitle = null }) => {
    const colorConfigs = {
        indigo: {
            bg: 'bg-indigo-50 dark:bg-slate-700',
            text: 'text-indigo-600 dark:text-indigo-400',
            iconBg: 'bg-indigo-100 dark:bg-slate-600',
            iconText: 'text-indigo-600 dark:text-indigo-400'
        },
        green: {
            bg: 'bg-green-50 dark:bg-slate-700',
            text: 'text-green-600 dark:text-green-400',
            iconBg: 'bg-green-100 dark:bg-slate-600',
            iconText: 'text-green-600 dark:text-green-400'
        },
        yellow: {
            bg: 'bg-yellow-50 dark:bg-slate-700',
            text: 'text-yellow-600 dark:text-yellow-400',
            iconBg: 'bg-yellow-100 dark:bg-slate-600',
            iconText: 'text-yellow-600 dark:text-yellow-400'
        },
        red: {
            bg: 'bg-red-50 dark:bg-slate-700',
            text: 'text-red-600 dark:text-red-400',
            iconBg: 'bg-red-100 dark:bg-slate-600',
            iconText: 'text-red-600 dark:text-red-400'
        },
        blue: {
            bg: 'bg-blue-50 dark:bg-slate-700',
            text: 'text-blue-600 dark:text-blue-400',
            iconBg: 'bg-blue-100 dark:bg-slate-600',
            iconText: 'text-blue-600 dark:text-blue-400'
        },
        purple: {
            bg: 'bg-purple-50 dark:bg-slate-700',
            text: 'text-purple-600 dark:text-purple-400',
            iconBg: 'bg-purple-100 dark:bg-slate-600',
            iconText: 'text-purple-600 dark:text-purple-400'
        }
    };

    // Usar config con fallback a indigo si el color no existe
    const config = colorConfigs[color] || colorConfigs['indigo'];

    return (
        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-minimal-md p-4 sm:p-6 border border-gray-200 dark:border-slate-700 animate-slideIn hover-lift transition-all duration-300">
            <div className="flex items-center justify-between">
                <div className="flex-1 min-w-0">
                    <p className="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">{label}</p>
                    <p className={`text-2xl sm:text-3xl font-black ${config.text} truncate`}>{value}</p>
                    {subtitle && (
                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">{subtitle}</p>
                    )}
                </div>
                {icon && (
                    <div className={`p-2 sm:p-3 rounded-xl ${config.iconBg} ${config.iconText} flex-shrink-0`}>
                        <span className="text-xl sm:text-2xl">{icon}</span>
                    </div>
                )}
            </div>

            {trend && (
                <div className="mt-4 flex items-center">
                    <span className={`text-xs font-bold px-2 py-1 rounded-lg ${
                        trend.positive
                            ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300'
                            : 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300'
                    }`}>
                        {trend.positive ? '‚Üë' : '‚Üì'} {trend.value}
                    </span>
                    <span className="text-xs text-gray-500 dark:text-gray-400 ml-2">{trend.label}</span>
                </div>
            )}
        </div>
    );
});

    </script>

    <script type="text/babel">
        // Componente ProgressBar con sistema de sem√°foro - Dise√±o Minimalista

const ProgressBar = memo(({
    label,
    current,
    max,
    showValues = true,
    showPercentage = true,
    size = 'md',
    animated = true
}) => {
    const porcentaje = calcularPorcentaje(current, max);
    const colores = getColorSemaforo(porcentaje);

    const sizeClasses = {
        sm: 'h-3',
        md: 'h-5',
        lg: 'h-7'
    };

    const disponible = Math.max(max - current, 0);
    const excedido = current > max;

    return (
        <div className="space-y-2">
            {/* Label y valores */}
            {label && (
                <div className="flex items-center justify-between">
                    <span className="text-sm font-bold text-gray-800 dark:text-white">{label}</span>
                    {showValues && (
                        <div className="flex items-center space-x-2">
                            <span className={`text-sm font-black ${colores.textColor} px-2 py-1 rounded-lg`}
                                style={{
                                    background: `${colores.color}15`,
                                    textShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                }}
                            >
                                {formatearMonto(current)}
                            </span>
                            <span className="text-xs text-gray-600 dark:text-gray-400 font-semibold">
                                de {formatearMonto(max)}
                            </span>
                        </div>
                    )}
                </div>
            )}

            {/* Barra de progreso minimalista */}
            <div className="relative">
                <div className={`w-full ${sizeClasses[size]} bg-gray-100 dark:bg-slate-700 rounded-full overflow-hidden`}>
                    <div
                        className={`${sizeClasses[size]} rounded-full transition-all duration-500 ease-out ${animated ? 'animate-pulse-soft' : ''}`}
                        style={{
                            width: `${Math.min(porcentaje, 100)}%`,
                            backgroundColor: colores.color
                        }}
                    />
                </div>

                {/* Indicador de excedido */}
                {excedido && (
                    <div className="absolute top-0 right-0 -mt-1 -mr-1">
                        <span className="flex h-3 w-3">
                            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                            <span className="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                        </span>
                    </div>
                )}
            </div>

            {/* Informaci√≥n adicional */}
            <div className="flex items-center justify-between text-xs">
                {showPercentage && (
                    <span className={`font-semibold ${colores.textColor}`}>
                        {porcentaje}%
                    </span>
                )}
                {!excedido && (
                    <span className="text-gray-500 dark:text-gray-400">
                        Disponible: {formatearMonto(disponible)}
                    </span>
                )}
                {excedido && (
                    <span className="text-red-600 dark:text-red-400 font-semibold">
                        ¬°Excedido por {formatearMonto(current - max)}!
                    </span>
                )}
            </div>
        </div>
    );
});

// Componente ProgressBarSimple para uso en listas - Dise√±o Minimalista
const ProgressBarSimple = memo(({ current, max, height = 'h-2' }) => {
    const porcentaje = calcularPorcentaje(current, max);
    const colores = getColorSemaforo(porcentaje);

    return (
        <div className="flex-1">
            <div className={`w-full ${height} bg-gray-100 dark:bg-slate-700 rounded-full overflow-hidden`}>
                <div
                    className={`${height} rounded-full transition-all duration-500`}
                    style={{
                        width: `${Math.min(porcentaje, 100)}%`,
                        backgroundColor: colores.color
                    }}
                />
            </div>
        </div>
    );
});

// Componente ProgressCircular para indicadores circulares - Dise√±o Minimalista
const ProgressCircular = memo(({ current, max, size = 80, strokeWidth = 8 }) => {
    const porcentaje = calcularPorcentaje(current, max);
    const colores = getColorSemaforo(porcentaje);

    const radius = (size - strokeWidth) / 2;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (porcentaje / 100) * circumference;

    return (
        <div className="relative inline-flex items-center justify-center">
            <svg width={size} height={size} className="transform -rotate-90">
                {/* C√≠rculo de fondo */}
                <circle
                    cx={size / 2}
                    cy={size / 2}
                    r={radius}
                    stroke="#e5e7eb"
                    className="dark:stroke-slate-700"
                    strokeWidth={strokeWidth}
                    fill="none"
                />
                {/* C√≠rculo de progreso */}
                <circle
                    cx={size / 2}
                    cy={size / 2}
                    r={radius}
                    stroke={colores.color}
                    strokeWidth={strokeWidth}
                    fill="none"
                    strokeDasharray={circumference}
                    strokeDashoffset={offset}
                    strokeLinecap="round"
                    className="transition-all duration-500"
                />
            </svg>
            <div className="absolute inset-0 flex items-center justify-center">
                <span className={`text-sm font-bold ${colores.textColor}`}>
                    {porcentaje}%
                </span>
            </div>
        </div>
    );
});

    </script>

    <script type="text/babel">
        // Componentes de alertas y badges

const AlertBadge = memo(({ type = 'info', children, icon = null, onClose = null, className = '' }) => {
    const typeClasses = {
        success: 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border-green-300 dark:border-green-700',
        warning: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 border-yellow-300 dark:border-yellow-700',
        error: 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 border-red-300 dark:border-red-700',
        info: 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 border-blue-300 dark:border-blue-700'
    };

    const defaultIcons = {
        success: '‚úì',
        warning: '‚ö†',
        error: '‚úï',
        info: '‚Ñπ'
    };

    return (
        <div className={`flex items-center space-x-2 px-4 py-3 rounded-lg border ${typeClasses[type]} ${className} animate-slideIn`}>
            {(icon || defaultIcons[type]) && (
                <span className="text-lg font-bold">
                    {icon || defaultIcons[type]}
                </span>
            )}
            <div className="flex-1 text-sm font-medium">
                {children}
            </div>
            {onClose && (
                <button
                    onClick={onClose}
                    className="text-current opacity-70 hover:opacity-100 transition-opacity"
                    aria-label="Cerrar alerta"
                >
                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                    </svg>
                </button>
            )}
        </div>
    );
});

// Badge simple para etiquetas
const Badge = memo(({ children, color = 'gray', size = 'md', className = '' }) => {
    const colorClasses = {
        gray: 'bg-gray-100 dark:bg-slate-600 text-gray-800 dark:text-gray-200',
        indigo: 'bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200',
        green: 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200',
        yellow: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200',
        red: 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200',
        blue: 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200',
        purple: 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200',
        pink: 'bg-pink-100 dark:bg-pink-900 text-pink-800 dark:text-pink-200'
    };

    const sizeClasses = {
        sm: 'px-2 py-0.5 text-xs',
        md: 'px-3 py-1 text-sm',
        lg: 'px-4 py-2 text-base'
    };

    return (
        <span className={`inline-flex items-center font-semibold rounded-full ${colorClasses[color]} ${sizeClasses[size]} ${className}`}>
            {children}
        </span>
    );
});

// Notificaci√≥n toast (para mostrar temporalmente)
const Toast = memo(({ message, type = 'info', duration = 3000, onClose }) => {
    useEffect(() => {
        if (duration > 0) {
            const timer = setTimeout(() => {
                if (onClose) onClose();
            }, duration);

            return () => clearTimeout(timer);
        }
    }, [duration, onClose]);

    const typeClasses = {
        success: 'bg-green-500 dark:bg-green-600 text-white',
        warning: 'bg-yellow-500 dark:bg-yellow-600 text-white',
        error: 'bg-red-500 dark:bg-red-600 text-white',
        info: 'bg-blue-500 dark:bg-blue-600 text-white'
    };

    return (
        <div className={`fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-xl ${typeClasses[type]} animate-slideIn z-50`}>
            <div className="flex items-center space-x-2">
                <span className="font-medium">{message}</span>
                {onClose && (
                    <button
                        onClick={onClose}
                        className="ml-4 text-white hover:text-gray-200 transition-colors"
                    >
                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                        </svg>
                    </button>
                )}
            </div>
        </div>
    );
});

// AlertCompact para alertas compactas en dashboard
const AlertCompact = memo(({ title, description, icon, color = 'indigo', onClick = null }) => {
    const colorClasses = {
        indigo: 'bg-indigo-50 dark:bg-indigo-900 border-indigo-200 dark:border-indigo-700 text-indigo-800 dark:text-indigo-200',
        green: 'bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700 text-green-800 dark:text-green-200',
        yellow: 'bg-yellow-50 dark:bg-yellow-900 border-yellow-200 dark:border-yellow-700 text-yellow-800 dark:text-yellow-200',
        red: 'bg-red-50 dark:bg-red-900 border-red-200 dark:border-red-700 text-red-800 dark:text-red-200'
    };

    return (
        <div
            className={`flex items-start space-x-3 p-4 rounded-lg border ${colorClasses[color]} ${onClick ? 'cursor-pointer hover:shadow-md' : ''} transition-all`}
            onClick={onClick}
        >
            {icon && (
                <div className="text-2xl mt-0.5">
                    {icon}
                </div>
            )}
            <div className="flex-1 min-w-0">
                <p className="font-semibold text-sm">{title}</p>
                {description && (
                    <p className="text-xs mt-1 opacity-80">{description}</p>
                )}
            </div>
            {onClick && (
                <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                </svg>
            )}
        </div>
    );
});

// EmptyState para cuando no hay datos
const EmptyState = memo(({ icon = 'üì≠', title, description, action = null }) => {
    return (
        <div className="flex flex-col items-center justify-center py-12 px-4 text-center">
            <div className="text-6xl mb-4 opacity-50">
                {icon}
            </div>
            <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">
                {title}
            </h3>
            {description && (
                <p className="text-gray-600 dark:text-gray-300 mb-6 max-w-md">
                    {description}
                </p>
            )}
            {action && (
                <div>
                    {action}
                </div>
            )}
        </div>
    );
});

    </script>

    <script type="text/babel">
        // Componente de secci√≥n colapsable

const CollapsibleSection = memo(({ title, icon, children, defaultOpen = false }) => {
    const [isOpen, setIsOpen] = useState(defaultOpen);

    return (
        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-gray-200 dark:border-slate-700 animate-slideIn overflow-hidden">
            {/* Header colapsable */}
            <button
                onClick={() => setIsOpen(!isOpen)}
                className="w-full p-6 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"
            >
                <div className="flex items-center space-x-3">
                    {icon && <span className="text-3xl">{icon}</span>}
                    <h3 className="text-xl font-bold text-gray-800 dark:text-white">{title}</h3>
                </div>
                <svg
                    className={`w-6 h-6 text-gray-600 dark:text-gray-400 transition-transform duration-200 ${
                        isOpen ? 'rotate-180' : ''
                    }`}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
            </button>

            {/* Contenido colapsable */}
            {isOpen && (
                <div className="px-6 pb-6 border-t border-gray-200 dark:border-slate-700">
                    <div className="pt-6">
                        {children}
                    </div>
                </div>
            )}
        </div>
    );
});

    </script>

    <!-- MAIN COMPONENTS -->
    <script type="text/babel">
        // Componente de Login con Firebase - Finzi v3.3

const Login = () => {
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const handleGoogleLogin = async () => {
        setLoading(true);
        setError(null);

        try {
            await window.loginWithGoogle();
            // El redirect se maneja autom√°ticamente en App.jsx
        } catch (err) {
            console.error('Error en login:', err);
            setError(err.message || 'Error al iniciar sesi√≥n');
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 via-white to-purple-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
            <div className="max-w-md w-full mx-4">
                {/* Card Principal */}
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 animate-slideIn">
                    {/* Logo */}
                    <div className="text-center mb-8">
                        <div className="inline-block">
                            <svg width="120" height="40" viewBox="0 0 120 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="text-gray-900 dark:text-white mx-auto">
                                <defs>
                                    <linearGradient id="arrow-gradient-login" x1="30" y1="8" x2="50" y2="32" gradientUnits="userSpaceOnUse">
                                        <stop offset="0%" style={{stopColor: '#7DD3C0', stopOpacity: 1}} />
                                        <stop offset="50%" style={{stopColor: '#A8E063', stopOpacity: 1}} />
                                        <stop offset="100%" style={{stopColor: '#56AB2F', stopOpacity: 1}} />
                                    </linearGradient>
                                </defs>
                                <path d="M 30 32 L 50 12 L 60 22" stroke="url(#arrow-gradient-login)" strokeWidth="8" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                                <text x="0" y="30" fontFamily="Arial, sans-serif" fontSize="24" fontWeight="bold" fill="currentColor">FINZI</text>
                                <rect x="115" y="10" width="4" height="20" rx="2" fill="#7DD3C0"/>
                            </svg>
                        </div>
                        <h1 className="text-3xl font-bold text-gray-900 dark:text-white mt-4">
                            Bienvenido
                        </h1>
                        <p className="text-gray-600 dark:text-gray-400 mt-2">
                            Analizador de Gastos de Tarjeta de Cr√©dito
                        </p>
                    </div>

                    {/* Descripci√≥n */}
                    <div className="mb-8">
                        <div className="bg-indigo-50 dark:bg-indigo-900/20 rounded-xl p-4 mb-4">
                            <h2 className="text-sm font-semibold text-indigo-900 dark:text-indigo-300 mb-2">
                                ‚ú® Caracter√≠sticas
                            </h2>
                            <ul className="text-sm text-indigo-700 dark:text-indigo-400 space-y-1">
                                <li>üìä An√°lisis autom√°tico de gastos</li>
                                <li>ü§ñ Categorizaci√≥n inteligente</li>
                                <li>üí∞ Gesti√≥n de presupuestos</li>
                                <li>üîÑ Sincronizaci√≥n multi-dispositivo</li>
                            </ul>
                        </div>
                    </div>

                    {/* Bot√≥n de Login */}
                    <button
                        onClick={handleGoogleLogin}
                        disabled={loading}
                        className="w-full bg-white dark:bg-slate-700 border-2 border-gray-300 dark:border-slate-600 hover:border-indigo-500 dark:hover:border-indigo-400 text-gray-700 dark:text-gray-200 font-semibold py-3 px-4 rounded-xl flex items-center justify-center space-x-3 transition-all hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {loading ? (
                            <>
                                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-600"></div>
                                <span>Iniciando sesi√≥n...</span>
                            </>
                        ) : (
                            <>
                                <svg className="w-5 h-5" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                <span>Continuar con Google</span>
                            </>
                        )}
                    </button>

                    {/* Error */}
                    {error && (
                        <div className="mt-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg animate-slideIn">
                            <p className="text-sm text-red-800 dark:text-red-300 flex items-center">
                                <svg className="w-5 h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd"/>
                                </svg>
                                {error}
                            </p>
                        </div>
                    )}

                    {/* Info */}
                    <div className="mt-6 text-center">
                        <p className="text-xs text-gray-500 dark:text-gray-400">
                            Solo usuarios autorizados pueden acceder
                        </p>
                    </div>
                </div>

                {/* Footer */}
                <div className="text-center mt-6">
                    <p className="text-sm text-gray-600 dark:text-gray-400">
                        ¬© 2025 Finzi - v3.3
                    </p>
                    <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">
                        Sincronizaci√≥n con Firebase
                    </p>
                </div>
            </div>
        </div>
    );
};

    </script>

    <script type="text/babel">
        // Componente Sidebar con navegaci√≥n - Dise√±o Minimalista Moderno

const Sidebar = () => {
    const { currentPage, setCurrentPage, isSidebarOpen, setIsSidebarOpen, isDarkMode, setIsDarkMode } = useApp();

    // Estado para grupos colapsados - todos colapsados por defecto
    const [collapsedGroups, setCollapsedGroups] = useState(() => {
        const saved = localStorage.getItem('collapsedGroups');
        if (saved) {
            return JSON.parse(saved);
        }
        // Inicializar todos los grupos como colapsados
        return {
            transacciones: true,
            analisis: true,
            configuracion: true,
            herramientas: true
        };
    });

    // Logo SVG inline con soporte para modo claro/oscuro
    const LogoFinzi = ({ className = "" }) => (
        <svg width="120" height="40" viewBox="0 0 120 40" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}>
            <defs>
                <linearGradient id="arrow-gradient" x1="30" y1="8" x2="50" y2="32" gradientUnits="userSpaceOnUse">
                    <stop offset="0%" style={{stopColor: '#7DD3C0', stopOpacity: 1}} />
                    <stop offset="50%" style={{stopColor: '#A8E063', stopOpacity: 1}} />
                    <stop offset="100%" style={{stopColor: '#56AB2F', stopOpacity: 1}} />
                </linearGradient>
            </defs>
            <path d="M 30 32 L 50 12 L 60 22" stroke="url(#arrow-gradient)" strokeWidth="8" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
            <text x="0" y="30" fontFamily="Arial, sans-serif" fontSize="24" fontWeight="bold" fill="currentColor">FINZI</text>
            <rect x="115" y="10" width="4" height="20" rx="2" fill="#7DD3C0"/>
        </svg>
    );

    // Logo compacto (solo icono) para sidebar colapsado
    const LogoFinziCompact = ({ className = "" }) => (
        <svg width="40" height="40" viewBox="0 0 60 40" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}>
            <defs>
                <linearGradient id="arrow-gradient-compact" x1="10" y1="8" x2="30" y2="32" gradientUnits="userSpaceOnUse">
                    <stop offset="0%" style={{stopColor: '#7DD3C0', stopOpacity: 1}} />
                    <stop offset="50%" style={{stopColor: '#A8E063', stopOpacity: 1}} />
                    <stop offset="100%" style={{stopColor: '#56AB2F', stopOpacity: 1}} />
                </linearGradient>
            </defs>
            <path d="M 10 32 L 30 12 L 40 22" stroke="url(#arrow-gradient-compact)" strokeWidth="8" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
            <rect x="48" y="10" width="4" height="20" rx="2" fill="#7DD3C0"/>
        </svg>
    );

    // Toggle de grupo colapsable
    const toggleGroup = (groupId) => {
        const newCollapsed = {
            ...collapsedGroups,
            [groupId]: !collapsedGroups[groupId]
        };
        setCollapsedGroups(newCollapsed);
        localStorage.setItem('collapsedGroups', JSON.stringify(newCollapsed));
    };

    const menuItems = [
        {
            id: 'home',
            icon: 'üè†',
            label: 'Home',
            type: 'single'
        },
        {
            id: 'transacciones',
            icon: 'üí∞',
            label: 'Transacciones',
            type: 'group',
            items: [
                { id: 'ingresos', icon: 'üíµ', label: 'Ingresos' },
                { id: 'reembolsos', icon: 'üí∏', label: 'Reembolsos' },
                { id: 'recurrentes', icon: 'üîÑ', label: 'Recurrentes' }
            ]
        },
        {
            id: 'analisis',
            icon: 'üìä',
            label: 'An√°lisis',
            type: 'group',
            items: [
                { id: 'analisis', icon: 'üìà', label: 'An√°lisis Cierre' },
                { id: 'historial', icon: 'üìÖ', label: 'Historial' },
                { id: 'balance', icon: 'üí∞', label: 'Balance' },
                { id: 'proyecciones', icon: 'üéØ', label: 'Proyecciones' }
            ]
        },
        {
            id: 'configuracion',
            icon: '‚öôÔ∏è',
            label: 'Configuraci√≥n',
            type: 'group',
            items: [
                { id: 'perfiles', icon: 'üë•', label: 'Perfiles' },
                { id: 'categorias', icon: 'üè∑Ô∏è', label: 'Categor√≠as' },
                { id: 'presupuestos', icon: 'üí∏', label: 'Presupuestos' }
            ]
        },
        {
            id: 'herramientas',
            icon: 'üìà',
            label: 'Proyecciones',
            type: 'group',
            items: [
                { id: 'cuotasFuturas', icon: 'üí≥', label: 'Cuotas Futuras' },
                { id: 'simulador', icon: 'üßÆ', label: 'Simulador' }
            ]
        }
    ];

    return (
        <>
            {/* Bot√≥n Hamburguesa para Mobile - Mejorado */}
            {!isSidebarOpen && (
                <button
                    onClick={() => setIsSidebarOpen(true)}
                    className="fixed top-3 left-3 z-50 lg:hidden p-2.5 bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-lg transition-all"
                    aria-label="Abrir men√∫"
                >
                    <svg
                        className="w-5 h-5 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            )}

            {/* Sidebar - Responsive */}
            <aside
                className={`fixed left-0 top-0 h-full bg-white dark:bg-slate-800 text-gray-800 dark:text-gray-100 transition-all duration-300 z-40 flex flex-col border-r border-gray-200 dark:border-slate-700 ${
                    isSidebarOpen ? 'w-64' : 'w-16 -translate-x-full lg:translate-x-0'
                } lg:translate-x-0`}
                style={{
                    boxShadow: '2px 0 8px rgba(0, 0, 0, 0.05)'
                }}
            >
                {/* Header minimalista - Responsive */}
                <div className={`border-b border-gray-100 dark:border-slate-700 flex-shrink-0 ${isSidebarOpen ? 'p-4 lg:p-6' : 'p-2'}`}>
                    <div className="flex items-center justify-between">
                        {isSidebarOpen ? (
                            <div className="animate-slideIn flex-1">
                                <LogoFinzi className="text-gray-900 dark:text-white mb-1 scale-90 lg:scale-100" />
                                <p className="text-xs text-gray-500 dark:text-gray-400 font-medium hidden lg:block">v3.2 - Gastos TC</p>
                            </div>
                        ) : (
                            <div className="mx-auto">
                                <LogoFinziCompact className="text-gray-900 dark:text-white" />
                            </div>
                        )}
                        {isSidebarOpen && (
                            <button
                                onClick={() => setIsSidebarOpen(false)}
                                className="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-all ml-2 lg:hidden"
                                aria-label="Cerrar men√∫"
                            >
                                <svg
                                    className="w-5 h-5"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        )}
                    </div>
                    {!isSidebarOpen && (
                        <button
                            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                            className="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-all mx-auto mt-2 w-full"
                            aria-label="Expandir men√∫"
                        >
                            <svg
                                className="w-5 h-5 transition-transform duration-300 rotate-180 mx-auto"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                            </svg>
                        </button>
                    )}
                </div>

                {/* Menu Items con grupos colapsables */}
                <nav className={`space-y-1 overflow-y-auto flex-1 ${isSidebarOpen ? 'p-2 lg:p-4' : 'p-1'}`} style={{ maxHeight: 'calc(100vh - 200px)' }}>
                    {menuItems.map((item) => {
                        if (item.type === 'single') {
                            // Item simple (Home)
                            const isActive = currentPage === item.id;
                            return (
                                <button
                                    key={item.id}
                                    onClick={() => {
                                        setCurrentPage(item.id);
                                        if (window.innerWidth < 1024) {
                                            setIsSidebarOpen(false);
                                        }
                                    }}
                                    className={`w-full flex items-center rounded-lg lg:rounded-xl transition-all duration-300 group relative ${
                                        isSidebarOpen ? 'space-x-2 lg:space-x-3 px-3 lg:px-4 py-2 lg:py-3' : 'justify-center py-3 px-2'
                                    } ${
                                        isActive
                                            ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400'
                                            : 'hover:bg-gray-50 dark:hover:bg-slate-700 text-gray-700 dark:text-gray-300'
                                    }`}
                                    title={!isSidebarOpen ? item.label : ''}
                                >
                                    {isActive && (
                                        <div className="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-6 lg:h-8 bg-indigo-600 rounded-r-full" />
                                    )}
                                    <span className="text-xl lg:text-2xl flex-shrink-0 transition-transform group-hover:scale-110">
                                        {item.icon}
                                    </span>
                                    {isSidebarOpen && (
                                        <div className="flex-1 text-left min-w-0">
                                            <p className={`font-bold text-xs lg:text-sm truncate ${
                                                isActive ? 'text-indigo-600 dark:text-indigo-400' : 'text-gray-700 dark:text-gray-300'
                                            }`}>
                                                {item.label}
                                            </p>
                                        </div>
                                    )}
                                </button>
                            );
                        }

                        // Item de grupo con subitems
                        const isCollapsed = collapsedGroups[item.id];
                        const hasActiveChild = item.items.some(subItem => currentPage === subItem.id);

                        return (
                            <div key={item.id} className="space-y-1">
                                {/* Header del grupo */}
                                <button
                                    onClick={() => {
                                        if (isSidebarOpen) {
                                            toggleGroup(item.id);
                                        }
                                    }}
                                    className={`w-full flex items-center rounded-lg lg:rounded-xl transition-all duration-300 group relative ${
                                        isSidebarOpen ? 'space-x-2 lg:space-x-3 px-3 lg:px-4 py-2 lg:py-3' : 'justify-center py-3 px-2'
                                    } ${
                                        hasActiveChild
                                            ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400'
                                            : 'hover:bg-gray-50 dark:hover:bg-slate-700 text-gray-700 dark:text-gray-300'
                                    }`}
                                    title={!isSidebarOpen ? item.label : ''}
                                >
                                    <span className="text-xl lg:text-2xl flex-shrink-0 transition-transform group-hover:scale-110">
                                        {item.icon}
                                    </span>
                                    {isSidebarOpen && (
                                        <>
                                            <div className="flex-1 text-left min-w-0">
                                                <p className={`font-bold text-xs lg:text-sm truncate ${
                                                    hasActiveChild ? 'text-indigo-600 dark:text-indigo-400' : 'text-gray-700 dark:text-gray-300'
                                                }`}>
                                                    {item.label}
                                                </p>
                                            </div>
                                            {/* Chevron */}
                                            <svg
                                                className={`w-4 h-4 transition-transform duration-200 ${isCollapsed ? '' : 'rotate-180'}`}
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </>
                                    )}
                                </button>

                                {/* Subitems */}
                                {isSidebarOpen && !isCollapsed && (
                                    <div className="space-y-0.5 ml-2 lg:ml-3">
                                        {item.items.map((subItem) => {
                                            const isActive = currentPage === subItem.id;
                                            return (
                                                <button
                                                    key={subItem.id}
                                                    onClick={() => {
                                                        setCurrentPage(subItem.id);
                                                        if (window.innerWidth < 1024) {
                                                            setIsSidebarOpen(false);
                                                        }
                                                    }}
                                                    className={`w-full flex items-center space-x-2 lg:space-x-3 px-3 lg:px-4 py-1.5 lg:py-2 rounded-lg transition-all duration-200 group relative ${
                                                        isActive
                                                            ? 'bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300'
                                                            : 'hover:bg-gray-100 dark:hover:bg-slate-700/50 text-gray-600 dark:text-gray-400'
                                                    }`}
                                                >
                                                    {isActive && (
                                                        <div className="absolute left-0 top-1/2 -translate-y-1/2 w-0.5 h-4 bg-indigo-600 rounded-r-full" />
                                                    )}
                                                    <span className="text-base lg:text-lg flex-shrink-0">
                                                        {subItem.icon}
                                                    </span>
                                                    <p className={`text-xs lg:text-sm font-medium truncate ${
                                                        isActive ? 'text-indigo-700 dark:text-indigo-300' : 'text-gray-600 dark:text-gray-400'
                                                    }`}>
                                                        {subItem.label}
                                                    </p>
                                                </button>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </nav>

                {/* Footer minimalista */}
                <div className={`border-t border-gray-100 dark:border-slate-700 flex-shrink-0 ${isSidebarOpen ? 'p-4' : 'p-2'}`}>
                    {/* Toggle Dark Mode */}
                    <button
                        onClick={() => setIsDarkMode(!isDarkMode)}
                        className={`w-full mb-3 px-3 py-2 text-sm font-semibold rounded-lg transition-all flex items-center ${
                            isSidebarOpen ? 'justify-start space-x-2' : 'justify-center'
                        } ${
                            isDarkMode
                                ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 hover:bg-yellow-200 dark:hover:bg-yellow-900/50'
                                : 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 hover:bg-indigo-200 dark:hover:bg-indigo-900/50'
                        }`}
                        title={isDarkMode ? 'Modo Claro' : 'Modo Oscuro'}
                    >
                        <span className="text-xl">{isDarkMode ? '‚òÄÔ∏è' : 'üåô'}</span>
                        {isSidebarOpen && (
                            <span>{isDarkMode ? 'Modo Claro' : 'Modo Oscuro'}</span>
                        )}
                    </button>

                    {isSidebarOpen && (
                        <a
                            href="reset-completo.html"
                            target="_blank"
                            className="block w-full px-3 py-2 mb-3 text-xs font-semibold text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/30 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-lg transition-colors text-center"
                        >
                            üóëÔ∏è Limpiar Cach√©
                        </a>
                    )}
                    {isSidebarOpen ? (
                        <div className="text-center text-xs text-gray-500 dark:text-gray-400">
                            <p className="font-medium">¬© 2025 Gastos TC</p>
                            <p className="mt-1">v3.2 Minimalista</p>
                        </div>
                    ) : (
                        <div className="text-center text-xs text-gray-400 dark:text-gray-500">
                            <span>¬©</span>
                        </div>
                    )}
                </div>
            </aside>

            {/* Overlay para mobile - solo visible cuando sidebar est√° abierto */}
            {isSidebarOpen && (
                <div
                    className="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden"
                    onClick={() => setIsSidebarOpen(false)}
                />
            )}
        </>
    );
};

    </script>

    <script type="text/babel">
        // P√°gina Home - Dashboard principal

const Home = () => {
    const { selectedMonth, setSelectedMonth, selectedMonths, setSelectedMonths, perfiles, categorias, mesesCargados, refreshMesesCargados } = useApp();

    const [transacciones, setTransacciones] = useState([]);
    const [presupuestos, setPresupuestos] = useState([]);
    const [ingresos, setIngresos] = useState([]);
    const [loading, setLoading] = useState(false);
    const [activeTab, setActiveTab] = useState('todas'); // todas, spot, cuotasMes, cuotasAnteriores
    const [filtros, setFiltros] = useState({ perfilId: null, categoria: null, busqueda: '' });
    const [showModalCargarCSV, setShowModalCargarCSV] = useState(false);
    const [showModalEditarTransaccion, setShowModalEditarTransaccion] = useState(false);
    const [transaccionEditar, setTransaccionEditar] = useState(null);
    const [showToast, setShowToast] = useState(null);
    const [showModalQuickAdd, setShowModalQuickAdd] = useState(false);
    const [showSelectorMeses, setShowSelectorMeses] = useState(false);
    const [showMenuFAB, setShowMenuFAB] = useState(false);
    const [showModalEntradaRapida, setShowModalEntradaRapida] = useState(false);
    const [showModalCargarPDF, setShowModalCargarPDF] = useState(false);

    // Cargar datos cuando cambian los meses seleccionados
    useEffect(() => {
        if (selectedMonths.length > 0) {
            cargarDatosDeMeses();
        }
    }, [selectedMonths]);

    const cargarDatosDeMeses = async () => {
        if (selectedMonths.length === 0) return;

        console.log('üîÑ cargarDatosDeMeses ejecut√°ndose...', selectedMonths.map(m => m.id));
        setLoading(true);
        try {
            // WORKAROUND: db.js no se actualiza, usar filtrado manual
            const todasLasTransDB = await db.transacciones.toArray();
            const todasLosPresDB = await db.presupuestos.toArray();

            const todasTransacciones = [];
            const todosPresupuestos = [];
            const todosIngresos = [];

            for (const mes of selectedMonths) {
                // Filtrar manualmente en lugar de usar √≠ndice roto
                const trans = todasLasTransDB.filter(t => t.mesAnioId === mes.id);
                todasTransacciones.push(...trans);
                console.log(`üìä Mes ${mes.mesAnio}: ${trans.length} transacciones`);

                const pres = todasLosPresDB.filter(p => p.mesAnioId === mes.id);
                todosPresupuestos.push(...pres);

                const ings = await getIngresos(mes.mesAnio);
                todosIngresos.push(...ings);
            }

            console.log(`‚úÖ Total cargado: ${todasTransacciones.length} transacciones`);
            setTransacciones(todasTransacciones);
            setPresupuestos(todosPresupuestos);
            setIngresos(todosIngresos);
        } catch (error) {
            console.error('Error al cargar datos:', error);
            mostrarToast('Error al cargar datos', 'error');
        } finally {
            setLoading(false);
        }
    };

    const mostrarToast = (message, type = 'info') => {
        setShowToast({ message, type });
        setTimeout(() => setShowToast(null), 3000);
    };

    // Funci√≥n para toggle de selecci√≥n de mes
    const toggleMesSeleccionado = (mes) => {
        const index = selectedMonths.findIndex(m => m.id === mes.id);
        if (index >= 0) {
            // Si ya est√° seleccionado, removerlo (pero mantener al menos uno)
            if (selectedMonths.length > 1) {
                const nuevosSeleccionados = selectedMonths.filter(m => m.id !== mes.id);
                setSelectedMonths(nuevosSeleccionados);
                setSelectedMonth(nuevosSeleccionados[0]);
            }
        } else {
            // Si no est√° seleccionado, agregarlo
            setSelectedMonths([...selectedMonths, mes]);
        }
    };

    // Funci√≥n para seleccionar todos los meses
    const seleccionarTodosMeses = () => {
        setSelectedMonths(mesesCargados);
        if (mesesCargados.length > 0) {
            setSelectedMonth(mesesCargados[0]);
        }
    };

    // Funci√≥n para limpiar selecci√≥n (dejar solo uno)
    const limpiarSeleccion = () => {
        if (selectedMonths.length > 0) {
            setSelectedMonths([selectedMonths[0]]);
            setSelectedMonth(selectedMonths[0]);
        }
    };

    // Calcular estad√≠sticas
    const desglose = useMemo(() => calcularDesglose(transacciones), [transacciones]);
    const gastosPorCategoria = useMemo(() => calcularGastosPorCategoria(transacciones), [transacciones]);
    const estadosPresupuestos = useMemo(() => calcularEstadoPresupuestos(transacciones, presupuestos), [transacciones, presupuestos]);
    const saludFinanciera = useMemo(() => calcularSaludFinanciera(estadosPresupuestos), [estadosPresupuestos]);
    const categoriasEnRiesgo = useMemo(() => getCategoriasEnRiesgo(estadosPresupuestos), [estadosPresupuestos]);
    const topGastos = useMemo(() => getTopGastos(transacciones, 3), [transacciones]);

    // Calcular disponible para gastar (US-008)
    const cuotasActivas = useMemo(() => {
        if (!selectedMonth) return [];
        return calcularCuotasActivas(transacciones, selectedMonth.mesAnio);
    }, [transacciones, selectedMonth]);

    const disponible = useMemo(() => {
        if (presupuestos.length === 0) return null;
        return calcularDisponible(transacciones, presupuestos, cuotasActivas);
    }, [transacciones, presupuestos, cuotasActivas]);

    // Calcular balance ingresos vs gastos
    const balanceIngresos = useMemo(() => {
        const totalIngresos = ingresos.reduce((sum, i) => sum + i.monto, 0);
        const totalGastos = desglose.total;
        const diferencia = totalIngresos - totalGastos;
        const porcentajeGastado = totalIngresos > 0 ? (totalGastos / totalIngresos) * 100 : 0;

        return {
            totalIngresos,
            totalGastos,
            diferencia,
            porcentajeGastado
        };
    }, [ingresos, desglose]);

    // Proyectar cuotas para los pr√≥ximos 12 meses
    const proyeccionCuotasFuturas = useMemo(() => {
        if (cuotasActivas.length === 0 || !selectedMonth) return [];

        const proyecciones = [];
        const mesActualDate = new Date(selectedMonth.mesAnio + '-01');
        // Comenzar desde el mes siguiente al mes cargado
        mesActualDate.setMonth(mesActualDate.getMonth() + 1);

        for (let i = 0; i < 12; i++) {
            const fechaMes = new Date(mesActualDate);
            fechaMes.setMonth(fechaMes.getMonth() + i);

            const mesAnio = `${fechaMes.getFullYear()}-${String(fechaMes.getMonth() + 1).padStart(2, '0')}`;

            let totalMes = 0;
            const cuotasDelMes = [];

            for (const cuota of cuotasActivas) {
                // Si esta cuota a√∫n tiene cuotas restantes para este mes
                if (i < cuota.cuotasRestantes) {
                    totalMes += cuota.montoCuota;
                    cuotasDelMes.push({
                        ...cuota,
                        numeroCuota: cuota.cuotaActual + i + 1
                    });
                }
            }

            proyecciones.push({
                mesAnio,
                mesNombre: getNombreMes(mesAnio),
                total: totalMes,
                cuotas: cuotasDelMes,
                cantidadCuotas: cuotasDelMes.length
            });
        }

        return proyecciones;
    }, [cuotasActivas, selectedMonth]);

    // Calcular balance simple para mostrar en stats
    const balance = useMemo(() => {
        if (transacciones.length === 0 || perfiles.length < 2) return null;

        const gastosCompartidos = transacciones.filter(t => t.esCompartido);
        if (gastosCompartidos.length === 0) return null;

        const balancePorPerfil = {};
        perfiles.forEach(perfil => {
            balancePorPerfil[perfil.id] = { perfil, debeRecuperar: 0 };
        });

        gastosCompartidos.forEach(t => {
            const porcentajeCompartido = 100 - (t.porcentajePerfil || 50);
            if (balancePorPerfil[t.perfilId]) {
                balancePorPerfil[t.perfilId].debeRecuperar += (t.monto * porcentajeCompartido / 100);
            }
            if (balancePorPerfil[t.perfilCompartidoId]) {
                balancePorPerfil[t.perfilCompartidoId].debeRecuperar -= (t.monto * porcentajeCompartido / 100);
            }
        });

        const perfilesArray = Object.values(balancePorPerfil);
        if (perfilesArray.length !== 2) return null;

        const [perfil1, perfil2] = perfilesArray;
        let deudor = null, acreedor = null, montoNeto = 0;

        if (perfil1.debeRecuperar > perfil2.debeRecuperar) {
            acreedor = perfil1.perfil;
            deudor = perfil2.perfil;
            montoNeto = perfil1.debeRecuperar - perfil2.debeRecuperar;
        } else if (perfil2.debeRecuperar > perfil1.debeRecuperar) {
            acreedor = perfil2.perfil;
            deudor = perfil1.perfil;
            montoNeto = perfil2.debeRecuperar - perfil1.debeRecuperar;
        }

        return { deudor, acreedor, montoNeto };
    }, [transacciones, perfiles]);

    // Filtrar transacciones seg√∫n tab y filtros
    const transaccionesFiltradas = useMemo(() => {
        let filtered = [...transacciones];

        // Filtrar por tab
        if (activeTab === 'spot') {
            // Spot: sin cuotas O pago del mes 1/1
            filtered = filtered.filter(t => !t.cuotaActual || (t.cuotaActual === 1 && t.cuotasTotal === 1));
        } else if (activeTab === 'cuotasMes') {
            // Cuotas del mes: primera cuota de compra en cuotas (1/2, 1/3, etc.)
            filtered = filtered.filter(t => t.cuotaActual === 1 && t.cuotasTotal > 1);
        } else if (activeTab === 'cuotasAnteriores') {
            // Cuotas anteriores: cuotas 2/12, 3/12, etc.
            filtered = filtered.filter(t => t.cuotaActual && t.cuotaActual > 1);
        }

        // Filtrar por perfil
        if (filtros.perfilId) {
            filtered = filtered.filter(t => t.perfilId === filtros.perfilId);
        }

        // Filtrar por categor√≠a
        if (filtros.categoria) {
            filtered = filtered.filter(t => t.categoria === filtros.categoria);
        }

        // Filtrar por b√∫squeda
        if (filtros.busqueda) {
            const busqueda = filtros.busqueda.toLowerCase();
            filtered = filtered.filter(t =>
                t.descripcion.toLowerCase().includes(busqueda) ||
                t.comercio.toLowerCase().includes(busqueda)
            );
        }

        return filtered.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    }, [transacciones, activeTab, filtros]);

    // Handlers
    const handleEliminarTransaccion = async (id) => {
        if (!confirm('¬øEst√°s seguro de eliminar esta transacci√≥n?')) return;

        try {
            await deleteTransaccion(id);
            setTransacciones(prev => prev.filter(t => t.id !== id));
            mostrarToast('Transacci√≥n eliminada', 'success');
        } catch (error) {
            console.error('Error al eliminar:', error);
            mostrarToast('Error al eliminar transacci√≥n', 'error');
        }
    };

    const handleEditarTransaccion = (transaccion) => {
        setTransaccionEditar(transaccion);
        setShowModalEditarTransaccion(true);
    };

    const handleGuardarEdicion = async (cambios) => {
        try {
            await updateTransaccion(transaccionEditar.id, cambios);

            // Si cambi√≥ la categor√≠a, aprenderla
            if (cambios.categoria && cambios.categoria !== transaccionEditar.categoria) {
                aprenderCategorizacion(transaccionEditar.comercio, cambios.categoria);
            }

            // Si cambi√≥ el nombre del comercio, aprenderlo para futuras importaciones
            // El comercio se aprende de forma SIMPLE: descripci√≥n original ‚Üí comercio nuevo
            if (cambios.comercio && cambios.comercio !== transaccionEditar.comercio) {
                guardarComercioAprendido(transaccionEditar.descripcion, cambios.comercio);
                console.log(`‚úÖ Aprendido comercio: "${transaccionEditar.descripcion}" ‚Üí "${cambios.comercio}"`);
            }

            // Si cambi√≥ la descripci√≥n Y la transacci√≥n tiene cuotas, aprenderlo de forma INTELIGENTE
            // Solo se aplicar√° a las cuotas de la misma compra (mismo comercio + total de cuotas)
            if (cambios.descripcion && cambios.descripcion !== transaccionEditar.descripcion) {
                if (transaccionEditar.cuotasTotal && transaccionEditar.cuotasTotal > 1) {
                    // Crear una clave √∫nica: comercio + total de cuotas
                    const claveCompra = `${transaccionEditar.comercio}_${transaccionEditar.cuotasTotal}cuotas`;
                    guardarDescripcionAprendida(claveCompra, cambios.descripcion);
                    console.log(`‚úÖ Aprendida descripci√≥n para cuotas: "${claveCompra}" ‚Üí "${cambios.descripcion}"`);
                }
            }

            setTransacciones(prev => prev.map(t =>
                t.id === transaccionEditar.id ? { ...t, ...cambios } : t
            ));

            setShowModalEditarTransaccion(false);
            setTransaccionEditar(null);
            mostrarToast('Transacci√≥n actualizada', 'success');
        } catch (error) {
            console.error('Error al actualizar:', error);
            mostrarToast('Error al actualizar transacci√≥n', 'error');
        }
    };

    // Si no hay meses seleccionados, mostrar estado inicial
    if (selectedMonths.length === 0) {
        return (
            <div className="max-w-7xl mx-auto">
                <EmptyState
                    icon="üìä"
                    title="Bienvenido a Analizador de Gastos TC"
                    description="Carga tu estado de cuenta desde PDF o CSV para comenzar a analizar tus gastos."
                    action={
                        <div className="flex flex-col sm:flex-row gap-4">
                            <button
                                onClick={() => setShowModalCargarPDF(true)}
                                className="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors shadow-lg flex items-center justify-center gap-2"
                            >
                                <span className="text-xl">üìë</span>
                                Cargar PDF
                            </button>
                            <button
                                onClick={() => setShowModalCargarCSV(true)}
                                className="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-lg flex items-center justify-center gap-2"
                            >
                                <span className="text-xl">üìÑ</span>
                                Cargar CSV
                            </button>
                        </div>
                    }
                />

                {showModalCargarPDF && (
                    <ModalCargarPDF
                        onClose={() => setShowModalCargarPDF(false)}
                        onSuccess={async (mesAnioId) => {
                            await refreshMesesCargados();
                            const mes = await db.mesesCarga.get(mesAnioId);
                            setSelectedMonth(mes);
                            setSelectedMonths([mes]);
                            setShowModalCargarPDF(false);
                            mostrarToast('PDF cargado exitosamente üìë', 'success');
                        }}
                    />
                )}

                {showModalCargarCSV && (
                    <ModalCargarCSV
                        onClose={() => setShowModalCargarCSV(false)}
                        onSuccess={async (mesAnioId) => {
                            console.log('üéØ onSuccess llamado con mesAnioId:', mesAnioId);

                            console.log('üîÑ Refrescando meses cargados...');
                            await refreshMesesCargados();

                            console.log('üìÖ Obteniendo mes de DB...');
                            const mes = await db.mesesCarga.get(mesAnioId);
                            console.log('‚úÖ Mes obtenido:', mes);

                            setSelectedMonth(mes);
                            setSelectedMonths([mes]);

                            // Cargar transacciones directamente sin esperar a que selectedMonths se actualice
                            console.log('üìä Cargando transacciones del mes...');

                            // WORKAROUND: db.js no se actualiza en GitHub Pages, usar query directa
                            const todasTrans = await db.transacciones.toArray();
                            const trans = todasTrans.filter(t => t.mesAnioId === mesAnioId);
                            console.log(`‚úÖ Transacciones cargadas: ${trans.length} (de ${todasTrans.length} totales)`);

                            const todosPres = await db.presupuestos.toArray();
                            const pres = todosPres.filter(p => p.mesAnioId === mesAnioId);
                            console.log(`‚úÖ Presupuestos cargados: ${pres.length}`);

                            const ings = await getIngresos(mes.mesAnio);
                            console.log(`‚úÖ Ingresos cargados: ${ings.length}`);

                            console.log('üíæ Actualizando estado de React...');
                            setTransacciones(trans);
                            setPresupuestos(pres);
                            setIngresos(ings);

                            console.log('‚úÖ Estado actualizado, cerrando modal');
                            setShowModalCargarCSV(false);
                            mostrarToast('CSV cargado exitosamente', 'success');
                            console.log('üéâ Proceso completado');
                        }}
                    />
                )}
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            {/* Header con selector de mes y bot√≥n cargar */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Dashboard de Gastos</h1>
                    <p className="text-gray-600">An√°lisis detallado de tus transacciones</p>
                </div>
                <button
                    onClick={() => setShowModalCargarCSV(true)}
                    className="px-6 py-3 bg-white text-indigo-600 font-semibold rounded-lg hover:bg-indigo-50 transition-colors shadow-lg"
                >
                    + Cargar CSV
                </button>
            </div>

            {/* Selector de Meses M√∫ltiple */}
            <div className="bg-white dark:bg-slate-800 rounded-lg shadow-md border border-gray-200 dark:border-slate-700 p-4">
                <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3 flex-1">
                        <span className="text-2xl">üìÖ</span>
                        <div className="flex-1">
                            <p className="text-sm font-semibold text-gray-800 dark:text-white mb-1">
                                {selectedMonths.length === 1
                                    ? getNombreMes(selectedMonths[0].mesAnio)
                                    : `${selectedMonths.length} meses seleccionados`
                                }
                            </p>
                            {selectedMonths.length > 1 && (
                                <div className="flex flex-wrap gap-1">
                                    {selectedMonths.slice(0, 3).map(mes => (
                                        <span
                                            key={mes.id}
                                            className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400"
                                        >
                                            {getNombreMes(mes.mesAnio)}
                                        </span>
                                    ))}
                                    {selectedMonths.length > 3 && (
                                        <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300">
                                            +{selectedMonths.length - 3} m√°s
                                        </span>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                    <button
                        onClick={() => setShowSelectorMeses(true)}
                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition-colors flex items-center space-x-2"
                    >
                        <span>Seleccionar meses</span>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
            </div>

            {/* Estad√≠sticas Clave - 4 cards principales */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <CardStat
                    label="Total del Mes"
                    value={formatearMonto(desglose.total)}
                    icon="üí∞"
                    color="indigo"
                />
                <CardStat
                    label="Spot"
                    value={formatearMonto(desglose.spot)}
                    icon="‚ö°"
                    color="blue"
                />
                <CardStat
                    label="Cuotas"
                    value={formatearMonto(desglose.cuotasMes + desglose.cuotasAnteriores)}
                    icon="üìä"
                    color="purple"
                    subtitle={`Mes: ${formatearMonto(desglose.cuotasMes)} | Anteriores: ${formatearMonto(desglose.cuotasAnteriores)}`}
                />
                <CardStat
                    label="Compartidos"
                    value={formatearMonto(transacciones.filter(t => t.esCompartido).reduce((sum, t) => sum + t.monto, 0))}
                    icon="üíë"
                    color="pink"
                    subtitle={balance && balance.montoNeto > 0 ? `${balance.deudor?.nombre} debe ${formatearMonto(balance.montoNeto)}` : 'Saldado'}
                />
            </div>

            {/* Gr√°fico Budget vs Real */}
            {presupuestos.length > 0 && (
                <GraficoBudgetVsReal
                    gastosPorCategoria={gastosPorCategoria}
                    presupuestos={presupuestos}
                    categorias={categorias}
                />
            )}

            {/* Resumen de Estados (Provisional vs Confirmado) */}
            <ResumenEstados transacciones={transacciones} />

            {/* Secciones Colapsables */}
            {ingresos.length > 0 && (
                <CollapsibleSection title="Balance Ingresos vs Gastos" icon="üí∞" defaultOpen={true}>
                    <div className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <CardStat
                                label="Ingresos Totales"
                                value={formatearMonto(balanceIngresos.totalIngresos)}
                                icon="üíµ"
                                color="green"
                            />
                            <CardStat
                                label="Gastos Totales"
                                value={formatearMonto(balanceIngresos.totalGastos)}
                                icon="üí≥"
                                color="red"
                            />
                            <CardStat
                                label={balanceIngresos.diferencia >= 0 ? "Ahorro del Mes" : "D√©ficit del Mes"}
                                value={formatearMonto(Math.abs(balanceIngresos.diferencia))}
                                icon={balanceIngresos.diferencia >= 0 ? "‚úÖ" : "‚ö†Ô∏è"}
                                color={balanceIngresos.diferencia >= 0 ? "green" : "red"}
                                subtitle={`${balanceIngresos.porcentajeGastado.toFixed(1)}% gastado`}
                            />
                        </div>

                        {balanceIngresos.diferencia >= 0 ? (
                            <div className="p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                                <p className="text-green-800 font-semibold">
                                    ‚úÖ ¬°Excelente! Este mes ahorraste {formatearMonto(balanceIngresos.diferencia)}.
                                    Revisa la secci√≥n de Proyecciones para ver cu√°ndo podr√≠as alcanzar tus metas.
                                </p>
                            </div>
                        ) : (
                            <div className="p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                                <p className="text-red-800 font-semibold">
                                    ‚ö†Ô∏è Este mes gastaste {formatearMonto(Math.abs(balanceIngresos.diferencia))} m√°s de lo que ingresaste.
                                    Revisa tus presupuestos y considera reducir gastos variables.
                                </p>
                            </div>
                        )}
                    </div>
                </CollapsibleSection>
            )}

            <CollapsibleSection title="Balance de Gastos Compartidos" icon="üíë" defaultOpen={false}>
                <BalanceCompartido transacciones={transacciones} perfiles={perfiles} />
            </CollapsibleSection>

            <CollapsibleSection title="Distribuci√≥n por Categor√≠as" icon="üìä" defaultOpen={false}>
                <GraficoDistribucion gastosPorCategoria={gastosPorCategoria} categorias={categorias} />
            </CollapsibleSection>

            {cuotasActivas.length > 0 && (
                <CollapsibleSection title="Proyecci√≥n de Cuotas Futuras (12 meses)" icon="üìà" defaultOpen={false}>
                    <GraficoProyeccionCuotas proyeccion={proyeccionCuotasFuturas} />
                </CollapsibleSection>
            )}

            {/* Transacciones como secci√≥n colapsable */}
            <CollapsibleSection title="Transacciones" icon="üí≥" defaultOpen={true}>
                {/* Tabs */}
                <div className="flex space-x-2 border-b border-gray-200 mb-4">
                    {[
                        { id: 'todas', label: 'Todas' },
                        { id: 'spot', label: 'Spot' },
                        { id: 'cuotasMes', label: 'Cuotas Mes' },
                        { id: 'cuotasAnteriores', label: 'Cuotas Anteriores' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2 font-semibold transition-colors ${
                                activeTab === tab.id
                                    ? 'border-b-2 border-indigo-600 text-indigo-600'
                                    : 'text-gray-600 hover:text-indigo-600'
                            }`}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>

                {/* Filtros */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <select
                        value={filtros.perfilId || ''}
                        onChange={(e) => setFiltros(prev => ({ ...prev, perfilId: e.target.value ? parseInt(e.target.value) : null }))}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    >
                        <option value="">Todos los perfiles</option>
                        {perfiles.map(p => (
                            <option key={p.id} value={p.id}>{p.nombre}</option>
                        ))}
                    </select>

                    <select
                        value={filtros.categoria || ''}
                        onChange={(e) => setFiltros(prev => ({ ...prev, categoria: e.target.value || null }))}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    >
                        <option value="">Todas las categor√≠as</option>
                        {categorias.map(c => (
                            <option key={c.id} value={c.id}>{c.icono} {c.nombre}</option>
                        ))}
                    </select>

                    <input
                        type="text"
                        placeholder="Buscar por descripci√≥n..."
                        value={filtros.busqueda}
                        onChange={(e) => setFiltros(prev => ({ ...prev, busqueda: e.target.value }))}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    />
                </div>

                {/* Lista de Transacciones */}
                <ListaTransacciones
                    transacciones={transaccionesFiltradas}
                    perfiles={perfiles}
                    categorias={categorias}
                    onEditar={handleEditarTransaccion}
                    onEliminar={handleEliminarTransaccion}
                />
            </CollapsibleSection>

            {/* Modales */}
            {showModalCargarCSV && (
                <ModalCargarCSV
                    onClose={() => setShowModalCargarCSV(false)}
                    onSuccess={async (mesAnioId) => {
                        console.log('üéØ onSuccess llamado con mesAnioId:', mesAnioId);

                        console.log('üîÑ Refrescando meses cargados...');
                        await refreshMesesCargados();

                        console.log('üìÖ Obteniendo mes de DB...');
                        const mes = await db.mesesCarga.get(mesAnioId);
                        console.log('‚úÖ Mes obtenido:', mes);

                        setSelectedMonth(mes);
                        setSelectedMonths([mes]);

                        // Cargar transacciones directamente sin esperar a que selectedMonths se actualice
                        console.log('üìä Cargando transacciones del mes...');

                        // WORKAROUND: db.js no se actualiza en GitHub Pages, usar query directa
                        const todasTrans = await db.transacciones.toArray();
                        const trans = todasTrans.filter(t => t.mesAnioId === mesAnioId);
                        console.log(`‚úÖ Transacciones cargadas: ${trans.length} (de ${todasTrans.length} totales)`);

                        const todosPres = await db.presupuestos.toArray();
                        const pres = todosPres.filter(p => p.mesAnioId === mesAnioId);
                        console.log(`‚úÖ Presupuestos cargados: ${pres.length}`);

                        const ings = await getIngresos(mes.mesAnio);
                        console.log(`‚úÖ Ingresos cargados: ${ings.length}`);

                        console.log('üíæ Actualizando estado de React...');
                        setTransacciones(trans);
                        setPresupuestos(pres);
                        setIngresos(ings);

                        console.log('‚úÖ Estado actualizado, cerrando modal');
                        setShowModalCargarCSV(false);
                        mostrarToast('CSV cargado exitosamente', 'success');
                        console.log('üéâ Proceso completado');
                    }}
                />
            )}

            {showModalEditarTransaccion && transaccionEditar && (
                <ModalEditarTransaccion
                    transaccion={transaccionEditar}
                    perfiles={perfiles}
                    categorias={categorias}
                    onClose={() => {
                        setShowModalEditarTransaccion(false);
                        setTransaccionEditar(null);
                    }}
                    onGuardar={handleGuardarEdicion}
                />
            )}

            {/* Modal Selector de Meses */}
            {showSelectorMeses && (
                <ModalSelectorMeses
                    mesesCargados={mesesCargados}
                    selectedMonths={selectedMonths}
                    onClose={() => setShowSelectorMeses(false)}
                    onToggleMes={toggleMesSeleccionado}
                    onSeleccionarTodos={seleccionarTodosMeses}
                    onLimpiarSeleccion={limpiarSeleccion}
                />
            )}

            {/* Toast */}
            {showToast && (
                <Toast
                    message={showToast.message}
                    type={showToast.type}
                    onClose={() => setShowToast(null)}
                />
            )}

            {/* Bot√≥n flotante con men√∫ expandible (FAB) */}
            <div className="fixed bottom-8 right-8 z-50">
                {/* Overlay para cerrar el men√∫ al hacer click fuera */}
                {showMenuFAB && (
                    <div
                        className="fixed inset-0 -z-10"
                        onClick={() => setShowMenuFAB(false)}
                    />
                )}

                {/* Opciones del men√∫ (se expanden hacia arriba) */}
                {showMenuFAB && (
                    <div className="absolute bottom-20 right-0 flex flex-col space-y-3 animate-slideIn">
                        {/* Opci√≥n: Entrada R√°pida */}
                        <button
                            onClick={() => {
                                setShowModalEntradaRapida(true);
                                setShowMenuFAB(false);
                            }}
                            className="flex items-center space-x-3 bg-white dark:bg-slate-800 text-gray-800 dark:text-white px-5 py-3 rounded-full shadow-xl hover:bg-indigo-50 dark:hover:bg-slate-700 transition-all transform hover:scale-105 whitespace-nowrap border-2 border-indigo-200 dark:border-indigo-800"
                        >
                            <span className="text-2xl">‚úçÔ∏è</span>
                            <span className="font-semibold">Entrada R√°pida</span>
                        </button>

                        {/* Opci√≥n: Cargar PDF */}
                        <button
                            onClick={() => {
                                setShowModalCargarPDF(true);
                                setShowMenuFAB(false);
                            }}
                            className="flex items-center space-x-3 bg-white dark:bg-slate-800 text-gray-800 dark:text-white px-5 py-3 rounded-full shadow-xl hover:bg-purple-50 dark:hover:bg-slate-700 transition-all transform hover:scale-105 whitespace-nowrap border-2 border-purple-200 dark:border-purple-800"
                        >
                            <span className="text-2xl">üìë</span>
                            <span className="font-semibold">Cargar PDF</span>
                        </button>

                        {/* Opci√≥n: Cargar CSV */}
                        <button
                            onClick={() => {
                                setShowModalCargarCSV(true);
                                setShowMenuFAB(false);
                            }}
                            className="flex items-center space-x-3 bg-white dark:bg-slate-800 text-gray-800 dark:text-white px-5 py-3 rounded-full shadow-xl hover:bg-green-50 dark:hover:bg-slate-700 transition-all transform hover:scale-105 whitespace-nowrap border-2 border-green-200 dark:border-green-800"
                        >
                            <span className="text-2xl">üìÑ</span>
                            <span className="font-semibold">Cargar CSV</span>
                        </button>
                    </div>
                )}

                {/* Bot√≥n principal */}
                <button
                    onClick={() => setShowMenuFAB(!showMenuFAB)}
                    className={`w-16 h-16 rounded-full shadow-2xl transition-all transform flex items-center justify-center text-3xl ${
                        showMenuFAB
                            ? 'bg-red-500 hover:bg-red-600 rotate-45'
                            : 'bg-indigo-600 hover:bg-indigo-700 hover:scale-110'
                    } text-white`}
                    title={showMenuFAB ? 'Cerrar men√∫' : 'Agregar gasto'}
                >
                    +
                </button>
            </div>

            {/* Modal Quick Add */}
            {showModalQuickAdd && (
                <ModalQuickAdd
                    onClose={() => setShowModalQuickAdd(false)}
                    onSuccess={async (nuevaTransaccion) => {
                        await cargarDatosDelMes();
                        setShowModalQuickAdd(false);
                        mostrarToast('Gasto agregado exitosamente', 'success');
                    }}
                />
            )}

            {/* Modal Entrada R√°pida */}
            {showModalEntradaRapida && (
                <EntradaRapida
                    onClose={() => setShowModalEntradaRapida(false)}
                    onSuccess={async () => {
                        await cargarDatosDeMeses();
                        setShowModalEntradaRapida(false);
                        mostrarToast('Gasto provisional agregado exitosamente üü†', 'success');
                    }}
                />
            )}

            {/* Modal Cargar PDF */}
            {showModalCargarPDF && (
                <ModalCargarPDF
                    onClose={() => setShowModalCargarPDF(false)}
                    onSuccess={async () => {
                        await refreshMesesCargados();
                        await cargarDatosDeMeses();
                        setShowModalCargarPDF(false);
                        mostrarToast('Transacciones del PDF cargadas exitosamente üìë', 'success');
                    }}
                />
            )}
        </div>
    );
};

// Componente Budget vs Real
const GraficoBudgetVsReal = memo(({ gastosPorCategoria, presupuestos, categorias }) => {
    const chartRef = useRef(null);
    const chartInstance = useRef(null);

    useEffect(() => {
        if (!chartRef.current) return;

        // Preparar datos para el gr√°fico
        const labels = [];
        const dataPresupuesto = [];
        const dataGastado = [];
        const backgroundColors = [];
        const gastadoColors = [];

        presupuestos.forEach(pres => {
            if (pres.monto > 0) {
                const categoria = categorias.find(c => c.id === pres.categoria);
                const gastado = gastosPorCategoria[pres.categoria] || 0;

                if (categoria) {
                    labels.push(categoria.nombre);
                    dataPresupuesto.push(pres.monto);
                    dataGastado.push(gastado);
                    backgroundColors.push(categoria.color);

                    // Si gastado > presupuesto, usar rojo, sino el color de la categor√≠a
                    gastadoColors.push(gastado > pres.monto ? '#dc2626' : categoria.color);
                }
            }
        });

        // Destruir gr√°fico anterior si existe
        if (chartInstance.current) {
            chartInstance.current.destroy();
        }

        // Crear nuevo gr√°fico
        const ctx = chartRef.current.getContext('2d');
        chartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Presupuesto',
                        data: dataPresupuesto,
                        backgroundColor: backgroundColors.map(color => color + '40'),
                        borderColor: backgroundColors,
                        borderWidth: 2
                    },
                    {
                        label: 'Gastado',
                        data: dataGastado,
                        backgroundColor: gastadoColors.map(color => color + 'CC'),
                        borderColor: gastadoColors,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const label = context.dataset.label || '';
                                const value = formatearMonto(context.parsed.y);
                                return `${label}: ${value}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => formatearMonto(value)
                        }
                    }
                }
            }
        });

        return () => {
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, [gastosPorCategoria, presupuestos, categorias]);

    if (presupuestos.length === 0) {
        return null;
    }

    return (
        <Card title="Presupuesto vs Gastado por Categor√≠a" icon="üìä">
            <div className="chart-container">
                <canvas ref={chartRef}></canvas>
            </div>
        </Card>
    );
});

// Componente auxiliar: Gr√°fico de distribuci√≥n con Chart.js
const GraficoDistribucion = memo(({ gastosPorCategoria, categorias }) => {
    const chartRef = useRef(null);
    const chartInstance = useRef(null);

    useEffect(() => {
        if (!chartRef.current) return;

        // Preparar datos para el gr√°fico
        const labels = [];
        const data = [];
        const backgroundColors = [];

        for (const [categoriaId, monto] of Object.entries(gastosPorCategoria)) {
            const categoria = categorias.find(c => c.id === categoriaId);
            if (categoria && monto > 0) {
                labels.push(categoria.nombre);
                data.push(monto);
                backgroundColors.push(categoria.color);
            }
        }

        // Destruir gr√°fico anterior si existe
        if (chartInstance.current) {
            chartInstance.current.destroy();
        }

        // Crear nuevo gr√°fico
        const ctx = chartRef.current.getContext('2d');
        chartInstance.current = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: backgroundColors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const label = context.label || '';
                                const value = formatearMonto(context.parsed);
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        return () => {
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, [gastosPorCategoria, categorias]);

    if (Object.keys(gastosPorCategoria).length === 0) {
        return (
            <div className="text-center text-gray-500 py-8">
                No hay datos para mostrar
            </div>
        );
    }

    return (
        <div className="chart-container">
            <canvas ref={chartRef}></canvas>
        </div>
    );
});

// Componente ListaTransacciones
const ListaTransacciones = memo(({ transacciones, perfiles, categorias, onEditar, onEliminar }) => {
    if (transacciones.length === 0) {
        return (
            <EmptyState
                icon="üì≠"
                title="No hay transacciones"
                description="No se encontraron transacciones con los filtros seleccionados."
            />
        );
    }

    return (
        <div className="space-y-3">
            {transacciones.map(t => {
                const perfil = perfiles.find(p => p.id === t.perfilId);
                const categoria = categorias.find(c => c.id === t.categoria);

                return (
                    <div
                        key={t.id}
                        className="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                    >
                        <div className="flex items-center space-x-4 flex-1">
                            {/* Icono de categor√≠a */}
                            <div className="text-3xl">{categoria?.icono || 'üì¶'}</div>

                            {/* Informaci√≥n principal */}
                            <div className="flex-1">
                                <div className="flex items-center space-x-2 flex-wrap">
                                    <p className="font-semibold text-gray-800 dark:text-white">{t.comercio}</p>

                                    {/* Badge de estado (provisional/confirmado) */}
                                    {t.estado === 'provisional' && (
                                        <Badge color="orange" size="sm" title="Gasto ingresado manualmente, pendiente de confirmar con CSV">
                                            üü† Provisional
                                        </Badge>
                                    )}

                                    {t.cuotaActual && (
                                        <Badge color="blue" size="sm">
                                            {t.cuotaActual}/{t.cuotasTotal}
                                        </Badge>
                                    )}
                                    {t.esCompartido && (
                                        <Badge color="pink" size="sm">
                                            üíë 50/50
                                        </Badge>
                                    )}
                                    {perfil && (
                                        <Badge color="gray" size="sm">
                                            {perfil.nombre}
                                        </Badge>
                                    )}
                                </div>
                                <p className="text-sm text-gray-600">{truncarTexto(t.descripcion, 50)}</p>
                                <div className="flex items-center space-x-3 mt-1 text-xs text-gray-500">
                                    <span>{formatearFecha(t.fecha)}</span>
                                    <span>‚Ä¢</span>
                                    <span>{categoria?.nombre || 'Sin categor√≠a'}</span>
                                </div>
                            </div>

                            {/* Monto */}
                            <div className="text-right">
                                <p className="text-xl font-bold text-gray-800 dark:text-white">{formatearMonto(t.monto)}</p>
                            </div>
                        </div>

                        {/* Acciones */}
                        <div className="flex items-center space-x-2 ml-4">
                            <button
                                onClick={() => onEditar(t)}
                                className="p-2 text-indigo-600 hover:bg-indigo-100 rounded-lg transition-colors"
                                title="Editar"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button
                                onClick={() => onEliminar(t.id)}
                                className="p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors"
                                title="Eliminar"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                );
            })}
        </div>
    );
});

// Componente Balance Compartido (US-009)
const BalanceCompartido = memo(({ transacciones, perfiles }) => {
    // Si no hay transacciones compartidas, no mostrar
    const tieneCompartidos = transacciones.some(t => t.esCompartido);
    if (!tieneCompartidos || perfiles.length < 2) return null;

    // Calcular balance entre los dos primeros perfiles
    const perfilId1 = perfiles[0].id;
    const perfilId2 = perfiles[1]?.id;

    const balance = calcularBalanceCompartido(transacciones, perfilId1, perfilId2);

    if (balance.cantidadTransacciones === 0) return null;

    const perfilDeudor = perfiles.find(p => p.id === balance.quienDebe);
    const perfilAcreedor = perfiles.find(p => p.id === balance.quienRecibe);

    return (
        <Card title="Balance de Gastos Compartidos" icon="üíë">
            <div className="space-y-4">
                {/* Resumen de transacciones compartidas */}
                <div className="grid grid-cols-2 gap-4">
                    <div className="bg-indigo-50 rounded-lg p-4">
                        <p className="text-sm text-indigo-600 font-medium mb-1">Transacciones Compartidas</p>
                        <p className="text-2xl font-bold text-indigo-900">{balance.cantidadTransacciones}</p>
                    </div>
                    <div className="bg-purple-50 rounded-lg p-4">
                        <p className="text-sm text-purple-600 font-medium mb-1">Total Compartido</p>
                        <p className="text-2xl font-bold text-purple-900">
                            {formatearMonto(balance.totalPagadoPerfil1 + balance.totalPagadoPerfil2)}
                        </p>
                    </div>
                </div>

                {/* Balance individual */}
                <div className="grid grid-cols-2 gap-4">
                    <div className="bg-gray-50 rounded-lg p-4">
                        <div className="flex items-center space-x-2 mb-2">
                            <div
                                className="w-3 h-3 rounded-full"
                                style={{ backgroundColor: perfiles[0].color }}
                            />
                            <p className="font-semibold text-gray-800 dark:text-white">{perfiles[0].nombre}</p>
                        </div>
                        <div className="space-y-1 text-sm">
                            <div className="flex justify-between">
                                <span className="text-gray-600">Pag√≥:</span>
                                <span className="font-semibold">{formatearMonto(balance.totalPagadoPerfil1)}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-600">Debe pagar:</span>
                                <span className="font-semibold">{formatearMonto(balance.debiaPagarPerfil1)}</span>
                            </div>
                        </div>
                    </div>
                    {perfilId2 && (
                        <div className="bg-gray-50 rounded-lg p-4">
                            <div className="flex items-center space-x-2 mb-2">
                                <div
                                    className="w-3 h-3 rounded-full"
                                    style={{ backgroundColor: perfiles[1].color }}
                                />
                                <p className="font-semibold text-gray-800 dark:text-white">{perfiles[1].nombre}</p>
                            </div>
                            <div className="space-y-1 text-sm">
                                <div className="flex justify-between">
                                    <span className="text-gray-600">Pag√≥:</span>
                                    <span className="font-semibold">{formatearMonto(balance.totalPagadoPerfil2)}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-600">Debe pagar:</span>
                                    <span className="font-semibold">{formatearMonto(balance.debiaPagarPerfil2)}</span>
                                </div>
                            </div>
                        </div>
                    )}
                </div>

                {/* Sugerencia de transferencia */}
                {balance.saldoNeto > 0 && perfilDeudor && perfilAcreedor && (
                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4">
                        <div className="flex items-start space-x-3">
                            <div className="text-3xl">üí∏</div>
                            <div className="flex-1">
                                <p className="font-semibold text-green-900 mb-1">Sugerencia de Transferencia</p>
                                <p className="text-sm text-green-800">
                                    <span className="font-bold">{perfilDeudor.nombre}</span> debe transferir{' '}
                                    <span className="font-bold text-lg">{formatearMonto(balance.saldoNeto)}</span> a{' '}
                                    <span className="font-bold">{perfilAcreedor.nombre}</span> para saldar las cuentas del mes.
                                </p>
                            </div>
                        </div>
                    </div>
                )}

                {/* Estado de balance */}
                {balance.saldoNeto === 0 && (
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                        <p className="text-green-800 font-semibold">
                            ‚úÖ Las cuentas est√°n saldadas
                        </p>
                    </div>
                )}
            </div>
        </Card>
    );
});

// Componente Resumen de Estados (Provisional vs Confirmado) - v3.4
const ResumenEstados = memo(({ transacciones }) => {
    const provisional = transacciones.filter(t => t.estado === 'provisional');
    const confirmado = transacciones.filter(t => t.estado === 'confirmado' || !t.estado);

    const montoProvisional = provisional.reduce((sum, t) => sum + t.monto, 0);
    const montoConfirmado = confirmado.reduce((sum, t) => sum + t.monto, 0);
    const montoTotal = montoProvisional + montoConfirmado;

    const porcentajeProvisional = montoTotal > 0 ? (montoProvisional / montoTotal) * 100 : 0;
    const porcentajeConfirmado = montoTotal > 0 ? (montoConfirmado / montoTotal) * 100 : 0;

    // Solo mostrar si hay transacciones provisionales
    if (provisional.length === 0) {
        return null;
    }

    return (
        <Card>
            <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-bold text-gray-900 dark:text-white">
                    üìä Estado de Transacciones
                </h3>
                <span className="text-sm text-gray-500 dark:text-gray-400">
                    {transacciones.length} total
                </span>
            </div>

            <div className="space-y-4">
                {/* Provisional */}
                <div>
                    <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center space-x-2">
                            <span className="text-sm font-semibold text-orange-700 dark:text-orange-400">
                                üü† Provisionales
                            </span>
                            <span className="text-xs text-gray-500 dark:text-gray-400">
                                ({provisional.length} transacciones)
                            </span>
                        </div>
                        <span className="text-sm font-bold text-orange-700 dark:text-orange-400">
                            {formatearMonto(montoProvisional)}
                        </span>
                    </div>
                    <div className="w-full h-2 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden">
                        <div
                            className="h-full bg-gradient-to-r from-orange-400 to-orange-600"
                            style={{ width: `${porcentajeProvisional}%` }}
                        />
                    </div>
                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        {porcentajeProvisional.toFixed(1)}% del total
                    </p>
                </div>

                {/* Confirmado */}
                <div>
                    <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center space-x-2">
                            <span className="text-sm font-semibold text-green-700 dark:text-green-400">
                                ‚úÖ Confirmados
                            </span>
                            <span className="text-xs text-gray-500 dark:text-gray-400">
                                ({confirmado.length} transacciones)
                            </span>
                        </div>
                        <span className="text-sm font-bold text-green-700 dark:text-green-400">
                            {formatearMonto(montoConfirmado)}
                        </span>
                    </div>
                    <div className="w-full h-2 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden">
                        <div
                            className="h-full bg-gradient-to-r from-green-400 to-green-600"
                            style={{ width: `${porcentajeConfirmado}%` }}
                        />
                    </div>
                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        {porcentajeConfirmado.toFixed(1)}% del total
                    </p>
                </div>

                {/* Total Proyectado */}
                <div className="pt-3 border-t border-gray-200 dark:border-slate-700">
                    <div className="flex items-center justify-between">
                        <span className="text-sm font-bold text-gray-900 dark:text-white">
                            Total Proyectado
                        </span>
                        <span className="text-lg font-bold text-indigo-600 dark:text-indigo-400">
                            {formatearMonto(montoTotal)}
                        </span>
                    </div>
                </div>

                {/* Alerta si hay muchos provisionales */}
                {porcentajeProvisional > 30 && (
                    <div className="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-3">
                        <p className="text-xs text-orange-800 dark:text-orange-300">
                            ‚ö†Ô∏è Tienes un alto porcentaje de gastos provisionales. Recuerda cargar el CSV del mes para confirmarlos.
                        </p>
                    </div>
                )}
            </div>
        </Card>
    );
});

// Componente Card Disponible para Gastar (US-008)
const CardDisponible = memo(({ disponible, categorias }) => {
    const {
        disponibleTotal,
        presupuestoTotal,
        gastadoTotal,
        cuotasProyectadas,
        disponiblePorCategoria
    } = disponible;

    // Determinar color y estado seg√∫n disponible
    const getColorDisponible = (disponible, presupuesto) => {
        const porcentaje = (disponible / presupuesto) * 100;
        if (porcentaje >= 50) return { bg: 'bg-green-50', border: 'border-green-300', text: 'text-green-900', icon: '‚úÖ' };
        if (porcentaje >= 20) return { bg: 'bg-yellow-50', border: 'border-yellow-300', text: 'text-yellow-900', icon: '‚ö†Ô∏è' };
        return { bg: 'bg-red-50', border: 'border-red-300', text: 'text-red-900', icon: 'üö®' };
    };

    const colorEstado = getColorDisponible(disponibleTotal, presupuestoTotal);

    return (
        <div className={`${colorEstado.bg} border-2 ${colorEstado.border} rounded-xl p-6 shadow-lg animate-slideIn`}>
            <div className="space-y-4">
                {/* Header */}
                <div className="flex items-center justify-between">
                    <div>
                        <div className="flex items-center space-x-2">
                            <span className="text-2xl">{colorEstado.icon}</span>
                            <h3 className="text-lg font-bold text-gray-700">Disponible para Gastar</h3>
                        </div>
                        <p className="text-sm text-gray-600 mt-1">
                            Presupuesto - Gastado - Cuotas Proyectadas
                        </p>
                    </div>
                </div>

                {/* Monto Disponible Destacado */}
                <div className="text-center py-4">
                    <p className="text-sm text-gray-600 mb-1">Te quedan disponibles</p>
                    <p className={`text-5xl font-black ${colorEstado.text}`}>
                        {formatearMonto(disponibleTotal)}
                    </p>
                </div>

                {/* Desglose */}
                <div className="grid grid-cols-3 gap-4 pt-4 border-t border-gray-300">
                    <div className="text-center">
                        <p className="text-xs text-gray-600 mb-1">Presupuesto</p>
                        <p className="text-lg font-bold text-gray-800 dark:text-white">{formatearMonto(presupuestoTotal)}</p>
                    </div>
                    <div className="text-center">
                        <p className="text-xs text-gray-600 dark:text-gray-400 mb-1">Gastado</p>
                        <p className="text-lg font-bold text-gray-800 dark:text-white">-{formatearMonto(gastadoTotal)}</p>
                    </div>
                    <div className="text-center">
                        <p className="text-xs text-gray-600 dark:text-gray-400 mb-1">Cuotas Futuras</p>
                        <p className="text-lg font-bold text-gray-800 dark:text-white">-{formatearMonto(cuotasProyectadas)}</p>
                    </div>
                </div>

                {/* Disponible por Categor√≠a */}
                {disponiblePorCategoria.length > 0 && (
                    <div className="pt-4 border-t border-gray-300">
                        <p className="text-sm font-semibold text-gray-700 mb-3">Disponible por Categor√≠a:</p>
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            {disponiblePorCategoria.slice(0, 8).map(cat => {
                                const categoria = categorias.find(c => c.id === cat.categoria);
                                const isNegative = cat.disponible < 0;

                                return (
                                    <div
                                        key={cat.categoria}
                                        className={`${isNegative ? 'bg-red-100 border-red-200' : 'bg-white border-gray-200'} border rounded-lg p-3 text-center`}
                                    >
                                        <div className="text-2xl mb-1">{categoria?.icono || 'üì¶'}</div>
                                        <p className="text-xs text-gray-600 truncate">{categoria?.nombre || 'Sin nombre'}</p>
                                        <p className={`text-sm font-bold ${isNegative ? 'text-red-700' : 'text-gray-800'}`}>
                                            {formatearMonto(cat.disponible)}
                                        </p>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
});

// Modal Quick Add - Agregar gasto r√°pido
const ModalQuickAdd = ({ onClose, onSuccess }) => {
    const { selectedMonth, perfiles, categorias } = useApp();
    const [comercio, setComercio] = useState('');
    const [monto, setMonto] = useState('');
    const [categoria, setCategoria] = useState('');
    const [perfilId, setPerfilId] = useState(perfiles[0]?.id || 1);
    const [fecha, setFecha] = useState(new Date().toISOString().split('T')[0]);
    const [cuotas, setCuotas] = useState('1');
    const [guardando, setGuardando] = useState(false);
    const [sugerenciasComercios, setSugerenciasComercios] = useState([]);
    const [mostrarSugerencias, setMostrarSugerencias] = useState(false);
    const [esCompartido, setEsCompartido] = useState(false);

    // Cargar hist√≥rico de comercios para autocompletado
    useEffect(() => {
        const cargarComercios = async () => {
            const todas = await db.transacciones.toArray();
            const comerciosUnicos = [...new Set(todas.map(t => t.comercio))].sort();
            setSugerenciasComercios(comerciosUnicos);
        };
        cargarComercios();
    }, []);

    // Autocompletar categor√≠a cuando selecciona comercio
    const handleComercioChange = (valor) => {
        setComercio(valor);

        // Intentar categorizar autom√°ticamente
        const categoriaAprendida = categorizarConAprendizaje({ comercio: valor });
        if (categoriaAprendida) {
            setCategoria(categoriaAprendida);
        }
    };

    const handleGuardar = async () => {
        if (!comercio || !monto || !categoria) {
            alert('Por favor completa todos los campos obligatorios');
            return;
        }

        setGuardando(true);
        try {
            const cuotasNum = parseInt(cuotas) || 1;
            const transaccion = {
                mesAnioId: selectedMonth.id,
                mesAnio: selectedMonth.mesAnio,
                fecha,
                descripcion: comercio,
                comercio,
                monto: parseInt(monto),
                categoria,
                perfilId,
                cuotaActual: 1,
                cuotasTotal: cuotasNum,
                esCompartido,
                perfilCompartidoId: esCompartido ? perfiles.find(p => p.id !== perfilId)?.id : null,
                porcentajePerfil: 50
            };

            await addTransaccion(transaccion);

            // Aprender la categorizaci√≥n
            aprenderCategorizacion(comercio, categoria);

            onSuccess(transaccion);
        } catch (error) {
            console.error('Error al guardar:', error);
            alert('Error al guardar el gasto');
        } finally {
            setGuardando(false);
        }
    };

    // Filtrar sugerencias basado en lo que escribe
    const sugerenciasFiltradas = comercio.length >= 2
        ? sugerenciasComercios.filter(c =>
            c.toLowerCase().includes(comercio.toLowerCase())
          ).slice(0, 5)
        : [];

    return (
        <Modal
            isOpen={true}
            onClose={onClose}
            title="‚ö° Agregar Gasto R√°pido"
            size="md"
        >
            <div className="space-y-4">
                {/* Comercio con autocompletado */}
                <div className="relative">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Comercio *
                    </label>
                    <input
                        type="text"
                        value={comercio}
                        onChange={(e) => handleComercioChange(e.target.value)}
                        onFocus={() => setMostrarSugerencias(true)}
                        onBlur={() => setTimeout(() => setMostrarSugerencias(false), 200)}
                        placeholder="Ej: Unimarc, Copec, Netflix..."
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        autoFocus
                    />

                    {/* Sugerencias de autocompletado */}
                    {mostrarSugerencias && sugerenciasFiltradas.length > 0 && (
                        <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                            {sugerenciasFiltradas.map((sugerencia, idx) => (
                                <button
                                    key={idx}
                                    type="button"
                                    onClick={() => {
                                        handleComercioChange(sugerencia);
                                        setMostrarSugerencias(false);
                                    }}
                                    className="w-full text-left px-4 py-2 hover:bg-indigo-50 transition-colors"
                                >
                                    {sugerencia}
                                </button>
                            ))}
                        </div>
                    )}
                </div>

                {/* Monto */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Monto *
                    </label>
                    <div className="flex items-center">
                        <span className="text-gray-600 mr-2">$</span>
                        <input
                            type="number"
                            value={monto}
                            onChange={(e) => setMonto(e.target.value)}
                            placeholder="0"
                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            min="0"
                        />
                    </div>
                </div>

                {/* Categor√≠a */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Categor√≠a *
                    </label>
                    <select
                        value={categoria}
                        onChange={(e) => setCategoria(e.target.value)}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    >
                        <option value="">Seleccionar...</option>
                        {categorias.map(c => (
                            <option key={c.id} value={c.id}>
                                {c.icono} {c.nombre}
                            </option>
                        ))}
                    </select>
                </div>

                {/* Fila: Perfil, Fecha, Cuotas */}
                <div className="grid grid-cols-3 gap-3">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Perfil
                        </label>
                        <select
                            value={perfilId}
                            onChange={(e) => setPerfilId(parseInt(e.target.value))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm"
                        >
                            {perfiles.map(p => (
                                <option key={p.id} value={p.id}>
                                    {p.nombre}
                                </option>
                            ))}
                        </select>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Fecha
                        </label>
                        <input
                            type="date"
                            value={fecha}
                            onChange={(e) => setFecha(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm"
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Cuotas
                        </label>
                        <input
                            type="number"
                            value={cuotas}
                            onChange={(e) => setCuotas(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm"
                            min="1"
                        />
                    </div>
                </div>

                {/* Checkbox de gasto compartido 50/50 */}
                {perfiles.length > 1 && (
                    <div className="border-t pt-4">
                        <div className="bg-pink-50 border border-pink-200 rounded-lg p-3">
                            <div className="flex items-start space-x-3">
                                <input
                                    type="checkbox"
                                    id="esCompartidoQuick"
                                    checked={esCompartido}
                                    onChange={(e) => setEsCompartido(e.target.checked)}
                                    className="w-5 h-5 text-pink-600 border-gray-300 rounded focus:ring-pink-500 mt-0.5 cursor-pointer"
                                />
                                <div className="flex-1">
                                    <label htmlFor="esCompartidoQuick" className="font-medium text-pink-900 cursor-pointer block">
                                        üíë Gasto compartido 50/50
                                    </label>
                                    {esCompartido && monto && (
                                        <p className="text-sm text-pink-700 mt-1">
                                            Este gasto se dividir√° en partes iguales: ${Math.round(parseInt(monto) / 2).toLocaleString('es-CL')} cada uno
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Botones */}
                <div className="flex space-x-3 pt-4">
                    <button
                        type="button"
                        onClick={onClose}
                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button
                        onClick={handleGuardar}
                        disabled={guardando || !comercio || !monto || !categoria}
                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 font-semibold"
                    >
                        {guardando ? 'Guardando...' : '‚úì Guardar'}
                    </button>
                </div>
            </div>
        </Modal>
    );
};

// Modal para cargar CSV (US-008: con selector de mes/a√±o)
const ModalCargarCSV = ({ onClose, onSuccess }) => {
    const { perfiles, categorias } = useApp();
    const [paso, setPaso] = useState(1); // 1: Mes/a√±o, 2: Subir, 3: Perfil y Modo, 4: Preview/Revisi√≥n, 5: Guardar
    const [anioSeleccionado, setAnioSeleccionado] = useState(new Date().getFullYear());
    const [mesSeleccionado, setMesSeleccionado] = useState(null);
    const [archivo, setArchivo] = useState(null);
    const [perfilSeleccionado, setPerfilSeleccionado] = useState(perfiles[0]?.id || 1);
    const [transaccionesParsed, setTransaccionesParsed] = useState([]);
    const [procesando, setProcesando] = useState(false);
    const [error, setError] = useState(null);
    const [mesAnioIdGuardado, setMesAnioIdGuardado] = useState(null);

    // Modo de revisi√≥n: 'auto' o 'manual'
    const [modoRevision, setModoRevision] = useState('auto');

    // Estados para revisi√≥n manual
    const [indiceRevisionActual, setIndiceRevisionActual] = useState(0);
    const [transaccionesRevisadas, setTransaccionesRevisadas] = useState([]);
    const [transaccionActualEdit, setTransaccionActualEdit] = useState(null);

    // Estados para gastos compartidos masivos
    const [todasCompartidas, setTodasCompartidas] = useState(false);
    const [perfilCompartidoMasivo, setPerfilCompartidoMasivo] = useState(null);
    const [porcentajeMasivo, setPorcentajeMasivo] = useState(50);

    // Estados para selecci√≥n masiva en preview
    const [transaccionesSeleccionadas, setTransaccionesSeleccionadas] = useState([]);
    const [filtroCategoria, setFiltroCategoria] = useState('todas');

    // Estados para reconciliaci√≥n (v3.4)
    const [mostrarReconciliacion, setMostrarReconciliacion] = useState(false);
    const [resultadoReconciliacion, setResultadoReconciliacion] = useState(null);

    const aniosDisponibles = [new Date().getFullYear(), new Date().getFullYear() - 1];
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    const handleArchivoChange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setError(null);
        setProcesando(true);

        try {
            // Validar CSV
            const validacion = await validarCSV(file);
            if (!validacion.valido) {
                setError(validacion.error);
                setProcesando(false);
                return;
            }

            setArchivo(file);
            setProcesando(false);
            setPaso(3); // Ir a selecci√≥n de perfil
        } catch (err) {
            setError('Error al leer el archivo');
            setProcesando(false);
        }
    };

    const handleProcesarCSV = async () => {
        if (!archivo || !mesSeleccionado || !perfilSeleccionado) return;

        setProcesando(true);
        setError(null);

        try {
            // Parsear CSV
            const transacciones = await parsearCSV(archivo);

            // Categorizar autom√°ticamente
            const transaccionesCategorizadas = categorizarLote(transacciones);

            // Asignar perfil, mes y opciones de compartido
            const mesAnio = `${anioSeleccionado}-${String(mesSeleccionado + 1).padStart(2, '0')}`;
            const transaccionesConPerfil = transaccionesCategorizadas.map(t => ({
                ...t,
                perfilId: perfilSeleccionado,
                mesAnio,
                esCompartido: todasCompartidas,
                perfilCompartidoId: todasCompartidas ? perfilCompartidoMasivo : null,
                porcentajePerfil: todasCompartidas ? porcentajeMasivo : 50
            }));

            setTransaccionesParsed(transaccionesConPerfil);

            // Si es modo manual, inicializar revisi√≥n
            if (modoRevision === 'manual') {
                setIndiceRevisionActual(0);
                setTransaccionesRevisadas([]);
                setTransaccionActualEdit(transaccionesConPerfil[0]);
            }

            setPaso(4); // Mostrar preview o revisi√≥n manual
            setProcesando(false);
        } catch (err) {
            console.error('Error al procesar CSV:', err);
            setError('Error al procesar el archivo CSV');
            setProcesando(false);
        }
    };

    // Funciones para revisi√≥n manual
    const handleAceptarTransaccion = () => {
        // Guardar la transacci√≥n editada
        const transaccionesActualizadas = [...transaccionesParsed];
        transaccionesActualizadas[indiceRevisionActual] = transaccionActualEdit;
        setTransaccionesParsed(transaccionesActualizadas);
        setTransaccionesRevisadas([...transaccionesRevisadas, transaccionActualEdit]);

        // Pasar a la siguiente
        if (indiceRevisionActual < transaccionesParsed.length - 1) {
            setIndiceRevisionActual(indiceRevisionActual + 1);
            setTransaccionActualEdit(transaccionesActualizadas[indiceRevisionActual + 1]);
        } else {
            // Terminamos, ir a paso de guardar
            setPaso(5);
        }
    };

    const handleSaltarTransaccion = () => {
        // Saltamos esta transacci√≥n (no la guardamos)
        if (indiceRevisionActual < transaccionesParsed.length - 1) {
            setIndiceRevisionActual(indiceRevisionActual + 1);
            setTransaccionActualEdit(transaccionesParsed[indiceRevisionActual + 1]);
        } else {
            // Terminamos
            setPaso(5);
        }
    };

    const handleEditTransaccionActual = (campo, valor) => {
        setTransaccionActualEdit({
            ...transaccionActualEdit,
            [campo]: valor
        });
    };

    // Funciones para selecci√≥n masiva
    const toggleSeleccion = (index) => {
        if (transaccionesSeleccionadas.includes(index)) {
            setTransaccionesSeleccionadas(transaccionesSeleccionadas.filter(i => i !== index));
        } else {
            setTransaccionesSeleccionadas([...transaccionesSeleccionadas, index]);
        }
    };

    const toggleSeleccionarTodas = () => {
        const transaccionesFiltradas = getTransaccionesFiltradas();
        const indicesFiltrados = transaccionesFiltradas.map(t => t.indiceOriginal);

        if (transaccionesSeleccionadas.length === indicesFiltrados.length) {
            setTransaccionesSeleccionadas([]);
        } else {
            setTransaccionesSeleccionadas(indicesFiltrados);
        }
    };

    const marcarSeleccionadasComoCompartidas = () => {
        if (perfiles.length < 2) return;

        const otroPerfil = perfiles.find(p => p.id !== perfilSeleccionado);
        if (!otroPerfil) return;

        const nuevasTransacciones = transaccionesParsed.map((t, index) => {
            if (transaccionesSeleccionadas.includes(index)) {
                return {
                    ...t,
                    esCompartido: true,
                    perfilCompartidoId: otroPerfil.id,
                    porcentajePerfil: 50
                };
            }
            return t;
        });

        setTransaccionesParsed(nuevasTransacciones);
        setTransaccionesSeleccionadas([]);
    };

    const desmarcarSeleccionadasComoCompartidas = () => {
        const nuevasTransacciones = transaccionesParsed.map((t, index) => {
            if (transaccionesSeleccionadas.includes(index)) {
                return {
                    ...t,
                    esCompartido: false,
                    perfilCompartidoId: null,
                    porcentajePerfil: 50
                };
            }
            return t;
        });

        setTransaccionesParsed(nuevasTransacciones);
        setTransaccionesSeleccionadas([]);
    };

    const getTransaccionesFiltradas = () => {
        return transaccionesParsed
            .map((t, index) => ({ ...t, indiceOriginal: index }))
            .filter(t => filtroCategoria === 'todas' || t.categoria === filtroCategoria);
    };

    const handleGuardar = async () => {
        console.log('üöÄ Iniciando guardado de transacciones...');
        setProcesando(true);
        try {
            const mesAnio = `${anioSeleccionado}-${String(mesSeleccionado + 1).padStart(2, '0')}`;
            console.log('üìÖ Mes/A√±o:', mesAnio);

            // Obtener o crear mes
            const mesAnioId = await getOrCreateMesAnio(mesAnio);
            console.log('‚úÖ Mes creado/obtenido ID:', mesAnioId);

            // Si es modo manual, solo guardar las revisadas
            const transaccionesAGuardar = modoRevision === 'manual'
                ? transaccionesRevisadas
                : transaccionesParsed;

            console.log(`üìù Transacciones a guardar: ${transaccionesAGuardar.length}`);

            // Agregar transacciones (marcadas como 'csv' y 'confirmado')
            const transaccionesParaGuardar = transaccionesAGuardar.map(t => ({
                ...t,
                mesAnioId,
                origen: 'csv',
                estado: 'confirmado',
                textoOriginal: null,
                transaccionRelacionadaId: null
            }));

            console.log('üíæ Guardando transacciones en DB...');
            console.log('üìã Muestra de transacci√≥n a guardar:', transaccionesParaGuardar[0]);
            console.log('üîë mesAnioId de la muestra:', transaccionesParaGuardar[0].mesAnioId);
            console.log('üìä Todas las propiedades:', Object.keys(transaccionesParaGuardar[0]));

            try {
                const resultado = await addTransacciones(transaccionesParaGuardar);
                console.log('‚úÖ Resultado de bulkAdd:', resultado);
                console.log('‚úÖ Transacciones guardadas exitosamente');

                // Verificar que realmente se guardaron
                const transVerificacion = await getTransaccionesByMes(mesAnioId);
                console.log(`üîç Verificaci√≥n inmediata: ${transVerificacion.length} transacciones en DB`);

                // DEBUG MANUAL: Inspeccionar DB directamente
                console.log('üî¨ DEBUG: Inspeccionando DB directamente...');
                const todasLasTrans = await db.transacciones.toArray();
                console.log(`üî¨ Total transacciones en toda la DB: ${todasLasTrans.length}`);

                if (todasLasTrans.length > 0) {
                    const ultima = todasLasTrans[todasLasTrans.length - 1];
                    console.log('üî¨ √öltima transacci√≥n guardada:', ultima);
                    console.log(`üî¨ mesAnioId de √∫ltima transacci√≥n: ${ultima.mesAnioId} (tipo: ${typeof ultima.mesAnioId})`);

                    const mesAnioIds = [...new Set(todasLasTrans.map(t => t.mesAnioId))];
                    console.log('üî¨ mesAnioIds √∫nicos en DB:', mesAnioIds);

                    // Contar por mesAnioId
                    const conteo = {};
                    todasLasTrans.forEach(t => {
                        conteo[t.mesAnioId] = (conteo[t.mesAnioId] || 0) + 1;
                    });
                    console.log('üî¨ Conteo por mesAnioId:', conteo);

                    // Verificar el tipo de mesAnioId que estamos buscando
                    console.log(`üî¨ Buscando mesAnioId: ${mesAnioId} (tipo: ${typeof mesAnioId})`);
                }
            } catch (bulkError) {
                console.error('‚ùå Error en bulkAdd:', bulkError);
                throw bulkError;
            }

            // Crear presupuestos base si no existen
            console.log('üìä Verificando presupuestos...');
            let presupuestosExistentes;
            try {
                presupuestosExistentes = await getPresupuestos(mesAnioId);
                console.log(`‚úÖ Presupuestos existentes: ${presupuestosExistentes.length}`);
            } catch (presError) {
                console.error('‚ùå Error al obtener presupuestos:', presError);
                presupuestosExistentes = [];
            }
            if (presupuestosExistentes.length === 0) {
                console.log('üìã Copiando plantilla de presupuestos...');
                const plantilla = await getPresupuestos(null);
                if (plantilla.length > 0) {
                    await savePresupuestos(plantilla.map(p => ({
                        categoria: p.categoria,
                        monto: p.monto
                    })), mesAnioId);
                    console.log('‚úÖ Presupuestos creados');
                }
            }

            // RECONCILIACI√ìN: Buscar transacciones manuales provisionales de este mes
            console.log('üîÑ Iniciando reconciliaci√≥n...');
            const resultado = await window.ejecutarReconciliacion(mesAnio);
            console.log('‚úÖ Reconciliaci√≥n completada:', resultado);

            setProcesando(false);

            // Guardar mesAnioId para usarlo despu√©s
            setMesAnioIdGuardado(mesAnioId);
            console.log('üíæ mesAnioId guardado:', mesAnioId);

            // Si hay transacciones para reconciliar, mostrar panel
            if (resultado.totalManuales > 0) {
                console.log('üîî Mostrando panel de reconciliaci√≥n');
                setResultadoReconciliacion(resultado);
                setMostrarReconciliacion(true);
            } else {
                console.log('‚úÖ Sin reconciliaci√≥n necesaria, llamando onSuccess');
                onSuccess(mesAnioId);
            }
        } catch (err) {
            console.error('Error al guardar:', err);
            setError('Error al guardar las transacciones');
            setProcesando(false);
        }
    };

    return (
        <>
        <Modal
            isOpen={true}
            onClose={onClose}
            title="Cargar CSV"
            size="md"
        >
            <div className="space-y-2.5 sm:space-y-6 max-w-md mx-auto sm:max-w-full">
                {/* Indicador de pasos - Responsive y m√°s compacto */}
                <div className="flex items-center justify-center gap-0.5 sm:gap-0 sm:justify-between overflow-x-auto pb-1">
                    {[1, 2, 3, 4].map(num => (
                        <div key={num} className="flex items-center flex-shrink-0">
                            <div className={`w-7 h-7 sm:w-10 sm:h-10 rounded-full flex items-center justify-center font-bold text-xs sm:text-base ${
                                paso >= num ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-600'
                            }`}>
                                {num}
                            </div>
                            {num < 4 && (
                                <div className={`w-4 sm:w-16 h-0.5 sm:h-1 ${paso > num ? 'bg-indigo-600' : 'bg-gray-200'}`} />
                            )}
                        </div>
                    ))}
                </div>

                {/* Paso 1: Seleccionar mes y a√±o */}
                {paso === 1 && (
                    <div className="space-y-2.5 sm:space-y-4">
                        <h3 className="text-sm sm:text-lg font-semibold">Selecciona el mes y a√±o</h3>

                        {/* Selector de a√±o - Responsive */}
                        <div className="flex gap-2 sm:gap-4">
                            {aniosDisponibles.map(anio => (
                                <button
                                    key={anio}
                                    onClick={() => setAnioSeleccionado(anio)}
                                    className={`flex-1 py-2 sm:py-3 rounded-lg font-semibold text-sm sm:text-base transition-colors ${
                                        anioSeleccionado === anio
                                            ? 'bg-indigo-600 text-white'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    {anio}
                                </button>
                            ))}
                        </div>

                        {/* Grilla de meses - 4 columnas en mobile para que entre todo */}
                        <div className="grid grid-cols-4 sm:grid-cols-3 gap-1.5 sm:gap-3">
                            {meses.map((mes, index) => (
                                <button
                                    key={index}
                                    onClick={() => {
                                        setMesSeleccionado(index);
                                        setPaso(2);
                                    }}
                                    className={`py-1.5 sm:py-4 px-0.5 rounded-md sm:rounded-lg font-semibold text-[11px] sm:text-base transition-colors ${
                                        mesSeleccionado === index
                                            ? 'bg-indigo-600 text-white'
                                            : 'bg-gray-50 text-gray-700 hover:bg-gray-100 border border-gray-200'
                                    }`}
                                >
                                    {mes}
                                </button>
                            ))}
                        </div>
                    </div>
                )}

                {/* Paso 2: Subir archivo */}
                {paso === 2 && (
                    <div className="space-y-3 sm:space-y-4">
                        <h3 className="text-sm sm:text-lg font-semibold">
                            CSV: {meses[mesSeleccionado]} {anioSeleccionado}
                        </h3>

                        <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 sm:p-8 text-center">
                            <input
                                type="file"
                                accept=".csv"
                                onChange={handleArchivoChange}
                                className="hidden"
                                id="file-upload"
                            />
                            <label
                                htmlFor="file-upload"
                                className="cursor-pointer flex flex-col items-center"
                            >
                                <svg className="w-10 h-10 sm:w-16 sm:h-16 text-gray-400 mb-2 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <p className="text-sm sm:text-lg font-semibold text-gray-700">Seleccionar archivo</p>
                                <p className="text-xs sm:text-sm text-gray-500 mt-1">o arrastra aqu√≠</p>
                                <p className="text-[10px] sm:text-xs text-gray-400 mt-1 sm:mt-2">CSV: Fecha;Descripci√≥n;Monto;Cuotas</p>
                            </label>
                        </div>

                        {error && (
                            <AlertBadge type="error">
                                {error}
                            </AlertBadge>
                        )}

                        <div className="flex space-x-2 sm:space-x-3">
                            <button
                                onClick={() => setPaso(1)}
                                className="flex-1 px-3 sm:px-4 py-2 text-sm sm:text-base border border-gray-300 rounded-lg hover:bg-gray-50"
                            >
                                Atr√°s
                            </button>
                        </div>
                    </div>
                )}

                {/* Paso 3: Seleccionar perfil y modo */}
                {paso === 3 && (
                    <div className="space-y-3 sm:space-y-4">
                        <h3 className="text-sm sm:text-lg font-semibold">Perfil y modo</h3>

                        {/* Selector de Perfil */}
                        <div>
                            <p className="text-xs sm:text-sm font-medium text-gray-700 mb-2">Perfil:</p>
                            <div className="grid grid-cols-1 gap-2 sm:gap-3">
                                {perfiles.map(perfil => (
                                    <button
                                        key={perfil.id}
                                        onClick={() => setPerfilSeleccionado(perfil.id)}
                                        className={`p-2.5 sm:p-4 rounded-lg border-2 transition-colors ${
                                            perfilSeleccionado === perfil.id
                                                ? 'border-indigo-600 bg-indigo-50'
                                                : 'border-gray-200 hover:border-indigo-300'
                                        }`}
                                    >
                                        <div className="flex items-center space-x-2 sm:space-x-3">
                                            <div
                                                className="w-3 h-3 sm:w-4 sm:h-4 rounded-full"
                                                style={{ backgroundColor: perfil.color }}
                                            />
                                            <span className="font-semibold text-sm sm:text-base">{perfil.nombre}</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Selector de Modo de Revisi√≥n */}
                        <div className="border-t pt-3 sm:pt-4">
                            <p className="text-xs sm:text-sm font-medium text-gray-700 mb-2">Modo:</p>
                            <div className="grid grid-cols-2 gap-2 sm:gap-3">
                                <button
                                    onClick={() => setModoRevision('auto')}
                                    className={`p-2 sm:p-4 rounded-lg border-2 transition-colors ${
                                        modoRevision === 'auto'
                                            ? 'border-green-600 bg-green-50'
                                            : 'border-gray-200 hover:border-green-300'
                                    }`}
                                >
                                    <div className="text-center">
                                        <span className="text-xl sm:text-3xl block mb-1 sm:mb-2">‚ö°</span>
                                        <p className="font-semibold text-gray-800 dark:text-white text-xs sm:text-base">Auto</p>
                                        <p className="text-[10px] sm:text-xs text-gray-600 mt-0.5 sm:mt-1 hidden sm:block">
                                            Carga r√°pida con categorizaci√≥n autom√°tica.
                                        </p>
                                    </div>
                                </button>

                                <button
                                    onClick={() => setModoRevision('manual')}
                                    className={`p-2 sm:p-4 rounded-lg border-2 transition-colors ${
                                        modoRevision === 'manual'
                                            ? 'border-blue-600 bg-blue-50'
                                            : 'border-gray-200 hover:border-blue-300'
                                    }`}
                                >
                                    <div className="text-center">
                                        <span className="text-xl sm:text-3xl block mb-1 sm:mb-2">üëÅÔ∏è</span>
                                        <p className="font-semibold text-gray-800 dark:text-white text-xs sm:text-base">Manual</p>
                                        <p className="text-[10px] sm:text-xs text-gray-600 mt-0.5 sm:mt-1 hidden sm:block">
                                            Revisa cada transacci√≥n una por una.
                                        </p>
                                    </div>
                                </button>
                            </div>
                        </div>

                        {/* Opci√≥n de gastos compartidos masivos */}
                        {perfiles.length > 1 && (
                            <div className="border-t pt-4 mt-4">
                                <div className="bg-pink-50 border border-pink-200 rounded-lg p-4">
                                    <div className="flex items-start space-x-3">
                                        <input
                                            type="checkbox"
                                            id="todasCompartidas"
                                            checked={todasCompartidas}
                                            onChange={(e) => {
                                                setTodasCompartidas(e.target.checked);
                                                if (e.target.checked) {
                                                    // Auto-seleccionar el primer perfil diferente al seleccionado
                                                    const otroPerfil = perfiles.find(p => p.id !== perfilSeleccionado);
                                                    if (otroPerfil) setPerfilCompartidoMasivo(otroPerfil.id);
                                                    setPorcentajeMasivo(50); // Siempre 50/50
                                                }
                                            }}
                                            className="w-5 h-5 text-pink-600 border-gray-300 rounded focus:ring-pink-500 mt-0.5"
                                        />
                                        <div className="flex-1">
                                            <label htmlFor="todasCompartidas" className="font-medium text-pink-900 cursor-pointer block mb-1">
                                                üíë Marcar todas como gastos compartidos 50/50
                                            </label>
                                            <p className="text-sm text-pink-700">
                                                Todas las transacciones se dividir√°n en partes iguales entre{' '}
                                                <strong>{perfiles.find(p => p.id === perfilSeleccionado)?.nombre}</strong> y{' '}
                                                <strong>{perfiles.find(p => p.id !== perfilSeleccionado)?.nombre}</strong>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="flex space-x-3">
                            <button
                                onClick={() => setPaso(2)}
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                            >
                                Atr√°s
                            </button>
                            <button
                                onClick={handleProcesarCSV}
                                disabled={procesando}
                                className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"
                            >
                                {procesando ? 'Procesando...' : 'Continuar'}
                            </button>
                        </div>
                    </div>
                )}

                {/* Paso 4: Preview (auto) o Revisi√≥n Manual */}
                {paso === 4 && modoRevision === 'manual' && transaccionActualEdit && (
                    <div className="space-y-4">
                        <div className="flex items-center justify-between">
                            <h3 className="text-lg font-semibold">üëÅÔ∏è Revisi√≥n Manual</h3>
                            <p className="text-sm text-gray-600">
                                {indiceRevisionActual + 1} de {transaccionesParsed.length}
                            </p>
                        </div>

                        {/* Progreso */}
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div
                                className="bg-indigo-600 h-2 rounded-full transition-all"
                                style={{ width: `${((indiceRevisionActual + 1) / transaccionesParsed.length) * 100}%` }}
                            ></div>
                        </div>

                        {/* Formulario de edici√≥n de transacci√≥n */}
                        <div className="bg-white border-2 border-indigo-300 rounded-lg p-6 space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                {/* Comercio */}
                                <div className="col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Comercio
                                    </label>
                                    <input
                                        type="text"
                                        value={transaccionActualEdit.comercio}
                                        onChange={(e) => handleEditTransaccionActual('comercio', e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    />
                                </div>

                                {/* Monto */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Monto
                                    </label>
                                    <input
                                        type="number"
                                        value={transaccionActualEdit.monto}
                                        onChange={(e) => handleEditTransaccionActual('monto', parseInt(e.target.value))}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    />
                                </div>

                                {/* Categor√≠a */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Categor√≠a
                                    </label>
                                    <select
                                        value={transaccionActualEdit.categoria}
                                        onChange={(e) => handleEditTransaccionActual('categoria', e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    >
                                        {categorias.map(c => (
                                            <option key={c.id} value={c.id}>
                                                {c.icono} {c.nombre}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                {/* Compartido */}
                                {perfiles.length > 1 && (
                                    <div className="col-span-2">
                                        <div className="flex items-center space-x-3 bg-pink-50 border border-pink-200 rounded-lg p-3">
                                            <input
                                                type="checkbox"
                                                id="esCompartidoEdit"
                                                checked={transaccionActualEdit.esCompartido}
                                                onChange={(e) => {
                                                    handleEditTransaccionActual('esCompartido', e.target.checked);
                                                    if (e.target.checked) {
                                                        const otroPerfil = perfiles.find(p => p.id !== perfilSeleccionado);
                                                        handleEditTransaccionActual('perfilCompartidoId', otroPerfil?.id);
                                                        handleEditTransaccionActual('porcentajePerfil', 50);
                                                    }
                                                }}
                                                className="w-5 h-5 text-pink-600"
                                            />
                                            <label htmlFor="esCompartidoEdit" className="flex-1 text-sm font-medium text-pink-900">
                                                üíë Gasto compartido 50/50 con {perfiles.find(p => p.id !== perfilSeleccionado)?.nombre}
                                            </label>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Botones */}
                        <div className="flex space-x-3">
                            <button
                                onClick={handleSaltarTransaccion}
                                className="px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 font-semibold"
                            >
                                ‚è≠Ô∏è Saltar
                            </button>
                            <button
                                onClick={handleAceptarTransaccion}
                                className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
                            >
                                ‚úì Aceptar y Siguiente
                            </button>
                        </div>
                    </div>
                )}

                {/* Paso 4: Preview autom√°tico (modo auto) */}
                {paso === 4 && modoRevision === 'auto' && (
                    <div className="space-y-4">
                        <div className="flex items-center justify-between">
                            <h3 className="text-lg font-semibold">Revisi√≥n de transacciones</h3>
                            <p className="text-sm text-gray-600">
                                {transaccionesParsed.filter(t => t.esCompartido).length} compartidas de {transaccionesParsed.length}
                            </p>
                        </div>

                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p className="text-sm text-blue-800">
                                üí° Selecciona las transacciones que quieres marcar como compartidas 50/50
                            </p>
                        </div>

                        {/* Controles de selecci√≥n masiva */}
                        <div className="flex items-center justify-between gap-3 flex-wrap">
                            <div className="flex items-center gap-3">
                                <select
                                    value={filtroCategoria}
                                    onChange={(e) => setFiltroCategoria(e.target.value)}
                                    className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                >
                                    <option value="todas">Todas las categor√≠as</option>
                                    {categorias.map(c => (
                                        <option key={c.id} value={c.id}>
                                            {c.icono} {c.nombre}
                                        </option>
                                    ))}
                                </select>

                                <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={transaccionesSeleccionadas.length === getTransaccionesFiltradas().length && getTransaccionesFiltradas().length > 0}
                                        onChange={toggleSeleccionarTodas}
                                        className="w-4 h-4 text-indigo-600 border-gray-300 rounded"
                                    />
                                    Seleccionar todas ({getTransaccionesFiltradas().length})
                                </label>
                            </div>

                            {transaccionesSeleccionadas.length > 0 && (
                                <div className="flex gap-2">
                                    <button
                                        onClick={marcarSeleccionadasComoCompartidas}
                                        className="px-3 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 text-sm font-medium"
                                    >
                                        üíë Marcar como compartidas ({transaccionesSeleccionadas.length})
                                    </button>
                                    <button
                                        onClick={desmarcarSeleccionadasComoCompartidas}
                                        className="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm font-medium"
                                    >
                                        Desmarcar ({transaccionesSeleccionadas.length})
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Tabla de transacciones */}
                        <div className="border border-gray-200 rounded-lg overflow-hidden">
                            <div className="max-h-96 overflow-y-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th className="px-3 py-2 text-left w-10"></th>
                                            <th className="px-3 py-2 text-left">Comercio</th>
                                            <th className="px-3 py-2 text-left">Categor√≠a</th>
                                            <th className="px-3 py-2 text-right">Monto</th>
                                            <th className="px-3 py-2 text-center">Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {getTransaccionesFiltradas().map((t) => {
                                            const categoria = categorias.find(c => c.id === t.categoria);
                                            const isSelected = transaccionesSeleccionadas.includes(t.indiceOriginal);

                                            return (
                                                <tr
                                                    key={t.indiceOriginal}
                                                    className={`border-t border-gray-100 hover:bg-gray-50 ${
                                                        t.esCompartido ? 'bg-pink-50' : ''
                                                    }`}
                                                >
                                                    <td className="px-3 py-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={isSelected}
                                                            onChange={() => toggleSeleccion(t.indiceOriginal)}
                                                            className="w-4 h-4 text-indigo-600 border-gray-300 rounded"
                                                        />
                                                    </td>
                                                    <td className="px-3 py-2 font-medium text-gray-800">
                                                        {t.comercio}
                                                        {t.cuotaActual && (
                                                            <span className="ml-2 text-xs text-gray-500">
                                                                {t.cuotaActual}/{t.cuotasTotales}
                                                            </span>
                                                        )}
                                                    </td>
                                                    <td className="px-3 py-2">
                                                        <span className="inline-flex items-center gap-1">
                                                            {categoria?.icono} {categoria?.nombre}
                                                        </span>
                                                    </td>
                                                    <td className="px-3 py-2 text-right font-bold">
                                                        {formatearMonto(t.monto)}
                                                    </td>
                                                    <td className="px-3 py-2 text-center">
                                                        {t.esCompartido && (
                                                            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-pink-100 text-pink-800">
                                                                üíë 50/50
                                                            </span>
                                                        )}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {error && (
                            <AlertBadge type="error">
                                {error}
                            </AlertBadge>
                        )}

                        <div className="flex space-x-3">
                            <button
                                onClick={() => setPaso(3)}
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                            >
                                Atr√°s
                            </button>
                            <button
                                onClick={handleGuardar}
                                disabled={procesando}
                                className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
                            >
                                {procesando ? 'Guardando...' : `Guardar ${transaccionesParsed.length} Transacciones`}
                            </button>
                        </div>
                    </div>
                )}

                {/* Paso 5: Confirmaci√≥n final (modo manual) */}
                {paso === 5 && modoRevision === 'manual' && (
                    <div className="space-y-4">
                        <h3 className="text-lg font-semibold">‚úÖ Revisi√≥n Completada</h3>

                        <div className="bg-green-50 border-2 border-green-200 rounded-lg p-6 text-center">
                            <p className="text-6xl mb-4">üéâ</p>
                            <p className="text-xl font-bold text-green-900 mb-2">
                                Has revisado todas las transacciones
                            </p>
                            <p className="text-gray-700">
                                {transaccionesRevisadas.length} transacciones listas para guardar
                            </p>
                            <p className="text-sm text-gray-600 mt-2">
                                (Saltadas: {transaccionesParsed.length - transaccionesRevisadas.length})
                            </p>
                        </div>

                        {/* Resumen */}
                        <div className="bg-white border border-gray-200 rounded-lg p-4">
                            <p className="text-sm font-semibold text-gray-700 mb-3">Resumen:</p>
                            <div className="grid grid-cols-2 gap-3 text-sm">
                                <div className="bg-blue-50 rounded p-3">
                                    <p className="text-blue-600 font-medium">Total a guardar</p>
                                    <p className="text-2xl font-bold text-blue-900">
                                        {transaccionesRevisadas.length}
                                    </p>
                                </div>
                                <div className="bg-pink-50 rounded p-3">
                                    <p className="text-pink-600 font-medium">Compartidas</p>
                                    <p className="text-2xl font-bold text-pink-900">
                                        {transaccionesRevisadas.filter(t => t.esCompartido).length}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div className="flex space-x-3">
                            <button
                                onClick={() => {
                                    setPaso(4);
                                    setIndiceRevisionActual(0);
                                    setTransaccionActualEdit(transaccionesParsed[0]);
                                }}
                                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                            >
                                ‚Üê Revisar de nuevo
                            </button>
                            <button
                                onClick={handleGuardar}
                                disabled={procesando}
                                className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 font-semibold"
                            >
                                {procesando ? 'Guardando...' : `üíæ Guardar ${transaccionesRevisadas.length} Transacciones`}
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </Modal>

        {/* Modal de Reconciliaci√≥n */}
        {mostrarReconciliacion && resultadoReconciliacion && (
            <Reconciliacion
                resultado={resultadoReconciliacion}
                onConfirmar={(resultado) => {
                    setMostrarReconciliacion(false);
                    onSuccess(mesAnioIdGuardado);
                    onClose();
                }}
                onCancelar={() => {
                    setMostrarReconciliacion(false);
                    onSuccess(mesAnioIdGuardado);
                    onClose();
                }}
            />
        )}
    </>
    );
};

// Modal para editar transacci√≥n
const ModalEditarTransaccion = ({ transaccion, perfiles, categorias, onClose, onGuardar }) => {
    const [form, setForm] = useState({
        descripcion: transaccion.descripcion,
        comercio: transaccion.comercio,
        monto: transaccion.monto,
        categoria: transaccion.categoria,
        perfilId: transaccion.perfilId,
        fecha: transaccion.fecha,
        esCompartido: transaccion.esCompartido || false,
        perfilCompartidoId: transaccion.perfilCompartidoId || null,
        porcentajePerfil: transaccion.porcentajePerfil || 50
    });

    const handleSubmit = (e) => {
        e.preventDefault();

        // Si la categor√≠a cambi√≥, guardar la asociaci√≥n para aprendizaje autom√°tico
        if (form.categoria !== transaccion.categoria) {
            window.aprenderCategorizacion(form.comercio, form.categoria);
        }

        onGuardar(form);
    };

    return (
        <Modal
            isOpen={true}
            onClose={onClose}
            title="Editar Transacci√≥n"
            size="md"
        >
            <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Comercio
                    </label>
                    <input
                        type="text"
                        value={form.comercio}
                        onChange={(e) => setForm({ ...form, comercio: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        required
                    />
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Descripci√≥n
                    </label>
                    <input
                        type="text"
                        value={form.descripcion}
                        onChange={(e) => setForm({ ...form, descripcion: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        required
                    />
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Monto
                    </label>
                    <input
                        type="number"
                        value={form.monto}
                        onChange={(e) => setForm({ ...form, monto: parseFloat(e.target.value) })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        required
                        min="0"
                        step="1"
                    />
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Categor√≠a
                    </label>
                    <select
                        value={form.categoria}
                        onChange={(e) => setForm({ ...form, categoria: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        required
                    >
                        {categorias.map(c => (
                            <option key={c.id} value={c.id}>
                                {c.icono} {c.nombre}
                            </option>
                        ))}
                    </select>
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Perfil
                    </label>
                    <select
                        value={form.perfilId}
                        onChange={(e) => setForm({ ...form, perfilId: parseInt(e.target.value) })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        required
                    >
                        {perfiles.map(p => (
                            <option key={p.id} value={p.id}>
                                {p.nombre}
                            </option>
                        ))}
                    </select>
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Fecha
                    </label>
                    <input
                        type="date"
                        value={form.fecha}
                        onChange={(e) => setForm({ ...form, fecha: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        required
                    />
                </div>

                {/* Secci√≥n de gastos compartidos */}
                {perfiles.length > 1 && (
                    <div className="border-t pt-4 mt-4">
                        <div className="bg-pink-50 border border-pink-200 rounded-lg p-3">
                            <div className="flex items-start space-x-3">
                                <input
                                    type="checkbox"
                                    id="esCompartido"
                                    checked={form.esCompartido}
                                    onChange={(e) => {
                                        const checked = e.target.checked;
                                        setForm({
                                            ...form,
                                            esCompartido: checked,
                                            porcentajePerfil: 50, // Siempre 50/50
                                            perfilCompartidoId: checked
                                                ? perfiles.find(p => p.id !== form.perfilId)?.id || null
                                                : null
                                        });
                                    }}
                                    className="w-5 h-5 text-pink-600 border-gray-300 rounded focus:ring-pink-500 mt-0.5"
                                />
                                <div className="flex-1">
                                    <label htmlFor="esCompartido" className="font-medium text-pink-900 cursor-pointer block">
                                        üíë Gasto compartido 50/50
                                    </label>
                                    {form.esCompartido && (
                                        <p className="text-sm text-pink-700 mt-1">
                                            Este gasto se dividir√° en partes iguales: {formatearMonto(form.monto / 2)} cada uno
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                <div className="flex space-x-3 pt-4">
                    <button
                        type="button"
                        onClick={onClose}
                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button
                        type="submit"
                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                    >
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </Modal>
    );
};

// Componente de gr√°fico de proyecci√≥n de cuotas futuras
const GraficoProyeccionCuotas = memo(({ proyeccion }) => {
    const chartRef = useRef(null);
    const chartInstance = useRef(null);

    useEffect(() => {
        if (!chartRef.current || proyeccion.length === 0) return;

        // Preparar datos
        const labels = proyeccion.map(p => p.mesNombre);
        const data = proyeccion.map(p => p.total);

        // Destruir gr√°fico anterior
        if (chartInstance.current) {
            chartInstance.current.destroy();
        }

        // Crear gr√°fico
        const ctx = chartRef.current.getContext('2d');
        chartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Monto en Cuotas',
                    data,
                    backgroundColor: 'rgba(99, 102, 241, 0.6)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                return `Total: ${window.formatearMonto(context.parsed.y)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value === 0) return String.fromCharCode(36) + '0';
                                return String.fromCharCode(36) + Math.round(value).toLocaleString('es-CL');
                            }
                        }
                    }
                }
            }
        });

        return () => {
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, [proyeccion]);

    if (proyeccion.length === 0) {
        return (
            <div className="text-center text-gray-500 py-8">
                No hay datos para mostrar
            </div>
        );
    }

    const containerStyle = { position: 'relative', height: '400px' };

    return (
        <div style={containerStyle}>
            <canvas ref={chartRef}></canvas>
        </div>
    );
});

// Modal para seleccionar m√∫ltiples meses
const ModalSelectorMeses = memo(({ mesesCargados, selectedMonths, onClose, onToggleMes, onSeleccionarTodos, onLimpiarSeleccion }) => {
    // Ordenar meses por fecha (m√°s reciente primero)
    const mesesOrdenados = useMemo(() => {
        return [...mesesCargados].sort((a, b) => {
            return new Date(b.mesAnio) - new Date(a.mesAnio);
        });
    }, [mesesCargados]);

    const isMesSeleccionado = (mes) => {
        return selectedMonths.some(m => m.id === mes.id);
    };

    return (
        <Modal
            isOpen={true}
            onClose={onClose}
            title="Seleccionar Meses"
            size="md"
        >
            <div className="space-y-4">
                {/* Botones de acci√≥n r√°pida */}
                <div className="flex items-center justify-between pb-3 border-b border-gray-200 dark:border-slate-700">
                    <div className="text-sm text-gray-600 dark:text-gray-400">
                        {selectedMonths.length} de {mesesCargados.length} meses seleccionados
                    </div>
                    <div className="flex space-x-2">
                        <button
                            onClick={onSeleccionarTodos}
                            className="px-3 py-1.5 text-xs font-semibold text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-lg transition-colors"
                        >
                            Seleccionar todos
                        </button>
                        <button
                            onClick={onLimpiarSeleccion}
                            className="px-3 py-1.5 text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
                        >
                            Limpiar
                        </button>
                    </div>
                </div>

                {/* Lista de meses con checkboxes */}
                <div className="max-h-96 overflow-y-auto space-y-2">
                    {mesesOrdenados.map(mes => {
                        const isSelected = isMesSeleccionado(mes);
                        return (
                            <label
                                key={mes.id}
                                className={`flex items-center justify-between p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                    isSelected
                                        ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20'
                                        : 'border-gray-200 dark:border-slate-700 hover:border-indigo-300 dark:hover:border-indigo-700 hover:bg-gray-50 dark:hover:bg-slate-800'
                                }`}
                            >
                                <div className="flex items-center space-x-3 flex-1">
                                    <input
                                        type="checkbox"
                                        checked={isSelected}
                                        onChange={() => onToggleMes(mes)}
                                        className="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"
                                    />
                                    <div className="flex-1">
                                        <p className={`text-sm font-semibold ${
                                            isSelected
                                                ? 'text-indigo-700 dark:text-indigo-400'
                                                : 'text-gray-800 dark:text-gray-200'
                                        }`}>
                                            {getNombreMes(mes.mesAnio)}
                                        </p>
                                        <p className="text-xs text-gray-500 dark:text-gray-400">
                                            Cargado el {formatearFecha(mes.fechaCarga)}
                                        </p>
                                    </div>
                                </div>
                                {isSelected && (
                                    <span className="text-indigo-600 dark:text-indigo-400">
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                        </svg>
                                    </span>
                                )}
                            </label>
                        );
                    })}
                </div>

                {/* Bot√≥n cerrar */}
                <div className="flex justify-end pt-3 border-t border-gray-200 dark:border-slate-700">
                    <button
                        onClick={onClose}
                        className="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition-colors"
                    >
                        Aplicar
                    </button>
                </div>
            </div>
        </Modal>
    );
});

    </script>

    <script type="text/babel">
        // Componente An√°lisis de Cierre - Proyecci√≥n, Comparativa e Insights

const AnalisisCierre = () => {
    const { selectedMonth, mesesCargados, categorias } = useApp();
    const [transaccionesActuales, setTransaccionesActuales] = useState([]);
    const [transaccionesAnteriores, setTransaccionesAnteriores] = useState([]);
    const [recurrentes, setRecurrentes] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (selectedMonth) {
            cargarDatos();
        }
    }, [selectedMonth]);

    const cargarDatos = async () => {
        setLoading(true);
        try {
            // Cargar transacciones del mes actual
            const transActuales = await getTransaccionesByMes(selectedMonth.id);
            setTransaccionesActuales(transActuales);

            // Cargar transacciones del mes anterior
            const mesAnterior = obtenerMesAnterior(selectedMonth.mesAnio);
            const mesAnteriorObj = mesesCargados.find(m => m.mesAnio === mesAnterior);
            if (mesAnteriorObj) {
                const transAnteriores = await getTransaccionesByMes(mesAnteriorObj.id);
                setTransaccionesAnteriores(transAnteriores);
            } else {
                setTransaccionesAnteriores([]);
            }

            // Cargar recurrentes
            const rec = await getRecurrentes();
            setRecurrentes(rec);
        } catch (error) {
            console.error('Error al cargar datos:', error);
        } finally {
            setLoading(false);
        }
    };

    // Obtener mes anterior en formato YYYY-MM
    const obtenerMesAnterior = (mesAnio) => {
        const [year, month] = mesAnio.split('-').map(Number);
        const fecha = new Date(year, month - 1, 1);
        fecha.setMonth(fecha.getMonth() - 1);
        const nuevoYear = fecha.getFullYear();
        const nuevoMes = String(fecha.getMonth() + 1).padStart(2, '0');
        return `${nuevoYear}-${nuevoMes}`;
    };

    // Obtener mes siguiente
    const obtenerMesSiguiente = (mesAnio) => {
        const [year, month] = mesAnio.split('-').map(Number);
        const fecha = new Date(year, month - 1, 1);
        fecha.setMonth(fecha.getMonth() + 1);
        const nuevoYear = fecha.getFullYear();
        const nuevoMes = String(fecha.getMonth() + 1).padStart(2, '0');
        return `${nuevoYear}-${nuevoMes}`;
    };

    if (!selectedMonth) {
        return (
            <div className="max-w-7xl mx-auto space-y-6">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">üìä An√°lisis de Cierre</h1>
                    <p className="text-gray-600">Proyecciones e insights de tus gastos</p>
                </div>
                <EmptyState
                    icon="üìÖ"
                    title="Selecciona un mes"
                    description="Para ver el an√°lisis de cierre, primero debes tener un mes cargado."
                />
            </div>
        );
    }

    if (loading) {
        return (
            <div className="max-w-7xl mx-auto space-y-6">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">üìä An√°lisis de Cierre</h1>
                    <p className="text-gray-600">Proyecciones e insights de tus gastos</p>
                </div>
                <div className="flex items-center justify-center py-20">
                    <div className="text-center">
                        <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4"></div>
                        <p className="text-gray-900 text-xl font-semibold">Cargando an√°lisis...</p>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            {/* Header */}
            <div>
                <h1 className="text-3xl font-bold text-gray-900">üìä An√°lisis de Cierre</h1>
                <p className="text-gray-600">
                    {selectedMonth ? `An√°lisis de ${getNombreMes(selectedMonth.mesAnio)}` : 'Proyecciones e insights'}
                </p>
            </div>

            {/* C. Proyecci√≥n Pr√≥ximo Mes */}
            <ProyeccionProximoMes
                mesActual={selectedMonth.mesAnio}
                transaccionesActuales={transaccionesActuales}
                recurrentes={recurrentes}
                categorias={categorias}
            />

            {/* A. Comparativa Mensual */}
            {transaccionesAnteriores.length > 0 && (
                <ComparativaMensual
                    transaccionesActuales={transaccionesActuales}
                    transaccionesAnteriores={transaccionesAnteriores}
                    mesActual={selectedMonth.mesAnio}
                    categorias={categorias}
                />
            )}

            {/* D. Top Insights */}
            <TopInsights
                transacciones={transaccionesActuales}
                transaccionesAnteriores={transaccionesAnteriores}
                categorias={categorias}
            />
        </div>
    );
};

// Componente: Proyecci√≥n Pr√≥ximo Mes
const ProyeccionProximoMes = memo(({ mesActual, transaccionesActuales, recurrentes, categorias }) => {
    // Calcular cuotas comprometidas para el pr√≥ximo mes
    const cuotasProyectadas = useMemo(() => {
        return calcularCuotasActivas(transaccionesActuales, mesActual)
            .reduce((sum, cuota) => sum + cuota.montoCuota, 0);
    }, [transaccionesActuales, mesActual]);

    // Calcular gastos recurrentes
    const gastosRecurrentes = useMemo(() => {
        return recurrentes
            .filter(r => r.activo)
            .reduce((sum, r) => sum + r.monto, 0);
    }, [recurrentes]);

    // Estimar gasto spot basado en promedio de √∫ltimos meses
    const estimadoSpot = useMemo(() => {
        const spot = transaccionesActuales.filter(t =>
            !t.cuotaActual || (t.cuotaActual === 1 && t.cuotasTotal === 1)
        );
        return spot.reduce((sum, t) => sum + t.monto, 0);
    }, [transaccionesActuales]);

    const totalProyectado = cuotasProyectadas + gastosRecurrentes + estimadoSpot;

    return (
        <Card title="üîÆ Proyecci√≥n Pr√≥ximo Mes" icon="üîÆ">
            <div className="space-y-4">
                <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-6 border-2 border-indigo-200">
                    <p className="text-sm text-gray-600 mb-2 text-center">Estimaci√≥n de gasto para pr√≥ximo mes</p>
                    <p className="text-4xl font-black text-indigo-900 text-center">
                        {formatearMonto(totalProyectado)}
                    </p>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <p className="text-sm text-blue-600 font-medium mb-1">üí≥ Cuotas Comprometidas</p>
                        <p className="text-2xl font-bold text-blue-900">{formatearMonto(cuotasProyectadas)}</p>
                        <p className="text-xs text-blue-600 mt-1">Pagos de compras en cuotas</p>
                    </div>

                    <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                        <p className="text-sm text-green-600 font-medium mb-1">üîÑ Gastos Recurrentes</p>
                        <p className="text-2xl font-bold text-green-900">{formatearMonto(gastosRecurrentes)}</p>
                        <p className="text-xs text-green-600 mt-1">
                            {recurrentes.filter(r => r.activo).length} servicios mensuales
                        </p>
                    </div>

                    <div className="bg-purple-50 rounded-lg p-4 border border-purple-200">
                        <p className="text-sm text-purple-600 font-medium mb-1">‚ö° Estimado Spot</p>
                        <p className="text-2xl font-bold text-purple-900">{formatearMonto(estimadoSpot)}</p>
                        <p className="text-xs text-purple-600 mt-1">Basado en promedio actual</p>
                    </div>
                </div>

                {/* Detalle de recurrentes */}
                {recurrentes.filter(r => r.activo).length > 0 && (
                    <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                        <p className="text-sm font-semibold text-gray-700 mb-2">Detalle de gastos recurrentes:</p>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                            {recurrentes.filter(r => r.activo).map(r => {
                                const categoria = categorias.find(c => c.id === r.categoria);
                                return (
                                    <div key={r.id} className="text-sm text-gray-600">
                                        <span className="mr-1">{categoria?.icono || 'üì¶'}</span>
                                        {r.nombre}: {formatearMonto(r.monto)}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}
            </div>
        </Card>
    );
});

// Componente: Comparativa Mensual
const ComparativaMensual = memo(({ transaccionesActuales, transaccionesAnteriores, mesActual, categorias }) => {
    const desglose = useMemo(() => {
        const actual = calcularDesglose(transaccionesActuales);
        const anterior = calcularDesglose(transaccionesAnteriores);

        const calcularCambio = (actual, anterior) => {
            if (anterior === 0) return { porcentaje: 0, direccion: 'igual' };
            const diff = actual - anterior;
            const porcentaje = Math.round((diff / anterior) * 100);
            const direccion = diff > 0 ? 'arriba' : diff < 0 ? 'abajo' : 'igual';
            return { porcentaje: Math.abs(porcentaje), direccion, diff };
        };

        return {
            total: {
                actual: actual.total,
                anterior: anterior.total,
                cambio: calcularCambio(actual.total, anterior.total)
            },
            spot: {
                actual: actual.spot,
                anterior: anterior.spot,
                cambio: calcularCambio(actual.spot, anterior.spot)
            },
            cuotas: {
                actual: actual.cuotasMes + actual.cuotasAnteriores,
                anterior: anterior.cuotasMes + anterior.cuotasAnteriores,
                cambio: calcularCambio(
                    actual.cuotasMes + actual.cuotasAnteriores,
                    anterior.cuotasMes + anterior.cuotasAnteriores
                )
            }
        };
    }, [transaccionesActuales, transaccionesAnteriores]);

    // Categor√≠as que m√°s crecieron
    const categoriasCrecimiento = useMemo(() => {
        const gastosActuales = calcularGastosPorCategoria(transaccionesActuales);
        const gastosAnteriores = calcularGastosPorCategoria(transaccionesAnteriores);

        const cambios = Object.keys(gastosActuales).map(catId => {
            const actual = gastosActuales[catId] || 0;
            const anterior = gastosAnteriores[catId] || 0;
            const diff = actual - anterior;
            const porcentaje = anterior > 0 ? Math.round((diff / anterior) * 100) : 0;

            return {
                categoria: categorias.find(c => c.id === catId),
                actual,
                anterior,
                diff,
                porcentaje
            };
        });

        return cambios
            .filter(c => c.diff > 0)
            .sort((a, b) => b.diff - a.diff)
            .slice(0, 3);
    }, [transaccionesActuales, transaccionesAnteriores, categorias]);

    const FlechaCambio = ({ cambio }) => {
        if (cambio.direccion === 'arriba') {
            return <span className="text-red-600">‚Üë +{cambio.porcentaje}%</span>;
        } else if (cambio.direccion === 'abajo') {
            return <span className="text-green-600">‚Üì -{cambio.porcentaje}%</span>;
        }
        return <span className="text-gray-600">‚Üí 0%</span>;
    };

    return (
        <Card title="üìà Comparativa vs Mes Anterior" icon="üìà">
            <div className="space-y-4">
                {/* Comparativa general */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-gray-50 rounded-lg p-4">
                        <p className="text-sm text-gray-600 mb-1">Total del Mes</p>
                        <p className="text-2xl font-bold text-gray-900">{formatearMonto(desglose.total.actual)}</p>
                        <div className="flex items-center justify-between mt-2">
                            <p className="text-xs text-gray-500">Anterior: {formatearMonto(desglose.total.anterior)}</p>
                            <FlechaCambio cambio={desglose.total.cambio} />
                        </div>
                    </div>

                    <div className="bg-gray-50 rounded-lg p-4">
                        <p className="text-sm text-gray-600 mb-1">Spot</p>
                        <p className="text-2xl font-bold text-gray-900">{formatearMonto(desglose.spot.actual)}</p>
                        <div className="flex items-center justify-between mt-2">
                            <p className="text-xs text-gray-500">Anterior: {formatearMonto(desglose.spot.anterior)}</p>
                            <FlechaCambio cambio={desglose.spot.cambio} />
                        </div>
                    </div>

                    <div className="bg-gray-50 rounded-lg p-4">
                        <p className="text-sm text-gray-600 mb-1">Cuotas</p>
                        <p className="text-2xl font-bold text-gray-900">{formatearMonto(desglose.cuotas.actual)}</p>
                        <div className="flex items-center justify-between mt-2">
                            <p className="text-xs text-gray-500">Anterior: {formatearMonto(desglose.cuotas.anterior)}</p>
                            <FlechaCambio cambio={desglose.cuotas.cambio} />
                        </div>
                    </div>
                </div>

                {/* Categor√≠as que m√°s crecieron */}
                {categoriasCrecimiento.length > 0 && (
                    <div className="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <p className="text-sm font-semibold text-yellow-900 mb-3">
                            üìä Categor√≠as que m√°s crecieron:
                        </p>
                        <div className="space-y-2">
                            {categoriasCrecimiento.map((c, idx) => (
                                <div key={idx} className="flex items-center justify-between">
                                    <div className="flex items-center space-x-2">
                                        <span className="text-2xl">{c.categoria?.icono}</span>
                                        <span className="font-medium text-gray-800">{c.categoria?.nombre}</span>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-bold text-red-600">+{formatearMonto(c.diff)}</p>
                                        <p className="text-xs text-red-600">(+{c.porcentaje}%)</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        </Card>
    );
});

// Componente: Top Insights
const TopInsights = memo(({ transacciones, transaccionesAnteriores, categorias }) => {
    const insights = useMemo(() => {
        const resultados = [];

        // 1. Gasto m√°s grande del mes
        if (transacciones.length > 0) {
            const gastoMasGrande = [...transacciones].sort((a, b) => b.monto - a.monto)[0];
            const categoria = categorias.find(c => c.id === gastoMasGrande.categoria);
            resultados.push({
                icono: 'üí∞',
                titulo: 'Gasto m√°s grande del mes',
                descripcion: `${formatearMonto(gastoMasGrande.monto)} en ${gastoMasGrande.comercio}`,
                detalle: `Categor√≠a: ${categoria?.nombre || 'Sin categor√≠a'}`,
                color: 'blue'
            });
        }

        // 2. Comparaci√≥n fin de semana vs d√≠as laborales
        const finDeSemana = transacciones.filter(t => {
            const fecha = new Date(t.fecha);
            const dia = fecha.getDay();
            return dia === 0 || dia === 6; // Domingo o S√°bado
        });
        const diasLaborales = transacciones.filter(t => {
            const fecha = new Date(t.fecha);
            const dia = fecha.getDay();
            return dia >= 1 && dia <= 5;
        });

        const totalFinDeSemana = finDeSemana.reduce((sum, t) => sum + t.monto, 0);
        const totalDiasLaborales = diasLaborales.reduce((sum, t) => sum + t.monto, 0);

        const promedioFinDeSemana = finDeSemana.length > 0 ? totalFinDeSemana / (finDeSemana.length / 7 * 2) : 0;
        const promedioDiasLaborales = diasLaborales.length > 0 ? totalDiasLaborales / (diasLaborales.length / 7 * 5) : 0;

        if (promedioFinDeSemana > promedioDiasLaborales * 1.3) {
            const porcentaje = Math.round((promedioFinDeSemana / promedioDiasLaborales - 1) * 100);
            resultados.push({
                icono: 'üìÖ',
                titulo: 'Patr√≥n de fin de semana',
                descripcion: `Gastas ${porcentaje}% m√°s los fines de semana`,
                detalle: `Promedio fin de semana: ${formatearMonto(promedioFinDeSemana)} vs d√≠as laborales: ${formatearMonto(promedioDiasLaborales)}`,
                color: 'purple'
            });
        }

        // 3. Ahorro o exceso vs mes anterior
        if (transaccionesAnteriores.length > 0) {
            const totalActual = transacciones.reduce((sum, t) => sum + t.monto, 0);
            const totalAnterior = transaccionesAnteriores.reduce((sum, t) => sum + t.monto, 0);
            const diferencia = totalAnterior - totalActual;

            if (Math.abs(diferencia) > 10000) {
                if (diferencia > 0) {
                    resultados.push({
                        icono: 'üéâ',
                        titulo: 'Ahorraste vs mes anterior',
                        descripcion: `Gastaste ${formatearMonto(Math.abs(diferencia))} menos que el mes pasado`,
                        detalle: 'Buen trabajo controlando tus gastos',
                        color: 'green'
                    });
                } else {
                    resultados.push({
                        icono: '‚ö†Ô∏è',
                        titulo: 'Aumento de gastos',
                        descripcion: `Gastaste ${formatearMonto(Math.abs(diferencia))} m√°s que el mes pasado`,
                        detalle: 'Revisa tus gastos para el pr√≥ximo mes',
                        color: 'red'
                    });
                }
            }
        }

        // 4. Cantidad de transacciones
        const cantidadTransacciones = transacciones.length;
        const promedioTransaccion = cantidadTransacciones > 0
            ? transacciones.reduce((sum, t) => sum + t.monto, 0) / cantidadTransacciones
            : 0;

        resultados.push({
            icono: 'üìä',
            titulo: 'An√°lisis de transacciones',
            descripcion: `${cantidadTransacciones} transacciones este mes`,
            detalle: `Promedio por transacci√≥n: ${formatearMonto(promedioTransaccion)}`,
            color: 'indigo'
        });

        return resultados;
    }, [transacciones, transaccionesAnteriores, categorias]);

    const colorClasses = {
        blue: 'bg-blue-50 border-blue-200',
        purple: 'bg-purple-50 border-purple-200',
        green: 'bg-green-50 border-green-200',
        red: 'bg-red-50 border-red-200',
        indigo: 'bg-indigo-50 border-indigo-200'
    };

    return (
        <Card title="üîç Descubrimientos del Mes" icon="üîç">
            <div className="space-y-3">
                {insights.map((insight, idx) => (
                    <div
                        key={idx}
                        className={`p-4 rounded-lg border-2 ${colorClasses[insight.color]}`}
                    >
                        <div className="flex items-start space-x-3">
                            <span className="text-3xl">{insight.icono}</span>
                            <div className="flex-1">
                                <p className="font-semibold text-gray-800 mb-1">{insight.titulo}</p>
                                <p className="text-gray-700">{insight.descripcion}</p>
                                {insight.detalle && (
                                    <p className="text-sm text-gray-600 mt-1">{insight.detalle}</p>
                                )}
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </Card>
    );
});

    </script>

    <script type="text/babel">
        // P√°gina HistorialMeses - Gesti√≥n de meses cargados

const HistorialMeses = () => {
    const { mesesCargados, refreshMesesCargados, setSelectedMonth, setCurrentPage } = useApp();
    const [showToast, setShowToast] = useState(null);

    const handleEliminarMes = async (mes) => {
        if (!confirm(`¬øEst√°s seguro de eliminar todos los datos de ${getNombreMes(mes.mesAnio)}? Esta acci√≥n no se puede deshacer.`)) {
            return;
        }

        try {
            await deleteMesCompleto(mes.id);
            await refreshMesesCargados();
            setShowToast({ message: 'Mes eliminado exitosamente', type: 'success' });
        } catch (error) {
            console.error('Error al eliminar mes:', error);
            setShowToast({ message: 'Error al eliminar el mes', type: 'error' });
        }
    };

    const handleVerMes = (mes) => {
        setSelectedMonth(mes);
        setCurrentPage('home');
    };

    const getEstadisticasMes = async (mes) => {
        const transacciones = await getTransaccionesByMes(mes.id);
        const desglose = calcularDesglose(transacciones);
        return {
            totalTransacciones: transacciones.length,
            totalGasto: desglose.total
        };
    };

    if (mesesCargados.length === 0) {
        return (
            <div className="max-w-7xl mx-auto">
                <EmptyState
                    icon="üìÖ"
                    title="No hay meses cargados"
                    description="Carga tu primer archivo CSV desde la p√°gina Home para comenzar."
                    action={
                        <button
                            onClick={() => setCurrentPage('home')}
                            className="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-lg"
                        >
                            Ir a Home
                        </button>
                    }
                />
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            <div>
                <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Historial de Meses</h1>
                <p className="text-gray-600">Gestiona los meses con datos cargados</p>
            </div>

            <Card>
                <div className="space-y-4">
                    {mesesCargados
                        .sort((a, b) => b.mesAnio.localeCompare(a.mesAnio))
                        .map(mes => (
                            <MesCard
                                key={mes.id}
                                mes={mes}
                                onVer={() => handleVerMes(mes)}
                                onEliminar={() => handleEliminarMes(mes)}
                            />
                        ))}
                </div>
            </Card>

            {showToast && (
                <Toast
                    message={showToast.message}
                    type={showToast.type}
                    onClose={() => setShowToast(null)}
                />
            )}
        </div>
    );
};

const MesCard = memo(({ mes, onVer, onEliminar }) => {
    const [stats, setStats] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const cargarStats = async () => {
            try {
                const transacciones = await getTransaccionesByMes(mes.id);
                const desglose = calcularDesglose(transacciones);
                setStats({
                    totalTransacciones: transacciones.length,
                    totalGasto: desglose.total
                });
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
            } finally {
                setLoading(false);
            }
        };

        cargarStats();
    }, [mes.id]);

    return (
        <div className="flex items-center justify-between p-6 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
            <div className="flex items-center space-x-6 flex-1">
                <div className="text-4xl">
                    üìÖ
                </div>
                <div className="flex-1">
                    <h3 className="text-xl font-bold text-gray-800">
                        {getNombreMes(mes.mesAnio)}
                    </h3>
                    <p className="text-sm text-gray-600">
                        Cargado el {formatearFecha(mes.fechaCarga, 'largo')}
                    </p>
                    {!loading && stats && (
                        <div className="flex items-center space-x-4 mt-2 text-sm">
                            <span className="text-gray-600">
                                {stats.totalTransacciones} transacciones
                            </span>
                            <span className="text-gray-400">‚Ä¢</span>
                            <span className="font-semibold text-indigo-600">
                                {formatearMonto(stats.totalGasto)}
                            </span>
                        </div>
                    )}
                </div>
            </div>

            <div className="flex items-center space-x-2">
                <button
                    onClick={onVer}
                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                >
                    Ver Detalles
                </button>
                <button
                    onClick={onEliminar}
                    className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                >
                    Eliminar
                </button>
            </div>
        </div>
    );
});

    </script>

    <script type="text/babel">
        // Componente Balance - C√°lculo de neto de deudas entre perfiles

const Balance = () => {
    const { selectedMonth, perfiles } = useApp();
    const [transacciones, setTransacciones] = useState([]);
    const [liquidaciones, setLiquidaciones] = useState([]);
    const [loading, setLoading] = useState(false);
    const [mostrarModalLiquidar, setMostrarModalLiquidar] = useState(false);
    const [showToast, setShowToast] = useState(null);

    // Funci√≥n para mostrar toast
    const mostrarToast = (message, type = 'info') => {
        setShowToast({ message, type });
        setTimeout(() => setShowToast(null), 3000);
    };

    useEffect(() => {
        if (selectedMonth) {
            cargarDatos();
        }
    }, [selectedMonth]);

    const cargarDatos = async () => {
        setLoading(true);
        try {
            const trans = await getTransaccionesByMes(selectedMonth.id);
            setTransacciones(trans);

            const liq = await getLiquidaciones(selectedMonth.id);
            setLiquidaciones(liq);
        } catch (error) {
            console.error('Error al cargar datos:', error);
        } finally {
            setLoading(false);
        }
    };

    // Calcular balance entre perfiles
    const balance = useMemo(() => {
        if (!selectedMonth || transacciones.length === 0 || perfiles.length < 2) {
            return null;
        }

        // Filtrar solo gastos compartidos
        const gastosCompartidos = transacciones.filter(t => t.esCompartido);

        if (gastosCompartidos.length === 0) {
            return null;
        }

        // Calcular por cada perfil
        const balancePorPerfil = {};

        perfiles.forEach(perfil => {
            balancePorPerfil[perfil.id] = {
                perfil: perfil,
                pagado: 0,
                debeRecuperar: 0,
                gastos: []
            };
        });

        // Procesar cada gasto compartido
        gastosCompartidos.forEach(t => {
            const perfilPago = t.perfilId;
            const perfilCompartido = t.perfilCompartidoId;
            const porcentajePerfil = t.porcentajePerfil || 50;
            const porcentajeCompartido = 100 - porcentajePerfil;

            // El que pag√≥
            if (balancePorPerfil[perfilPago]) {
                balancePorPerfil[perfilPago].pagado += t.monto;
                balancePorPerfil[perfilPago].debeRecuperar += (t.monto * porcentajeCompartido / 100);
                balancePorPerfil[perfilPago].gastos.push({
                    ...t,
                    montoPagado: t.monto,
                    montoRecuperar: (t.monto * porcentajeCompartido / 100)
                });
            }

            // El que comparti√≥
            if (balancePorPerfil[perfilCompartido]) {
                // Este perfil debe pagar su parte
                balancePorPerfil[perfilCompartido].debeRecuperar -= (t.monto * porcentajeCompartido / 100);
            }
        });

        // Calcular neto entre perfiles (asumiendo 2 perfiles)
        const perfilesArray = Object.values(balancePorPerfil);
        if (perfilesArray.length !== 2) {
            return balancePorPerfil;
        }

        const [perfil1, perfil2] = perfilesArray;

        // Neto: qui√©n le debe a qui√©n
        let deudor = null;
        let acreedor = null;
        let montoNeto = 0;

        if (perfil1.debeRecuperar > perfil2.debeRecuperar) {
            acreedor = perfil1.perfil;
            deudor = perfil2.perfil;
            montoNeto = perfil1.debeRecuperar - perfil2.debeRecuperar;
        } else if (perfil2.debeRecuperar > perfil1.debeRecuperar) {
            acreedor = perfil2.perfil;
            deudor = perfil1.perfil;
            montoNeto = perfil2.debeRecuperar - perfil1.debeRecuperar;
        }

        return {
            balancePorPerfil,
            deudor,
            acreedor,
            montoNeto,
            totalGastosCompartidos: gastosCompartidos.reduce((sum, t) => sum + t.monto, 0),
            cantidadGastos: gastosCompartidos.length
        };
    }, [transacciones, perfiles, selectedMonth]);

    const handleLiquidar = async () => {
        if (!balance || balance.montoNeto === 0) return;

        try {
            const liquidacion = {
                mesAnioId: selectedMonth.id,
                mesAnio: selectedMonth.mesAnio,
                deudorId: balance.deudor.id,
                deudorNombre: balance.deudor.nombre,
                acreedorId: balance.acreedor.id,
                acreedorNombre: balance.acreedor.nombre,
                monto: balance.montoNeto,
                fecha: new Date().toISOString(),
                gastosIncluidos: balance.cantidadGastos
            };

            await addLiquidacion(liquidacion);
            await cargarDatos();
            setMostrarModalLiquidar(false);
            mostrarToast('Liquidaci√≥n registrada exitosamente', 'success');
        } catch (error) {
            console.error('Error al liquidar:', error);
            mostrarToast('Error al registrar liquidaci√≥n', 'error');
        }
    };

    if (!selectedMonth) {
        return (
            <div className="max-w-7xl mx-auto space-y-6">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">üí∞ Balance del Mes</h1>
                    <p className="text-gray-600">Liquidaci√≥n de gastos compartidos</p>
                </div>
                <EmptyState
                    icon="üìÖ"
                    title="Selecciona un mes"
                    description="Para ver el balance, primero debes tener un mes cargado."
                />
            </div>
        );
    }

    if (loading) {
        return (
            <div className="max-w-7xl mx-auto space-y-6">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">üí∞ Balance del Mes</h1>
                    <p className="text-gray-600">Liquidaci√≥n de gastos compartidos</p>
                </div>
                <div className="flex items-center justify-center py-20">
                    <div className="text-center">
                        <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4"></div>
                        <p className="text-gray-900 text-xl font-semibold">Cargando balance...</p>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            {/* Header */}
            <div>
                <h1 className="text-3xl font-bold text-gray-900">üí∞ Balance del Mes</h1>
                <p className="text-gray-600">
                    {selectedMonth ? `${selectedMonth.mesAnio}` : 'Liquidaci√≥n de gastos compartidos'}
                </p>
            </div>

            {/* Resumen del Balance */}
            {!balance ? (
                <Card title="Sin gastos compartidos" icon="üí∞">
                    <div className="text-center py-8">
                        <p className="text-6xl mb-4">üíë</p>
                        <p className="text-gray-700 font-medium mb-2">
                            No hay gastos compartidos en este mes
                        </p>
                        <p className="text-sm text-gray-500">
                            Marca algunas transacciones como compartidas en la p√°gina Home para ver el balance
                        </p>
                    </div>
                </Card>
            ) : (
                <>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <CardStat
                            label="Total Gastos Compartidos"
                            value={formatearMonto(balance.totalGastosCompartidos)}
                            icon="ü§ù"
                            color="blue"
                        />
                        <CardStat
                            label="Cantidad de Gastos"
                            value={balance.cantidadGastos}
                            icon="üìä"
                            color="purple"
                        />
                        <CardStat
                            label="Neto a Pagar"
                            value={balance.montoNeto > 0 ? formatearMonto(balance.montoNeto) : '$0'}
                            icon="üí∏"
                            color={balance.montoNeto > 0 ? 'green' : 'gray'}
                        />
                    </div>

                    {/* Balance por Perfil */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {Object.values(balance.balancePorPerfil).map(datos => (
                            <Card key={datos.perfil.id} title={datos.perfil.nombre} icon="üë§">
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                        <span className="text-sm font-medium text-gray-700">Total pagado</span>
                                        <span className="text-lg font-bold text-blue-600">{formatearMonto(datos.pagado)}</span>
                                    </div>
                                    <div className="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                        <span className="text-sm font-medium text-gray-700">Debe recuperar</span>
                                        <span className="text-lg font-bold text-green-600">
                                            {formatearMonto(Math.abs(datos.debeRecuperar))}
                                        </span>
                                    </div>
                                    <div className="text-xs text-gray-500">
                                        {datos.gastos.length} gasto{datos.gastos.length !== 1 ? 's' : ''} compartido{datos.gastos.length !== 1 ? 's' : ''}
                                    </div>
                                </div>
                            </Card>
                        ))}
                    </div>

                    {/* Resultado Final */}
                    {balance.montoNeto > 0 && (
                        <Card title="Resultado Final" icon="üéØ">
                            <div className="space-y-4">
                                <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-6 border-2 border-indigo-200">
                                    <div className="text-center">
                                        <p className="text-sm text-gray-600 mb-2">Para equilibrar las cuentas:</p>
                                        <p className="text-2xl font-bold text-gray-800 mb-1">
                                            <span style={{ color: balance.deudor.color }}>{balance.deudor.nombre}</span>
                                            {' debe pagar '}
                                            <span className="text-green-600">{formatearMonto(balance.montoNeto)}</span>
                                            {' a '}
                                            <span style={{ color: balance.acreedor.color }}>{balance.acreedor.nombre}</span>
                                        </p>
                                        <p className="text-xs text-gray-500 mt-2">
                                            As√≠ ambos habr√°n pagado exactamente la mitad de los gastos compartidos
                                        </p>
                                    </div>
                                </div>

                                <button
                                    onClick={() => setMostrarModalLiquidar(true)}
                                    className="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold transition-colors"
                                >
                                    ‚úÖ Marcar como Liquidado
                                </button>
                            </div>
                        </Card>
                    )}

                    {balance.montoNeto === 0 && (
                        <Card title="Resultado Final" icon="‚úÖ">
                            <div className="bg-green-50 rounded-lg p-6 border-2 border-green-200 text-center">
                                <p className="text-xl font-bold text-green-800">¬°Las cuentas est√°n equilibradas!</p>
                                <p className="text-sm text-green-600 mt-2">No hay deudas pendientes entre perfiles</p>
                            </div>
                        </Card>
                    )}

                    {/* Detalle de Gastos Compartidos */}
                    <Card title="Detalle de Gastos Compartidos" icon="üìã">
                        <div className="space-y-2">
                            {Object.values(balance.balancePorPerfil).map(datos => (
                                datos.gastos.length > 0 && (
                                    <div key={datos.perfil.id} className="mb-6">
                                        <h4 className="font-semibold text-gray-700 mb-3">
                                            Pagados por {datos.perfil.nombre}:
                                        </h4>
                                        {datos.gastos.map((gasto, index) => (
                                            <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                                                <div className="flex-1">
                                                    <p className="font-medium text-gray-800">{gasto.comercio}</p>
                                                    <p className="text-xs text-gray-500">{formatearFecha(gasto.fecha)}</p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="font-bold text-gray-800">{formatearMonto(gasto.montoPagado)}</p>
                                                    <p className="text-xs text-green-600">
                                                        Recupera: {formatearMonto(gasto.montoRecuperar)}
                                                    </p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )
                            ))}
                        </div>
                    </Card>

                    {/* Historial de Liquidaciones */}
                    {liquidaciones.length > 0 && (
                        <Card title="Historial de Liquidaciones" icon="üìú">
                            <div className="space-y-3">
                                {liquidaciones.map((liq, index) => (
                                    <div key={index} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border-l-4 border-green-500">
                                        <div>
                                            <p className="font-medium text-gray-800">
                                                {liq.deudorNombre} pag√≥ {formatearMonto(liq.monto)} a {liq.acreedorNombre}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                {formatearFecha(liq.fecha)} ‚Ä¢ {liq.gastosIncluidos} gasto{liq.gastosIncluidos !== 1 ? 's' : ''}
                                            </p>
                                        </div>
                                        <div className="text-green-600 text-2xl">‚úÖ</div>
                                    </div>
                                ))}
                            </div>
                        </Card>
                    )}
                </>
            )}

            {/* Modal Confirmar Liquidaci√≥n */}
            {mostrarModalLiquidar && balance && (
                <Modal
                    isOpen={mostrarModalLiquidar}
                    onClose={() => setMostrarModalLiquidar(false)}
                    title="Confirmar Liquidaci√≥n"
                    size="md"
                >
                    <div className="space-y-4">
                        <p className="text-gray-700">
                            ¬øConfirmas que <strong>{balance.deudor.nombre}</strong> ha pagado{' '}
                            <strong className="text-green-600">{formatearMonto(balance.montoNeto)}</strong> a{' '}
                            <strong>{balance.acreedor.nombre}</strong>?
                        </p>

                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                            <p className="font-semibold mb-1">Esta acci√≥n registrar√°:</p>
                            <ul className="list-disc list-inside space-y-1">
                                <li>Fecha de liquidaci√≥n: {formatearFecha(new Date())}</li>
                                <li>Monto: {formatearMonto(balance.montoNeto)}</li>
                                <li>Gastos incluidos: {balance.cantidadGastos}</li>
                            </ul>
                        </div>

                        <div className="flex space-x-3">
                            <button
                                onClick={() => setMostrarModalLiquidar(false)}
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={handleLiquidar}
                                className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                            >
                                Confirmar
                            </button>
                        </div>
                    </div>
                </Modal>
            )}

            {/* Toast */}
            {showToast && (
                <Toast
                    message={showToast.message}
                    type={showToast.type}
                    onClose={() => setShowToast(null)}
                />
            )}
        </div>
    );
};

    </script>

    <script type="text/babel">
        // P√°gina Perfiles - CRUD de perfiles de usuario

const Perfiles = () => {
    const { perfiles, updatePerfiles } = useApp();
    const [showModal, setShowModal] = useState(false);
    const [perfilEditar, setPerfilEditar] = useState(null);
    const [showToast, setShowToast] = useState(null);

    const coloresDisponibles = [
        '#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
        '#06b6d4', '#ec4899', '#f97316', '#84cc16', '#0ea5e9'
    ];

    const handleAgregar = () => {
        setPerfilEditar(null);
        setShowModal(true);
    };

    const handleEditar = (perfil) => {
        setPerfilEditar(perfil);
        setShowModal(true);
    };

    const handleEliminar = (perfilId) => {
        if (perfiles.length === 1) {
            setShowToast({ message: 'Debe existir al menos un perfil', type: 'error' });
            return;
        }

        if (!confirm('¬øEst√°s seguro de eliminar este perfil?')) return;

        const nuevosPerfiles = perfiles.filter(p => p.id !== perfilId);
        updatePerfiles(nuevosPerfiles);
        setShowToast({ message: 'Perfil eliminado', type: 'success' });
    };

    const handleGuardar = (perfil) => {
        let nuevosPerfiles;

        if (perfilEditar) {
            // Editar existente
            nuevosPerfiles = perfiles.map(p => p.id === perfilEditar.id ? { ...p, ...perfil } : p);
            setShowToast({ message: 'Perfil actualizado', type: 'success' });
        } else {
            // Agregar nuevo
            if (perfiles.length >= 5) {
                setShowToast({ message: 'M√°ximo 5 perfiles permitidos', type: 'error' });
                return;
            }
            const nuevoId = Math.max(...perfiles.map(p => p.id), 0) + 1;
            nuevosPerfiles = [...perfiles, { ...perfil, id: nuevoId, activo: false }];
            setShowToast({ message: 'Perfil creado', type: 'success' });
        }

        updatePerfiles(nuevosPerfiles);
        setShowModal(false);
    };

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Gesti√≥n de Perfiles</h1>
                    <p className="text-gray-600">Administra los perfiles de usuario</p>
                </div>
                <button
                    onClick={handleAgregar}
                    disabled={perfiles.length >= 5}
                    className="px-6 py-3 bg-white text-indigo-600 font-semibold rounded-lg hover:bg-indigo-50 transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    + Nuevo Perfil
                </button>
            </div>

            <Card>
                <div className="space-y-3">
                    {perfiles.map(perfil => (
                        <div
                            key={perfil.id}
                            className="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                        >
                            <div className="flex items-center space-x-4">
                                <div
                                    className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg"
                                    style={{ backgroundColor: perfil.color }}
                                >
                                    {perfil.nombre.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800">
                                        {perfil.nombre}
                                    </h3>
                                    {perfil.activo && (
                                        <Badge color="green" size="sm">Activo</Badge>
                                    )}
                                </div>
                            </div>

                            <div className="flex items-center space-x-2">
                                <button
                                    onClick={() => handleEditar(perfil)}
                                    className="px-4 py-2 text-indigo-600 hover:bg-indigo-100 rounded-lg transition-colors"
                                >
                                    Editar
                                </button>
                                <button
                                    onClick={() => handleEliminar(perfil.id)}
                                    className="px-4 py-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors"
                                    disabled={perfiles.length === 1}
                                >
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    ))}
                </div>

                {perfiles.length >= 5 && (
                    <AlertBadge type="info" className="mt-4">
                        Has alcanzado el l√≠mite m√°ximo de 5 perfiles
                    </AlertBadge>
                )}
            </Card>

            {showModal && (
                <ModalPerfil
                    perfil={perfilEditar}
                    colores={coloresDisponibles}
                    onClose={() => setShowModal(false)}
                    onGuardar={handleGuardar}
                />
            )}

            {showToast && (
                <Toast
                    message={showToast.message}
                    type={showToast.type}
                    onClose={() => setShowToast(null)}
                />
            )}
        </div>
    );
};

const ModalPerfil = ({ perfil, colores, onClose, onGuardar }) => {
    const [form, setForm] = useState({
        nombre: perfil?.nombre || '',
        color: perfil?.color || colores[0]
    });

    const handleSubmit = (e) => {
        e.preventDefault();
        if (!form.nombre.trim()) return;
        onGuardar(form);
    };

    return (
        <Modal
            isOpen={true}
            onClose={onClose}
            title={perfil ? 'Editar Perfil' : 'Nuevo Perfil'}
            size="md"
        >
            <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Nombre del Perfil
                    </label>
                    <input
                        type="text"
                        value={form.nombre}
                        onChange={(e) => setForm({ ...form, nombre: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="Ej: Personal, Familia, Trabajo"
                        required
                        maxLength={20}
                    />
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        Color del Perfil
                    </label>
                    <div className="grid grid-cols-5 gap-3">
                        {colores.map(color => (
                            <button
                                key={color}
                                type="button"
                                onClick={() => setForm({ ...form, color })}
                                className={`w-12 h-12 rounded-full transition-transform hover:scale-110 ${
                                    form.color === color ? 'ring-4 ring-indigo-300 scale-110' : ''
                                }`}
                                style={{ backgroundColor: color }}
                            />
                        ))}
                    </div>
                </div>

                <div className="flex items-center space-x-2 p-4 bg-gray-50 rounded-lg">
                    <div
                        className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg"
                        style={{ backgroundColor: form.color }}
                    >
                        {form.nombre.charAt(0).toUpperCase() || '?'}
                    </div>
                    <div>
                        <p className="text-sm text-gray-600">Vista previa:</p>
                        <p className="font-semibold text-gray-800">
                            {form.nombre || 'Nombre del perfil'}
                        </p>
                    </div>
                </div>

                <div className="flex space-x-3 pt-4">
                    <button
                        type="button"
                        onClick={onClose}
                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button
                        type="submit"
                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                    >
                        {perfil ? 'Actualizar' : 'Crear'}
                    </button>
                </div>
            </form>
        </Modal>
    );
};

    </script>

    <script type="text/babel">
        // P√°gina Categor√≠as - CRUD de categor√≠as

const Categorias = () => {
    const { categorias, updateCategorias } = useApp();
    const [showModal, setShowModal] = useState(false);
    const [categoriaEditar, setCategoriaEditar] = useState(null);
    const [showToast, setShowToast] = useState(null);

    const iconosDisponibles = ['üçî', 'üöó', 'üí°', '‚öïÔ∏è', 'üé¨', 'üìö', 'üè†', 'üíª', 'üëï', 'üíÖ', 'üêæ', '‚úàÔ∏è', 'üõ°Ô∏è', 'üí∞', 'üìà', '‚ù§Ô∏è', 'üì¶', 'üéØ', 'üé®', '‚öΩ'];

    const handleGuardar = (categoria) => {
        let nuevasCategorias;

        if (categoriaEditar) {
            nuevasCategorias = categorias.map(c => c.id === categoriaEditar.id ? { ...c, ...categoria } : c);
            setShowToast({ message: 'Categor√≠a actualizada', type: 'success' });
        } else {
            const nuevoId = `cat_${Date.now()}`;
            nuevasCategorias = [...categorias, { ...categoria, id: nuevoId }];
            setShowToast({ message: 'Categor√≠a creada', type: 'success' });
        }

        updateCategorias(nuevasCategorias);
        setShowModal(false);
    };

    const handleEliminar = (categoriaId) => {
        if (!confirm('¬øEliminar esta categor√≠a? Las transacciones asociadas se mover√°n a "Otros".')) return;
        const nuevasCategorias = categorias.filter(c => c.id !== categoriaId);
        updateCategorias(nuevasCategorias);
        setShowToast({ message: 'Categor√≠a eliminada', type: 'success' });
    };

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Gesti√≥n de Categor√≠as</h1>
                    <p className="text-gray-600">Personaliza las categor√≠as de gastos</p>
                </div>
                <button onClick={() => { setCategoriaEditar(null); setShowModal(true); }} className="px-6 py-3 bg-white text-indigo-600 font-semibold rounded-lg hover:bg-indigo-50 transition-colors shadow-lg">
                    + Nueva Categor√≠a
                </button>
            </div>

            <Card>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {categorias.map(cat => (
                        <div key={cat.id} className="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center space-x-3">
                                    <span className="text-3xl">{cat.icono}</span>
                                    <div>
                                        <h3 className="font-semibold text-gray-800">{cat.nombre}</h3>
                                        <div className="w-16 h-2 rounded-full mt-1" style={{ backgroundColor: cat.color }} />
                                    </div>
                                </div>
                            </div>
                            <div className="flex space-x-2 mt-3">
                                <button onClick={() => { setCategoriaEditar(cat); setShowModal(true); }} className="flex-1 px-3 py-1 text-sm text-indigo-600 hover:bg-indigo-100 rounded">Editar</button>
                                <button onClick={() => handleEliminar(cat.id)} className="flex-1 px-3 py-1 text-sm text-red-600 hover:bg-red-100 rounded">Eliminar</button>
                            </div>
                        </div>
                    ))}
                </div>
            </Card>

            {showModal && <ModalCategoria categoria={categoriaEditar} iconos={iconosDisponibles} onClose={() => setShowModal(false)} onGuardar={handleGuardar} />}
            {showToast && <Toast message={showToast.message} type={showToast.type} onClose={() => setShowToast(null)} />}
        </div>
    );
};

const ModalCategoria = ({ categoria, iconos, onClose, onGuardar }) => {
    const [form, setForm] = useState({
        nombre: categoria?.nombre || '',
        icono: categoria?.icono || iconos[0],
        color: categoria?.color || '#6366f1'
    });

    return (
        <Modal isOpen={true} onClose={onClose} title={categoria ? 'Editar Categor√≠a' : 'Nueva Categor√≠a'} size="md">
            <form onSubmit={(e) => { e.preventDefault(); onGuardar(form); }} className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                    <input type="text" value={form.nombre} onChange={(e) => setForm({ ...form, nombre: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required maxLength={20} />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Icono</label>
                    <div className="grid grid-cols-10 gap-2">
                        {iconos.map(icono => (
                            <button key={icono} type="button" onClick={() => setForm({ ...form, icono })} className={`text-2xl p-2 rounded hover:bg-gray-100 ${form.icono === icono ? 'bg-indigo-100 ring-2 ring-indigo-500' : ''}`}>{icono}</button>
                        ))}
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Color</label>
                    <input type="color" value={form.color} onChange={(e) => setForm({ ...form, color: e.target.value })} className="w-full h-12 rounded-lg cursor-pointer" />
                </div>
                <div className="flex space-x-3 pt-4">
                    <button type="button" onClick={onClose} className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancelar</button>
                    <button type="submit" className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">{categoria ? 'Actualizar' : 'Crear'}</button>
                </div>
            </form>
        </Modal>
    );
};

    </script>

    <script type="text/babel">
        // P√°gina Presupuestos - Configuraci√≥n de l√≠mites por categor√≠a

const Presupuestos = () => {
    const { selectedMonth, categorias, mesesCargados } = useApp();
    const [presupuestos, setPresupuestos] = useState([]);
    const [esPlantilla, setEsPlantilla] = useState(true);
    const [loading, setLoading] = useState(true);
    const [guardando, setGuardando] = useState(false);
    const [showToast, setShowToast] = useState(null);

    useEffect(() => {
        cargarPresupuestos();
    }, [selectedMonth, esPlantilla]);

    const cargarPresupuestos = async () => {
        setLoading(true);
        try {
            const mesId = esPlantilla ? null : selectedMonth?.id;
            const pres = await getPresupuestos(mesId);

            if (pres.length === 0) {
                // Crear presupuestos iniciales con monto 0
                const presInicial = categorias.map(c => ({
                    categoria: c.id,
                    monto: 0
                }));
                setPresupuestos(presInicial);
            } else {
                setPresupuestos(pres);
            }
        } catch (error) {
            console.error('Error al cargar presupuestos:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleGuardar = async () => {
        setGuardando(true);
        try {
            const mesId = esPlantilla ? null : selectedMonth?.id;
            await savePresupuestos(presupuestos, mesId);
            setShowToast({ message: 'Presupuestos guardados', type: 'success' });
        } catch (error) {
            console.error('Error al guardar:', error);
            setShowToast({ message: 'Error al guardar presupuestos', type: 'error' });
        } finally {
            setGuardando(false);
        }
    };

    const handleChangeMonto = (categoriaId, value) => {
        // Remover puntos (separadores de miles) y convertir a n√∫mero
        const numeroLimpio = value.replace(/\./g, '');
        const monto = Math.max(0, parseInt(numeroLimpio) || 0);

        setPresupuestos(prev => prev.map(p =>
            p.categoria === categoriaId ? { ...p, monto } : p
        ));
    };

    const formatearMontoInput = (monto) => {
        // Formatear con separador de miles
        return monto.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    };

    const handleRestaurarPlantilla = async () => {
        if (!confirm('¬øRestaurar los presupuestos de este mes con la plantilla base?')) return;

        try {
            const plantilla = await getPresupuestos(null);
            if (plantilla.length > 0) {
                setPresupuestos(plantilla);
                setShowToast({ message: 'Plantilla restaurada', type: 'success' });
            }
        } catch (error) {
            console.error('Error:', error);
        }
    };

    const totalPresupuesto = presupuestos.reduce((sum, p) => sum + p.monto, 0);

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            <div>
                <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Configuraci√≥n de Presupuestos</h1>
                <p className="text-gray-600">Define los l√≠mites de gasto por categor√≠a</p>
            </div>

            {/* Selector Plantilla/Mes espec√≠fico */}
            <Card>
                <div className="flex items-center justify-between">
                    <div className="flex space-x-4">
                        <button
                            onClick={() => setEsPlantilla(true)}
                            className={`px-6 py-3 rounded-lg font-semibold transition-colors ${esPlantilla ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                        >
                            üìã Plantilla Base
                        </button>
                        <button
                            onClick={() => setEsPlantilla(false)}
                            disabled={!selectedMonth}
                            className={`px-6 py-3 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed ${!esPlantilla ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                        >
                            üìÖ Mes Espec√≠fico
                        </button>
                    </div>

                    {!esPlantilla && selectedMonth && (
                        <button
                            onClick={handleRestaurarPlantilla}
                            className="px-4 py-2 text-indigo-600 hover:bg-indigo-100 rounded-lg transition-colors"
                        >
                            Restaurar Plantilla
                        </button>
                    )}
                </div>

                {!esPlantilla && (
                    <div className="mt-4">
                        <p className="text-sm text-gray-600">
                            {selectedMonth ? `Editando: ${getNombreMes(selectedMonth.mesAnio)}` : 'Selecciona un mes desde Home'}
                        </p>
                    </div>
                )}
            </Card>

            {/* Lista de presupuestos */}
            <Card title="Presupuestos por Categor√≠a" subtitle={`Total: ${formatearMonto(totalPresupuesto)}`}>
                {loading ? (
                    <div className="text-center py-8">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                    </div>
                ) : (
                    <div className="space-y-4">
                        {presupuestos.map(pres => {
                            const categoria = categorias.find(c => c.id === pres.categoria);
                            if (!categoria) return null;

                            return (
                                <div key={pres.categoria} className="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                                    <span className="text-3xl">{categoria.icono}</span>
                                    <div className="flex-1">
                                        <p className="font-semibold text-gray-800">{categoria.nombre}</p>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <span className="text-gray-600">$</span>
                                        <input
                                            type="text"
                                            value={formatearMontoInput(pres.monto)}
                                            onChange={(e) => handleChangeMonto(pres.categoria, e.target.value)}
                                            className="w-40 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-right font-semibold"
                                            placeholder="0"
                                        />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}

                <div className="mt-6 flex justify-end">
                    <button
                        onClick={handleGuardar}
                        disabled={guardando || loading}
                        className="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50"
                    >
                        {guardando ? 'Guardando...' : 'Guardar Presupuestos'}
                    </button>
                </div>
            </Card>

            {showToast && <Toast message={showToast.message} type={showToast.type} onClose={() => setShowToast(null)} />}
        </div>
    );
};

    </script>

    <script type="text/babel">
        // P√°gina de Cuotas Futuras - Proyecci√≥n de pagos en cuotas

const CuotasFuturas = () => {
    const { selectedMonth, categorias, perfiles, mesesCargados } = useApp();
    const [transacciones, setTransacciones] = useState([]);
    const [loading, setLoading] = useState(false);
    const [mesesProyeccion, setMesesProyeccion] = useState(12);

    // Cargar todas las transacciones hist√≥ricas para calcular cuotas
    useEffect(() => {
        cargarTodasLasTransacciones();
    }, [mesesCargados]);

    const cargarTodasLasTransacciones = async () => {
        setLoading(true);
        try {
            const todasTransacciones = [];
            for (const mes of mesesCargados) {
                const trans = await getTransaccionesByMes(mes.id);
                todasTransacciones.push(...trans);
            }
            setTransacciones(todasTransacciones);
        } catch (error) {
            console.error('Error al cargar transacciones:', error);
        } finally {
            setLoading(false);
        }
    };

    // Calcular cuotas activas
    const cuotasActivas = useMemo(() => {
        if (!selectedMonth || transacciones.length === 0) return [];
        return calcularCuotasActivas(transacciones, selectedMonth.mesAnio);
    }, [transacciones, selectedMonth]);

    // Proyectar cuotas para los pr√≥ximos meses
    const proyeccionMensual = useMemo(() => {
        if (cuotasActivas.length === 0 || !selectedMonth) return [];

        const proyecciones = [];
        const mesActualDate = new Date(selectedMonth.mesAnio + '-01');
        // Comenzar desde el mes siguiente al mes cargado
        mesActualDate.setMonth(mesActualDate.getMonth() + 1);

        for (let i = 0; i < mesesProyeccion; i++) {
            const fechaMes = new Date(mesActualDate);
            fechaMes.setMonth(fechaMes.getMonth() + i);

            const mesAnio = `${fechaMes.getFullYear()}-${String(fechaMes.getMonth() + 1).padStart(2, '0')}`;

            let totalMes = 0;
            const cuotasDelMes = [];

            for (const cuota of cuotasActivas) {
                // Si esta cuota a√∫n tiene cuotas restantes para este mes
                if (i < cuota.cuotasRestantes) {
                    totalMes += cuota.montoCuota;
                    cuotasDelMes.push({
                        ...cuota,
                        numeroCuota: cuota.cuotaActual + i + 1 // Cuota que se pagar√° este mes
                    });
                }
            }

            proyecciones.push({
                mesAnio,
                mesNombre: getNombreMes(mesAnio),
                total: totalMes,
                cuotas: cuotasDelMes,
                cantidadCuotas: cuotasDelMes.length
            });
        }

        return proyecciones;
    }, [cuotasActivas, selectedMonth, mesesProyeccion]);

    // Calcular totales
    const totalProyectado = useMemo(() => {
        return proyeccionMensual.reduce((sum, p) => sum + p.total, 0);
    }, [proyeccionMensual]);

    if (!selectedMonth) {
        return (
            <div className="max-w-7xl mx-auto">
                <EmptyState
                    icon="üìÖ"
                    title="Selecciona un mes"
                    description="Para ver las cuotas futuras, primero debes tener un mes cargado."
                />
            </div>
        );
    }

    if (loading) {
        return (
            <div className="max-w-7xl mx-auto">
                <div className="flex items-center justify-center min-h-screen">
                    <div className="text-center">
                        <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4"></div>
                        <p className="text-gray-900 text-xl font-semibold">Cargando cuotas...</p>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">üí≥ Cuotas Futuras</h1>
                    <p className="text-gray-600">Proyecci√≥n de pagos en cuotas para los pr√≥ximos meses</p>
                </div>
                <div className="flex items-center space-x-3">
                    <select
                        value={mesesProyeccion}
                        onChange={(e) => setMesesProyeccion(parseInt(e.target.value))}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white"
                    >
                        <option value={6}>6 meses</option>
                        <option value={12}>12 meses</option>
                        <option value={18}>18 meses</option>
                        <option value={24}>24 meses</option>
                    </select>
                </div>
            </div>

            {cuotasActivas.length === 0 ? (
                <EmptyState
                    icon="‚úÖ"
                    title="No tienes cuotas activas"
                    description="No hay compras en cuotas pendientes. ¬°Todas tus compras est√°n al d√≠a!"
                />
            ) : (
                <>
                    {/* Resumen General */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <CardStat
                            label="Compras en Cuotas"
                            value={cuotasActivas.length}
                            icon="üõí"
                            color="indigo"
                        />
                        <CardStat
                            label="Total Proyectado"
                            value={formatearMonto(totalProyectado)}
                            icon="üí∞"
                            color="purple"
                        />
                        <CardStat
                            label="Promedio Mensual"
                            value={formatearMonto(totalProyectado / mesesProyeccion)}
                            icon="üìä"
                            color="blue"
                        />
                    </div>

                    {/* Compras Activas */}
                    <Card title="Compras en Cuotas Activas" icon="üõçÔ∏è">
                        <div className="space-y-3">
                            {cuotasActivas.map((cuota, index) => {
                                const categoria = categorias.find(c => c.id === cuota.categoria);
                                const perfil = perfiles.find(p => p.id === cuota.perfilId);
                                const porcentajeCompletado = ((cuota.cuotaActual / cuota.cuotasTotal) * 100).toFixed(0);

                                return (
                                    <div key={index} className="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors">
                                        <div className="flex items-start justify-between">
                                            <div className="flex items-start space-x-4 flex-1">
                                                {/* Icono */}
                                                <div className="text-3xl">{categoria?.icono || 'üì¶'}</div>

                                                {/* Info */}
                                                <div className="flex-1">
                                                    <div className="flex items-center space-x-2 mb-2">
                                                        <h4 className="font-semibold text-gray-800 text-lg">{cuota.comercio}</h4>
                                                        {perfil && (
                                                            <Badge color="gray" size="sm">
                                                                {perfil.nombre}
                                                            </Badge>
                                                        )}
                                                    </div>

                                                    <p className="text-sm text-gray-600 mb-3">{truncarTexto(cuota.descripcion, 60)}</p>

                                                    {/* Barra de progreso */}
                                                    <div className="space-y-1">
                                                        <div className="flex items-center justify-between text-xs text-gray-600">
                                                            <span>Cuota {cuota.cuotaActual} de {cuota.cuotasTotal}</span>
                                                            <span>{porcentajeCompletado}% completado</span>
                                                        </div>
                                                        <ProgressBar
                                                            current={cuota.cuotaActual}
                                                            max={cuota.cuotasTotal}
                                                            height={8}
                                                        />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Montos */}
                                            <div className="text-right ml-4">
                                                <p className="text-2xl font-bold text-indigo-600">{formatearMonto(cuota.montoCuota)}</p>
                                                <p className="text-xs text-gray-600">por mes</p>
                                                <p className="text-sm text-gray-700 mt-2">
                                                    {cuota.cuotasRestantes} cuotas restantes
                                                </p>
                                                <p className="text-xs text-gray-500">
                                                    Total: {formatearMonto(cuota.montoTotal)}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </Card>

                    {/* Proyecci√≥n Mensual */}
                    <Card title="Proyecci√≥n Mensual" icon="üìÖ">
                        <div className="space-y-3">
                            {proyeccionMensual.map((mes, index) => {
                                const esProximoMes = index === 0;
                                const tieneGastos = mes.total > 0;

                                return (
                                    <div
                                        key={mes.mesAnio}
                                        className={`border-l-4 rounded-lg p-4 transition-all ${
                                            esProximoMes
                                                ? 'border-indigo-500 bg-indigo-50'
                                                : tieneGastos
                                                ? 'border-gray-300 bg-gray-50'
                                                : 'border-gray-200 bg-gray-50 opacity-60'
                                        }`}
                                    >
                                        <div className="flex items-center justify-between">
                                            <div className="flex-1">
                                                <div className="flex items-center space-x-2 mb-1">
                                                    <h4 className={`font-semibold ${esProximoMes ? 'text-indigo-900' : 'text-gray-800'}`}>
                                                        {mes.mesNombre}
                                                    </h4>
                                                    {esProximoMes && (
                                                        <Badge color="indigo" size="sm">Pr√≥ximo mes</Badge>
                                                    )}
                                                </div>

                                                {tieneGastos ? (
                                                    <p className="text-sm text-gray-600">
                                                        {mes.cantidadCuotas} cuota{mes.cantidadCuotas !== 1 ? 's' : ''} a pagar
                                                    </p>
                                                ) : (
                                                    <p className="text-sm text-gray-500">Sin cuotas este mes</p>
                                                )}
                                            </div>

                                            <div className="text-right">
                                                <p className={`text-2xl font-bold ${
                                                    esProximoMes ? 'text-indigo-600' : 'text-gray-800'
                                                }`}>
                                                    {formatearMonto(mes.total)}
                                                </p>
                                            </div>
                                        </div>

                                        {/* Detalle de cuotas del mes (colapsable) */}
                                        {tieneGastos && mes.cuotas.length > 0 && (
                                            <div className="mt-3 pt-3 border-t border-gray-200">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                    {mes.cuotas.map((cuota, idx) => (
                                                        <div key={idx} className="text-xs text-gray-600 flex items-center justify-between">
                                                            <span className="truncate">
                                                                {truncarTexto(cuota.comercio, 25)} ({cuota.numeroCuota}/{cuota.cuotasTotal})
                                                            </span>
                                                            <span className="font-semibold ml-2">{formatearMonto(cuota.montoCuota)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </Card>

                    {/* Gr√°fico de Barras de Proyecci√≥n */}
                    <Card title="Visualizaci√≥n Gr√°fica" icon="üìä">
                        <GraficoProyeccionCuotas proyeccion={proyeccionMensual} />
                    </Card>
                </>
            )}
        </div>
    );
};

// Componente de gr√°fico de proyecci√≥n
const GraficoProyeccionCuotas = memo(({ proyeccion }) => {
    const chartRef = useRef(null);
    const chartInstance = useRef(null);

    useEffect(() => {
        if (!chartRef.current || proyeccion.length === 0) return;

        // Preparar datos
        const labels = proyeccion.map(p => p.mesNombre);
        const data = proyeccion.map(p => p.total);

        // Destruir gr√°fico anterior
        if (chartInstance.current) {
            chartInstance.current.destroy();
        }

        // Crear gr√°fico
        const ctx = chartRef.current.getContext('2d');
        chartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Monto en Cuotas',
                    data,
                    backgroundColor: 'rgba(99, 102, 241, 0.6)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                return `Total: ${window.formatearMonto(context.parsed.y)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value === 0) return String.fromCharCode(36) + '0';
                                return String.fromCharCode(36) + Math.round(value).toLocaleString('es-CL');
                            }
                        }
                    }
                }
            }
        });

        return () => {
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, [proyeccion]);

    if (proyeccion.length === 0) {
        return (
            <div className="text-center text-gray-500 py-8">
                No hay datos para mostrar
            </div>
        );
    }

    const containerStyle = { position: 'relative', height: '400px' };

    return (
        <div style={containerStyle}>
            <canvas ref={chartRef}></canvas>
        </div>
    );
});

    </script>

    <script type="text/babel">
        // P√°gina Recurrentes - Gesti√≥n de gastos mensuales recurrentes

const Recurrentes = () => {
    const { perfiles, categorias } = useApp();
    const [recurrentes, setRecurrentes] = useState([]);
    const [showModal, setShowModal] = useState(false);
    const [recurrenteEditar, setRecurrenteEditar] = useState(null);
    const [showToast, setShowToast] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        cargarRecurrentes();
    }, []);

    const cargarRecurrentes = async () => {
        setLoading(true);
        try {
            const recs = await db.recurrentes.toArray();
            setRecurrentes(recs);
        } catch (error) {
            console.error('Error al cargar recurrentes:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleGuardar = async (recurrente) => {
        try {
            if (recurrenteEditar) {
                await db.recurrentes.update(recurrenteEditar.id, recurrente);
                setShowToast({ message: 'Recurrente actualizada', type: 'success' });
            } else {
                await db.recurrentes.add({ ...recurrente, activa: 1 });
                setShowToast({ message: 'Recurrente creada', type: 'success' });
            }
            cargarRecurrentes();
            setShowModal(false);
        } catch (error) {
            console.error('Error:', error);
            setShowToast({ message: 'Error al guardar', type: 'error' });
        }
    };

    const handleEliminar = async (id) => {
        if (!confirm('¬øEliminar esta recurrente?')) return;
        try {
            await db.recurrentes.delete(id);
            setShowToast({ message: 'Recurrente eliminada', type: 'success' });
            cargarRecurrentes();
        } catch (error) {
            console.error('Error:', error);
        }
    };

    const handleToggleActiva = async (rec) => {
        try {
            await db.recurrentes.update(rec.id, { activa: rec.activa ? 0 : 1 });
            cargarRecurrentes();
        } catch (error) {
            console.error('Error:', error);
        }
    };

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Gastos Recurrentes</h1>
                    <p className="text-gray-600 dark:text-gray-400">Gestiona gastos mensuales, anuales, semestrales y m√°s</p>
                </div>
                <button onClick={() => { setRecurrenteEditar(null); setShowModal(true); }} className="px-6 py-3 bg-white text-indigo-600 font-semibold rounded-lg hover:bg-indigo-50 transition-colors shadow-lg">
                    + Nueva Recurrente
                </button>
            </div>

            <Card>
                {loading ? (
                    <div className="text-center py-8">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                    </div>
                ) : recurrentes.length === 0 ? (
                    <EmptyState icon="üîÑ" title="No hay recurrentes" description="Agrega gastos que se repiten cada mes como Netflix, servicios, etc." />
                ) : (
                    <div className="space-y-3">
                        {recurrentes.map(rec => {
                            const categoria = categorias.find(c => c.id === rec.categoria);
                            const perfil = perfiles.find(p => p.id === rec.perfilId);

                            // Calcular info de pr√≥ximo pago
                            const fechaPago = new Date(rec.fechaProximoPago + 'T00:00:00');
                            const hoy = new Date();
                            const diasHasta = Math.ceil((fechaPago - hoy) / (1000 * 60 * 60 * 24));

                            const getFrecuenciaLabel = (frec) => {
                                const labels = {
                                    'mensual': 'Mensual',
                                    'bimestral': 'Bimestral',
                                    'trimestral': 'Trimestral',
                                    'semestral': 'Semestral',
                                    'anual': 'Anual'
                                };
                                return labels[frec] || frec;
                            };

                            const getMesesFrecuencia = (frec) => {
                                const meses = {
                                    'mensual': 1,
                                    'bimestral': 2,
                                    'trimestral': 3,
                                    'semestral': 6,
                                    'anual': 12
                                };
                                return meses[frec] || 1;
                            };

                            const montoMensual = rec.monto / getMesesFrecuencia(rec.frecuencia || 'mensual');
                            const urgencia = diasHasta <= 7 ? 'urgent' : diasHasta <= 30 ? 'soon' : 'later';

                            return (
                                <div key={rec.id} className="flex items-center justify-between p-4 bg-gray-50 dark:bg-slate-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                                    <div className="flex items-center space-x-4 flex-1">
                                        <span className="text-3xl">{categoria?.icono || 'üîÑ'}</span>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center space-x-2 flex-wrap">
                                                <h3 className="font-semibold text-gray-800 dark:text-white">{rec.nombre}</h3>
                                                {!rec.activa && <Badge color="gray" size="sm">Inactiva</Badge>}
                                                <Badge color={urgencia === 'urgent' ? 'red' : urgencia === 'soon' ? 'yellow' : 'blue'} size="sm">
                                                    {getFrecuenciaLabel(rec.frecuencia)}
                                                </Badge>
                                            </div>
                                            <p className="text-sm text-gray-600 dark:text-gray-400">{categoria?.nombre} ‚Ä¢ {perfil?.nombre}</p>
                                            <p className={`text-xs font-medium mt-1 ${
                                                urgencia === 'urgent' ? 'text-red-600 dark:text-red-400' :
                                                urgencia === 'soon' ? 'text-yellow-600 dark:text-yellow-400' :
                                                'text-blue-600 dark:text-blue-400'
                                            }`}>
                                                {diasHasta < 0 ? `Vencido hace ${Math.abs(diasHasta)} d√≠as` :
                                                 diasHasta === 0 ? 'Vence hoy' :
                                                 diasHasta === 1 ? 'Vence ma√±ana' :
                                                 `Pr√≥ximo pago: ${fechaPago.toLocaleDateString('es-CL', { day: 'numeric', month: 'short' })}`}
                                            </p>
                                        </div>
                                        <div className="text-right flex-shrink-0">
                                            <p className="text-lg font-bold text-gray-800 dark:text-white">{formatearMonto(rec.monto)}</p>
                                            {rec.frecuencia !== 'mensual' && (
                                                <p className="text-xs text-gray-500 dark:text-gray-400">‚âà {formatearMonto(montoMensual)}/mes</p>
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex items-center space-x-2 ml-4">
                                        <button onClick={() => handleToggleActiva(rec)} className={`px-3 py-1 rounded text-sm font-medium ${rec.activa ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}`}>
                                            {rec.activa ? '‚úì Activa' : 'Inactiva'}
                                        </button>
                                        <button onClick={() => { setRecurrenteEditar(rec); setShowModal(true); }} className="p-2 text-indigo-600 hover:bg-indigo-100 rounded-lg">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                        </button>
                                        <button onClick={() => handleEliminar(rec.id)} className="p-2 text-red-600 hover:bg-red-100 rounded-lg">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                        </button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </Card>

            {showModal && <ModalRecurrente recurrente={recurrenteEditar} perfiles={perfiles} categorias={categorias} onClose={() => setShowModal(false)} onGuardar={handleGuardar} />}
            {showToast && <Toast message={showToast.message} type={showToast.type} onClose={() => setShowToast(null)} />}
        </div>
    );
};

const ModalRecurrente = ({ recurrente, perfiles, categorias, onClose, onGuardar }) => {
    const [form, setForm] = useState({
        nombre: recurrente?.nombre || '',
        categoria: recurrente?.categoria || categorias[0]?.id,
        perfilId: recurrente?.perfilId || perfiles[0]?.id,
        monto: recurrente?.monto || recurrente?.montoEstimado || 0,
        frecuencia: recurrente?.frecuencia || 'mensual',
        fechaProximoPago: recurrente?.fechaProximoPago || new Date().toISOString().split('T')[0]
    });

    const frecuencias = [
        { value: 'mensual', label: 'Mensual', meses: 1 },
        { value: 'bimestral', label: 'Bimestral (cada 2 meses)', meses: 2 },
        { value: 'trimestral', label: 'Trimestral (cada 3 meses)', meses: 3 },
        { value: 'semestral', label: 'Semestral (cada 6 meses)', meses: 6 },
        { value: 'anual', label: 'Anual (cada 12 meses)', meses: 12 }
    ];

    const getMesesFrecuencia = (frec) => {
        const f = frecuencias.find(f => f.value === frec);
        return f ? f.meses : 1;
    };

    const calcularMontoMensual = () => {
        const meses = getMesesFrecuencia(form.frecuencia);
        return meses > 0 ? (form.monto / meses).toFixed(0) : 0;
    };

    return (
        <Modal isOpen={true} onClose={onClose} title={recurrente ? 'Editar Recurrente' : 'Nueva Recurrente'} size="md">
            <form onSubmit={(e) => { e.preventDefault(); onGuardar(form); }} className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre</label>
                    <input
                        type="text"
                        value={form.nombre}
                        onChange={(e) => setForm({ ...form, nombre: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="Ej: Netflix, Seguro Auto, Spotify"
                        required
                    />
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categor√≠a</label>
                        <select
                            value={form.categoria}
                            onChange={(e) => setForm({ ...form, categoria: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                            required
                        >
                            {categorias.map(c => <option key={c.id} value={c.id}>{c.icono} {c.nombre}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Perfil</label>
                        <select
                            value={form.perfilId}
                            onChange={(e) => setForm({ ...form, perfilId: parseInt(e.target.value) })}
                            className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                            required
                        >
                            {perfiles.map(p => <option key={p.id} value={p.id}>{p.nombre}</option>)}
                        </select>
                    </div>
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Frecuencia de pago</label>
                    <select
                        value={form.frecuencia}
                        onChange={(e) => setForm({ ...form, frecuencia: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                        required
                    >
                        {frecuencias.map(f => <option key={f.value} value={f.value}>{f.label}</option>)}
                    </select>
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monto del pago</label>
                        <input
                            type="number"
                            value={form.monto}
                            onChange={(e) => setForm({ ...form, monto: parseFloat(e.target.value) || 0 })}
                            className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                            required
                            min="0"
                            step="100"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pr√≥ximo pago</label>
                        <input
                            type="date"
                            value={form.fechaProximoPago}
                            onChange={(e) => setForm({ ...form, fechaProximoPago: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                            required
                        />
                    </div>
                </div>

                {form.frecuencia !== 'mensual' && (
                    <div className="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-lg p-3">
                        <p className="text-sm text-indigo-700 dark:text-indigo-300">
                            üí° Impacto mensual promedio: <span className="font-bold">{formatearMonto(calcularMontoMensual())}</span>
                        </p>
                    </div>
                )}

                <div className="flex space-x-3 pt-4">
                    <button
                        type="button"
                        onClick={onClose}
                        className="flex-1 px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 text-gray-700 dark:text-gray-300"
                    >
                        Cancelar
                    </button>
                    <button
                        type="submit"
                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold"
                    >
                        {recurrente ? 'Actualizar' : 'Crear'}
                    </button>
                </div>
            </form>
        </Modal>
    );
};

    </script>

    <script type="text/babel">
        // P√°gina Simulador - An√°lisis de impacto de nuevas compras

const Simulador = () => {
    const { selectedMonth, categorias } = useApp();
    const [montoCompra, setMontoCompra] = useState('');
    const [cuotas, setCuotas] = useState('1');
    const [simulacionActiva, setSimulacionActiva] = useState(false);
    const [resultadoSimulacion, setResultadoSimulacion] = useState(null);
    const [proyeccionBase, setProyeccionBase] = useState([]);
    const [loading, setLoading] = useState(false);

    const handleSimular = async () => {
        if (!montoCompra || !cuotas) return;

        setLoading(true);
        try {
            // Obtener cuotas activas
            const todasTransacciones = await db.transacciones.toArray();
            const cuotasActivas = calcularCuotasActivas(todasTransacciones, selectedMonth?.mesAnio || getMesAnio(new Date()));

            // Obtener recurrentes activas
            const recurrentesActivas = await getRecurrentesActivas();

            // Obtener compras planeadas
            const comprasPlaneadas = await getComprasPlaneadas();

            // Proyectar sin la nueva compra
            const proyeccionSinCompra = await proyectarGastosFuturos(
                cuotasActivas,
                recurrentesActivas,
                comprasPlaneadas,
                selectedMonth?.mesAnio || getMesAnio(new Date()),
                12
            );

            // Calcular presupuesto mensual promedio
            const presupuestoMensual = proyeccionSinCompra.reduce((sum, p) => sum + p.total, 0) / 12;

            // Simular nueva compra
            const resultado = simularNuevaCompra(
                parseFloat(montoCompra),
                parseInt(cuotas),
                proyeccionSinCompra,
                presupuestoMensual * 1.1 // 10% m√°s de margen
            );

            setProyeccionBase(proyeccionSinCompra);
            setResultadoSimulacion(resultado);
            setSimulacionActiva(true);
        } catch (error) {
            console.error('Error en simulaci√≥n:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleLimpiar = () => {
        setMontoCompra('');
        setCuotas('1');
        setSimulacionActiva(false);
        setResultadoSimulacion(null);
    };

    const handleAgregarAPlaneadas = async () => {
        if (!resultadoSimulacion) return;

        try {
            await addCompraPlaneada({
                nombre: 'Compra simulada',
                monto: parseFloat(montoCompra),
                cuotas: parseInt(cuotas),
                categoria: categorias[0].id,
                perfilId: 1
            });
            alert('Compra agregada a planeadas');
        } catch (error) {
            console.error('Error:', error);
        }
    };

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            <div>
                <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Simulador de Compras</h1>
                <p className="text-gray-600">Analiza el impacto de una nueva compra en tu presupuesto</p>
            </div>

            {/* Formulario de simulaci√≥n */}
            <Card title="Nueva Compra" icon="üßÆ">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Monto Total</label>
                        <input
                            type="number"
                            value={montoCompra}
                            onChange={(e) => setMontoCompra(e.target.value)}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="Ej: 500000"
                            min="0"
                            step="1000"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Cantidad de Cuotas</label>
                        <select
                            value={cuotas}
                            onChange={(e) => setCuotas(e.target.value)}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        >
                            {[1, 3, 6, 9, 12, 18, 24, 36].map(n => (
                                <option key={n} value={n}>{n} {n === 1 ? 'cuota' : 'cuotas'}</option>
                            ))}
                        </select>
                    </div>
                    <div className="flex items-end space-x-2">
                        <button
                            onClick={handleSimular}
                            disabled={!montoCompra || loading}
                            className="flex-1 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50"
                        >
                            {loading ? 'Simulando...' : 'Simular'}
                        </button>
                        {simulacionActiva && (
                            <button
                                onClick={handleLimpiar}
                                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                            >
                                Limpiar
                            </button>
                        )}
                    </div>
                </div>

                {montoCompra && cuotas && (
                    <div className="mt-4 p-4 bg-indigo-50 rounded-lg">
                        <p className="text-sm text-indigo-800">
                            Cuota mensual: <strong>{formatearMonto(parseFloat(montoCompra) / parseInt(cuotas))}</strong> durante {cuotas} meses
                        </p>
                    </div>
                )}
            </Card>

            {/* Resultado de la simulaci√≥n */}
            {simulacionActiva && resultadoSimulacion && (
                <>
                    {/* Recomendaci√≥n */}
                    <Card>
                        <div className={`p-6 rounded-lg ${
                            resultadoSimulacion.nivelRiesgo === 'bajo' ? 'bg-green-50 border-2 border-green-300' :
                            resultadoSimulacion.nivelRiesgo === 'medio' ? 'bg-yellow-50 border-2 border-yellow-300' :
                            'bg-red-50 border-2 border-red-300'
                        }`}>
                            <div className="flex items-start space-x-4">
                                <span className="text-4xl">
                                    {resultadoSimulacion.nivelRiesgo === 'bajo' ? '‚úÖ' : resultadoSimulacion.nivelRiesgo === 'medio' ? '‚ö†Ô∏è' : '‚ùå'}
                                </span>
                                <div className="flex-1">
                                    <h3 className={`text-xl font-bold mb-2 ${
                                        resultadoSimulacion.nivelRiesgo === 'bajo' ? 'text-green-800' :
                                        resultadoSimulacion.nivelRiesgo === 'medio' ? 'text-yellow-800' :
                                        'text-red-800'
                                    }`}>
                                        {resultadoSimulacion.nivelRiesgo === 'bajo' ? 'Compra Viable' :
                                         resultadoSimulacion.nivelRiesgo === 'medio' ? 'Compra Riesgosa' :
                                         'Compra No Recomendada'}
                                    </h3>
                                    <p className="text-gray-700">{resultadoSimulacion.recomendacion}</p>
                                    {resultadoSimulacion.mesesExcedidos > 0 && (
                                        <p className="text-sm text-gray-600 mt-2">
                                            {resultadoSimulacion.mesesExcedidos} mes(es) superar√≠an el presupuesto proyectado
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </Card>

                    {/* Estad√≠sticas */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <CardStat
                            label="Cuota Mensual"
                            value={formatearMonto(resultadoSimulacion.montoCuota)}
                            icon="üí≥"
                            color="indigo"
                        />
                        <CardStat
                            label="Meses con Excedente"
                            value={resultadoSimulacion.mesesExcedidos}
                            icon="‚ö†Ô∏è"
                            color={resultadoSimulacion.mesesExcedidos === 0 ? 'green' : 'red'}
                        />
                        <CardStat
                            label="Mayor Excedente"
                            value={formatearMonto(resultadoSimulacion.excedenteMayor)}
                            icon="üìä"
                            color="yellow"
                        />
                    </div>

                    {/* Gr√°fico comparativo */}
                    <Card title="Proyecci√≥n Comparativa (12 meses)" icon="üìà">
                        <GraficoProyeccion
                            proyeccionSinCompra={proyeccionBase}
                            proyeccionConCompra={resultadoSimulacion.proyeccionConCompra}
                        />
                    </Card>

                    {/* Acciones */}
                    <div className="flex justify-center">
                        <button
                            onClick={handleAgregarAPlaneadas}
                            className="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors"
                        >
                            Agregar a Compras Planeadas
                        </button>
                    </div>
                </>
            )}

            {/* Estado inicial */}
            {!simulacionActiva && !loading && (
                <EmptyState
                    icon="üßÆ"
                    title="Ingresa los datos de tu compra"
                    description="Simula el impacto de una nueva compra en cuotas y recibe una recomendaci√≥n basada en tu proyecci√≥n financiera."
                />
            )}
        </div>
    );
};

// Gr√°fico de proyecci√≥n comparativa
const GraficoProyeccion = memo(({ proyeccionSinCompra, proyeccionConCompra }) => {
    const chartRef = useRef(null);
    const chartInstance = useRef(null);

    useEffect(() => {
        if (!chartRef.current) return;

        if (chartInstance.current) {
            chartInstance.current.destroy();
        }

        const ctx = chartRef.current.getContext('2d');
        chartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: proyeccionSinCompra.map(p => p.mesNombre.split(' ')[0]),
                datasets: [
                    {
                        label: 'Sin compra',
                        data: proyeccionSinCompra.map(p => p.total),
                        backgroundColor: '#6366f1',
                        borderColor: '#4f46e5',
                        borderWidth: 1
                    },
                    {
                        label: 'Con compra',
                        data: proyeccionConCompra.map(p => p.total),
                        backgroundColor: '#ef4444',
                        borderColor: '#dc2626',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                return `${context.dataset.label}: ${formatearMonto(context.parsed.y)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => formatearMonto(value, false)
                        }
                    }
                }
            }
        });

        return () => {
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, [proyeccionSinCompra, proyeccionConCompra]);

    return (
        <div className="chart-container">
            <canvas ref={chartRef}></canvas>
        </div>
    );
});

    </script>

    <script type="text/babel">
        // P√°gina Ingresos - Gesti√≥n de ingresos mensuales

const Ingresos = () => {
    const { selectedMonth, perfiles } = useApp();
    const [ingresos, setIngresos] = useState([]);
    const [showModal, setShowModal] = useState(false);
    const [ingresoEditar, setIngresoEditar] = useState(null);
    const [showToast, setShowToast] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (selectedMonth) {
            cargarIngresos();
        }
    }, [selectedMonth]);

    const cargarIngresos = async () => {
        if (!selectedMonth) return;

        setLoading(true);
        try {
            const ings = await getIngresos(selectedMonth.mesAnio);
            setIngresos(ings);
        } catch (error) {
            console.error('Error al cargar ingresos:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleGuardar = async (ingreso) => {
        try {
            if (ingresoEditar) {
                await updateIngreso(ingresoEditar.id, ingreso);
                setShowToast({ message: 'Ingreso actualizado', type: 'success' });
            } else {
                await addIngreso({ ...ingreso, mesAnio: selectedMonth.mesAnio });
                setShowToast({ message: 'Ingreso agregado', type: 'success' });
            }
            cargarIngresos();
            setShowModal(false);
            setIngresoEditar(null);
        } catch (error) {
            console.error('Error:', error);
            setShowToast({ message: 'Error al guardar', type: 'error' });
        }
    };

    const handleEliminar = async (id) => {
        if (!confirm('¬øEliminar este ingreso?')) return;
        try {
            await deleteIngreso(id);
            setShowToast({ message: 'Ingreso eliminado', type: 'success' });
            cargarIngresos();
        } catch (error) {
            console.error('Error:', error);
        }
    };

    // Calcular totales
    const totalesPorPerfil = useMemo(() => {
        const totales = {};
        perfiles.forEach(p => {
            totales[p.id] = ingresos
                .filter(i => i.perfilId === p.id)
                .reduce((sum, i) => sum + i.monto, 0);
        });
        return totales;
    }, [ingresos, perfiles]);

    const totalGeneral = Object.values(totalesPorPerfil).reduce((sum, val) => sum + val, 0);

    if (!selectedMonth) {
        return (
            <div className="max-w-7xl mx-auto">
                <EmptyState
                    icon="üìÖ"
                    title="Selecciona un mes"
                    description="Para gestionar ingresos, primero debes tener un mes cargado."
                />
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Ingresos del Mes</h1>
                    <p className="text-gray-600">{getNombreMes(selectedMonth.mesAnio)}</p>
                </div>
                <button
                    onClick={() => { setIngresoEditar(null); setShowModal(true); }}
                    className="px-6 py-3 bg-white text-indigo-600 font-semibold rounded-lg hover:bg-indigo-50 transition-colors shadow-lg"
                >
                    + Agregar Ingreso
                </button>
            </div>

            {/* Totales por perfil */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {perfiles.map(perfil => (
                    <CardStat
                        key={perfil.id}
                        label={`Ingresos ${perfil.nombre}`}
                        value={formatearMonto(totalesPorPerfil[perfil.id] || 0)}
                        icon="üí∞"
                        color={perfil.id === 1 ? 'green' : 'blue'}
                    />
                ))}
                <CardStat
                    label="Total Familiar"
                    value={formatearMonto(totalGeneral)}
                    icon="üíµ"
                    color="indigo"
                />
            </div>

            {/* Lista de ingresos */}
            <Card>
                {loading ? (
                    <div className="text-center py-8">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                    </div>
                ) : ingresos.length === 0 ? (
                    <EmptyState
                        icon="üí∞"
                        title="No hay ingresos registrados"
                        description="Agrega los ingresos mensuales tuyos y de tu esposa para hacer seguimiento del balance."
                    />
                ) : (
                    <div className="space-y-3">
                        {ingresos.map(ingreso => {
                            const perfil = perfiles.find(p => p.id === ingreso.perfilId);

                            return (
                                <div
                                    key={ingreso.id}
                                    className="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                                >
                                    <div className="flex items-center space-x-4 flex-1">
                                        <div
                                            className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold"
                                            style={{ backgroundColor: perfil?.color || '#6366f1' }}
                                        >
                                            {perfil?.nombre.charAt(0).toUpperCase() || '?'}
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="font-semibold text-gray-800">{ingreso.descripcion}</h3>
                                            <p className="text-sm text-gray-600">
                                                {perfil?.nombre}
                                                {ingreso.esRecurrente && <Badge color="green" size="sm" className="ml-2">Recurrente</Badge>}
                                            </p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-lg font-bold text-green-600">{formatearMonto(ingreso.monto)}</p>
                                            <p className="text-xs text-gray-500">{formatearFecha(ingreso.fecha)}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center space-x-2 ml-4">
                                        <button
                                            onClick={() => { setIngresoEditar(ingreso); setShowModal(true); }}
                                            className="p-2 text-indigo-600 hover:bg-indigo-100 rounded-lg"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <button
                                            onClick={() => handleEliminar(ingreso.id)}
                                            className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </Card>

            {showModal && (
                <ModalIngreso
                    ingreso={ingresoEditar}
                    perfiles={perfiles}
                    onClose={() => { setShowModal(false); setIngresoEditar(null); }}
                    onGuardar={handleGuardar}
                />
            )}

            {showToast && <Toast message={showToast.message} type={showToast.type} onClose={() => setShowToast(null)} />}
        </div>
    );
};

const ModalIngreso = ({ ingreso, perfiles, onClose, onGuardar }) => {
    const [form, setForm] = useState({
        descripcion: ingreso?.descripcion || '',
        perfilId: ingreso?.perfilId || perfiles[0]?.id,
        monto: ingreso?.monto || 0,
        esRecurrente: ingreso?.esRecurrente || false
    });

    return (
        <Modal isOpen={true} onClose={onClose} title={ingreso ? 'Editar Ingreso' : 'Nuevo Ingreso'} size="md">
            <form onSubmit={(e) => { e.preventDefault(); onGuardar(form); }} className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                    <input
                        type="text"
                        value={form.descripcion}
                        onChange={(e) => setForm({ ...form, descripcion: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="Ej: Sueldo, Bono, Freelance"
                        required
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Perfil</label>
                    <select
                        value={form.perfilId}
                        onChange={(e) => setForm({ ...form, perfilId: parseInt(e.target.value) })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        required
                    >
                        {perfiles.map(p => (
                            <option key={p.id} value={p.id}>{p.nombre}</option>
                        ))}
                    </select>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Monto</label>
                    <input
                        type="number"
                        value={form.monto}
                        onChange={(e) => setForm({ ...form, monto: parseFloat(e.target.value) || 0 })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        required
                        min="0"
                        step="1000"
                    />
                </div>
                <div className="flex items-center">
                    <input
                        type="checkbox"
                        id="esRecurrente"
                        checked={form.esRecurrente}
                        onChange={(e) => setForm({ ...form, esRecurrente: e.target.checked })}
                        className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                    />
                    <label htmlFor="esRecurrente" className="ml-2 text-sm text-gray-700">
                        Ingreso recurrente mensual
                    </label>
                </div>
                <div className="flex space-x-3 pt-4">
                    <button type="button" onClick={onClose} className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        {ingreso ? 'Actualizar' : 'Crear'}
                    </button>
                </div>
            </form>
        </Modal>
    );
};

    </script>

    <script type="text/babel">
        // Componente Reembolsos - Sistema completo de seguimiento de reembolsos

const Reembolsos = () => {
    const { perfiles, mesesCargados } = useApp();
    const [reembolsos, setReembolsos] = useState([]);
    const [loading, setLoading] = useState(true);
    const [filtroEstado, setFiltroEstado] = useState('todos'); // todos, pendiente, solicitado, pagado
    const [showModalNuevo, setShowModalNuevo] = useState(false);
    const [showToast, setShowToast] = useState(null);

    useEffect(() => {
        cargarReembolsos();
    }, [filtroEstado]);

    const cargarReembolsos = async () => {
        setLoading(true);
        try {
            const estado = filtroEstado === 'todos' ? null : filtroEstado;
            const data = await getReembolsosConTransacciones(estado);
            setReembolsos(data);
        } catch (error) {
            console.error('Error al cargar reembolsos:', error);
            mostrarToast('Error al cargar reembolsos', 'error');
        } finally {
            setLoading(false);
        }
    };

    const mostrarToast = (message, type = 'info') => {
        setShowToast({ message, type });
        setTimeout(() => setShowToast(null), 3000);
    };

    const handleCambiarEstado = async (reembolsoId, nuevoEstado) => {
        try {
            await updateEstadoReembolso(reembolsoId, nuevoEstado);
            await cargarReembolsos();
            mostrarToast(`Estado actualizado a: ${nuevoEstado}`, 'success');
        } catch (error) {
            console.error('Error:', error);
            mostrarToast('Error al actualizar estado', 'error');
        }
    };

    const handleEliminar = async (reembolsoId) => {
        if (!confirm('¬øEst√°s seguro de eliminar este reembolso?')) return;

        try {
            await deleteReembolso(reembolsoId);
            await cargarReembolsos();
            mostrarToast('Reembolso eliminado', 'success');
        } catch (error) {
            console.error('Error:', error);
            mostrarToast('Error al eliminar', 'error');
        }
    };

    // Calcular totales
    const totales = useMemo(() => {
        const pendientes = reembolsos.filter(r => r.estado === 'pendiente');
        const solicitados = reembolsos.filter(r => r.estado === 'solicitado');
        const pagados = reembolsos.filter(r => r.estado === 'pagado');

        return {
            pendiente: pendientes.reduce((sum, r) => sum + calcularMontoTotal(r), 0),
            solicitado: solicitados.reduce((sum, r) => sum + calcularMontoTotal(r), 0),
            pagado: pagados.reduce((sum, r) => sum + calcularMontoTotal(r), 0),
            total: reembolsos.reduce((sum, r) => sum + calcularMontoTotal(r), 0)
        };
    }, [reembolsos]);

    const calcularMontoTotal = (reembolso) => {
        if (reembolso.tipoCompra === 'spot') {
            return reembolso.transaccion?.monto || 0;
        } else {
            // Para cuotas: monto de la cuota * total de cuotas
            const montoCuota = reembolso.transaccion?.monto || 0;
            return montoCuota * reembolso.cuotasTotal;
        }
    };

    const getColorEstado = (estado) => {
        switch (estado) {
            case 'pendiente': return 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400';
            case 'solicitado': return 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400';
            case 'pagado': return 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400';
            default: return 'bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300';
        }
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4"></div>
                    <p className="text-gray-600 dark:text-gray-400">Cargando reembolsos...</p>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Reembolsos</h1>
                    <p className="text-gray-600 dark:text-gray-400">Gestiona gastos a reembolsar y devoluciones</p>
                </div>
                <button
                    onClick={() => setShowModalNuevo(true)}
                    className="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition-colors flex items-center space-x-2"
                >
                    <span>+</span>
                    <span>Nuevo Reembolso</span>
                </button>
            </div>

            {/* Estad√≠sticas */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <CardStat
                    label="Pendientes"
                    value={formatearMonto(totales.pendiente)}
                    icon="‚è≥"
                    color="yellow"
                    subtitle={`${reembolsos.filter(r => r.estado === 'pendiente').length} reembolsos`}
                />
                <CardStat
                    label="Solicitados"
                    value={formatearMonto(totales.solicitado)}
                    icon="üì§"
                    color="blue"
                    subtitle={`${reembolsos.filter(r => r.estado === 'solicitado').length} reembolsos`}
                />
                <CardStat
                    label="Pagados"
                    value={formatearMonto(totales.pagado)}
                    icon="‚úÖ"
                    color="green"
                    subtitle={`${reembolsos.filter(r => r.estado === 'pagado').length} reembolsos`}
                />
                <CardStat
                    label="Total"
                    value={formatearMonto(totales.total)}
                    icon="üí∞"
                    color="indigo"
                    subtitle={`${reembolsos.length} reembolsos`}
                />
            </div>

            {/* Filtros */}
            <div className="bg-white dark:bg-slate-800 rounded-lg shadow-md border border-gray-200 dark:border-slate-700 p-4">
                <div className="flex items-center space-x-2">
                    <span className="text-sm font-semibold text-gray-700 dark:text-gray-300">Filtrar por estado:</span>
                    {['todos', 'pendiente', 'solicitado', 'pagado'].map(estado => (
                        <button
                            key={estado}
                            onClick={() => setFiltroEstado(estado)}
                            className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${
                                filtroEstado === estado
                                    ? 'bg-indigo-600 text-white'
                                    : 'bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-600'
                            }`}
                        >
                            {estado.charAt(0).toUpperCase() + estado.slice(1)}
                        </button>
                    ))}
                </div>
            </div>

            {/* Lista de Reembolsos */}
            {reembolsos.length === 0 ? (
                <EmptyState
                    icon="üí∏"
                    title="No hay reembolsos"
                    description="Crea un nuevo reembolso para comenzar el seguimiento"
                    action={
                        <button
                            onClick={() => setShowModalNuevo(true)}
                            className="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition-colors"
                        >
                            Crear Reembolso
                        </button>
                    }
                />
            ) : (
                <div className="space-y-4">
                    {reembolsos.map(reembolso => (
                        <ReembolsoCard
                            key={reembolso.id}
                            reembolso={reembolso}
                            perfiles={perfiles}
                            onCambiarEstado={handleCambiarEstado}
                            onEliminar={handleEliminar}
                            getColorEstado={getColorEstado}
                            calcularMontoTotal={calcularMontoTotal}
                        />
                    ))}
                </div>
            )}

            {/* Modales */}
            {showModalNuevo && (
                <ModalNuevoReembolso
                    onClose={() => setShowModalNuevo(false)}
                    onSuccess={() => {
                        cargarReembolsos();
                        setShowModalNuevo(false);
                        mostrarToast('Reembolso creado exitosamente', 'success');
                    }}
                    mesesCargados={mesesCargados}
                    perfiles={perfiles}
                />
            )}

            {/* Toast */}
            {showToast && (
                <Toast
                    message={showToast.message}
                    type={showToast.type}
                    onClose={() => setShowToast(null)}
                />
            )}
        </div>
    );
};

// Componente Card para cada reembolso
const ReembolsoCard = memo(({ reembolso, perfiles, onCambiarEstado, onEliminar, getColorEstado, calcularMontoTotal }) => {
    const [mostrarDetalle, setMostrarDetalle] = useState(false);
    const transaccion = reembolso.transaccion;
    const perfil = perfiles.find(p => p.id === transaccion?.perfilId);

    const montoTotal = calcularMontoTotal(reembolso);

    return (
        <Card className="hover-lift">
            <div className="flex items-start justify-between">
                <div className="flex-1">
                    <div className="flex items-center space-x-3 mb-2">
                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${getColorEstado(reembolso.estado)}`}>
                            {reembolso.estado.toUpperCase()}
                        </span>
                        <span className="text-sm text-gray-500 dark:text-gray-400">
                            {reembolso.tipoCompra === 'cuotas' ? 'üìÖ Compra en cuotas' : '‚ö° Compra spot'}
                        </span>
                    </div>

                    <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-1">
                        {transaccion?.comercio || 'Comercio desconocido'}
                    </h3>
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        {transaccion?.descripcion || 'Sin descripci√≥n'}
                    </p>

                    <div className="flex items-center space-x-4 text-sm">
                        <span className="text-gray-600 dark:text-gray-400">
                            üë§ <strong>Deudor:</strong> {reembolso.nombreDeudor}
                        </span>
                        <span className="text-gray-600 dark:text-gray-400">
                            üí∞ <strong>Total:</strong> {formatearMonto(montoTotal)}
                        </span>
                        {reembolso.tipoCompra === 'cuotas' && (
                            <span className="text-gray-600 dark:text-gray-400">
                                üìä <strong>Cuotas:</strong> {reembolso.cuotasTotal}x {formatearMonto(transaccion?.monto || 0)}
                            </span>
                        )}
                    </div>

                    <button
                        onClick={() => setMostrarDetalle(!mostrarDetalle)}
                        className="mt-2 text-xs text-indigo-600 dark:text-indigo-400 hover:underline"
                    >
                        {mostrarDetalle ? '‚ñ≤ Ocultar detalle' : '‚ñº Ver detalle'}
                    </button>

                    {mostrarDetalle && (
                        <div className="mt-3 p-3 bg-gray-50 dark:bg-slate-700 rounded-lg text-sm space-y-1">
                            <p><strong>Fecha creaci√≥n:</strong> {formatearFecha(reembolso.fechaCreacion)}</p>
                            {reembolso.fechaSolicitud && (
                                <p><strong>Fecha solicitud:</strong> {formatearFecha(reembolso.fechaSolicitud)}</p>
                            )}
                            {reembolso.fechaPago && (
                                <p><strong>Fecha pago:</strong> {formatearFecha(reembolso.fechaPago)}</p>
                            )}
                            <p><strong>Perfil:</strong> {perfil?.nombre || 'Desconocido'}</p>
                            <p><strong>Categor√≠a:</strong> {transaccion?.categoria || 'Sin categor√≠a'}</p>
                        </div>
                    )}
                </div>

                <div className="flex flex-col space-y-2 ml-4">
                    {reembolso.estado === 'pendiente' && (
                        <button
                            onClick={() => onCambiarEstado(reembolso.id, 'solicitado')}
                            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold transition-colors"
                        >
                            Marcar Solicitado
                        </button>
                    )}
                    {reembolso.estado === 'solicitado' && (
                        <button
                            onClick={() => onCambiarEstado(reembolso.id, 'pagado')}
                            className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-colors"
                        >
                            Marcar Pagado
                        </button>
                    )}
                    <button
                        onClick={() => onEliminar(reembolso.id)}
                        className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-semibold transition-colors"
                    >
                        Eliminar
                    </button>
                </div>
            </div>
        </Card>
    );
});

// Modal para crear nuevo reembolso
const ModalNuevoReembolso = ({ onClose, onSuccess, mesesCargados, perfiles }) => {
    const [paso, setPaso] = useState(1); // 1: Seleccionar transacci√≥n, 2: Confirmar datos
    const [mesSeleccionado, setMesSeleccionado] = useState(null);
    const [transacciones, setTransacciones] = useState([]);
    const [transaccionSeleccionada, setTransaccionSeleccionada] = useState(null);
    const [nombreDeudor, setNombreDeudor] = useState('');
    const [guardando, setGuardando] = useState(false);

    useEffect(() => {
        if (mesesCargados.length > 0 && !mesSeleccionado) {
            const mesReciente = mesesCargados.sort((a, b) =>
                new Date(b.mesAnio) - new Date(a.mesAnio)
            )[0];
            setMesSeleccionado(mesReciente);
        }
    }, [mesesCargados]);

    useEffect(() => {
        if (mesSeleccionado) {
            cargarTransacciones();
        }
    }, [mesSeleccionado]);

    const cargarTransacciones = async () => {
        try {
            const trans = await getTransaccionesByMes(mesSeleccionado.id);
            // Filtrar solo las que NO son reembolsables a√∫n
            const disponibles = trans.filter(t => !t.esReembolsable);
            setTransacciones(disponibles);
        } catch (error) {
            console.error('Error:', error);
        }
    };

    const handleSeleccionarTransaccion = (transaccion) => {
        setTransaccionSeleccionada(transaccion);
        setPaso(2);
    };

    const handleCrear = async () => {
        if (!nombreDeudor.trim()) {
            alert('Debes ingresar el nombre del deudor');
            return;
        }

        setGuardando(true);
        try {
            const tipoCompra = transaccionSeleccionada.cuotasTotal > 1 ? 'cuotas' : 'spot';

            await addReembolso({
                transaccionOrigenId: transaccionSeleccionada.id,
                nombreDeudor: nombreDeudor.trim(),
                estado: 'pendiente',
                tipoCompra,
                cuotasTotal: transaccionSeleccionada.cuotasTotal || 1
            });

            onSuccess();
        } catch (error) {
            console.error('Error:', error);
            alert('Error al crear reembolso');
        } finally {
            setGuardando(false);
        }
    };

    return (
        <Modal
            isOpen={true}
            onClose={onClose}
            title={paso === 1 ? 'Seleccionar Transacci√≥n' : 'Confirmar Reembolso'}
            size="lg"
        >
            {paso === 1 ? (
                <div className="space-y-4">
                    {/* Selector de mes */}
                    <div>
                        <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Mes
                        </label>
                        <select
                            value={mesSeleccionado?.id || ''}
                            onChange={(e) => {
                                const mes = mesesCargados.find(m => m.id === parseInt(e.target.value));
                                setMesSeleccionado(mes);
                            }}
                            className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                        >
                            {mesesCargados.map(mes => (
                                <option key={mes.id} value={mes.id}>
                                    {getNombreMes(mes.mesAnio)}
                                </option>
                            ))}
                        </select>
                    </div>

                    {/* Lista de transacciones */}
                    <div>
                        <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Selecciona una transacci√≥n ({transacciones.length} disponibles)
                        </label>
                        <div className="max-h-96 overflow-y-auto space-y-2">
                            {transacciones.length === 0 ? (
                                <p className="text-gray-500 dark:text-gray-400 text-center py-8">
                                    No hay transacciones disponibles en este mes
                                </p>
                            ) : (
                                transacciones.map(trans => {
                                    const perfil = perfiles.find(p => p.id === trans.perfilId);
                                    return (
                                        <button
                                            key={trans.id}
                                            onClick={() => handleSeleccionarTransaccion(trans)}
                                            className="w-full p-3 border-2 border-gray-200 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-500 rounded-lg text-left transition-all"
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex-1">
                                                    <p className="font-semibold text-gray-900 dark:text-white">{trans.comercio}</p>
                                                    <p className="text-sm text-gray-600 dark:text-gray-400">{trans.descripcion}</p>
                                                    <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                                        {perfil?.nombre} ‚Ä¢ {formatearFecha(trans.fecha)}
                                                        {trans.cuotasTotal > 1 && ` ‚Ä¢ ${trans.cuotaActual}/${trans.cuotasTotal}`}
                                                    </p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-lg font-bold text-indigo-600 dark:text-indigo-400">
                                                        {formatearMonto(trans.monto)}
                                                    </p>
                                                </div>
                                            </div>
                                        </button>
                                    );
                                })
                            )}
                        </div>
                    </div>
                </div>
            ) : (
                <div className="space-y-4">
                    {/* Resumen de transacci√≥n */}
                    <div className="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg">
                        <h3 className="font-bold text-gray-900 dark:text-white mb-2">Transacci√≥n seleccionada:</h3>
                        <p><strong>Comercio:</strong> {transaccionSeleccionada.comercio}</p>
                        <p><strong>Descripci√≥n:</strong> {transaccionSeleccionada.descripcion}</p>
                        <p><strong>Monto:</strong> {formatearMonto(transaccionSeleccionada.monto)}</p>
                        {transaccionSeleccionada.cuotasTotal > 1 && (
                            <p><strong>Cuotas:</strong> {transaccionSeleccionada.cuotaActual}/{transaccionSeleccionada.cuotasTotal}</p>
                        )}
                    </div>

                    {/* Nombre del deudor */}
                    <div>
                        <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            ¬øQui√©n debe reembolsar este gasto? *
                        </label>
                        <input
                            type="text"
                            value={nombreDeudor}
                            onChange={(e) => setNombreDeudor(e.target.value)}
                            placeholder="Ej: Juan P√©rez, Empresa ABC, etc."
                            className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500"
                            required
                        />
                    </div>

                    {/* Informaci√≥n adicional */}
                    {transaccionSeleccionada.cuotasTotal > 1 && (
                        <AlertBadge type="info">
                            <strong>Compra en cuotas detectada:</strong> Se crear√° un seguimiento para solicitar el reembolso mes a mes (cada cuota).
                        </AlertBadge>
                    )}

                    {/* Botones */}
                    <div className="flex space-x-3">
                        <button
                            onClick={() => setPaso(1)}
                            className="flex-1 px-6 py-3 bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-slate-600 transition-colors"
                        >
                            Atr√°s
                        </button>
                        <button
                            onClick={handleCrear}
                            disabled={guardando || !nombreDeudor.trim()}
                            className="flex-1 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {guardando ? 'Creando...' : 'Crear Reembolso'}
                        </button>
                    </div>
                </div>
            )}
        </Modal>
    );
};

    </script>

    <script type="text/babel">
        // P√°gina Proyecciones - Planificaci√≥n financiera a futuro

const Proyecciones = () => {
    const { selectedMonth, mesesCargados } = useApp();
    const [loading, setLoading] = useState(false);
    const [proyeccion, setProyeccion] = useState(null);
    const [metas, setMetas] = useState([
        { id: 1, nombre: 'Departamento m√°s grande', monto: 15000000, activa: false },
        { id: 2, nombre: 'Viaje familiar', monto: 3000000, activa: false },
        { id: 3, nombre: 'Fondo emergencia', monto: 2000000, activa: false }
    ]);
    const [metaPersonalizada, setMetaPersonalizada] = useState({ nombre: '', monto: 0 });
    const [showModalMeta, setShowModalMeta] = useState(false);

    useEffect(() => {
        if (selectedMonth) {
            calcularProyeccion();
        }
    }, [selectedMonth]);

    const calcularProyeccion = async () => {
        if (!selectedMonth) return;

        setLoading(true);
        try {
            // Obtener datos hist√≥ricos de los √∫ltimos 3 meses
            const ultimosMeses = mesesCargados
                .sort((a, b) => b.mesAnio.localeCompare(a.mesAnio))
                .slice(0, 3);

            const datosHistoricos = [];

            for (const mes of ultimosMeses) {
                const transacciones = await getTransaccionesByMes(mes.id);
                const ingresos = await getIngresos(mes.mesAnio);

                const totalGastos = transacciones.reduce((sum, t) => sum + t.monto, 0);
                const totalIngresos = ingresos.reduce((sum, i) => sum + i.monto, 0);

                datosHistoricos.push({
                    mes: mes.mesAnio,
                    mesNombre: getNombreMes(mes.mesAnio),
                    gastos: totalGastos,
                    ingresos: totalIngresos,
                    balance: totalIngresos - totalGastos
                });
            }

            // Calcular promedios
            const promedioGastos = datosHistoricos.reduce((sum, d) => sum + d.gastos, 0) / datosHistoricos.length;
            const promedioIngresos = datosHistoricos.reduce((sum, d) => sum + d.ingresos, 0) / datosHistoricos.length;
            const promedioBalance = promedioIngresos - promedioGastos;

            // Obtener cuotas activas para proyectar compromisos futuros
            const todasTransacciones = await db.transacciones.toArray();
            const cuotasActivas = calcularCuotasActivas(todasTransacciones, selectedMonth.mesAnio);
            const totalCuotasMensuales = cuotasActivas.reduce((sum, c) => sum + c.montoCuota, 0);

            // Proyectar pr√≥ximos 12 meses
            const proyeccionMensual = [];
            const mesActualDate = new Date(selectedMonth.mesAnio + '-01');

            for (let i = 1; i <= 12; i++) {
                const fechaMes = new Date(mesActualDate);
                fechaMes.setMonth(fechaMes.getMonth() + i);
                const mesAnio = `${fechaMes.getFullYear()}-${String(fechaMes.getMonth() + 1).padStart(2, '0')}`;

                // Calcular cuotas que se pagar√≠an ese mes
                let cuotasMes = 0;
                for (const cuota of cuotasActivas) {
                    if (i <= cuota.cuotasRestantes) {
                        cuotasMes += cuota.montoCuota;
                    }
                }

                const gastosProyectados = promedioGastos + cuotasMes;
                const balanceProyectado = promedioIngresos - gastosProyectados;

                proyeccionMensual.push({
                    mes: i,
                    mesAnio,
                    mesNombre: getNombreMes(mesAnio),
                    ingresos: promedioIngresos,
                    gastos: gastosProyectados,
                    balance: balanceProyectado,
                    cuotas: cuotasMes
                });
            }

            // Calcular ahorro acumulado
            let ahorroAcumulado = 0;
            proyeccionMensual.forEach(p => {
                ahorroAcumulado += p.balance;
                p.ahorroAcumulado = ahorroAcumulado;
            });

            setProyeccion({
                datosHistoricos,
                promedioGastos,
                promedioIngresos,
                promedioBalance,
                proyeccionMensual,
                totalCuotasMensuales
            });

        } catch (error) {
            console.error('Error al calcular proyecci√≥n:', error);
        } finally {
            setLoading(false);
        }
    };

    const toggleMeta = (metaId) => {
        setMetas(prev => prev.map(m =>
            m.id === metaId ? { ...m, activa: !m.activa } : m
        ));
    };

    const agregarMetaPersonalizada = () => {
        if (!metaPersonalizada.nombre || metaPersonalizada.monto <= 0) return;

        const nuevaMeta = {
            id: Date.now(),
            nombre: metaPersonalizada.nombre,
            monto: metaPersonalizada.monto,
            activa: true
        };

        setMetas([...metas, nuevaMeta]);
        setMetaPersonalizada({ nombre: '', monto: 0 });
        setShowModalMeta(false);
    };

    const calcularMesesParaMeta = (montoMeta) => {
        if (!proyeccion || proyeccion.promedioBalance <= 0) return null;
        return Math.ceil(montoMeta / proyeccion.promedioBalance);
    };

    if (!selectedMonth) {
        return (
            <div className="max-w-7xl mx-auto">
                <EmptyState
                    icon="üìä"
                    title="Selecciona un mes"
                    description="Para ver proyecciones, primero debes tener un mes cargado."
                />
            </div>
        );
    }

    if (loading) {
        return (
            <div className="max-w-7xl mx-auto">
                <div className="flex items-center justify-center min-h-screen">
                    <div className="text-center">
                        <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4"></div>
                        <p className="text-gray-900 text-xl font-semibold">Calculando proyecciones...</p>
                    </div>
                </div>
            </div>
        );
    }

    if (!proyeccion) {
        return (
            <div className="max-w-7xl mx-auto">
                <EmptyState
                    icon="üìä"
                    title="No hay datos suficientes"
                    description="Necesitas al menos un mes con transacciones e ingresos para calcular proyecciones."
                />
            </div>
        );
    }

    const metasActivas = metas.filter(m => m.activa);

    return (
        <div className="max-w-7xl mx-auto space-y-6">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Proyecciones Financieras</h1>
                    <p className="text-gray-600">Planifica tu futuro y alcanza tus metas</p>
                </div>
                <button
                    onClick={() => setShowModalMeta(true)}
                    className="px-6 py-3 bg-white text-indigo-600 font-semibold rounded-lg hover:bg-indigo-50 transition-colors shadow-lg"
                >
                    + Agregar Meta
                </button>
            </div>

            {/* Resumen Financiero Actual */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <CardStat
                    label="Ingreso Promedio"
                    value={formatearMonto(proyeccion.promedioIngresos)}
                    icon="üí∞"
                    color="green"
                    subtitle="√öltimos 3 meses"
                />
                <CardStat
                    label="Gasto Promedio"
                    value={formatearMonto(proyeccion.promedioGastos)}
                    icon="üí≥"
                    color="red"
                    subtitle="√öltimos 3 meses"
                />
                <CardStat
                    label="Balance Mensual"
                    value={formatearMonto(proyeccion.promedioBalance)}
                    icon={proyeccion.promedioBalance > 0 ? "‚úÖ" : "‚ö†Ô∏è"}
                    color={proyeccion.promedioBalance > 0 ? "green" : "red"}
                    subtitle={proyeccion.promedioBalance > 0 ? "Super√°vit" : "D√©ficit"}
                />
                <CardStat
                    label="Cuotas Activas"
                    value={formatearMonto(proyeccion.totalCuotasMensuales)}
                    icon="üìä"
                    color="purple"
                    subtitle="Compromisos mensuales"
                />
            </div>

            {/* Metas Financieras */}
            <Card title="Tus Metas Financieras" icon="üéØ">
                <div className="space-y-4">
                    {metas.map(meta => {
                        const mesesNecesarios = calcularMesesParaMeta(meta.monto);
                        const ahorroAcumulado12Meses = proyeccion.proyeccionMensual[11]?.ahorroAcumulado || 0;
                        const alcanzableEn12Meses = ahorroAcumulado12Meses >= meta.monto;

                        return (
                            <div
                                key={meta.id}
                                className={`p-4 rounded-lg border-2 transition-all ${
                                    meta.activa
                                        ? 'border-indigo-300 bg-indigo-50'
                                        : 'border-gray-200 bg-gray-50'
                                }`}
                            >
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center space-x-4 flex-1">
                                        <input
                                            type="checkbox"
                                            checked={meta.activa}
                                            onChange={() => toggleMeta(meta.id)}
                                            className="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                                        />
                                        <div className="flex-1">
                                            <h3 className="text-lg font-semibold text-gray-800">{meta.nombre}</h3>
                                            <p className="text-sm text-gray-600">Monto objetivo: {formatearMonto(meta.monto)}</p>
                                        </div>
                                    </div>
                                    {meta.activa && mesesNecesarios && (
                                        <div className="text-right">
                                            <p className={`text-2xl font-bold ${alcanzableEn12Meses ? 'text-green-600' : 'text-orange-600'}`}>
                                                {mesesNecesarios} meses
                                            </p>
                                            <p className="text-xs text-gray-600">
                                                {alcanzableEn12Meses ? '‚úÖ Alcanzable en 1 a√±o' : '‚è∞ Requiere m√°s tiempo'}
                                            </p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </Card>

            {/* Gr√°fico de Proyecci√≥n */}
            {metasActivas.length > 0 && (
                <Card title="Proyecci√≥n de Ahorro vs Metas (12 meses)" icon="üìà">
                    <GraficoProyeccionAhorro
                        proyeccion={proyeccion.proyeccionMensual}
                        metas={metasActivas}
                    />
                </Card>
            )}

            {/* Tabla de Proyecci√≥n Mensual */}
            <Card title="Proyecci√≥n Mensual Detallada" icon="üìã">
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mes</th>
                                <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ingresos</th>
                                <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Gastos</th>
                                <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Cuotas</th>
                                <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Balance</th>
                                <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acumulado</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {proyeccion.proyeccionMensual.map((p, index) => (
                                <tr key={index} className="hover:bg-gray-50">
                                    <td className="px-4 py-3 text-sm font-medium text-gray-900">{p.mesNombre}</td>
                                    <td className="px-4 py-3 text-sm text-right text-green-600">{formatearMonto(p.ingresos)}</td>
                                    <td className="px-4 py-3 text-sm text-right text-red-600">{formatearMonto(p.gastos)}</td>
                                    <td className="px-4 py-3 text-sm text-right text-purple-600">{formatearMonto(p.cuotas)}</td>
                                    <td className={`px-4 py-3 text-sm text-right font-semibold ${p.balance > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {formatearMonto(p.balance)}
                                    </td>
                                    <td className="px-4 py-3 text-sm text-right font-bold text-indigo-600">
                                        {formatearMonto(p.ahorroAcumulado)}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>

            {/* Modal para meta personalizada */}
            {showModalMeta && (
                <Modal isOpen={true} onClose={() => setShowModalMeta(false)} title="Agregar Meta Personalizada" size="md">
                    <form onSubmit={(e) => { e.preventDefault(); agregarMetaPersonalizada(); }} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Nombre de la Meta</label>
                            <input
                                type="text"
                                value={metaPersonalizada.nombre}
                                onChange={(e) => setMetaPersonalizada({ ...metaPersonalizada, nombre: e.target.value })}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="Ej: Auto nuevo, Renovaci√≥n casa"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Monto Objetivo</label>
                            <input
                                type="number"
                                value={metaPersonalizada.monto}
                                onChange={(e) => setMetaPersonalizada({ ...metaPersonalizada, monto: parseFloat(e.target.value) || 0 })}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                required
                                min="0"
                                step="100000"
                            />
                        </div>
                        <div className="flex space-x-3 pt-4">
                            <button type="button" onClick={() => setShowModalMeta(false)} className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Cancelar
                            </button>
                            <button type="submit" className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                Agregar
                            </button>
                        </div>
                    </form>
                </Modal>
            )}
        </div>
    );
};

// Componente de gr√°fico de proyecci√≥n de ahorro
const GraficoProyeccionAhorro = memo(({ proyeccion, metas }) => {
    const chartRef = useRef(null);
    const chartInstance = useRef(null);

    useEffect(() => {
        if (!chartRef.current || proyeccion.length === 0) return;

        // Destruir gr√°fico anterior
        if (chartInstance.current) {
            chartInstance.current.destroy();
        }

        const ctx = chartRef.current.getContext('2d');

        // Dataset principal: ahorro acumulado
        const datasets = [
            {
                label: 'Ahorro Acumulado',
                data: proyeccion.map(p => p.ahorroAcumulado),
                borderColor: 'rgba(99, 102, 241, 1)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }
        ];

        // Agregar l√≠neas horizontales para cada meta
        const colors = ['rgba(34, 197, 94, 1)', 'rgba(249, 115, 22, 1)', 'rgba(168, 85, 247, 1)'];
        metas.forEach((meta, index) => {
            datasets.push({
                label: meta.nombre,
                data: proyeccion.map(() => meta.monto),
                borderColor: colors[index % colors.length],
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0
            });
        });

        chartInstance.current = new Chart(ctx, {
            type: 'line',
            data: {
                labels: proyeccion.map(p => p.mesNombre),
                datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                return `${context.dataset.label}: ${window.formatearMonto(context.parsed.y)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return String.fromCharCode(36) + Math.round(value / 1000) + 'k';
                            }
                        }
                    }
                }
            }
        });

        return () => {
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
        };
    }, [proyeccion, metas]);

    const containerStyle = { position: 'relative', height: '400px' };

    return (
        <div style={containerStyle}>
            <canvas ref={chartRef}></canvas>
        </div>
    );
});

    </script>

    <script type="text/babel">
        // Tour Guiado de Bienvenida - Finzi v3.3

const TourGuide = () => {
    const { setCurrentPage } = useApp();
    const [showTour, setShowTour] = useState(false);
    const [currentStep, setCurrentStep] = useState(0);

    useEffect(() => {
        // Verificar si el usuario ya vio el tour
        const tourCompleted = localStorage.getItem('tourCompleted');
        if (!tourCompleted) {
            // Esperar un momento antes de mostrar el tour
            setTimeout(() => setShowTour(true), 1000);
        }
    }, []);

    // Navegaci√≥n con teclado
    useEffect(() => {
        if (!showTour) return;

        const handleKeyDown = (e) => {
            if (e.key === 'ArrowRight' || e.key === 'Enter') {
                handleNext();
            } else if (e.key === 'ArrowLeft') {
                handlePrev();
            } else if (e.key === 'Escape') {
                handleSkip();
            }
        };

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [showTour, currentStep]);

    const steps = [
        {
            title: "¬°Bienvenido a Finzi! üéâ",
            content: "Tu analizador inteligente de gastos de tarjeta de cr√©dito. Te guiar√© por las funcionalidades principales en unos segundos.",
            target: null,
            action: null
        },
        {
            title: "Dashboard Principal üè†",
            content: "Aqu√≠ ver√°s el resumen de tus gastos del mes: transacciones, presupuestos, balance y estad√≠sticas clave.",
            target: "home",
            action: () => setCurrentPage('home')
        },
        {
            title: "Cargar CSV üìÑ",
            content: "El primer paso es cargar el CSV de tu tarjeta. Puedes seleccionar mes/a√±o, asignar perfil y elegir entre categorizaci√≥n autom√°tica o manual.",
            target: "home",
            action: null
        },
        {
            title: "Transacciones üí∞",
            content: "Gestiona tus ingresos mensuales, gastos a reembolsar y gastos recurrentes (Netflix, seguros anuales, etc.).",
            target: "transacciones",
            action: null
        },
        {
            title: "An√°lisis üìä",
            content: "Visualiza an√°lisis detallados, historial de meses, balance entre perfiles y proyecciones de ahorro.",
            target: "analisis",
            action: null
        },
        {
            title: "Configuraci√≥n ‚öôÔ∏è",
            content: "Configura perfiles (qui√©n usa cada tarjeta), categor√≠as personalizadas y presupuestos mensuales por categor√≠a.",
            target: "configuracion",
            action: null
        },
        {
            title: "Herramientas Avanzadas üìà",
            content: "Proyecta cuotas futuras y simula el impacto de compras grandes en tu presupuesto antes de hacerlas.",
            target: "herramientas",
            action: null
        },
        {
            title: "Sincronizaci√≥n Firebase ‚òÅÔ∏è",
            content: "Tus datos se sincronizan autom√°ticamente con Firebase. Accede desde cualquier dispositivo con tu cuenta de Google.",
            target: null,
            action: null
        },
        {
            title: "¬°Listo para empezar! üöÄ",
            content: "Ya conoces lo b√°sico. Empieza cargando tu primer CSV o explora las configuraciones. ¬°Que tengas un excelente control de tus finanzas!",
            target: null,
            action: null
        }
    ];

    const handleNext = () => {
        if (currentStep < steps.length - 1) {
            const nextStep = currentStep + 1;
            const step = steps[nextStep];
            if (step.action) step.action();
            setCurrentStep(nextStep);
        } else {
            completeTour();
        }
    };

    const handlePrev = () => {
        if (currentStep > 0) {
            const prevStep = currentStep - 1;
            const step = steps[prevStep];
            if (step.action) step.action();
            setCurrentStep(prevStep);
        }
    };

    const handleSkip = () => {
        completeTour();
    };

    const completeTour = () => {
        localStorage.setItem('tourCompleted', 'true');
        setShowTour(false);
    };

    if (!showTour) return null;

    const step = steps[currentStep];
    const isFirst = currentStep === 0;
    const isLast = currentStep === steps.length - 1;

    return (
        <>
            {/* Overlay */}
            <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] animate-fadeIn" />

            {/* Modal del tour */}
            <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 pointer-events-none">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-lg w-full p-6 pointer-events-auto animate-slideIn border-2 border-indigo-500">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center space-x-3">
                            <div className="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center">
                                <span className="text-white text-xl">
                                    {isFirst ? 'üëã' : isLast ? 'üéâ' : 'üí°'}
                                </span>
                            </div>
                            <div>
                                <h2 className="text-xl font-bold text-gray-900 dark:text-white">
                                    {step.title}
                                </h2>
                                <p className="text-xs text-gray-500 dark:text-gray-400">
                                    Paso {currentStep + 1} de {steps.length}
                                </p>
                            </div>
                        </div>
                        <button
                            onClick={handleSkip}
                            className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors p-2"
                            aria-label="Saltar tour"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    {/* Progress bar */}
                    <div className="w-full h-1.5 bg-gray-200 dark:bg-slate-700 rounded-full mb-4 overflow-hidden">
                        <div
                            className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300"
                            style={{ width: `${((currentStep + 1) / steps.length) * 100}%` }}
                        />
                    </div>

                    {/* Content */}
                    <div className="mb-6">
                        <p className="text-gray-700 dark:text-gray-300 leading-relaxed">
                            {step.content}
                        </p>
                    </div>

                    {/* Actions */}
                    <div className="flex items-center justify-between">
                        <button
                            onClick={handleSkip}
                            className="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors"
                        >
                            Saltar tour
                        </button>
                        <div className="flex space-x-2">
                            {!isFirst && (
                                <button
                                    onClick={handlePrev}
                                    className="px-4 py-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"
                                >
                                    Anterior
                                </button>
                            )}
                            <button
                                onClick={handleNext}
                                className="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg font-semibold"
                            >
                                {isLast ? '¬°Empezar!' : 'Siguiente'}
                            </button>
                        </div>
                    </div>

                    {/* Indicador de teclas */}
                    <div className="mt-4 pt-4 border-t border-gray-200 dark:border-slate-700">
                        <p className="text-xs text-gray-500 dark:text-gray-400 text-center">
                            üí° Tip: Usa las flechas ‚Üê ‚Üí del teclado para navegar
                        </p>
                    </div>
                </div>
            </div>
        </>
    );
};

    </script>

    <script type="text/babel">
        // Componente de Entrada R√°pida con Parser de Texto Natural - Finzi v3.4

const EntradaRapida = ({ onClose, onSuccess }) => {
    const { perfiles, categorias } = useApp();
    const [textoLibre, setTextoLibre] = useState('');
    const [form, setForm] = useState({
        comercio: '',
        monto: '',
        cuotas: 1,
        montoCuota: '',
        categoria: '',
        perfilId: perfiles[0]?.id || '',
        fecha: new Date().toISOString().split('T')[0]
    });
    const [parsed, setParsed] = useState({
        comercio: false,
        monto: false,
        cuotas: false
    });
    const [comerciosSugeridos, setComerciosSugeridos] = useState([]);

    // Parser de texto natural
    const parsearTexto = useCallback(async (texto) => {
        if (!texto.trim()) {
            setParsed({ comercio: false, monto: false, cuotas: false });
            return;
        }

        const textoLower = texto.toLowerCase().trim();
        let updates = {};
        let parsedFlags = { comercio: false, monto: false, cuotas: false };

        // 1. Extraer MONTO
        // Patrones: "150.000", "150000", "150 mil", "150k", "$150.000"
        const regexMonto = /\$?\s*(\d{1,3})[\s.]?(\d{3})(?:\s*(mil|k))?|\$?\s*(\d+)\s*(mil|k)/gi;
        const matchMonto = regexMonto.exec(textoLower);

        if (matchMonto) {
            let monto = 0;
            if (matchMonto[1] && matchMonto[2]) {
                // Formato: "150.000" o "150 000"
                monto = parseInt(matchMonto[1] + matchMonto[2]);
            } else if (matchMonto[4]) {
                // Formato: "150 mil" o "150k"
                monto = parseInt(matchMonto[4]) * 1000;
            }

            if (monto > 0) {
                updates.monto = monto;
                parsedFlags.monto = true;
            }
        }

        // 2. Extraer CUOTAS
        // Patrones: "en 3 cuotas", "3 cuotas", "3x", "cuotas 3"
        const regexCuotas = /(?:en\s+)?(\d+)\s*(?:cuotas?|x)|cuotas?\s+(\d+)/i;
        const matchCuotas = regexCuotas.exec(textoLower);

        if (matchCuotas) {
            const numCuotas = parseInt(matchCuotas[1] || matchCuotas[2]);
            if (numCuotas > 1 && numCuotas <= 48) {
                updates.cuotas = numCuotas;
                parsedFlags.cuotas = true;

                // Calcular monto de cada cuota si ya tenemos el monto total
                if (updates.monto) {
                    updates.montoCuota = Math.round(updates.monto / numCuotas);
                }
            }
        } else {
            updates.cuotas = 1;
            updates.montoCuota = updates.monto || '';
        }

        // 3. Extraer COMERCIO
        // Buscar en historial de comercios existentes
        const transacciones = await db.transacciones.toArray();
        const comerciosUnicos = [...new Set(transacciones.map(t => t.comercio))];

        // Buscar coincidencias en el texto
        let mejorMatch = null;
        let mejorScore = 0;

        for (const comercio of comerciosUnicos) {
            const comercioLower = comercio.toLowerCase();
            // Match exacto o contenido
            if (textoLower.includes(comercioLower)) {
                const score = comercioLower.length; // Priorizar matches m√°s largos
                if (score > mejorScore) {
                    mejorMatch = comercio;
                    mejorScore = score;
                }
            }
        }

        if (mejorMatch) {
            updates.comercio = mejorMatch;
            parsedFlags.comercio = true;
        } else {
            // Si no hay match, extraer palabras clave comunes
            const palabrasClave = [
                'uber', 'mercadona', 'falabella', 'ripley', 'paris', 'lider', 'jumbo',
                'copec', 'shell', 'esso', 'petrobras', 'terpel',
                'netflix', 'spotify', 'disney', 'amazon', 'apple',
                'restaurant', 'cafe', 'bar', 'almuerzo', 'cena'
            ];

            for (const palabra of palabrasClave) {
                if (textoLower.includes(palabra)) {
                    // Capitalizar primera letra
                    updates.comercio = palabra.charAt(0).toUpperCase() + palabra.slice(1);
                    parsedFlags.comercio = true;
                    break;
                }
            }

            // Si a√∫n no hay comercio, extraer despu√©s de "en" o "de"
            if (!updates.comercio) {
                const regexComercio = /(?:en|de)\s+([a-z√°√©√≠√≥√∫√±]+)/i;
                const matchComercio = regexComercio.exec(texto);
                if (matchComercio) {
                    updates.comercio = matchComercio[1].charAt(0).toUpperCase() + matchComercio[1].slice(1);
                    parsedFlags.comercio = true;
                }
            }
        }

        // 4. Sugerir CATEGOR√çA basada en palabras clave o comercio
        if (updates.comercio) {
            const categoriasSugeridas = await sugerirCategoria(updates.comercio, textoLower);
            if (categoriasSugeridas && categoriasSugeridas.length > 0) {
                updates.categoria = categoriasSugeridas[0];
            }
        }

        // Actualizar estado
        setForm(prev => ({ ...prev, ...updates }));
        setParsed(parsedFlags);

    }, []);

    // Sugerir categor√≠a basada en comercio o palabras clave
    const sugerirCategoria = async (comercio, textoCompleto) => {
        // 1. Buscar en historial si este comercio ya tiene una categor√≠a frecuente
        const transacciones = await db.transacciones
            .where('comercio')
            .equals(comercio)
            .toArray();

        if (transacciones.length > 0) {
            // Contar frecuencia de categor√≠as
            const frecuencias = {};
            transacciones.forEach(t => {
                frecuencias[t.categoria] = (frecuencias[t.categoria] || 0) + 1;
            });

            // Retornar la m√°s frecuente
            const masFrecuente = Object.entries(frecuencias)
                .sort((a, b) => b[1] - a[1])[0][0];

            return [masFrecuente];
        }

        // 2. Si no hay historial, usar palabras clave
        const palabrasClave = {
            'supermercado': ['mercadona', 'lider', 'jumbo', 'tottus', 'santa isabel', 'super', 'supermercado'],
            'transporte': ['uber', 'cabify', 'didi', 'bencina', 'copec', 'shell', 'esso', 'metro', 'bus', 'taxi'],
            'alimentacion': ['restaurant', 'cafe', 'bar', 'almuerzo', 'cena', 'comida', 'pizza', 'sushi'],
            'vestuario': ['falabella', 'ripley', 'paris', 'zapatillas', 'zapatos', 'ropa', 'polera', 'pantalon', 'vestido'],
            'salud': ['farmacia', 'cruz verde', 'salcobrand', 'ahumada', 'doctor', 'clinica', 'hospital'],
            'entretenimiento': ['cine', 'netflix', 'spotify', 'disney', 'hbo', 'prime', 'concierto', 'teatro'],
            'hogar': ['homecenter', 'sodimac', 'easy', 'ikea', 'mueble', 'deco', 'construccion'],
            'servicios': ['luz', 'agua', 'gas', 'internet', 'telefono', 'seguros']
        };

        const textoLower = (comercio + ' ' + textoCompleto).toLowerCase();

        for (const [categoria, palabras] of Object.entries(palabrasClave)) {
            for (const palabra of palabras) {
                if (textoLower.includes(palabra)) {
                    return [categoria];
                }
            }
        }

        return []; // Sin sugerencia
    };

    // Cargar sugerencias de comercios para autocompletado
    useEffect(() => {
        const cargarComerciosSugeridos = async () => {
            const transacciones = await db.transacciones.toArray();
            const comercios = [...new Set(transacciones.map(t => t.comercio))];
            setComerciosSugeridos(comercios.sort());
        };
        cargarComerciosSugeridos();
    }, []);

    // Parsear cuando cambia el texto
    useEffect(() => {
        const timer = setTimeout(() => {
            parsearTexto(textoLibre);
        }, 500); // Debounce de 500ms

        return () => clearTimeout(timer);
    }, [textoLibre, parsearTexto]);

    // Actualizar montoCuota cuando cambia monto o cuotas
    useEffect(() => {
        if (form.monto && form.cuotas > 0) {
            setForm(prev => ({
                ...prev,
                montoCuota: Math.round(prev.monto / prev.cuotas)
            }));
        }
    }, [form.monto, form.cuotas]);

    const handleSubmit = async (e, continuar = false) => {
        e.preventDefault();

        if (!form.comercio || !form.monto || !form.categoria || !form.perfilId) {
            alert('Por favor completa todos los campos requeridos');
            return;
        }

        try {
            // Preparar transacci√≥n con campos nuevos
            const transaccionBase = {
                comercio: form.comercio,
                monto: form.cuotas > 1 ? form.montoCuota : form.monto,
                montoOriginal: form.monto,
                categoria: form.categoria,
                perfilId: form.perfilId,
                fecha: form.fecha,
                descripcion: form.cuotas > 1 ? `Cuota de ${form.comercio}` : form.comercio,

                // Nuevos campos v3.4
                origen: 'manual',
                estado: 'provisional',
                textoOriginal: textoLibre,
                transaccionRelacionadaId: null,

                // Campos de cuotas
                cuotaActual: form.cuotas > 1 ? 1 : null,
                cuotasTotal: form.cuotas > 1 ? form.cuotas : null,

                // Campos de reembolso
                esReembolsable: false,
                reembolsoId: null
            };

            if (form.cuotas > 1) {
                // Crear m√∫ltiples transacciones para las cuotas
                const primeraTransaccionId = await db.transacciones.add(transaccionBase);

                // Crear las cuotas restantes
                for (let i = 2; i <= form.cuotas; i++) {
                    const fechaCuota = new Date(form.fecha);
                    fechaCuota.setMonth(fechaCuota.getMonth() + (i - 1));

                    await db.transacciones.add({
                        ...transaccionBase,
                        cuotaActual: i,
                        fecha: fechaCuota.toISOString().split('T')[0],
                        transaccionOrigenId: primeraTransaccionId
                    });
                }
            } else {
                // Transacci√≥n simple
                await db.transacciones.add(transaccionBase);
            }

            if (continuar) {
                // Limpiar formulario pero mantener perfil
                setTextoLibre('');
                setForm({
                    comercio: '',
                    monto: '',
                    cuotas: 1,
                    montoCuota: '',
                    categoria: '',
                    perfilId: form.perfilId,
                    fecha: new Date().toISOString().split('T')[0]
                });
                setParsed({ comercio: false, monto: false, cuotas: false });
            } else {
                onSuccess?.();
                onClose();
            }

        } catch (error) {
            console.error('Error al guardar transacci√≥n:', error);
            alert('Error al guardar la transacci√≥n');
        }
    };

    return (
        <Modal title="‚úçÔ∏è Entrada R√°pida" onClose={onClose} size="md">
            <form onSubmit={(e) => handleSubmit(e, false)} className="space-y-4">
                {/* Campo de texto libre */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        üí¨ Describe tu gasto
                    </label>
                    <textarea
                        value={textoLibre}
                        onChange={(e) => setTextoLibre(e.target.value)}
                        placeholder='Ej: "compr√© zapatillas en falabella por 60.000" o "uber 8500"'
                        className="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-slate-700 text-gray-900 dark:text-white resize-none"
                        rows="3"
                        autoFocus
                    />
                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        üí° Escribe de forma natural, el sistema reconocer√° autom√°ticamente el comercio, monto y cuotas
                    </p>
                </div>

                {/* Separador visual */}
                {textoLibre && (
                    <div className="border-t border-gray-200 dark:border-slate-700 my-4" />
                )}

                {/* Comercio */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        üè™ Comercio {parsed.comercio && <span className="text-green-600 dark:text-green-400 text-xs">‚úì Detectado</span>}
                    </label>
                    <input
                        type="text"
                        list="comercios-sugeridos"
                        value={form.comercio}
                        onChange={(e) => setForm({ ...form, comercio: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                        required
                    />
                    <datalist id="comercios-sugeridos">
                        {comerciosSugeridos.map((comercio, idx) => (
                            <option key={idx} value={comercio} />
                        ))}
                    </datalist>
                </div>

                {/* Monto y Cuotas */}
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            üí∞ Monto {form.cuotas > 1 ? 'Total' : ''} {parsed.monto && <span className="text-green-600 dark:text-green-400 text-xs">‚úì</span>}
                        </label>
                        <input
                            type="number"
                            value={form.monto}
                            onChange={(e) => setForm({ ...form, monto: parseInt(e.target.value) || '' })}
                            className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                            required
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            üí≥ Cuotas {parsed.cuotas && <span className="text-green-600 dark:text-green-400 text-xs">‚úì</span>}
                        </label>
                        <input
                            type="number"
                            min="1"
                            max="48"
                            value={form.cuotas}
                            onChange={(e) => setForm({ ...form, cuotas: parseInt(e.target.value) || 1 })}
                            className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                        />
                    </div>
                </div>

                {/* Mostrar monto de cuota si hay cuotas */}
                {form.cuotas > 1 && form.montoCuota && (
                    <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3">
                        <p className="text-sm text-blue-800 dark:text-blue-300">
                            üíµ Cada cuota: <span className="font-bold">${form.montoCuota.toLocaleString('es-CL')}</span>
                        </p>
                    </div>
                )}

                {/* Categor√≠a */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        üè∑Ô∏è Categor√≠a
                    </label>
                    <select
                        value={form.categoria}
                        onChange={(e) => setForm({ ...form, categoria: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                        required
                    >
                        <option value="">Seleccionar categor√≠a</option>
                        {categorias.map(cat => (
                            <option key={cat.id} value={cat.id}>
                                {cat.emoji} {cat.nombre}
                            </option>
                        ))}
                    </select>
                </div>

                {/* Perfil */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        üë§ Perfil
                    </label>
                    <select
                        value={form.perfilId}
                        onChange={(e) => setForm({ ...form, perfilId: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                        required
                    >
                        {perfiles.map(perfil => (
                            <option key={perfil.id} value={perfil.id}>
                                {perfil.nombre}
                            </option>
                        ))}
                    </select>
                </div>

                {/* Fecha */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        üìÖ Fecha
                    </label>
                    <input
                        type="date"
                        value={form.fecha}
                        onChange={(e) => setForm({ ...form, fecha: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                        required
                    />
                </div>

                {/* Badge de estado */}
                <div className="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-3">
                    <p className="text-sm text-orange-800 dark:text-orange-300">
                        üü† Se guardar√° como <span className="font-bold">"Provisional"</span> hasta que cargues el CSV del mes
                    </p>
                </div>

                {/* Botones de acci√≥n */}
                <div className="flex space-x-3 pt-4 border-t border-gray-200 dark:border-slate-700">
                    <button
                        type="button"
                        onClick={onClose}
                        className="flex-1 px-4 py-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"
                    >
                        Cancelar
                    </button>
                    <button
                        type="button"
                        onClick={(e) => handleSubmit(e, true)}
                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                        Guardar y + Otro
                    </button>
                    <button
                        type="submit"
                        className="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg font-semibold"
                    >
                        Guardar
                    </button>
                </div>
            </form>
        </Modal>
    );
};

    </script>

    <script type="text/babel">
        // Panel de Reconciliaci√≥n Inteligente - Finzi v3.4

const Reconciliacion = ({ resultado, onConfirmar, onCancelar }) => {
    const [decisiones, setDecisiones] = useState({
        autoMatches: {}, // { manualId: 'accept' | 'reject' }
        suggestedMatches: {}, // { manualId: csvId | 'none' }
        noMatches: {} // { manualId: 'keep' | 'delete' }
    });

    // Inicializar decisiones con valores por defecto
    useEffect(() => {
        const defaultDecisiones = {
            autoMatches: {},
            suggestedMatches: {},
            noMatches: {}
        };

        // Auto-matches: aceptar por defecto
        resultado.autoMatches.forEach(match => {
            defaultDecisiones.autoMatches[match.manual.id] = 'accept';
        });

        // Suggested matches: aceptar sugerencia por defecto
        resultado.suggestedMatches.forEach(match => {
            defaultDecisiones.suggestedMatches[match.manual.id] = match.csv.id;
        });

        // No matches: mantener por defecto
        resultado.noMatches.forEach(item => {
            defaultDecisiones.noMatches[item.manual.id] = 'keep';
        });

        setDecisiones(defaultDecisiones);
    }, [resultado]);

    const handleConfirmar = async () => {
        // Procesar todas las decisiones
        const resultadoFinal = {
            fusionados: [],
            mantenidos: [],
            eliminados: []
        };

        try {
            // 1. Procesar auto-matches
            for (const match of resultado.autoMatches) {
                const decision = decisiones.autoMatches[match.manual.id];
                if (decision === 'accept') {
                    await window.fusionarTransacciones(match.manual, match.csv);
                    resultadoFinal.fusionados.push(match.manual.id);
                }
            }

            // 2. Procesar suggested matches
            for (const match of resultado.suggestedMatches) {
                const csvId = decisiones.suggestedMatches[match.manual.id];
                if (csvId && csvId !== 'none') {
                    // Buscar el CSV correspondiente
                    const csvMatch = csvId === match.csv.id ? match.csv : null;
                    if (csvMatch) {
                        await window.fusionarTransacciones(match.manual, csvMatch);
                        resultadoFinal.fusionados.push(match.manual.id);
                    }
                }
            }

            // 3. Procesar no-matches
            for (const item of resultado.noMatches) {
                const decision = decisiones.noMatches[item.manual.id];
                if (decision === 'keep') {
                    await window.marcarSinEmparejar(item.manual, 'Pago no incluido en TC');
                    resultadoFinal.mantenidos.push(item.manual.id);
                } else if (decision === 'delete') {
                    await db.transacciones.delete(item.manual.id);
                    resultadoFinal.eliminados.push(item.manual.id);
                }
            }

            onConfirmar(resultadoFinal);
        } catch (error) {
            console.error('Error en reconciliaci√≥n:', error);
            alert('Error al procesar la reconciliaci√≥n');
        }
    };

    const totalProcesar = resultado.autoMatches.length + resultado.suggestedMatches.length + resultado.noMatches.length;

    return (
        <Modal title="üîó Reconciliaci√≥n de Transacciones" onClose={onCancelar} size="xl">
            <div className="space-y-6">
                {/* Resumen */}
                <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <p className="text-sm text-blue-800 dark:text-blue-300">
                        üìä Encontramos <span className="font-bold">{totalProcesar} transacciones manuales</span> del mes.
                        Revisa los emparejamientos sugeridos antes de confirmar.
                    </p>
                </div>

                {/* Secci√≥n 1: Emparejados autom√°ticamente */}
                {resultado.autoMatches.length > 0 && (
                    <div>
                        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                            <span className="text-2xl mr-2">‚úÖ</span>
                            Emparejados autom√°ticamente ({resultado.autoMatches.length})
                        </h3>
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                            Match mayor al 85%. Se fusionar√°n autom√°ticamente.
                        </p>
                        <div className="space-y-3">
                            {resultado.autoMatches.map(match => (
                                <div
                                    key={match.manual.id}
                                    className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4"
                                >
                                    <div className="flex items-start justify-between">
                                        <div className="flex-1">
                                            {/* Transacci√≥n manual */}
                                            <div className="mb-2">
                                                <span className="inline-block px-2 py-1 bg-orange-200 dark:bg-orange-800 text-orange-800 dark:text-orange-200 text-xs font-semibold rounded mr-2">
                                                    üü† Manual
                                                </span>
                                                <span className="font-semibold text-gray-900 dark:text-white">
                                                    {match.manual.comercio}
                                                </span>
                                                <span className="ml-2 text-gray-700 dark:text-gray-300">
                                                    ${match.manual.monto.toLocaleString('es-CL')}
                                                </span>
                                                <span className="ml-2 text-sm text-gray-500 dark:text-gray-400">
                                                    {new Date(match.manual.fecha).toLocaleDateString('es-CL')}
                                                </span>
                                            </div>

                                            {/* Flecha */}
                                            <div className="flex items-center my-1">
                                                <svg className="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                                </svg>
                                                <span className="ml-2 text-xs font-semibold text-green-700 dark:text-green-400">
                                                    Match {match.score}%
                                                </span>
                                            </div>

                                            {/* Transacci√≥n CSV */}
                                            <div>
                                                <span className="inline-block px-2 py-1 bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 text-xs font-semibold rounded mr-2">
                                                    ‚úÖ CSV
                                                </span>
                                                <span className="font-semibold text-gray-900 dark:text-white">
                                                    {match.csv.comercio}
                                                </span>
                                                <span className="ml-2 text-gray-700 dark:text-gray-300">
                                                    ${match.csv.monto.toLocaleString('es-CL')}
                                                </span>
                                                <span className="ml-2 text-sm text-gray-500 dark:text-gray-400">
                                                    {new Date(match.csv.fecha).toLocaleDateString('es-CL')}
                                                </span>
                                            </div>
                                        </div>

                                        {/* Toggle para rechazar */}
                                        <button
                                            onClick={() => {
                                                const newDecision = decisiones.autoMatches[match.manual.id] === 'accept' ? 'reject' : 'accept';
                                                setDecisiones({
                                                    ...decisiones,
                                                    autoMatches: {
                                                        ...decisiones.autoMatches,
                                                        [match.manual.id]: newDecision
                                                    }
                                                });
                                            }}
                                            className={`px-3 py-1 rounded text-xs font-semibold transition-colors ${
                                                decisiones.autoMatches[match.manual.id] === 'accept'
                                                    ? 'bg-green-600 text-white hover:bg-green-700'
                                                    : 'bg-red-600 text-white hover:bg-red-700'
                                            }`}
                                        >
                                            {decisiones.autoMatches[match.manual.id] === 'accept' ? '‚úì Aceptar' : '‚úó Rechazar'}
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* Secci√≥n 2: Requieren revisi√≥n */}
                {resultado.suggestedMatches.length > 0 && (
                    <div>
                        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                            <span className="text-2xl mr-2">‚ö†Ô∏è</span>
                            Requieren revisi√≥n ({resultado.suggestedMatches.length})
                        </h3>
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                            Match entre 70-85%. Revisa si son el mismo gasto.
                        </p>
                        <div className="space-y-3">
                            {resultado.suggestedMatches.map(match => (
                                <div
                                    key={match.manual.id}
                                    className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4"
                                >
                                    {/* Transacci√≥n manual */}
                                    <div className="mb-2">
                                        <span className="inline-block px-2 py-1 bg-orange-200 dark:bg-orange-800 text-orange-800 dark:text-orange-200 text-xs font-semibold rounded mr-2">
                                            üü† Manual
                                        </span>
                                        <span className="font-semibold text-gray-900 dark:text-white">
                                            {match.manual.comercio}
                                        </span>
                                        <span className="ml-2 text-gray-700 dark:text-gray-300">
                                            ${match.manual.monto.toLocaleString('es-CL')}
                                        </span>
                                        <span className="ml-2 text-sm text-gray-500 dark:text-gray-400">
                                            {new Date(match.manual.fecha).toLocaleDateString('es-CL')}
                                        </span>
                                    </div>

                                    {/* Opciones de emparejamiento */}
                                    <div className="mt-3 space-y-2">
                                        <p className="text-sm font-medium text-gray-700 dark:text-gray-300">
                                            ¬øEmparejar con?
                                        </p>
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="radio"
                                                name={`match-${match.manual.id}`}
                                                checked={decisiones.suggestedMatches[match.manual.id] === match.csv.id}
                                                onChange={() => {
                                                    setDecisiones({
                                                        ...decisiones,
                                                        suggestedMatches: {
                                                            ...decisiones.suggestedMatches,
                                                            [match.manual.id]: match.csv.id
                                                        }
                                                    });
                                                }}
                                                className="w-4 h-4"
                                            />
                                            <span className="text-sm text-gray-700 dark:text-gray-300">
                                                <span className="font-semibold">{match.csv.comercio}</span> - ${match.csv.monto.toLocaleString('es-CL')} ({new Date(match.csv.fecha).toLocaleDateString('es-CL')})
                                                <span className="ml-2 text-yellow-600 dark:text-yellow-400 font-medium">
                                                    {match.score}% match
                                                </span>
                                            </span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="radio"
                                                name={`match-${match.manual.id}`}
                                                checked={decisiones.suggestedMatches[match.manual.id] === 'none'}
                                                onChange={() => {
                                                    setDecisiones({
                                                        ...decisiones,
                                                        suggestedMatches: {
                                                            ...decisiones.suggestedMatches,
                                                            [match.manual.id]: 'none'
                                                        }
                                                    });
                                                }}
                                                className="w-4 h-4"
                                            />
                                            <span className="text-sm text-gray-700 dark:text-gray-300">
                                                No emparejar (mantener separado)
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* Secci√≥n 3: Sin emparejar */}
                {resultado.noMatches.length > 0 && (
                    <div>
                        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center">
                            <span className="text-2xl mr-2">‚ùì</span>
                            Sin emparejar ({resultado.noMatches.length})
                        </h3>
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                            No se encontr√≥ match en el CSV. Probablemente pagos en efectivo o compras no facturadas.
                        </p>
                        <div className="space-y-3">
                            {resultado.noMatches.map(item => (
                                <div
                                    key={item.manual.id}
                                    className="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4"
                                >
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <span className="inline-block px-2 py-1 bg-orange-200 dark:bg-orange-800 text-orange-800 dark:text-orange-200 text-xs font-semibold rounded mr-2">
                                                üü† Manual
                                            </span>
                                            <span className="font-semibold text-gray-900 dark:text-white">
                                                {item.manual.comercio}
                                            </span>
                                            <span className="ml-2 text-gray-700 dark:text-gray-300">
                                                ${item.manual.monto.toLocaleString('es-CL')}
                                            </span>
                                            <span className="ml-2 text-sm text-gray-500 dark:text-gray-400">
                                                {new Date(item.manual.fecha).toLocaleDateString('es-CL')}
                                            </span>
                                        </div>

                                        <select
                                            value={decisiones.noMatches[item.manual.id]}
                                            onChange={(e) => {
                                                setDecisiones({
                                                    ...decisiones,
                                                    noMatches: {
                                                        ...decisiones.noMatches,
                                                        [item.manual.id]: e.target.value
                                                    }
                                                });
                                            }}
                                            className="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                        >
                                            <option value="keep">Mantener (no facturado)</option>
                                            <option value="delete">Eliminar (error)</option>
                                        </select>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* Botones de acci√≥n */}
                <div className="flex space-x-3 pt-4 border-t border-gray-200 dark:border-slate-700">
                    <button
                        onClick={onCancelar}
                        className="flex-1 px-6 py-3 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors font-semibold"
                    >
                        Cancelar
                    </button>
                    <button
                        onClick={handleConfirmar}
                        className="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg font-semibold"
                    >
                        Confirmar Reconciliaci√≥n
                    </button>
                </div>
            </div>
        </Modal>
    );
};

    </script>

    <script type="text/babel">
        // Modal para Cargar PDF del Estado de Cuenta - Finzi v3.5

const ModalCargarPDF = ({ onClose, onSuccess }) => {
    const { perfiles } = useApp();
    const [paso, setPaso] = useState(1); // 1: Mes/a√±o + Banco, 2: Subir PDF, 3: Preview, 4: Confirmar
    const [anioSeleccionado, setAnioSeleccionado] = useState(new Date().getFullYear());
    const [mesSeleccionado, setMesSeleccionado] = useState(null);
    const [archivo, setArchivo] = useState(null);
    const [bancoSeleccionado, setBancoSeleccionado] = useState('');
    const [perfilSeleccionado, setPerfilSeleccionado] = useState(perfiles[0]?.id || 1);
    const [transaccionesParsed, setTransaccionesParsed] = useState([]);
    const [procesando, setProcesando] = useState(false);
    const [error, setError] = useState(null);

    const aniosDisponibles = [new Date().getFullYear(), new Date().getFullYear() - 1];
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    // Lista de bancos disponibles
    const bancos = [
        { id: 'santander', nombre: 'Banco Santander', icon: 'üè¶' },
        { id: 'bci', nombre: 'Banco BCI', icon: 'üè¶' },
        { id: 'chile', nombre: 'Banco de Chile / Edwards', icon: 'üè¶' },
        { id: 'estado', nombre: 'BancoEstado', icon: 'üè¶' },
        { id: 'scotiabank', nombre: 'Scotiabank', icon: 'üè¶' },
        { id: 'falabella', nombre: 'Banco Falabella (CMR)', icon: 'üí≥' },
        { id: 'ripley', nombre: 'Banco Ripley', icon: 'üí≥' },
        { id: 'itau', nombre: 'Ita√∫', icon: 'üè¶' },
        { id: 'generico', nombre: 'Otro / No s√©', icon: 'üìÑ' }
    ];

    const handleArchivoChange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setError(null);
        setProcesando(true);

        try {
            // Validar PDF
            const validacion = await validarPDF(file);
            if (!validacion.valido) {
                setError(validacion.error);
                setProcesando(false);
                return;
            }

            setArchivo(file);
            setProcesando(false);
            setPaso(3); // Ir a preview

            // Parsear autom√°ticamente
            await parsearPDF();

        } catch (err) {
            setError(err.message || 'Error al procesar el archivo');
            setProcesando(false);
        }
    };

    const parsearPDF = async () => {
        if (!archivo || mesSeleccionado === null) return;

        setProcesando(true);
        setError(null);

        try {
            const mesAnio = `${anioSeleccionado}-${String(mesSeleccionado + 1).padStart(2, '0')}`;

            // Parsear PDF con el banco seleccionado
            const resultado = await window.parsearPDF(archivo, bancoSeleccionado === 'generico' ? null : bancoSeleccionado, mesAnio);

            // Categorizar autom√°ticamente las transacciones
            const transaccionesCategorizadas = resultado.transacciones.map(t => {
                const categoriaSugerida = categorizarAutomatico(t.descripcion);

                return {
                    ...t,
                    categoria: categoriaSugerida,
                    perfilId: perfilSeleccionado,
                    esCompartido: false,
                    esReembolsable: false,
                    reembolsoId: null
                };
            });

            setTransaccionesParsed(transaccionesCategorizadas);
            setProcesando(false);

            // Mostrar info del banco detectado
            if (resultado.bancoDetectado && bancoSeleccionado === 'generico') {
                const bancoInfo = bancos.find(b => b.id === resultado.bancoDetectado);
                if (bancoInfo) {
                    setError(`‚úì Banco detectado autom√°ticamente: ${bancoInfo.nombre}`);
                }
            }

        } catch (err) {
            console.error('Error al parsear PDF:', err);
            setError(err.message || 'No se pudieron extraer las transacciones del PDF');
            setProcesando(false);
        }
    };

    const handleGuardar = async () => {
        setProcesando(true);
        try {
            const mesAnio = `${anioSeleccionado}-${String(mesSeleccionado + 1).padStart(2, '0')}`;

            // Obtener o crear mes
            const mesAnioId = await getOrCreateMesAnio(mesAnio);

            // Agregar transacciones (marcadas como 'csv' y 'confirmado')
            const transaccionesParaGuardar = transaccionesParsed.map(t => ({
                ...t,
                mesAnioId,
                origen: 'csv',
                estado: 'confirmado',
                textoOriginal: null,
                transaccionRelacionadaId: null
            }));

            await addTransacciones(transaccionesParaGuardar);

            // Crear presupuestos base si no existen
            const presupuestosExistentes = await getPresupuestos(mesAnioId);
            if (presupuestosExistentes.length === 0) {
                const plantilla = await getPresupuestos(null);
                if (plantilla.length > 0) {
                    await savePresupuestos(plantilla.map(p => ({
                        categoria: p.categoria,
                        monto: p.monto
                    })), mesAnioId);
                }
            }

            // RECONCILIACI√ìN: Buscar transacciones manuales provisionales de este mes
            const resultado = await window.ejecutarReconciliacion(mesAnio);

            setProcesando(false);

            // Si hay transacciones para reconciliar, cerrar este modal y mostrar reconciliaci√≥n
            if (resultado.totalManuales > 0) {
                // TODO: Mostrar modal de reconciliaci√≥n
                onSuccess(mesAnioId);
                onClose();
            } else {
                onSuccess(mesAnioId);
                onClose();
            }

        } catch (err) {
            console.error('Error al guardar:', err);
            setError('Error al guardar las transacciones');
            setProcesando(false);
        }
    };

    return (
        <Modal
            isOpen={true}
            onClose={onClose}
            title="Cargar PDF"
            size="md"
        >
            <div className="space-y-4">
                {/* Indicador de pasos */}
                <div className="flex items-center justify-between">
                    {[1, 2, 3].map(num => (
                        <div key={num} className="flex items-center flex-1">
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${
                                paso >= num ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-600'
                            }`}>
                                {num}
                            </div>
                            {num < 3 && (
                                <div className={`flex-1 h-1 mx-2 ${
                                    paso > num ? 'bg-indigo-600' : 'bg-gray-200'
                                }`} />
                            )}
                        </div>
                    ))}
                </div>

                {/* Error */}
                {error && (
                    <div className={`p-3 rounded-lg ${
                        error.startsWith('‚úì')
                            ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800'
                            : 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800'
                    }`}>
                        <p className={`text-sm ${
                            error.startsWith('‚úì')
                                ? 'text-green-800 dark:text-green-300'
                                : 'text-red-800 dark:text-red-300'
                        }`}>
                            {error}
                        </p>
                    </div>
                )}

                {/* Paso 1: Seleccionar Mes/A√±o y Banco */}
                {paso === 1 && (
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Selecciona el mes del estado de cuenta
                            </label>
                            <div className="grid grid-cols-3 gap-2">
                                {meses.map((mes, index) => (
                                    <button
                                        key={index}
                                        onClick={() => setMesSeleccionado(index)}
                                        className={`py-2 px-2 rounded-lg font-semibold text-sm transition-colors ${
                                            mesSeleccionado === index
                                                ? 'bg-indigo-600 text-white'
                                                : 'bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-600'
                                        }`}
                                    >
                                        {mes}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                A√±o
                            </label>
                            <div className="grid grid-cols-2 gap-3">
                                {aniosDisponibles.map(anio => (
                                    <button
                                        key={anio}
                                        onClick={() => setAnioSeleccionado(anio)}
                                        className={`py-3 px-4 rounded-lg font-semibold transition-colors ${
                                            anioSeleccionado === anio
                                                ? 'bg-indigo-600 text-white'
                                                : 'bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-600'
                                        }`}
                                    >
                                        {anio}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Selecciona tu banco
                            </label>
                            <div className="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto">
                                {bancos.map(banco => (
                                    <button
                                        key={banco.id}
                                        onClick={() => setBancoSeleccionado(banco.id)}
                                        className={`py-3 px-3 rounded-lg font-semibold text-sm transition-colors text-left flex items-center space-x-2 ${
                                            bancoSeleccionado === banco.id
                                                ? 'bg-indigo-600 text-white'
                                                : 'bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-600'
                                        }`}
                                    >
                                        <span className="text-xl">{banco.icon}</span>
                                        <span className="flex-1">{banco.nombre}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <button
                            onClick={() => setPaso(2)}
                            disabled={mesSeleccionado === null || !bancoSeleccionado}
                            className="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-semibold"
                        >
                            Continuar
                        </button>
                    </div>
                )}

                {/* Paso 2: Subir PDF */}
                {paso === 2 && (
                    <div className="space-y-4">
                        <div className="text-center">
                            <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                                Sube el PDF del estado de cuenta de <span className="font-bold">{meses[mesSeleccionado]} {anioSeleccionado}</span>
                            </p>
                            <input
                                type="file"
                                accept=".pdf"
                                onChange={handleArchivoChange}
                                className="hidden"
                                id="pdf-upload"
                            />
                            <label
                                htmlFor="pdf-upload"
                                className="inline-flex items-center px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 cursor-pointer font-semibold"
                            >
                                üìë Seleccionar PDF
                            </label>
                        </div>

                        <button
                            onClick={() => setPaso(1)}
                            className="w-full px-6 py-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700"
                        >
                            Volver
                        </button>
                    </div>
                )}

                {/* Paso 3: Preview */}
                {paso === 3 && (
                    <div className="space-y-4">
                        <div>
                            <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">
                                Transacciones encontradas: {transaccionesParsed.length}
                            </h3>
                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                Revisa que las transacciones se hayan extra√≠do correctamente
                            </p>
                        </div>

                        {/* Lista de transacciones */}
                        <div className="max-h-96 overflow-y-auto space-y-2">
                            {transaccionesParsed.slice(0, 10).map((t, index) => (
                                <div key={index} className="p-3 bg-gray-50 dark:bg-slate-800 rounded-lg">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <p className="font-semibold text-gray-900 dark:text-white text-sm">
                                                {t.comercio}
                                            </p>
                                            <p className="text-xs text-gray-500 dark:text-gray-400">
                                                {t.fecha} ‚Ä¢ {t.categoria}
                                            </p>
                                        </div>
                                        <p className="font-bold text-gray-900 dark:text-white">
                                            {formatearMonto(t.monto)}
                                        </p>
                                    </div>
                                </div>
                            ))}
                            {transaccionesParsed.length > 10 && (
                                <p className="text-center text-sm text-gray-500 dark:text-gray-400">
                                    ... y {transaccionesParsed.length - 10} m√°s
                                </p>
                            )}
                        </div>

                        <div className="flex space-x-3">
                            <button
                                onClick={() => {
                                    setPaso(2);
                                    setArchivo(null);
                                    setTransaccionesParsed([]);
                                }}
                                className="flex-1 px-6 py-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700"
                            >
                                Cambiar PDF
                            </button>
                            <button
                                onClick={handleGuardar}
                                disabled={procesando || transaccionesParsed.length === 0}
                                className="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 font-semibold"
                            >
                                {procesando ? 'Guardando...' : `Guardar ${transaccionesParsed.length} Transacciones`}
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </Modal>
    );
};

    </script>

    <!-- APP PRINCIPAL -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useContext, createContext, useRef } = React;

        // Context Global
        const AppContext = createContext();

        // Hook personalizado para usar el contexto
        const useApp = () => {
            const context = useContext(AppContext);
            if (!context) {
                throw new Error('useApp debe usarse dentro de AppProvider');
            }
            return context;
        };

        // Componente App Principal
        function App() {
            const [currentPage, setCurrentPage] = useState('home');
            const [selectedMonth, setSelectedMonth] = useState(null);
            const [selectedMonths, setSelectedMonths] = useState([]); // Nuevo: array de meses seleccionados
            const [perfiles, setPerfiles] = useState([]);
            const [categorias, setCategorias] = useState([]);
            const [loading, setLoading] = useState(true);
            const [mesesCargados, setMesesCargados] = useState([]);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [isDarkMode, setIsDarkMode] = useState(() => {
                // Inicializar desde localStorage
                const saved = localStorage.getItem('darkMode');
                return saved === 'true';
            });

            // FIREBASE: Estado de autenticaci√≥n
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [firebaseReady, setFirebaseReady] = useState(false);

            // Aplicar dark mode al document
            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    document.body.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.body.classList.remove('dark');
                }
                localStorage.setItem('darkMode', isDarkMode);
            }, [isDarkMode]);

            // FIREBASE: Inicializar Firebase
            useEffect(() => {
                const initFirebase = async () => {
                    if (window.USE_FIREBASE) {
                        try {
                            await window.initializeFirebase();
                            setFirebaseReady(true);
                            console.log('‚úÖ Firebase inicializado en App');
                        } catch (error) {
                            console.error('‚ùå Error al inicializar Firebase:', error);
                            // Si falla Firebase, deshabilitarlo y usar IndexedDB
                            window.USE_FIREBASE = false;
                            setFirebaseReady(true);
                        }
                    } else {
                        setFirebaseReady(true);
                    }
                };

                initFirebase();
            }, []);

            // FIREBASE: Listener de autenticaci√≥n
            useEffect(() => {
                if (!window.USE_FIREBASE || !firebaseReady) return;

                console.log('üéß Registrando listener de autenticaci√≥n...');

                const handleAuthChange = (event) => {
                    const { isAuthenticated: authStatus } = event.detail;
                    console.log('üîÑ Auth changed:', authStatus);
                    setIsAuthenticated(authStatus);

                    // Si se autentica, reinicializar app
                    if (authStatus) {
                        console.log('‚úÖ Usuario autenticado, inicializando app...');
                        initializeApp();
                    }
                };

                window.addEventListener('firebaseUserChanged', handleAuthChange);
                console.log('‚úÖ Listener registrado');

                // Verificar si ya hay un usuario autenticado (caso de login antes de que se registre el listener)
                if (window.currentUser) {
                    console.log('üîç Usuario ya autenticado, inicializando app...');
                    setIsAuthenticated(true);
                    initializeApp();
                }

                return () => {
                    window.removeEventListener('firebaseUserChanged', handleAuthChange);
                };
            }, [firebaseReady]);

            // Inicializar datos al montar
            useEffect(() => {
                // Si usa Firebase, esperar autenticaci√≥n
                if (window.USE_FIREBASE) {
                    if (firebaseReady && isAuthenticated) {
                        initializeApp();
                    } else if (firebaseReady && !isAuthenticated) {
                        // No autenticado, mostrar login
                        setLoading(false);
                    }
                } else {
                    // No usa Firebase, inicializar directamente
                    initializeApp();
                }
            }, [firebaseReady, isAuthenticated]);

            const initializeApp = async () => {
                try {
                    console.log('üì± Iniciando carga de datos...');

                    // Cargar perfiles desde localStorage o crear default
                    const storedPerfiles = localStorage.getItem('perfiles');
                    if (storedPerfiles) {
                        setPerfiles(JSON.parse(storedPerfiles));
                    } else {
                        const defaultPerfiles = window.getDefaultPerfiles();
                        setPerfiles(defaultPerfiles);
                        localStorage.setItem('perfiles', JSON.stringify(defaultPerfiles));
                    }
                    console.log('‚úÖ Perfiles cargados');

                    // Cargar categor√≠as desde localStorage o crear default
                    const storedCategorias = localStorage.getItem('categorias');
                    if (storedCategorias) {
                        setCategorias(JSON.parse(storedCategorias));
                    } else {
                        setCategorias(window.DEFAULT_CATEGORIES);
                        localStorage.setItem('categorias', JSON.stringify(window.DEFAULT_CATEGORIES));
                    }
                    console.log('‚úÖ Categor√≠as cargadas');

                    // Cargar meses (usa dataLayer que funciona con IndexedDB o Firebase)
                    console.log('‚è≥ Cargando meses...');
                    const meses = await window.getMesesCarga();
                    console.log('‚úÖ Meses cargados:', meses.length);
                    setMesesCargados(meses);

                    // Seleccionar el mes m√°s reciente por defecto
                    if (meses.length > 0) {
                        const mesReciente = meses.sort((a, b) =>
                            new Date(b.fechaCarga) - new Date(a.fechaCarga)
                        )[0];
                        setSelectedMonth(mesReciente);
                        setSelectedMonths([mesReciente]); // Inicializar con el mes m√°s reciente
                    }

                    console.log('‚úÖ App inicializada correctamente');
                    setLoading(false);
                } catch (error) {
                    console.error('‚ùå Error al inicializar la app:', error);
                    alert('Error al cargar la aplicaci√≥n: ' + error.message);
                    setLoading(false);
                }
            };

            // Funciones para actualizar perfiles y categor√≠as
            const updatePerfiles = useCallback((newPerfiles) => {
                setPerfiles(newPerfiles);
                localStorage.setItem('perfiles', JSON.stringify(newPerfiles));
            }, []);

            const updateCategorias = useCallback((newCategorias) => {
                setCategorias(newCategorias);
                localStorage.setItem('categorias', JSON.stringify(newCategorias));
            }, []);

            const refreshMesesCargados = useCallback(async () => {
                const meses = await db.mesesCarga.toArray();
                setMesesCargados(meses);
            }, []);

            const contextValue = {
                currentPage,
                setCurrentPage,
                selectedMonth,
                setSelectedMonth,
                selectedMonths,
                setSelectedMonths,
                perfiles,
                updatePerfiles,
                categorias,
                updateCategorias,
                mesesCargados,
                refreshMesesCargados,
                isSidebarOpen,
                setIsSidebarOpen,
                isDarkMode,
                setIsDarkMode
            };

            // FIREBASE: Mostrar Login si usa Firebase y no est√° autenticado
            if (window.USE_FIREBASE && firebaseReady && !isAuthenticated && !loading) {
                return <Login />;
            }

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-slate-900">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4"></div>
                            <p className="text-gray-700 dark:text-gray-300 text-xl font-semibold">Cargando...</p>
                        </div>
                    </div>
                );
            }

            return (
                <AppContext.Provider value={contextValue}>
                    <div className="flex min-h-screen overflow-x-hidden">
                        <Sidebar />
                        <main className={`flex-1 transition-all duration-300 ${isSidebarOpen ? 'lg:ml-64' : 'lg:ml-16'} ml-0 w-full max-w-full overflow-x-hidden`}>
                            <div className="p-3 sm:p-4 lg:p-6 pt-16 lg:pt-6 max-w-full">
                                {currentPage === 'home' && <Home />}
                                {currentPage === 'ingresos' && <Ingresos />}
                                {currentPage === 'reembolsos' && <Reembolsos />}
                                {currentPage === 'proyecciones' && <Proyecciones />}
                                {currentPage === 'analisis' && <AnalisisCierre />}
                                {currentPage === 'historial' && <HistorialMeses />}
                                {currentPage === 'balance' && <Balance />}
                                {currentPage === 'perfiles' && <Perfiles />}
                                {currentPage === 'categorias' && <Categorias />}
                                {currentPage === 'presupuestos' && <Presupuestos />}
                                {currentPage === 'cuotasFuturas' && <CuotasFuturas />}
                                {currentPage === 'recurrentes' && <Recurrentes />}
                                {currentPage === 'simulador' && <Simulador />}
                            </div>
                        </main>
                        {/* Tour Guiado de Bienvenida */}
                        <TourGuide />
                    </div>
                </AppContext.Provider>
            );
        }

        // Renderizar la aplicaci√≥n
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
